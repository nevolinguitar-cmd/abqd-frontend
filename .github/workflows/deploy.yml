name: Deploy frontend (self-hosted) v3 (no-sudo)

on:
  push:
    branches: ["main", "develop"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, abqd, frontend]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Decide target (prod/stage)
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ github.ref_name }}" = "main" ]; then
            TARGET_DIR="/var/www/abqd/prod/frontend"
          else
            TARGET_DIR="/var/www/abqd/stage/frontend"
          fi
          echo "TARGET_DIR=$TARGET_DIR" >> "$GITHUB_ENV"
          echo "Deploy target: $TARGET_DIR"

      - name: Ensure target dir exists (no sudo)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$TARGET_DIR"

      - name: Ensure repo structure is clean
        shell: bash
        run: |
          set -euo pipefail

          # Root Vite duplicates must not exist; CRM lives only in apps/crm
          test ! -d "./src" || { echo "ERROR: ./src exists in repo root (duplicate Vite)"; exit 1; }
          test ! -d "./public" || { echo "ERROR: ./public exists in repo root (duplicate Vite)"; exit 1; }
          test ! -f "./vite.config.js" || { echo "ERROR: ./vite.config.js exists in repo root"; exit 1; }
          test ! -f "./package.json" || { echo "ERROR: ./package.json exists in repo root"; exit 1; }

          # Static frontend folder must exist
          test -d "./frontend" || { echo "ERROR: ./frontend not found in repo root"; exit 1; }

          # CRM app must exist
          test -d "./apps/crm" || { echo "ERROR: ./apps/crm not found"; exit 1; }

          echo "OK: repo structure clean"

      - name: Build CRM (Vite) -> frontend/dashboard
        shell: bash
        run: |
          set -euo pipefail

          node -v
          npm -v

          cd apps/crm
          npm ci
          npm run build
          cd ../..

          test -d "./apps/crm/dist" || { echo "ERROR: apps/crm/dist not found after build"; exit 1; }

          rm -rf ./frontend/dashboard
          mkdir -p ./frontend/dashboard
          rsync -rltDz --delete ./apps/crm/dist/ ./frontend/dashboard/

          test -f ./frontend/dashboard/index.html || { echo "ERROR: CRM index.html not found in frontend/dashboard"; exit 1; }
          echo "OK: CRM built into ./frontend/dashboard"

      - name: Deploy (rsync without owner/group/perms)
        shell: bash
        run: |
          set -euo pipefail

          rsync -rltDz --delete \
            --delete-excluded \
            --exclude='*.bak*' \
            --exclude='*.repo.bak*' \
            --exclude='.git/' \
            --no-owner --no-group --no-perms --omit-dir-times \
            ./frontend/ "$TARGET_DIR/"

          echo "Deployed files (top):"
          ls -la "$TARGET_DIR" | head -n 50

      - name: Healthcheck (local nginx, avoid DNS)
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ github.ref_name }}" = "main" ]; then
            curl -kfsSI https://127.0.0.1/dashboard/ -H "Host: app.abqd.ru" | head -n 20
            curl -kfsSI https://127.0.0.1/tariffs/   -H "Host: app.abqd.ru" | head -n 20
          else
            echo "Skip host healthcheck for non-main branch."
          fi
