name: Deploy frontend (self-hosted)

on:
  push:
    branches: ["main", "develop"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, abqd, frontend]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Decide target (prod/stage)
        shell: bash
        run: |
          set -e
          if [ "${{ github.ref_name }}" = "main" ]; then
            TARGET_DIR="/var/www/abqd/prod"
          else
            TARGET_DIR="/var/www/abqd/stage"
          fi
          echo "TARGET_DIR=$TARGET_DIR" >> "$GITHUB_ENV"
          echo "Deploy target: $TARGET_DIR"

      - name: Ensure target dir exists
        shell: bash
        run: |
          set -e
          mkdir -p "${TARGET_DIR}/frontend"

      - name: Ensure frontend folder exists in repo
        shell: bash
        run: |
          set -e
          test -d "./frontend" || (echo "ERROR: ./frontend not found in repo root" && exit 1)
          test -f "./frontend/index.html" || echo "WARN: frontend/index.html not found (but deploying folder anyway)"

      - name: Deploy (rsync)
        shell: bash
        run: |
          set -e
          rsync -az --delete ./frontend/ "${TARGET_DIR}/frontend/"
          echo "Deployed files:"
          ls -la "${TARGET_DIR}/frontend" | head -n 50

      - name: Reload nginx
        shell: bash
        run: |
          set -e
          sudo nginx -t
          sudo systemctl reload nginx
          echo "âœ… nginx reloaded"
