name: Deploy frontend (self-hosted)

on:
  push:
    branches: ["main", "develop"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, abqd, frontend]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Decide target (prod/stage)
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ github.ref_name }}" = "main" ]; then
            TARGET_DIR="/var/www/abqd/prod"
          else
            TARGET_DIR="/var/www/abqd/stage"
          fi
          echo "TARGET_DIR=$TARGET_DIR" >> "$GITHUB_ENV"
          echo "Deploy target: $TARGET_DIR"

      - name: Ensure target dir exists
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${TARGET_DIR}/frontend"

      - name: Ensure frontend folder exists in repo
        shell: bash
        run: |
          set -euo pipefail
          test -d "./frontend" || (echo "ERROR: ./frontend not found in repo root" && exit 1)
          test -f "./frontend/index.html" || echo "WARN: frontend/index.html not found (but deploying folder anyway)"

      - name: Deploy (rsync without owner/group)
        shell: bash
        run: |
          set -euo pipefail
          # ВАЖНО: не трогаем владельцев/группы (иначе падает chgrp)
          rsync -rltz --delete --no-owner --no-group ./frontend/ "${TARGET_DIR}/frontend/"
          echo "Deployed files:"
          ls -la "${TARGET_DIR}/frontend" | head -n 80

      - name: Fix permissions for nginx read (no chown/chgrp)
        shell: bash
        run: |
          set -euo pipefail
          # Только права, чтобы nginx (www-data) мог читать статику
          find "${TARGET_DIR}/frontend" -type d -exec chmod 755 {} \;
          find "${TARGET_DIR}/frontend" -type f -exec chmod 644 {} \;
          echo "✅ perms fixed (755 dirs / 644 files)"

      - name: Reload nginx
        shell: bash
        run: |
          set -euo pipefail
          sudo nginx -t
          sudo systemctl reload nginx
          echo "✅ nginx reloaded"
