import React, { useCallback, useEffect, useMemo, useState } from "react";

// ABQD CRM — 1-file, preview-safe (JSX only)
// ✅ Без TS-синтаксиса / без внешних UI-библиотек
// ✅ Montserrat + матовое стекло + Light/Dark (сохранение)
// ✅ Канбан: 4 карточки вниз → следующий «этаж» вправо (grid-auto-flow: column; rows: 4)

// =========================
// DEMO DATA
// =========================
const demoStages = [
  { key: "inbox", title: "Входящие", hint: "Новые касания и лиды" },
  { key: "qual", title: "Квалификация", hint: "Понимаем цель/контекст" },
  { key: "plan", title: "Стратегия", hint: "План доведения до результата" },
  { key: "work", title: "В работе", hint: "Касания, созвоны, задачи" },
  { key: "won", title: "Результат", hint: "Достигнута цель" },
];

const demoLeads = [
  {
    id: "L-1021",
    name: "Ольга М.",
    company: "Салон красоты",
    stage: "inbox",
    score: 62,
    goal: "Повысить повторные покупки",
    next: "Сценарий касаний на 14 дней",
    tags: ["NFC", "retail"],
    lastTouch: "NFC tap — меню услуг",
    touches7d: 5,
  },
  {
    id: "L-1044",
    name: "Илья К.",
    company: "Автодетейлинг",
    stage: "qual",
    score: 74,
    goal: "Увеличить конверсию лид→запись",
    next: "Запуск WhatsApp-цепочки",
    tags: ["WhatsApp", "calls"],
    lastTouch: "Звонок — пропущен",
    touches7d: 9,
  },
  {
    id: "L-1098",
    name: "Марина С.",
    company: "Онлайн‑школа",
    stage: "plan",
    score: 81,
    goal: "Систематизировать отдел продаж",
    next: "Карта метрик и ролей",
    tags: ["AI", "ops"],
    lastTouch: "Telegram — ответила",
    touches7d: 12,
  },
  {
    id: "L-1106",
    name: "Дмитрий П.",
    company: "Юр. услуги",
    stage: "work",
    score: 69,
    goal: "Ускорить обработку заявок",
    next: "Включить AI‑телефонию",
    tags: ["Telegram", "AI"],
    lastTouch: "NFC tap — прайс",
    touches7d: 7,
  },
  {
    id: "L-1120",
    name: "Алексей В.",
    company: "Студия дизайна",
    stage: "won",
    score: 90,
    goal: "Упаковать продукт и воронку",
    next: "Сопровождение 30 дней",
    tags: ["NFC", "brand"],
    lastTouch: "Договор — подписан",
    touches7d: 18,
  },
  // дополнительно для демонстрации "4 вниз → вправо"
  {
    id: "L-1131",
    name: "Елена Р.",
    company: "Стоматология",
    stage: "inbox",
    score: 58,
    goal: "Стабилизировать поток первичек",
    next: "Скрипт первого касания + FAQ",
    tags: ["NFC", "calls"],
    lastTouch: "WhatsApp — прочитано",
    touches7d: 4,
  },
  {
    id: "L-1137",
    name: "Роман Г.",
    company: "Кофейня",
    stage: "inbox",
    score: 71,
    goal: "Увеличить средний чек",
    next: "Шаблон оффера + QR-постер",
    tags: ["retail", "ops"],
    lastTouch: "NFC tap — меню",
    touches7d: 6,
  },
  {
    id: "L-1142",
    name: "Светлана Н.",
    company: "Фитнес-студия",
    stage: "qual",
    score: 66,
    goal: "Дожим до абонемента",
    next: "Цепочка: польза → кейс → оффер",
    tags: ["WhatsApp"],
    lastTouch: "Telegram — вопрос",
    touches7d: 8,
  },
];

// =========================
// HELPERS
// =========================
function cx() {
  return Array.prototype.slice
    .call(arguments)
    .filter(Boolean)
    .join(" ");
}

function scoreLabel(score) {
  if (score >= 85) return { text: "Горячий", tone: "hot" };
  if (score >= 70) return { text: "Тёплый", tone: "warm" };
  if (score >= 55) return { text: "Холодный", tone: "cold" };
  return { text: "Слабый", tone: "weak" };
}

function createSearchString(lead) {
  const base = [lead.name, lead.company, lead.id, lead.goal, lead.next, lead.lastTouch]
    .filter(Boolean)
    .join(" ");
  const tags = (lead.tags || []).join(" ");
  return `${base} ${tags}`.toLowerCase();
}

// =========================
// TESTS (runtime checks)
// =========================
(function tests() {
  try {
    console.assert(scoreLabel(90).tone === "hot", "scoreLabel hot");
    console.assert(scoreLabel(74).tone === "warm", "scoreLabel warm");
    console.assert(scoreLabel(62).tone === "cold", "scoreLabel cold");
    console.assert(scoreLabel(10).tone === "weak", "scoreLabel weak");

    const s = createSearchString({
      id: "X",
      name: "Test",
      company: "Acme",
      goal: "Grow",
      next: "Call",
      lastTouch: "NFC",
      tags: ["one", "TWO"],
    });
    console.assert(s.includes("test") && s.includes("acme") && s.includes("two"), "createSearchString");

    const init = demoStages.reduce((acc, st) => {
      acc[st.key] = [];
      return acc;
    }, {});
    const by = [{ stage: "work" }, { stage: "work" }, { stage: "inbox" }].reduce((acc, l) => {
      if (acc[l.stage]) acc[l.stage].push(l);
      return acc;
    }, init);
    console.assert((by.work || []).length === 2, "byStage reduce");
  } catch {
    // ignore
  }
})();

function useStoredTheme() {
  const [theme, setTheme] = useState("dark");

  useEffect(() => {
    try {
      const saved = window.localStorage.getItem("abqd_crm_theme");
      if (saved === "dark" || saved === "light") {
        setTheme(saved);
        return;
      }
      const prefersLight =
        typeof window !== "undefined" &&
        !!window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: light)").matches;
      setTheme(prefersLight ? "light" : "dark");
    } catch {
      // ignore
    }
  }, []);

  const set = (t) => {
    setTheme(t);
    try {
      window.localStorage.setItem("abqd_crm_theme", t);
    } catch {
      // ignore
    }
  };

  return [theme, set];
}

// =========================
// STYLES
// =========================
const css = `
@import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap');

[data-theme='dark']{
  --bg:#060607;
  --fg:#f4f4f5;
  --muted:rgba(244,244,245,.62);
  --muted2:rgba(244,244,245,.45);
  --bd:rgba(244,244,245,.16);
  --bd2:rgba(244,244,245,.10);
  --panel:linear-gradient(135deg, rgba(24,24,27,.38), rgba(24,24,27,.22));
  --chip:rgba(9,9,11,.24);
  --chip2:rgba(9,9,11,.34);
  --shadow:rgba(0,0,0,.50);
  --shine:rgba(255,255,255,.06);
}

[data-theme='light']{
  --bg:#f5f6f8;
  --fg:#0b0b0f;
  --muted:rgba(11,11,15,.62);
  --muted2:rgba(11,11,15,.42);
  --bd:rgba(11,11,15,.14);
  --bd2:rgba(11,11,15,.10);
  --panel:linear-gradient(135deg, rgba(255,255,255,.82), rgba(235,238,242,.68));
  --chip:rgba(255,255,255,.60);
  --chip2:rgba(230,233,238,.70);
  --shadow:rgba(0,0,0,.16);
  --shine:rgba(0,0,0,.05);
}

.abqd-root{min-height:100vh;background:var(--bg);color:var(--fg);font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
.abqd-wrap{max-width:1720px;margin:0 auto;padding:16px 12px 28px;}

.abqd-grid{display:grid;grid-template-columns:1fr;gap:14px;}
@media (min-width:1024px){.abqd-grid{grid-template-columns:340px 1fr;}}

.abqd-radius{border-radius:22px;}
.abqd-glass{position:relative;border:1px solid var(--bd);background:var(--panel);backdrop-filter:blur(18px) saturate(120%);-webkit-backdrop-filter:blur(18px) saturate(120%);box-shadow:0 20px 60px var(--shadow), inset 0 1px 0 rgba(255,255,255,.08);}
.abqd-glow{pointer-events:none;position:absolute;inset:0;border-radius:22px;mask-image:radial-gradient(60% 60% at 50% 0%,#000,transparent);-webkit-mask-image:radial-gradient(60% 60% at 50% 0%,#000,transparent);}
.abqd-glow::before{content:'';position:absolute;left:50%;top:-56px;transform:translateX(-50%);width:560px;height:140px;border-radius:999px;background:var(--shine);}

.abqd-top{position:sticky;top:0;z-index:10;display:grid;gap:10px;}
.abqd-bar{padding:14px 14px;background:var(--panel);}
.abqd-barRow{display:flex;flex-wrap:wrap;align-items:center;gap:10px;}

.abqd-brand{display:flex;align-items:center;gap:10px;min-width:240px;}
.abqd-brandLogo{display:block;height:34px;width:auto;}
.abqd-brandMeta{line-height:1.1;}
.abqd-brandSub{font-size:12px;color:var(--muted);}

.abqd-inputWrap{position:relative;flex:1;min-width:260px;}
.abqd-input{width:100%;border-radius:18px;border:1px solid var(--bd);background:var(--chip2);padding:11px 12px 11px 34px;color:var(--fg);outline:none;}
.abqd-input::placeholder{color:var(--muted2);} 
.abqd-inputIcon{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--muted2);font-size:14px;}

.abqd-btn{border-radius:16px;border:1px solid var(--bd);background:rgba(255,255,255,.08);color:var(--fg);padding:10px 12px;font-weight:700;font-size:13px;cursor:pointer;transition:transform .08s ease,filter .2s ease;}
[data-theme='light'] .abqd-btn{background:rgba(0,0,0,.04);} 
.abqd-btn:hover{filter:brightness(1.06);} 
.abqd-btn:active{transform:translateY(1px);} 
.abqd-btn--secondary{background:var(--chip2);} 
.abqd-btn--sm{padding:7px 10px;font-size:12px;border-radius:14px;} 
.abqd-btn--full{width:100%;margin-top:10px;} 

.abqd-toggle{display:flex;align-items:center;border:1px solid var(--bd);background:var(--chip2);border-radius:16px;padding:3px;} 
.abqd-toggleBtn{border:0;background:transparent;color:var(--muted);font-weight:800;font-size:12px;padding:7px 10px;border-radius:13px;cursor:pointer;} 
.abqd-toggleBtn.is-active{background:var(--chip);color:var(--fg);} 

.abqd-switch{width:44px;height:26px;border-radius:999px;border:1px solid var(--bd);background:var(--chip2);position:relative;cursor:pointer;} 
.abqd-switchDot{position:absolute;left:4px;top:4px;width:18px;height:18px;border-radius:50%;background:var(--fg);opacity:.8;transition:left .18s ease,opacity .18s ease;} 
.abqd-switch.is-on .abqd-switchDot{left:22px;opacity:.95;} 

.abqd-pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--bd);background:var(--chip);padding:4px 10px;border-radius:999px;font-size:12px;font-weight:800;} 
.abqd-ibox{display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:12px;border:1px solid var(--bd);background:var(--chip2);font-size:12px;opacity:.9;} 

.abqd-section{padding:14px;} 
.abqd-h2{font-size:18px;font-weight:900;letter-spacing:-.015em;} 
.abqd-h3{font-size:16px;font-weight:900;letter-spacing:-.01em;} 
.abqd-muted{color:var(--muted);} 
.abqd-strong{font-weight:900;} 
.abqd-trunc{min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;} 
.abqd-sep{height:1px;background:var(--bd2);} 

.abqd-stat{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border-radius:18px;border:1px solid var(--bd);background:var(--chip);} 
.abqd-statTitle{font-weight:900;font-size:13px;} 
.abqd-statSub{font-size:12px;color:var(--muted);} 
.abqd-statValue{font-weight:900;font-size:14px;} 

.abqd-tabs{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;} 
.abqd-tab{border:1px solid var(--bd);background:var(--chip2);color:var(--muted);border-radius:999px;padding:8px 12px;font-weight:900;font-size:12px;cursor:pointer;} 
.abqd-tab.is-active{background:var(--chip);color:var(--fg);} 

.abqd-kanban{display:flex;gap:12px;overflow-x:auto;padding-bottom:6px;} 
.abqd-kanban::-webkit-scrollbar{height:8px;} 
.abqd-kanban::-webkit-scrollbar-thumb{background:rgba(127,127,127,.25);border-radius:999px;} 

.abqd-col{width:300px;min-width:300px;padding:14px;background:var(--panel);border-radius:22px;} 
.abqd-colHead{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;} 
.abqd-colTitle{font-weight:900;font-size:13px;} 
.abqd-colHint{font-size:12px;color:var(--muted);} 

.abqd-cardRail{margin-top:10px;overflow-x:auto;padding-bottom:6px;} 
.abqd-cardRail::-webkit-scrollbar{height:8px;} 
.abqd-cardRail::-webkit-scrollbar-thumb{background:rgba(127,127,127,.20);border-radius:999px;} 

/* 4 вниз → затем вправо */
.abqd-cardGrid{display:grid;grid-auto-flow:column;grid-template-rows:repeat(4,auto);gap:10px;align-content:start;} 
.abqd-cardGrid.is-compact{grid-auto-columns:250px;} 
.abqd-cardGrid:not(.is-compact){grid-auto-columns:270px;} 

.abqd-leadBtn{border:0;background:transparent;padding:0;cursor:pointer;text-align:left;} 
.abqd-lead{padding:12px;transition:filter .18s ease, transform .18s ease;} 
.abqd-lead:hover{filter:brightness(1.06);transform:translateY(-1px);} 

.abqd-leadTop{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;} 
.abqd-leadTitle{display:flex;align-items:center;gap:8px;font-weight:900;font-size:13px;} 
.abqd-leadSub{font-size:12px;color:var(--muted);margin-top:2px;} 
.abqd-leadMeta{display:flex;gap:8px;margin-top:8px;} 

.abqd-metaChip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--bd);background:var(--chip2);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--fg);max-width:100%;} 

.abqd-leadNext{margin-top:10px;} 
.abqd-leadNextText{margin-top:2px;font-weight:800;font-size:13px;line-height:1.25;} 
.abqd-leadNextCompact{margin-top:8px;font-size:12px;color:var(--muted);} 

.abqd-tags{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;} 
.abqd-tag{border:1px solid var(--bd);background:var(--chip);border-radius:999px;padding:6px 10px;font-size:12px;font-weight:800;} 

.abqd-score{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--bd);background:var(--chip2);border-radius:999px;padding:6px 10px;font-weight:900;font-size:12px;white-space:nowrap;} 
.abqd-scoreDot{width:7px;height:7px;border-radius:50%;background:var(--fg);opacity:.75;} 
.abqd-score.tone-hot{border-color:rgba(16,185,129,.30);background:rgba(16,185,129,.10);} 
.abqd-score.tone-warm{border-color:rgba(245,158,11,.26);background:rgba(245,158,11,.10);} 
.abqd-score.tone-cold{border-color:rgba(161,161,170,.26);background:rgba(161,161,170,.10);} 
.abqd-score.tone-weak{border-color:rgba(244,63,94,.26);background:rgba(244,63,94,.10);} 
.abqd-score.is-compact{padding:6px 10px;} 

.abqd-drawerWrap{position:fixed;inset:0;z-index:50;} 
.abqd-drawerBackdrop{position:absolute;inset:0;background:rgba(0,0,0,.42);border:0;} 
.abqd-drawer{position:absolute;right:0;top:0;height:100%;width:min(560px,100%);padding:12px;} 
.abqd-drawerCard{height:100%;display:flex;flex-direction:column;overflow:hidden;} 
.abqd-drawerHead{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:14px;} 
.abqd-drawerBody{padding:14px;overflow:auto;} 

.abqd-box{border:1px solid var(--bd);background:var(--chip);border-radius:22px;padding:14px;margin-bottom:12px;} 
.abqd-boxTitle{font-weight:900;margin-bottom:6px;} 
.abqd-boxText{font-weight:800;font-size:13px;line-height:1.35;} 
.abqd-boxGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;} 
.abqd-mini{border:1px solid var(--bd);background:var(--chip2);border-radius:18px;padding:10px;} 
.abqd-aiList{margin-top:10px;display:grid;gap:10px;} 
.abqd-aiRow{display:flex;align-items:center;justify-content:space-between;gap:10px;border:1px solid var(--bd);background:var(--chip2);border-radius:18px;padding:10px;} 
.abqd-list{display:grid;gap:8px;margin-top:8px;} 
.abqd-listRow{border:1px solid var(--bd);background:var(--chip2);border-radius:18px;padding:10px;font-weight:700;font-size:13px;} 

.abqd-foot{margin-top:10px;font-size:12px;color:var(--muted2);padding:0 4px;} 

/* CTA button */
.abqd-ctaCard{padding:14px;} 
.abqd-ctaBtn{display:flex;align-items:center;gap:12px;text-align:left;padding:12px 14px;border-radius:18px;border:1px solid var(--bd);background:linear-gradient(135deg, rgba(255,255,255,.10), rgba(255,255,255,.04));color:var(--fg);cursor:pointer;transition:filter .18s ease, transform .08s ease;} 
[data-theme='light'] .abqd-ctaBtn{background:linear-gradient(135deg, rgba(0,0,0,.04), rgba(0,0,0,.02));} 
.abqd-ctaBtn:hover{filter:brightness(1.06);}  
.abqd-ctaBtn:active{transform:translateY(1px);}  
.abqd-ctaTitle{font-weight:900;font-size:14px;letter-spacing:-.01em;} 
.abqd-ctaSub{margin-top:2px;font-size:12px;color:var(--muted);line-height:1.25;} 
.abqd-ctaIcon{width:38px;height:38px;border-radius:16px;border:1px solid var(--bd);background:var(--chip2);display:flex;align-items:center;justify-content:center;font-size:16px;flex:0 0 auto;} 
.abqd-ctaArrow{margin-left:auto;opacity:.85;font-weight:900;} 

/* Inline placement in the panel (before "Компактно") */
.abqd-ctaBtnInline{padding:10px 12px;border-radius:16px;} 
.abqd-ctaBtnInline .abqd-ctaTitle{font-size:15px;font-weight:900;letter-spacing:-.015em;} 
.abqd-ctaBtnInline .abqd-ctaSub{display:none;} 
.abqd-ctaBtnInline .abqd-ctaIcon{width:34px;height:34px;border-radius:14px;} 

/* Metallic aluminum finish (premium) */
.abqd-metal{
  position:relative;
  background:
    radial-gradient(140% 120% at 20% 0%, rgba(255,255,255,.22), rgba(255,255,255,0) 55%),
    linear-gradient(135deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
}
[data-theme='light'] .abqd-metal{
  background:
    radial-gradient(140% 120% at 20% 0%, rgba(255,255,255,.95), rgba(255,255,255,0) 55%),
    linear-gradient(135deg, rgba(255,255,255,.92), rgba(232,235,240,.78));
}
.abqd-metal::before{
  content:"";
  position:absolute;
  inset:0;
  border-radius:inherit;
  pointer-events:none;
  background:
    linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,0) 40%),
    linear-gradient(90deg, rgba(255,255,255,.10), rgba(255,255,255,0) 35%, rgba(255,255,255,.08) 70%, rgba(255,255,255,0));
  opacity:.85;
}
[data-theme='light'] .abqd-metal::before{ opacity:.70; }
.abqd-metal{
  box-shadow:
    0 18px 45px rgba(0,0,0,.22),
    inset 0 1px 0 rgba(255,255,255,.22),
    inset 0 -1px 0 rgba(0,0,0,.12);
}
[data-theme='light'] .abqd-metal{
  box-shadow:
    0 14px 34px rgba(0,0,0,.12),
    inset 0 1px 0 rgba(255,255,255,.70),
    inset 0 -1px 0 rgba(0,0,0,.10);
}

@media (max-width:520px){
  .abqd-ctaBtnInline{width:100%;}
}
}
`;

// =========================
// UI ATOMS
// =========================
function GlassCard({ children, className }) {
  return (
    <div className={cx("abqd-glass abqd-radius", className)}>
      <div className="abqd-glow" aria-hidden />
      {children}
    </div>
  );
}

function Pill({ children }) {
  return <span className="abqd-pill">{children}</span>;
}

function IconBox({ children }) {
  return <span className="abqd-ibox">{children}</span>;
}

function Button({ children, variant, onClick, small, className, type }) {
  const v = variant || "primary";
  const t = type || "button";
  return (
    <button
      type={t}
      onClick={onClick}
      className={cx(
        "abqd-btn",
        v === "secondary" && "abqd-btn--secondary",
        small && "abqd-btn--sm",
        className
      )}
    >
      {children}
    </button>
  );
}

function Input({ value, onChange, placeholder }) {
  return (
    <div className="abqd-inputWrap">
      <span className="abqd-inputIcon" aria-hidden>
        ⌕
      </span>
      <input
        className="abqd-input"
        value={value}
        onChange={(e) => onChange(e.target.value)}
        placeholder={placeholder}
      />
    </div>
  );
}

function ThemeToggle({ theme, setTheme }) {
  return (
    <div className="abqd-toggle">
      <button
        type="button"
        className={cx("abqd-toggleBtn", theme === "light" && "is-active")}
        onClick={() => setTheme("light")}
      >
        Светлая
      </button>
      <button
        type="button"
        className={cx("abqd-toggleBtn", theme === "dark" && "is-active")}
        onClick={() => setTheme("dark")}
      >
        Тёмная
      </button>
    </div>
  );
}

function Switch({ checked, onChange }) {
  return (
    <button
      type="button"
      className={cx("abqd-switch", checked && "is-on")}
      onClick={() => onChange(!checked)}
      aria-pressed={checked}
    >
      <span className="abqd-switchDot" />
    </button>
  );
}

function ScoreBadge({ score, compact }) {
  const s = scoreLabel(score);
  return (
    <span className={cx("abqd-score", `tone-${s.tone}`, compact && "is-compact")}>
      <span className="abqd-scoreDot" />
      {compact ? score : `${s.text} · ${score}`}
    </span>
  );
}

function LeadCard({ lead, compact, onOpen }) {
  const s = scoreLabel(lead.score);

  return (
    <button
      type="button"
      className="abqd-leadBtn"
      onClick={() => onOpen(lead)}
      title="Открыть карточку"
    >
      <GlassCard className={cx("abqd-lead", compact ? "is-compact" : "")}> 
        <div className="abqd-leadTop">
          <div style={{ minWidth: 0 }}>
            <div className="abqd-leadTitle">
              <span className="abqd-trunc">{lead.name}</span>
              {!compact ? <Pill>{s.text}</Pill> : null}
            </div>
            <div className="abqd-leadSub abqd-trunc">{lead.company}</div>
          </div>
          <ScoreBadge score={lead.score} compact={compact} />
        </div>

        <div className="abqd-leadMeta">
          <span className="abqd-metaChip">
            <IconBox>≈</IconBox>
            <span>{lead.touches7d}</span>
            <span className="abqd-muted">/7д</span>
          </span>
          <span className="abqd-metaChip abqd-trunc">
            <IconBox>↻</IconBox>
            <span className="abqd-trunc">{lead.lastTouch}</span>
          </span>
        </div>

        {!compact ? (
          <div className="abqd-leadNext">
            <div className="abqd-muted">Следующий шаг</div>
            <div className="abqd-leadNextText">{lead.next}</div>
          </div>
        ) : (
          <div className="abqd-leadNextCompact abqd-trunc" title={lead.next}>
            ✦ {lead.next}
          </div>
        )}

        {!compact ? (
          <div className="abqd-tags">
            {lead.tags.map((t) => (
              <span key={t} className="abqd-tag">
                #{t}
              </span>
            ))}
          </div>
        ) : null}
      </GlassCard>
    </button>
  );
}

function Drawer({ lead, onClose, compact }) {
  return (
    <div className="abqd-drawerWrap" role="dialog" aria-modal="true">
      <button className="abqd-drawerBackdrop" onClick={onClose} aria-label="Закрыть" />
      <div className="abqd-drawer">
        <GlassCard className="abqd-drawerCard">
          <div className="abqd-drawerHead">
            <div style={{ minWidth: 0 }}>
              <div className="abqd-h3 abqd-trunc">{lead.name}</div>
              <div className="abqd-muted abqd-trunc">{lead.company}</div>
            </div>
            <Button variant="secondary" onClick={onClose}>
              Закрыть
            </Button>
          </div>

          <div className="abqd-sep" />

          <div className="abqd-drawerBody">
            <div className="abqd-box">
              <div className="abqd-boxTitle">Цель клиента</div>
              <div className="abqd-boxText">{lead.goal}</div>
              <div className="abqd-boxGrid">
                <div className="abqd-mini">
                  <div className="abqd-muted">ID</div>
                  <div className="abqd-strong">{lead.id}</div>
                </div>
                <div className="abqd-mini">
                  <div className="abqd-muted">Касаний 7д</div>
                  <div className="abqd-strong">{lead.touches7d}</div>
                </div>
              </div>
            </div>

            <div className="abqd-box">
              <div className="abqd-boxTitle">AI · Next Best Action</div>
              <div className="abqd-boxText abqd-muted">
                Мок. В проде тут будет: резюме, риск‑факторы, следующий шаг, шаблоны сообщений.
              </div>
              <div className="abqd-aiList">
                {["Скрипт звонка", "WhatsApp‑шаблон", "Контент‑план", "Сегментация"].map((x) => (
                  <div key={x} className="abqd-aiRow">
                    <div className="abqd-trunc">{x}</div>
                    <Button small variant="secondary">
                      Сгенерировать
                    </Button>
                  </div>
                ))}
              </div>
            </div>

            <div className="abqd-box">
              <div className="abqd-boxTitle">Лента касаний</div>
              <div className="abqd-list">
                {["NFC tap → страница", "Telegram → сообщение", "Звонок → попытка"].map((x) => (
                  <div key={x} className="abqd-listRow">
                    {x}
                  </div>
                ))}
              </div>
            </div>

            {!compact ? (
              <div className="abqd-box">
                <div className="abqd-boxTitle">Теги</div>
                <div className="abqd-tags">
                  {lead.tags.map((t) => (
                    <span key={t} className="abqd-tag">
                      #{t}
                    </span>
                  ))}
                </div>
              </div>
            ) : null}
          </div>
        </GlassCard>
      </div>
    </div>
  );
}

// =========================
// MAIN
// =========================
export default function ABQDCrmPrototype() {
  const [theme, setTheme] = useStoredTheme();
  const [query, setQuery] = useState("");
  const [compact, setCompact] = useState(true);
  const [tab, setTab] = useState("board");
  const [drawerOpen, setDrawerOpen] = useState(false);
  const [activeLead, setActiveLead] = useState(null);

  const filtered = useMemo(() => {
    const q = query.trim().toLowerCase();
    if (!q) return demoLeads;
    return demoLeads.filter((l) => createSearchString(l).includes(q));
  }, [query]);

  // byStage: reduce вместо for
  const byStage = useMemo(() => {
    const init = demoStages.reduce((acc, s) => {
      acc[s.key] = [];
      return acc;
    }, {});

    return filtered.reduce((acc, l) => {
      if (acc[l.stage]) acc[l.stage].push(l);
      return acc;
    }, init);
  }, [filtered]);

  const totals = useMemo(() => {
    const total = demoLeads.length;
    const touches = demoLeads.reduce((a, b) => a + (b.touches7d || 0), 0);
    const hot = demoLeads.filter((l) => l.score >= 85).length;
    const warm = demoLeads.filter((l) => l.score >= 70 && l.score < 85).length;
    const cold = total - hot - warm;
    return { total, touches, hot, warm, cold };
  }, []);

  const openLead = useCallback((l) => {
    setActiveLead(l);
    setDrawerOpen(true);
  }, []);

  const closeDrawer = useCallback(() => {
    setDrawerOpen(false);
  }, []);

  const setTabBoard = useCallback(() => setTab("board"), []);
  const setTabTouch = useCallback(() => setTab("touch"), []);
  const setTabAuto = useCallback(() => setTab("auto"), []);
  const setTabArch = useCallback(() => setTab("arch"), []);

  const onCompactChange = useCallback((v) => setCompact(v), []);

  const onOpenConstructor = useCallback(() => {
    // Ведём на страницу app.abqd.ru (конструктор)
    const url = "https://app.abqd.ru/constructor/";
    try {
      window.location.assign(url);
    } catch {
      try {
        window.location.href = url;
      } catch {
        // ignore
      }
    }
  }, []);

  // Контент правой панели, чтобы исключить ошибку "adjacent JSX" в любых конфигурациях
  const rightContent = useMemo(() => {
    if (tab === "board") {
      return (
        <div style={{ marginTop: 12 }}>
          <div className="abqd-kanban">
            {demoStages.map((stage) => (
              <GlassCard key={stage.key} className="abqd-col">
                <div className="abqd-colHead">
                  <div style={{ minWidth: 0 }}>
                    <div className="abqd-colTitle">{stage.title}</div>
                    <div className="abqd-colHint">{stage.hint}</div>
                  </div>
                  <Pill>{(byStage[stage.key] || []).length}</Pill>
                </div>

                <div className="abqd-cardRail">
                  <div className={cx("abqd-cardGrid", compact && "is-compact")}>
                    {(byStage[stage.key] || []).map((lead) => (
                      <LeadCard key={lead.id} lead={lead} compact={compact} onOpen={openLead} />
                    ))}
                  </div>
                </div>

                <Button variant="secondary" className="abqd-btn--full" onClick={() => {}}>
                  + Добавить
                </Button>
              </GlassCard>
            ))}
          </div>
        </div>
      );
    }

    if (tab === "touch") {
      return (
        <div style={{ marginTop: 12, display: "grid", gap: 12 }}>
          <GlassCard className="abqd-box">
            <div className="abqd-boxTitle">NFC‑касания</div>
            <div className="abqd-muted" style={{ fontSize: 12, lineHeight: 1.45 }}>
              Счётчики, источники, страницы, устройства. Основа УТП.
            </div>
            <div className="abqd-list">
              {["NFC tap → прайс", "NFC tap → портфолио", "NFC tap → запись"].map((x) => (
                <div key={x} className="abqd-listRow">
                  {x}
                </div>
              ))}
            </div>
            <div className="abqd-muted" style={{ fontSize: 12, marginTop: 8, lineHeight: 1.45 }}>
              В проде: уникальные посетители, attribution, события в мессенджеры, конверсии по шагам.
            </div>
          </GlassCard>

          <GlassCard className="abqd-box">
            <div className="abqd-boxTitle">Клиенты клиента (B2B2C)</div>
            <div className="abqd-muted" style={{ fontSize: 12, lineHeight: 1.45 }}>
              Лиды/контакты твоих клиентов — их «боевые солдаты».
            </div>
            <div className="abqd-aiList">
              {demoLeads.slice(0, 4).map((l) => (
                <div key={l.id} className="abqd-aiRow">
                  <div style={{ minWidth: 0 }}>
                    <div className="abqd-strong abqd-trunc">{l.company}</div>
                    <div className="abqd-muted abqd-trunc" style={{ fontSize: 12 }}>
                      {l.lastTouch}
                    </div>
                  </div>
                  <Button small variant="secondary" onClick={() => openLead(l)}>
                    Открыть
                  </Button>
                </div>
              ))}
            </div>
          </GlassCard>
        </div>
      );
    }

    if (tab === "auto") {
      return (
        <div style={{ marginTop: 12, display: "grid", gap: 12 }}>
          <GlassCard className="abqd-box">
            <div className="abqd-boxTitle">Telegram/WhatsApp</div>
            <div className="abqd-list">
              {["Новый NFC tap → Telegram", "Нет ответа 24ч → WhatsApp", "Сделка выиграна → опрос"].map((x) => (
                <div key={x} className="abqd-listRow">
                  {x}
                </div>
              ))}
            </div>
          </GlassCard>

          <GlassCard className="abqd-box">
            <div className="abqd-boxTitle">AI‑телефония</div>
            <div className="abqd-muted" style={{ fontSize: 12, lineHeight: 1.45 }}>
              MVP: «умный ассистент подтверждения записи» лучше, чем попытка сразу заменить менеджера.
            </div>
            <div style={{ marginTop: 10 }}>
              <Button variant="secondary">Подключить провайдера</Button>
            </div>
          </GlassCard>

          <GlassCard className="abqd-box">
            <div className="abqd-boxTitle">n8n / Webhooks</div>
            <div className="abqd-list">
              {["Webhook: payment_succeeded", "Event: nfc_touch", "Action: create_task", "Action: send_message"].map(
                (x) => (
                  <div key={x} className="abqd-listRow">
                    {x}
                  </div>
                )
              )}
            </div>
          </GlassCard>
        </div>
      );
    }

    // arch
    return (
      <div style={{ marginTop: 12, display: "grid", gap: 12 }}>
        <GlassCard className="abqd-box">
          <div className="abqd-boxTitle">Модули продукта (roadmap)</div>
          <div className="abqd-muted" style={{ fontSize: 12, lineHeight: 1.45 }}>
            Порядок сборки как у больших систем, но без лишней тяжести.
          </div>
          <div className="abqd-list" style={{ marginTop: 10 }}>
            {[
              "Core CRM: Contacts/Companies/Deals + Timeline событий",
              "Automation: Rules + цепочки касаний + webhooks",
              "AI Layer: Next Action + Summary + агенты по ролям",
              "Analytics: конверсия, time-to-win, прогноз",
            ].map((x) => (
              <div key={x} className="abqd-listRow">
                {x}
              </div>
            ))}
          </div>
        </GlassCard>

        <GlassCard className="abqd-box">
          <div className="abqd-boxTitle">Enterprise‑готовность</div>
          <div className="abqd-list" style={{ marginTop: 10 }}>
            {[
              "Custom objects (как Salesforce Objects)",
              "RBAC + аудит + журнал действий",
              "Мульти‑тенант + лимиты + биллинг",
              "Событийная модель (event log) → отчёты без потерь",
              "Маркетплейс интеграций (модули)",
            ].map((x) => (
              <div key={x} className="abqd-listRow">
                {x}
              </div>
            ))}
          </div>
          <div className="abqd-muted" style={{ fontSize: 12, marginTop: 10, lineHeight: 1.45 }}>
            Принцип: не копировать Salesforce «всё сразу». Сначала Core + события + автоматизация, потом
            AI‑роль‑агенты + отчёты.
          </div>
        </GlassCard>
      </div>
    );
  }, [tab, compact, byStage, openLead]);

  return (
    <div className="abqd-root" data-theme={theme}>
      <style>{css}</style>

      <div className="abqd-wrap">
        <div className="abqd-top">
          <GlassCard className="abqd-bar">
            <div className="abqd-barRow">
              <div className="abqd-brand">
                <img
                  className="abqd-brandLogo"
                  src="https://static.tildacdn.com/tild3532-3636-4132-b064-346663353861/_abqd.png"
                  alt="abqd"
                />
                <div className="abqd-brandMeta">
                  <div className="abqd-h2">CRM (прототип)</div>
                  <div className="abqd-brandSub">Канбан · NFC/касания · автоматизация · AI</div>
                </div>
              </div>

              <Input value={query} onChange={setQuery} placeholder="Поиск по лидам, компании, тегам…" />
              <ThemeToggle theme={theme} setTheme={setTheme} />
              <Button>+ Новый лид</Button>
              <Button variant="secondary">⚙ Настройки</Button>
            </div>
          </GlassCard>

          <GlassCard className="abqd-bar">
            <div className="abqd-barRow">
              <button type="button" className={cx("abqd-ctaBtn","abqd-ctaBtnInline","abqd-metal")} onClick={onOpenConstructor}>
                <span style={{ minWidth: 0 }}>
                  <div className="abqd-ctaTitle">Конструктор визитки</div>
                  <div className="abqd-ctaSub">Профиль · NFC · публикация</div>
                </span>
                <span className="abqd-ctaIcon" aria-hidden>
                  ⌁
                </span>
                <span className="abqd-ctaArrow" aria-hidden>
                  →
                </span>
              </button>

              <span className="abqd-pill">
                <span className="abqd-muted">Компактно</span>
                <span style={{ width: 8 }} />
                <Switch checked={compact} onChange={onCompactChange} />
              </span>

              <span className="abqd-pill">Скор: 55+</span>
              <span className="abqd-pill">Теги: любые</span>
              <span className="abqd-pill">Сорт: скор</span>

              <div style={{ marginLeft: "auto", display: "flex", gap: 10, flexWrap: "wrap" }}>
                <Button variant="secondary">Экспорт</Button>
                <Button variant="secondary">Воронка</Button>
              </div>
            </div>
          </GlassCard>
        </div>

        <div className="abqd-grid">
          {/* LEFT */}
          <div style={{ display: "grid", gap: 14 }}>
            <GlassCard className="abqd-section">
              <div className="abqd-h2">Метрики (MVP)</div>
              <div className="abqd-muted" style={{ marginTop: 4, fontSize: 12 }}>
                Только по делу: лиды, касания, температура.
              </div>
              <div style={{ display: "grid", gap: 10, marginTop: 12 }}>
                <div className="abqd-stat">
                  <div>
                    <div className="abqd-statTitle">Лидов всего</div>
                    <div className="abqd-statSub">Сейчас демо‑данные</div>
                  </div>
                  <div className="abqd-statValue">{totals.total}</div>
                </div>
                <div className="abqd-stat">
                  <div>
                    <div className="abqd-statTitle">Касаний 7д</div>
                    <div className="abqd-statSub">NFC + мессенджеры + звонки</div>
                  </div>
                  <div className="abqd-statValue">{totals.touches}</div>
                </div>
                <div className="abqd-stat">
                  <div className="abqd-statTitle">Горячих</div>
                  <div className="abqd-statValue">{totals.hot}</div>
                </div>
                <div className="abqd-stat">
                  <div className="abqd-statTitle">Тёплых</div>
                  <div className="abqd-statValue">{totals.warm}</div>
                </div>
                <div className="abqd-stat">
                  <div className="abqd-statTitle">Холодных</div>
                  <div className="abqd-statValue">{totals.cold}</div>
                </div>
              </div>
            </GlassCard>

            <GlassCard className="abqd-section">
              <div className="abqd-h2">План касаний</div>
              <div className="abqd-muted" style={{ marginTop: 4, fontSize: 12 }}>
                Дисциплина процесса + автоматизация → рост конверсии.
              </div>
              <div style={{ display: "grid", gap: 10, marginTop: 12 }}>
                {["День 0: приветствие", "День 1: польза", "День 3: кейс", "День 7: оффер"].map((x, i) => (
                  <div key={x} className="abqd-stat" style={{ justifyContent: "space-between" }}>
                    <div style={{ display: "flex", alignItems: "center", gap: 10, minWidth: 0 }}>
                      <span className="abqd-ibox">{i + 1}</span>
                      <span className="abqd-trunc" style={{ fontWeight: 800, fontSize: 13 }}>
                        {x}
                      </span>
                    </div>
                    <Button small variant="secondary">
                      Авто
                    </Button>
                  </div>
                ))}
                <div className="abqd-box" style={{ marginBottom: 0 }}>
                  <div className="abqd-muted" style={{ fontSize: 12, lineHeight: 1.45 }}>
                    В проде: правила (если не ответил → следующий канал), лимиты, согласия, логирование,
                    отчёт по эффективности.
                  </div>
                </div>
              </div>
            </GlassCard>

            <GlassCard className="abqd-section">
              <div className="abqd-h2">AI‑агенты</div>
              <div className="abqd-muted" style={{ marginTop: 4, fontSize: 12 }}>
                Роль + доступы + ответственность + метрика. Никакой «магии».
              </div>
              <div style={{ display: "grid", gap: 10, marginTop: 12 }}>
                {["Sales‑Coach", "Ops‑Analyst", "Marketing‑Planner", "Quality‑Control"].map((x) => (
                  <div key={x} className="abqd-stat">
                    <div style={{ display: "flex", alignItems: "center", gap: 10, minWidth: 0 }}>
                      <span className="abqd-ibox">AI</span>
                      <span className="abqd-trunc" style={{ fontWeight: 900, fontSize: 13 }}>
                        {x}
                      </span>
                    </div>
                    <Pill>demo</Pill>
                  </div>
                ))}
              </div>
            </GlassCard>
          </div>

          {/* RIGHT */}
          <div style={{ display: "grid", gap: 14 }}>
            <GlassCard className="abqd-section">
              <div
                style={{
                  display: "flex",
                  alignItems: "baseline",
                  justifyContent: "space-between",
                  gap: 10,
                  flexWrap: "wrap",
                }}
              >
                <div>
                  <div className="abqd-h2">Рабочие карточки</div>
                  <div className="abqd-muted" style={{ marginTop: 4, fontSize: 12 }}>
                    Канбан (процесс) + касания + интеграции. Без лишних модулей.
                  </div>
                </div>

                <div className="abqd-tabs">
                  <button className={cx("abqd-tab", tab === "board" && "is-active")} onClick={setTabBoard}>
                    Канбан
                  </button>
                  <button className={cx("abqd-tab", tab === "touch" && "is-active")} onClick={setTabTouch}>
                    NFC/Касания
                  </button>
                  <button className={cx("abqd-tab", tab === "auto" && "is-active")} onClick={setTabAuto}>
                    Автоматизация
                  </button>
                  <button className={cx("abqd-tab", tab === "arch" && "is-active")} onClick={setTabArch}>
                    Архитектура
                  </button>
                </div>
              </div>

              {rightContent}
            </GlassCard>

            <div className="abqd-foot">
              Прототип интерфейса. Без бэкенда. Дальше подключим API, роли, биллинг и события NFC/мессенджеров.
            </div>
          </div>
        </div>

        {drawerOpen && activeLead ? <Drawer lead={activeLead} onClose={closeDrawer} compact={compact} /> : null}
      </div>
    </div>
  );
}
