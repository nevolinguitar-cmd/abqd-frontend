<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ABQD — Календарь</title>
  <style>
    html, body { height: 100%; margin: 0; }
    body { background: #0b0f1a; overflow: hidden; }
    .wrap { height: 100%; position: relative; }
    iframe { width: 100%; height: 100%; border: 0; display: block; }
    .loader {
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      background: #0b0f1a;
      color: rgba(255,255,255,.85);
      font: 600 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      letter-spacing:.2px;
      transition: opacity .25s ease;
      pointer-events:none;
    }
    .loader.hide { opacity: 0; }
    .dot { width:7px; height:7px; border-radius:999px; background: rgba(255,255,255,.5); margin:0 4px; animation: pulse 1s infinite ease-in-out; }
    .dot:nth-child(2){ animation-delay:.15s }
    .dot:nth-child(3){ animation-delay:.3s }
    @keyframes pulse { 0%,100%{ transform:scale(.85); opacity:.35 } 50%{ transform:scale(1.15); opacity:.9 } }
  </style>
</head>
<body>
  <div class="wrap">
    <iframe id="crm" src="/dashboard/" title="ABQD CRM" loading="eager"></iframe>
    <div id="loader" class="loader">
      <div style="display:flex;align-items:center;gap:10px">
        <span>Открываю календарь</span>
        <span style="display:flex">
          <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        </span>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const frame = document.getElementById('crm');
      const loader = document.getElementById('loader');

      function hideLoaderSoon(){
        loader.classList.add('hide');
        setTimeout(()=>{ loader.style.display='none'; }, 350);
      }

      function trySwitchToCalendar(){
        let doc;
        try { doc = frame.contentDocument || frame.contentWindow.document; } catch(e){ return false; }
        if (!doc) return false;

        // Ищем кнопку, у которой текст ровно "Календарь"
        const btn = Array.from(doc.querySelectorAll('button')).find(b => (b.textContent || '').trim() === 'Календарь');
        if (btn) { btn.click(); return true; }

        return false;
      }

      function poll(){
        const startedAt = Date.now();
        const t = setInterval(() => {
          // Если CRM не прогрузилась/редирект на логин — кнопку не найдём, но хотя бы не висим вечно
          const ok = trySwitchToCalendar();
          if (ok){
            clearInterval(t);
            // даём UI чуть перерисоваться и прячем лоадер
            setTimeout(hideLoaderSoon, 250);
          } else if (Date.now() - startedAt > 9000){
            clearInterval(t);
            hideLoaderSoon();
          }
        }, 200);
      }

      frame.addEventListener('load', poll);
      // если load уже случился раньше (редко), подстрахуемся:
      setTimeout(poll, 800);
    })();
  </script>
</body>
</html>
