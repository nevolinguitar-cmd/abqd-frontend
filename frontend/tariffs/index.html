(() => {
  const API = "https://api.abqd.ru/api/v1";
  const CABINET_ORIGIN = "https://app.abqd.ru"; // фиксируем один домен для localStorage
  const TOKEN_KEY = "abqd_token";

  const mapPlan = (p) => {
    p = (p || "").toLowerCase();
    if (p === "starter") return "probn";
    if (["probn", "pro", "full", "trial"].includes(p)) return p;
    return p;
  };

  const token = () => localStorage.getItem(TOKEN_KEY) || "";
  const authed = () => !!token();
  const qs = () => new URLSearchParams(location.search);

  // login/register → вернуться обратно на tariffs с автозапуском нужного плана
  const goAuth = (plan, mode = "register") => {
    const next = `${CABINET_ORIGIN}/tariffs/?plan=${encodeURIComponent(plan)}&autostart=1`;
    location.href = `${CABINET_ORIGIN}/auth/?mode=${encodeURIComponent(mode)}&next=${encodeURIComponent(next)}`;
  };

  async function createPayment(plan) {
    // ВАЖНО: максимально надёжно возвращать на /tariffs/ после оплаты
    // (там уже можем показать "оплачено" / вести дальше)
    const return_url = `${CABINET_ORIGIN}/tariffs/?plan=${encodeURIComponent(plan)}&paid=1`;

    const headers = { "Content-Type": "application/json" };
    const t = token();
    if (t) headers["Authorization"] = `Bearer ${t}`; // если токен есть — прикладываем

    const res = await fetch(`${API}/payments/create`, {
      method: "POST",
      headers,
      body: JSON.stringify({ plan, return_url }),
    });

    const text = await res.text();
    let j;
    try {
      j = JSON.parse(text);
    } catch {
      throw new Error(text.slice(0, 200));
    }
    if (!res.ok) throw new Error(j.detail || `HTTP ${res.status}`);
    return j;
  }

  async function activateTrial() {
    const t = token();
    if (!t) throw new Error("Нет токена");

    const res = await fetch(`${API}/trial/activate`, {
      method: "POST",
      headers: { Authorization: `Bearer ${t}`, "Content-Type": "application/json" },
      body: "{}",
    });

    const text = await res.text();
    let j;
    try {
      j = JSON.parse(text);
    } catch {
      j = { detail: text.slice(0, 200) };
    }
    if (!res.ok) throw new Error(j.detail || `HTTP ${res.status}`);
    return j;
  }

  async function pay(plan) {
    plan = mapPlan(plan);

    // ===== TRIAL =====
    if (plan === "trial") {
      if (!authed()) return goAuth("trial", "register");

      const btn = document.activeElement;
      if (btn && btn.tagName === "BUTTON") {
        btn.disabled = true;
        btn.dataset._txt = btn.textContent;
        btn.textContent = "Открываем конструктор…";
      }

      // Пытаемся активировать, но НЕ блокируем переход в конструктор
      try {
        await activateTrial();
      } catch (e) {
        console.warn("Trial activate failed, continue to constructor:", e);
      }

      location.href = `${CABINET_ORIGIN}/constructor/`;
      return;
    }

    // ===== PAID =====
    try {
      const btn = document.activeElement;
      if (btn && btn.tagName === "BUTTON") {
        btn.disabled = true;
        btn.dataset._txt = btn.textContent;
        btn.textContent = "Переходим к оплате…";
      }

      const j = await createPayment(plan);
      if (!j.confirmation_url) throw new Error("Нет confirmation_url от ЮKassa");
      location.href = j.confirmation_url;
    } catch (e) {
      alert("Ошибка оплаты: " + (e?.message || e));
      const btn = document.activeElement;
      if (btn && btn.tagName === "BUTTON" && btn.dataset._txt) {
        btn.disabled = false;
        btn.textContent = btn.dataset._txt;
      }
    }
  }

  // ===== Авто-старт после логина/регистрации =====
  // /tariffs/?plan=trial&autostart=1
  try {
    const p = mapPlan(qs().get("plan"));
    const autostart = qs().get("autostart") === "1";
    if (autostart && p && authed()) {
      const u = new URL(location.href);
      u.searchParams.delete("autostart");
      history.replaceState(null, "", u.toString());
      pay(p);
    }
  } catch (e) {}

  // ===== Кнопки =====
  const btnTrial = document.getElementById("btnStartTrial");
  if (btnTrial) btnTrial.addEventListener("click", () => pay("trial"));

  document.querySelectorAll(".btnChoosePlan").forEach((b) => {
    b.addEventListener("click", () => pay(b.dataset.plan));
  });
})();
