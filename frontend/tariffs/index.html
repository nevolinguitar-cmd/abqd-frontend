(() => {
  const API = "https://api.abqd.ru/api/v1";
  const TOKEN_KEY = "abqd_token";

  const mapPlan = (p) => {
    p = (p || "").toLowerCase();
    if (p === "starter") return "probn";
    if (["probn", "pro", "full", "trial"].includes(p)) return p;
    return p;
  };

  const token = () => localStorage.getItem(TOKEN_KEY) || "";
  const authed = () => !!token();
  const qs = () => new URLSearchParams(location.search);

  const goRegisterForPlan = (plan) => {
    // Возвращаемся обратно на tariffs и автозапускаем нужный план
    const next = `/tariffs/?plan=${encodeURIComponent(plan)}&autostart=1`;
    location.href = `/auth/?mode=register&next=${encodeURIComponent(next)}`;
  };

  async function parseJsonSafe(res) {
    const text = await res.text();
    if (!text) return null;
    try { return JSON.parse(text); } catch { return { raw: text }; }
  }

  async function createPayment(plan) {
    // после успешной оплаты возвращаем прямо в CRM-модуль
    const return_url = `/dashboard/crm?paid=1&plan=${encodeURIComponent(plan)}`;

    const headers = { "Content-Type": "application/json" };
    const t = token();
    if (t) headers["Authorization"] = `Bearer ${t}`;

    const res = await fetch(`${API}/payments/create`, {
      method: "POST",
      headers,
      body: JSON.stringify({ plan, return_url }),
    });

    const data = await parseJsonSafe(res);
    if (!res.ok) {
      const err = new Error(data?.detail || `HTTP ${res.status}`);
      err.status = res.status;
      err.data = data;
      throw err;
    }
    return data;
  }

  async function activateTrial() {
    const t = token();
    if (!t) {
      const err = new Error("Нет токена");
      err.status = 401;
      throw err;
    }

    const res = await fetch(`${API}/trial/activate`, {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${t}`,
        "Content-Type": "application/json",
      },
      body: "{}",
    });

    const data = await parseJsonSafe(res);
    if (!res.ok) {
      const err = new Error(data?.detail || `HTTP ${res.status}`);
      err.status = res.status;
      err.data = data;
      throw err;
    }
    return data;
  }

  function lockBtn(btn, txt) {
    if (!btn || btn.tagName !== "BUTTON") return;
    btn.disabled = true;
    btn.dataset._txt = btn.textContent;
    btn.textContent = txt;
  }

  function unlockBtn(btn) {
    if (!btn || btn.tagName !== "BUTTON") return;
    if (btn.dataset._txt) btn.textContent = btn.dataset._txt;
    btn.disabled = false;
  }

  async function pay(plan) {
    plan = mapPlan(plan);

    // --- TRIAL ---
    if (plan === "trial") {
      if (!authed()) {
        return goRegisterForPlan("trial");
      }

      const btn = document.activeElement;
      try {
        lockBtn(btn, "Активируем Trial…");
        await activateTrial();
      } catch (e) {
        // Важно: если trial уже активирован — всё равно пускаем в конструктор
        const msg = String(e?.message || "");
        const st = Number(e?.status || 0);
        const looksLikeAlready =
          st === 409 || st === 400 ||
          /already|уже|актив|trial/i.test(msg);

        if (!looksLikeAlready) {
          alert("Ошибка Trial: " + msg);
          unlockBtn(btn);
          return;
        }
      }

      // Всегда уходим в конструктор
      location.href = "/constructor/";
      return;
    }

    // --- PAID ---
    const btn = document.activeElement;
    try {
      lockBtn(btn, "Переходим к оплате…");
      const j = await createPayment(plan);
      if (!j?.confirmation_url) throw new Error("Нет confirmation_url от ЮKassa");
      location.href = j.confirmation_url;
    } catch (e) {
      alert("Ошибка оплаты: " + (e?.message || e));
      unlockBtn(btn);
    }
  }

  // Авто-старт Trial после регистрации/логина: /tariffs/?plan=trial&autostart=1
  try {
    const p = mapPlan(qs().get("plan"));
    const autostart = qs().get("autostart") === "1";
    if (autostart && p === "trial" && authed()) {
      const u = new URL(location.href);
      u.searchParams.delete("autostart");
      history.replaceState(null, "", u.toString());
      pay("trial");
    }
  } catch (_) {}

  const btnTrial = document.getElementById("btnStartTrial");
  if (btnTrial) btnTrial.addEventListener("click", () => pay("trial"));

  document.querySelectorAll(".btnChoosePlan").forEach((b) => {
    b.addEventListener("click", () => pay(b.dataset.plan));
  });
})();
