(() => {
  const API = "https://api.abqd.ru/api/v1";
  const CABINET_ORIGIN = "https://app.abqd.ru";
  const TOKEN_KEY = "abqd_token";

  const mapPlan = (p) => {
    p = (p || "").toLowerCase();
    if (p === "starter") return "probn";
    if (["probn", "pro", "full", "trial"].includes(p)) return p;
    return p;
  };

  const token = () => localStorage.getItem(TOKEN_KEY) || "";
  const authed = () => !!token();
  const qs = () => new URLSearchParams(location.search);

  const goAuth = (nextUrl, mode = "login") => {
    location.href = `${CABINET_ORIGIN}/auth/?mode=${encodeURIComponent(mode)}&next=${encodeURIComponent(nextUrl)}`;
  };

  function setBtnBusy(btn, txt) {
    if (!btn || btn.tagName !== "BUTTON") return;
    btn.disabled = true;
    btn.dataset._txt = btn.textContent;
    btn.textContent = txt;
  }

  function setBtnRestore(btn) {
    if (!btn || btn.tagName !== "BUTTON") return;
    if (btn.dataset._txt) btn.textContent = btn.dataset._txt;
    btn.disabled = false;
  }

  async function createPayment(plan) {
    const return_url = `${CABINET_ORIGIN}/tariffs/?paid=1&plan=${encodeURIComponent(plan)}`;

    const headers = { "Content-Type": "application/json" };
    const t = token();
    if (t) headers["Authorization"] = `Bearer ${t}`;

    const res = await fetch(`${API}/payments/create`, {
      method: "POST",
      headers,
      body: JSON.stringify({ plan, return_url }),
    });

    const text = await res.text();
    let j;
    try { j = JSON.parse(text); } catch { j = { detail: text.slice(0, 200) }; }

    if (!res.ok) {
      const err = new Error(j.detail || `HTTP ${res.status}`);
      err.status = res.status;
      err.data = j;
      throw err;
    }
    return j;
  }

  function afterPaidRedirect(plan) {
    const nextCrm = `${CABINET_ORIGIN}/dashboard/crm?paid=1&plan=${encodeURIComponent(plan)}`;
    if (authed()) location.replace(nextCrm);
    else goAuth(nextCrm, "login");
  }

  async function pay(plan) {
    plan = mapPlan(plan);
    const btn = document.activeElement;

    // TRIAL -> constructor (no activation)
    if (plan === "trial") {
      location.href = `${CABINET_ORIGIN}/constructor/`;
      return;
    }

    // PAID -> YooKassa
    try {
      setBtnBusy(btn, "Переходим к оплате…");
      const j = await createPayment(plan);
      if (!j.confirmation_url) throw new Error("Нет confirmation_url от ЮKassa");
      location.href = j.confirmation_url;
    } catch (e) {
      // if backend requires auth, bounce to register and then autostart payment
      if (e && (e.status === 401 || e.status === 403)) {
        const back = `${CABINET_ORIGIN}/tariffs/?plan=${encodeURIComponent(plan)}&autostart=1`;
        return goAuth(back, "register");
      }
      alert("Ошибка оплаты: " + (e?.message || e));
      setBtnRestore(btn);
    }
  }

  // After payment: /tariffs/?paid=1&plan=...
  try {
    const paid = qs().get("paid") === "1";
    const plan = mapPlan(qs().get("plan"));
    if (paid && plan && plan !== "trial") {
      afterPaidRedirect(plan);
      return;
    }
  } catch (e) {}

  // Autostart after auth: /tariffs/?plan=pro&autostart=1 etc.
  try {
    const p = mapPlan(qs().get("plan"));
    const autostart = qs().get("autostart") === "1";
    if (autostart && p) {
      const u = new URL(location.href);
      u.searchParams.delete("autostart");
      history.replaceState(null, "", u.toString());
      pay(p);
    }
  } catch (e) {}

  const btnTrial = document.getElementById("btnStartTrial");
  if (btnTrial) btnTrial.addEventListener("click", () => pay("trial"));

  document.querySelectorAll(".btnChoosePlan").forEach((b) => {
    b.addEventListener("click", () => pay(b.dataset.plan));
  });
})();
