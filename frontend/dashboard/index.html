import React, { useCallback, useEffect, useMemo, useRef, useState } from "react";

/**
 * ABQD CRM ‚Äî Full-Screen Kanban Prototype (single-file React)
 *
 * –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ –≤ —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏:
 * ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ ReferenceError: theme is not defined ‚Äî useStoredTheme() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ App() –î–û –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è theme.
 * ‚úÖ ¬´–ü–∞–Ω–µ–ª—å¬ª –∏–∑ –ø—Ä–∞–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏ (–°—Ç–∞—Ç—É—Å/–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å + –∫–∞—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö) –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ –≤–µ—Ä—Ö–Ω—é—é —à–∞–ø–∫—É (Header).
 * ‚úÖ –í –ø—Ä–∞–≤–æ–π –∫–æ–ª–æ–Ω–∫–µ –±–æ–ª—å—à–µ –Ω–µ—Ç –±–ª–æ–∫–∞ ¬´–¢–∞—Ä–∏—Ñ¬ª ‚Äî –ø–ª–∞–Ω/—Ä–æ–ª—å –æ—Å—Ç–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —à–∞–ø–∫–µ.
 * ‚úÖ –î—Ä–∞—Ñ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å–¥–µ–ª–∫–∏ –ø–æ–¥–Ω—è—Ç –Ω–∞ —É—Ä–æ–≤–µ–Ω—å App ‚Äî —à–∞–ø–∫–∞ –∏ Drawer —Ä–∞–±–æ—Ç–∞—é—Ç —Å –æ–¥–Ω–∏–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º.
 * ‚úÖ Gate-–ø—Ä–æ–≤–µ—Ä–∫–∞ —ç—Ç–∞–ø–æ–≤ —É—á–∏—Ç—ã–≤–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π draft (—Ç–æ, —á—Ç–æ –≤–≤–µ–¥–µ–Ω–æ), –∞ –Ω–µ —Å—Ç–∞—Ä–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.
 * ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã —Ç–µ—Å—Ç-–∫–µ–π—Å—ã.
 */

// -------------------------
// API CONFIG (optional)
// -------------------------
const apiKey = ""; // API Key injected by environment

async function callGemini(prompt, jsonMode = false) {
  try {
    if (!apiKey) {
      return jsonMode ? "{}" : "–î–µ–º–æ-—Ä–µ–∂–∏–º: API –∫–ª—é—á –Ω–µ –∑–∞–¥–∞–Ω.";
    }

    const body = {
      contents: [{ parts: [{ text: prompt }] }],
      generationConfig: jsonMode ? { responseMimeType: "application/json" } : undefined,
    };

    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      }
    );

    if (!response.ok) {
      throw new Error(`AI API error: ${response.status}`);
    }

    const data = await response.json();
    return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
  } catch (e) {
    console.error(e);
    return jsonMode ? "{}" : "AI –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.";
  }
}

// -------------------------
// DATA
// -------------------------
const demoStages = [
  { key: "inbox", title: "–í—Ö–æ–¥—è—â–∏–µ", hint: "–ù–æ–≤—ã–µ –∫–∞—Å–∞–Ω–∏—è –∏ –ª–∏–¥—ã", gates: [] },
  { key: "qual", title: "–ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è", hint: "–ü–æ–Ω–∏–º–∞–µ–º —Ü–µ–ª—å/–∫–æ–Ω—Ç–µ–∫—Å—Ç", gates: ["budget", "deadline"] },
  { key: "proposal", title: "–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ", hint: "–ö–ü / —É—Å–ª–æ–≤–∏—è", gates: ["decisionMaker", "email"] },
  { key: "contract", title: "–î–æ–≥–æ–≤–æ—Ä", hint: "–Æ—Ä. –¥–∞–Ω–Ω—ã–µ –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ", gates: ["inn", "legalName"] },
  { key: "won", title: "–í—ã–∏–≥—Ä–∞–Ω–æ", hint: "–°–¥–µ–ª–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞", gates: [] },
  { key: "lost", title: "–ü–æ—Ç–µ—Ä—è–Ω–æ", hint: "–ü—Ä–∏—á–∏–Ω–∞ –∏ —Ä–µ—Ç–µ–Ω—à–Ω", gates: ["lostReason"] },
];

const stageTitleByKey = Object.fromEntries(demoStages.map((s) => [s.key, s.title]));

const roleDefs = {
  hunter: { title: "Hunter", subtitle: "–ù–æ–≤—ã–µ –ª–∏–¥—ã ¬∑ –¥–æ–∑–≤–æ–Ω ¬∑ –ö–ü", icon: "üéØ" },
  farmer: { title: "Farmer", subtitle: "–£–¥–µ—Ä–∂–∞–Ω–∏–µ ¬∑ LTV ¬∑ –ø—Ä–æ–¥–ª–µ–Ω–∏—è", icon: "üåø" },
};

const planRanks = { free: 0, starter: 1, pro: 2, business: 3 };
const planTitles = { free: "Free", starter: "Start", pro: "Pro", business: "Business" };

const pluginCatalog = [
  {
    id: "ai_agent",
    title: "AI –∞–≥–µ–Ω—Ç",
    icon: "ü§ñ",
    minPlan: "pro",
    desc: "Next Action, —Ä–µ–∑—é–º–µ –∑–≤–æ–Ω–∫–æ–≤/—á–∞—Ç–æ–≤, –∞–≤—Ç–æ–∑–∞–¥–∞—á–∏.",
  },
  {
    id: "calendar",
    title: "–ö–∞–ª–µ–Ω–¥–∞—Ä—å",
    icon: "üóìÔ∏è",
    minPlan: "starter",
    desc: "–°–ª–æ—Ç—ã, –≤—Å—Ç—Ä–µ—á–∏, –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –ø–æ–∑–∂–µ).",
  },
  {
    id: "constructor",
    title: "–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä",
    icon: "‚åÅ",
    minPlan: "free",
    desc: "–ë—ã—Å—Ç—Ä—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –≤ –≤–∏–∑–∏—Ç–∫—É/–ø—Ä–æ—Ñ–∏–ª—å (NFC).",
  },
  {
    id: "analytics",
    title: "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞",
    icon: "üìà",
    minPlan: "pro",
    desc: "–ö–æ–Ω–≤–µ—Ä—Å–∏—è, —Å–∫–æ—Ä–æ—Å—Ç—å –≤–æ—Ä–æ–Ω–∫–∏, –ø—Ä–∏—á–∏–Ω—ã –ø–æ—Ç–µ—Ä—å.",
  },
  {
    id: "automation",
    title: "–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏",
    icon: "‚ö°",
    minPlan: "business",
    desc: "–¢—Ä–∏–≥–≥–µ—Ä—ã: —ç—Ç–∞–ø ‚Üí –¥–µ–π—Å—Ç–≤–∏–µ, —Ç–∞–π–º–µ—Ä—ã, –≤–µ–±—Ö—É–∫–∏.",
  },
];

const demoDealsSeed = [
  {
    id: "D-1001",
    company: "SOVA Studio",
    contact: "–ê–Ω–∞—Å—Ç–∞—Å–∏—è ¬∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä",
    stage: "inbox",
    amount: 180000,
    currency: "RUB",
    score: 78,
    phone: "+7 900 111-22-33",
    email: "hello@sova.studio",
    fields: {
      budget: "",
      deadline: "",
      decisionMaker: "",
      inn: "",
      legalName: "",
      lostReason: "",
      note: "–ò–Ω—Ç–µ—Ä–µ—Å: NFC-–∑–Ω–∞—á–æ–∫ + CRM. –ë—é–¥–∂–µ—Ç –æ–∫–æ–ª–æ 200–∫, –Ω—É–∂–Ω–æ –¥–æ –∫–æ–Ω—Ü–∞ —Ñ–µ–≤—Ä–∞–ª—è.",
    },
    tags: ["nfc", "crm", "warm"],
    plugins: ["constructor"],
    nextTaskAt: "2026-01-27",
    tasks: [
      { id: "T-1", title: "–ü–µ—Ä–≤—ã–π –∑–≤–æ–Ω–æ–∫", due: "2026-01-26", done: false },
      { id: "T-2", title: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–µ–π—Å", due: "2026-01-27", done: false },
    ],
    timeline: [
      { id: "A-1", type: "nfc", at: "2026-01-25T11:10:00.000Z", text: "NFC tap ‚Üí –º–µ–Ω—é —É—Å–ª—É–≥" },
      { id: "A-2", type: "note", at: "2026-01-25T12:40:00.000Z", text: "–ü–æ–ø—Ä–æ—Å–∏–ª–∞ –ø—Ä–∏–º–µ—Ä—ã –≤–æ—Ä–æ–Ω–æ–∫" },
    ],
  },
  {
    id: "D-1002",
    company: "Nord Realty",
    contact: "–û–ª—å–≥–∞ ¬∑ —Ä–∏–µ–ª—Ç–æ—Ä",
    stage: "qual",
    amount: 95000,
    currency: "RUB",
    score: 71,
    phone: "+7 999 222-33-44",
    email: "",
    fields: {
      budget: "95 000",
      deadline: "2026-02-01",
      decisionMaker: "",
      inn: "",
      legalName: "",
      lostReason: "",
      note: "–ù—É–∂–Ω–∞ –±—ã—Å—Ç—Ä–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ + –∫–∞–ª–µ–Ω–¥–∞—Ä—å –≤—Å—Ç—Ä–µ—á.",
    },
    tags: ["realty", "qual"],
    plugins: ["calendar"],
    nextTaskAt: "2026-01-26",
    tasks: [{ id: "T-3", title: "–ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è: –õ–ü–† + email", due: "2026-01-26", done: false }],
    timeline: [
      { id: "A-3", type: "call", at: "2026-01-25T16:05:00.000Z", text: "–ó–≤–æ–Ω–æ–∫ ‚Äî –ø—Ä–æ–ø—É—â–µ–Ω" },
      { id: "A-4", type: "msg", at: "2026-01-25T16:06:00.000Z", text: "WhatsApp ‚Üí —Å–æ–æ–±—â–µ–Ω–∏–µ" },
    ],
  },
  {
    id: "D-1003",
    company: "ABQD Partners",
    contact: "–ú–∞–∫—Å–∏–º ¬∑ –∑–∞–∫—É–ø–∫–∏",
    stage: "proposal",
    amount: 240000,
    currency: "RUB",
    score: 86,
    phone: "+7 901 333-44-55",
    email: "team@abqd.partners",
    fields: {
      budget: "240 000",
      deadline: "2026-02-10",
      decisionMaker: "–ú–∞–∫—Å–∏–º",
      inn: "",
      legalName: "",
      lostReason: "",
      note: "–ñ–¥—É—Ç –ö–ü: –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ –º–µ—Ç–∫–∞–º/–∑–Ω–∞—á–∫–∞–º + –ø–∞–∫–µ—Ç CRM.",
    },
    tags: ["hot", "proposal"],
    plugins: ["ai_agent", "analytics"],
    nextTaskAt: "2026-01-28",
    tasks: [{ id: "T-4", title: "–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ö–ü", due: "2026-01-28", done: false }],
    timeline: [
      { id: "A-5", type: "msg", at: "2026-01-24T10:10:00.000Z", text: "Telegram ‚Äî –æ—Ç–≤–µ—Ç" },
      { id: "A-6", type: "email", at: "2026-01-24T12:30:00.000Z", text: "Email ‚Üí —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ö–ü" },
    ],
  },
];

// -------------------------
// HELPERS
// -------------------------
function cx() {
  return Array.prototype.slice.call(arguments).filter(Boolean).join(" ");
}

function deepCopy(obj) {
  return JSON.parse(JSON.stringify(obj));
}

function planTitle(key) {
  return planTitles[key] || "Free";
}

function isPluginUnlockedForPlan(plugin, planKey) {
  const min = plugin?.minPlan || "free";
  return (planRanks[planKey] ?? 0) >= (planRanks[min] ?? 0);
}

function pluginMinPlanText(plugin) {
  const min = plugin?.minPlan || "free";
  return `${planTitle(min)}+`;
}

function pluginHoverTitle(plugin) {
  if (!plugin) return "";
  return `${plugin.title} ‚Äî ${plugin.desc} ‚Ä¢ –î–æ—Å—Ç—É–ø: ${pluginMinPlanText(plugin)}`;
}

function createSearchString(deal) {
  const base = [
    deal.company,
    deal.contact,
    deal.id,
    deal.stage,
    deal.email,
    deal.phone,
    (deal.tags || []).join(" "),
    JSON.stringify(deal.fields || {}),
  ]
    .filter(Boolean)
    .join(" ");
  return base.toLowerCase();
}

function formatMoney(amount, currency) {
  try {
    const a = Number(amount || 0);
    return new Intl.NumberFormat("ru-RU", {
      style: "currency",
      currency: currency || "RUB",
      maximumFractionDigits: 0,
    }).format(a);
  } catch {
    return `${amount || 0} ${currency || "RUB"}`;
  }
}

function dueTone(dateStr) {
  if (!dateStr) return "none";
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const parts = String(dateStr).split("-");
  if (parts.length !== 3) return "none";
  const [y, m, d] = parts.map(Number);
  if (!y || !m || !d) return "none";
  const target = new Date(y, m - 1, d);
  if (Number.isNaN(target.getTime())) return "none";
  if (target.getTime() < today.getTime()) return "bad";
  if (target.getTime() === today.getTime()) return "warn";
  return "good";
}

function scoreLabel(score) {
  const s = Number(score || 0);
  if (s >= 85) return { text: "–ì–æ—Ä—è—á–∏–π", tone: "hot" };
  if (s >= 70) return { text: "–¢—ë–ø–ª—ã–π", tone: "warm" };
  if (s >= 55) return { text: "–•–æ–ª–æ–¥–Ω—ã–π", tone: "cold" };
  return { text: "–°–ª–∞–±—ã–π", tone: "weak" };
}

function requiredMissingForStage(deal, toStageKey) {
  const stage = demoStages.find((s) => s.key === toStageKey);
  if (!stage) return [];
  const gates = stage.gates || [];
  const f = deal?.fields || {};
  return gates.filter((k) => !String(f?.[k] ?? "").trim());
}

function pickPatchFromDraft(draft) {
  return {
    email: draft.email,
    phone: draft.phone,
    amount: draft.amount,
    score: draft.score,
    nextTaskAt: draft.nextTaskAt,
    fields: draft.fields,
    tags: draft.tags,
  };
}

// Mock API (deterministic; no random failures)
const mockApi = {
  saveDealPatch: async (dealId, patch) => {
    await new Promise((r) => setTimeout(r, 180));
    return { ok: true, dealId, patch };
  },
  moveStage: async (dealId, toStage, missing) => {
    await new Promise((r) => setTimeout(r, 140));
    if (missing && missing.length) return { ok: false, code: "GATES", missing };
    return { ok: true, dealId, toStage };
  },
};

// -------------------------
// HOOKS
// -------------------------
function useStoredTheme() {
  const [theme, setTheme] = useState("light");

  useEffect(() => {
    try {
      const saved = window.localStorage.getItem("abqd_crm_theme");
      if (saved === "dark" || saved === "light") {
        setTheme(saved);
        return;
      }
      const prefersDark =
        typeof window !== "undefined" &&
        !!window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;
      setTheme(prefersDark ? "dark" : "light");
    } catch {
      // ignore
    }
  }, []);

  const set = (t) => {
    setTheme(t);
    try {
      window.localStorage.setItem("abqd_crm_theme", t);
    } catch {
      // ignore
    }
  };

  return [theme, set];
}

function useToasts() {
  const [toasts, setToasts] = useState([]);
  const timersRef = useRef([]);

  useEffect(() => {
    return () => {
      timersRef.current.forEach((id) => clearTimeout(id));
      timersRef.current = [];
    };
  }, []);

  const push = useCallback((tone, title, text) => {
    const id = `toast_${Math.random().toString(16).slice(2)}`;
    const t = { id, tone, title, text };
    setToasts((prev) => [t, ...prev].slice(0, 6));
    const timer = setTimeout(() => {
      setToasts((prev) => prev.filter((x) => x.id !== id));
    }, 3400);
    timersRef.current.push(timer);
  }, []);

  return { toasts, push };
}

// -------------------------
// STYLES
// -------------------------
const css = `
@import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap');

:root{
  --radius: 16px;
  --header-h: 74px;
  --brand: #6366f1;
  --brand2: #8b5cf6;
  --ok: rgba(16,185,129,.14);
  --warn: rgba(245,158,11,.14);
  --bad: rgba(244,63,94,.14);
}

[data-theme='dark']{
  --bg:#0f0f14;
  --panel: rgba(22, 22, 30, 0.65);
  --panel2: rgba(22, 22, 30, 0.82);
  --fg:#f5f5f6;
  --muted: rgba(245,245,246,.65);
  --muted2: rgba(245,245,246,.48);
  --bd: rgba(245,245,246,.14);
  --bd2: rgba(245,245,246,.10);
  --shadow: rgba(0,0,0,.38);
}

[data-theme='light']{
  --bg:#f6f3ff;
  --panel: rgba(255,255,255,0.7);
  --panel2: rgba(255,255,255,0.88);
  --fg:#111827;
  --muted: rgba(17,24,39,.62);
  --muted2: rgba(17,24,39,.42);
  --bd: rgba(139,92,246,.16);
  --bd2: rgba(139,92,246,.10);
  --shadow: rgba(124,58,237,.12);
}

*{ box-sizing:border-box; }
html, body, #root{ height:100%; width:100%; margin:0; padding:0; overflow:hidden; }

.abqd-root{
  height:100%; width:100%;
  background: var(--bg);
  color: var(--fg);
  font-family: 'Montserrat', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  display:flex; flex-direction:column;
}

.abqd-header{
  min-height: var(--header-h);
  padding: 12px 16px;
  display:flex; align-items:center; justify-content:space-between;
  gap: 10px;
  flex-wrap: wrap;
  border-bottom: 1px solid var(--bd2);
  background: linear-gradient(135deg, var(--panel2), var(--panel));
  backdrop-filter: blur(14px);
}

.abqd-left{
  display:flex;
  align-items:center;
  gap: 12px;
  min-width: 260px;
  flex: 1 1 520px;
  flex-wrap: wrap;
}

.abqd-brand{
  display:flex;
  align-items:center;
  gap:12px;
}

.abqd-logo{
  width: 34px; height:34px;
  border-radius: 12px;
  background: radial-gradient(circle at 30% 30%, var(--brand2), var(--brand));
  box-shadow: 0 10px 30px var(--shadow);
}

.abqd-title{
  display:flex; flex-direction:column;
  line-height: 1.05;
}

.abqd-title b{ font-size: 14px; letter-spacing: 0.2px; }
.abqd-title span{ font-size: 12px; color: var(--muted); }

.abqd-headerTools{ display:flex; align-items:center; gap:10px; flex-wrap: wrap; justify-content:flex-end; }

.abqd-pill{
  height: 36px;
  display:flex; align-items:center;
  padding: 0 12px;
  border: 1px solid var(--bd);
  background: var(--panel);
  border-radius: 999px;
  gap: 8px;
}

.abqd-pill--wide{ height: 44px; padding: 0 12px; border-radius: 18px; }

.abqd-select{
  height: 28px;
  border: 0;
  outline: none;
  background: transparent;
  color: var(--fg);
  font-weight: 700;
}

.abqd-miniInput{
  height: 28px;
  width: 96px;
  border: 1px solid var(--bd2);
  background: rgba(255,255,255,0.04);
  color: var(--fg);
  border-radius: 12px;
  outline: none;
  padding: 0 10px;
  font-weight: 700;
}

.abqd-miniInput--date{ width: 132px; }

.abqd-input{
  height: 36px;
  padding: 0 12px;
  border: 1px solid var(--bd);
  background: var(--panel);
  border-radius: 12px;
  color: var(--fg);
  outline: none;
  min-width: 220px;
}

.abqd-btn{
  height: 36px;
  border-radius: 12px;
  border: 1px solid var(--bd);
  background: linear-gradient(135deg, rgba(99,102,241,.18), rgba(139,92,246,.12));
  color: var(--fg);
  font-weight: 800;
  padding: 0 12px;
  cursor: pointer;
}
.abqd-btn:hover{ border-color: rgba(139,92,246,.32); }

.abqd-btn--solid{
  border: 0;
  color: white;
  background: linear-gradient(135deg, var(--brand2), var(--brand));
}

.abqd-btn--ghost{ background: transparent; }

.abqd-layout{ flex: 1; min-height: 0; display:flex; }

.abqd-sidebar{
  width: 290px;
  flex: 0 0 290px;
  border-right: 1px solid var(--bd2);
  background: linear-gradient(135deg, var(--panel2), var(--panel));
  backdrop-filter: blur(14px);
  padding: 14px;
  overflow:auto;
}

.abqd-main{ flex: 1; min-width: 0; min-height: 0; display:flex; overflow:hidden; }

.abqd-board{ flex: 1; min-width: 0; min-height: 0; display:flex; gap: 12px; padding: 14px; overflow-x: auto; overflow-y: hidden; }

.abqd-col{
  width: 330px;
  flex: 0 0 330px;
  min-height: 0;
  display:flex;
  flex-direction:column;
  border: 1px solid var(--bd2);
  background: var(--panel);
  border-radius: var(--radius);
  box-shadow: 0 16px 40px var(--shadow);
}

.abqd-colHead{ padding: 12px 12px 10px; border-bottom: 1px solid var(--bd2); display:flex; justify-content: space-between; align-items:flex-start; gap:10px; }
.abqd-colHead b{ font-size: 13px; }
.abqd-colHead small{ display:block; margin-top: 3px; color: var(--muted); }

.abqd-count{ min-width: 30px; height: 24px; padding: 0 10px; display:flex; align-items:center; justify-content:center; border: 1px solid var(--bd); border-radius: 999px; font-weight: 800; color: var(--muted); background: rgba(255,255,255,0.04); }

.abqd-colBody{ padding: 10px; overflow: auto; min-height: 0; }

.abqd-card{ border: 1px solid var(--bd2); background: rgba(255,255,255,0.06); border-radius: 14px; padding: 10px 10px; margin-bottom: 10px; cursor: pointer; }
.abqd-card:hover{ border-color: rgba(139,92,246,.30); }

.abqd-cardTop{ display:flex; justify-content:space-between; gap:10px; }
.abqd-cardTop b{ font-size: 13px; }
.abqd-sub{ font-size: 12px; color: var(--muted); margin-top: 3px; }

.abqd-row{ display:flex; align-items:center; gap:8px; flex-wrap: wrap; margin-top: 8px; }

.abqd-chip{ display:inline-flex; align-items:center; gap:6px; padding: 4px 8px; border-radius: 999px; border: 1px solid var(--bd2); font-size: 11px; color: var(--muted); background: rgba(255,255,255,0.06); }

.abqd-chip--hot{ background: rgba(244,63,94,.12); border-color: rgba(244,63,94,.25); }
.abqd-chip--warm{ background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.25); }
.abqd-chip--cold{ background: rgba(59,130,246,.10); border-color: rgba(59,130,246,.20); }
.abqd-chip--weak{ background: rgba(156,163,175,.10); border-color: rgba(156,163,175,.18); }

.abqd-chip--good{ background: var(--ok); }
.abqd-chip--warn{ background: var(--warn); }
.abqd-chip--bad{ background: var(--bad); }

/* Drawer */
.abqd-drawer{ width: 380px; flex: 0 0 380px; border-left: 1px solid var(--bd2); background: linear-gradient(135deg, var(--panel2), var(--panel)); backdrop-filter: blur(14px); overflow:auto; padding: 0; }

.abqd-drawerHead{ position: sticky; top: 0; z-index: 5; padding: 14px; border-bottom: 1px solid var(--bd2); background: linear-gradient(135deg, var(--panel2), var(--panel)); backdrop-filter: blur(14px); }
.abqd-drawerBody{ padding: 14px; }

.abqd-drawerTopRow{ display:flex; justify-content: space-between; align-items: center; gap: 10px; }

.abqd-section{ margin-bottom: 14px; }
.abqd-sectionTitle{ font-weight: 900; font-size: 12px; letter-spacing: 0.2px; }
.abqd-sectionHint{ font-size: 12px; color: var(--muted); margin-top: 4px; }

.abqd-fieldLabel{ font-size: 12px; color: var(--muted); margin: 10px 0 6px; }

.abqd-textarea{ width: 100%; min-height: 82px; padding: 10px 12px; border: 1px solid var(--bd); background: var(--panel); color: var(--fg); border-radius: 12px; outline: none; resize: vertical; }

.abqd-smallInput{ width: 100%; height: 36px; padding: 0 12px; border: 1px solid var(--bd); background: var(--panel); color: var(--fg); border-radius: 12px; outline: none; }

.abqd-divider{ height: 1px; background: var(--bd2); margin: 12px 0; }

.abqd-toastStack{ position: fixed; top: 12px; right: 12px; width: 340px; z-index: 1000; display:flex; flex-direction:column; gap: 10px; pointer-events: none; }

.abqd-toast{ pointer-events: none; border-radius: 14px; border: 1px solid var(--bd2); background: var(--panel2); padding: 10px 12px; box-shadow: 0 18px 50px var(--shadow); }
.abqd-toast b{ display:block; font-size: 13px; }
.abqd-toast p{ margin: 4px 0 0; font-size: 12px; color: var(--muted); }

.abqd-toast--ok{ border-color: rgba(16,185,129,.25); }
.abqd-toast--warn{ border-color: rgba(245,158,11,.25); }
.abqd-toast--bad{ border-color: rgba(244,63,94,.25); }

@media (max-width: 1100px){
  .abqd-sidebar{ display:none; }
  .abqd-drawer{ width: 360px; flex: 0 0 360px; }
}

@media (max-width: 880px){
  .abqd-drawer{ display:none; }
  .abqd-input{ min-width: 160px; }
}
`;

// -------------------------
// UI COMPONENTS
// -------------------------
function Chip({ tone, children, title }) {
  return (
    <span
      title={title}
      className={cx(
        "abqd-chip",
        tone === "hot" && "abqd-chip--hot",
        tone === "warm" && "abqd-chip--warm",
        tone === "cold" && "abqd-chip--cold",
        tone === "weak" && "abqd-chip--weak",
        tone === "good" && "abqd-chip--good",
        tone === "warn" && "abqd-chip--warn",
        tone === "bad" && "abqd-chip--bad"
      )}
    >
      {children}
    </span>
  );
}

function Button({ variant = "ghost", onClick, children, title, disabled }) {
  return (
    <button
      className={cx("abqd-btn", variant === "solid" && "abqd-btn--solid", variant === "ghost" && "abqd-btn--ghost")}
      onClick={onClick}
      title={title}
      disabled={disabled}
      style={disabled ? { opacity: 0.55, cursor: "not-allowed" } : undefined}
    >
      {children}
    </button>
  );
}

function Sidebar({ role, setRole, plugins, activePluginIds, onTogglePlugin, pushToast, plan }) {
  return (
    <aside className="abqd-sidebar">
      <div className="abqd-section">
        <div className="abqd-sectionTitle">–†–æ–ª—å</div>
        <div className="abqd-sectionHint">–î–ª—è –ø—Ä–∏–º–µ—Ä–∞: —Ä–∞–∑–Ω—ã–µ —Ñ–æ–∫—É—Å—ã –ø–æ —Ä–∞–±–æ—Ç–µ.</div>
        <div className="abqd-row" style={{ marginTop: 10 }}>
          <span className="abqd-pill" style={{ width: "100%", justifyContent: "space-between" }}>
            <span style={{ fontWeight: 900 }}>
              {roleDefs[role]?.icon} {roleDefs[role]?.title}
            </span>
            <select className="abqd-select" value={role} onChange={(e) => setRole(e.target.value)}>
              <option value="hunter">Hunter</option>
              <option value="farmer">Farmer</option>
            </select>
          </span>
          <span style={{ fontSize: 12, color: "var(--muted)", marginTop: 8 }}>{roleDefs[role]?.subtitle}</span>
        </div>
      </div>

      <div className="abqd-divider" />

      <div className="abqd-section">
        <div className="abqd-sectionTitle">–ü–ª–∞–≥–∏–Ω—ã</div>
        <div className="abqd-sectionHint">–°–ø–∏—Å–æ–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤. –í –¥–µ–º–æ ‚Äî –≤–∫–ª—é—á–∞–µ–º —Ñ–∏–ª—å—Ç—Ä–æ–º.</div>
        <div style={{ marginTop: 10, display: "flex", flexDirection: "column", gap: 10 }}>
          {plugins.map((p) => {
            const unlocked = isPluginUnlockedForPlan(p, plan);
            const active = activePluginIds.includes(p.id);
            return (
              <div
                key={p.id}
                title={pluginHoverTitle(p)}
                className={cx("abqd-card")}
                style={{
                  marginBottom: 0,
                  cursor: unlocked ? "pointer" : "not-allowed",
                  opacity: unlocked ? 1 : 0.65,
                }}
                onClick={() => {
                  if (!unlocked) {
                    pushToast("warn", "–ü–ª–∞–≥–∏–Ω –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω", `–ù—É–∂–µ–Ω —Ç–∞—Ä–∏—Ñ: ${pluginMinPlanText(p)}`);
                    return;
                  }
                  onTogglePlugin(p.id);
                }}
              >
                <div className="abqd-cardTop">
                  <b>
                    {p.icon} {p.title}
                  </b>
                  <Chip>{unlocked ? (active ? "ON" : "OFF") : pluginMinPlanText(p)}</Chip>
                </div>
                <div className="abqd-sub">{p.desc}</div>
              </div>
            );
          })}
        </div>
      </div>
    </aside>
  );
}

function DealCard({ deal, selected, onSelect }) {
  const s = scoreLabel(deal.score);
  const due = dueTone(deal.nextTaskAt);
  return (
    <div
      className={cx("abqd-card")}
      style={selected ? { borderColor: "rgba(139,92,246,.45)" } : undefined}
      onClick={onSelect}
    >
      <div className="abqd-cardTop">
        <b>{deal.company}</b>
        <Chip tone={s.tone} title={`–°–∫–æ—Ä: ${deal.score}`}>
          {s.text}
        </Chip>
      </div>
      <div className="abqd-sub">{deal.contact}</div>
      <div className="abqd-row">
        <Chip title={deal.id}>{deal.id}</Chip>
        <Chip title="–°—É–º–º–∞">{formatMoney(deal.amount, deal.currency)}</Chip>
        {due !== "none" && (
          <Chip tone={due === "good" ? "good" : due === "warn" ? "warn" : "bad"} title="–°–ª–µ–¥—É—é—â–∞—è –∑–∞–¥–∞—á–∞">
            üìå {deal.nextTaskAt}
          </Chip>
        )}
      </div>
      <div className="abqd-row" style={{ marginTop: 10 }}>
        {(deal.tags || []).slice(0, 3).map((t) => (
          <Chip key={t}>#{t}</Chip>
        ))}
      </div>
    </div>
  );
}

function StageColumn({ stage, deals, selectedId, onSelectDeal }) {
  return (
    <div className="abqd-col">
      <div className="abqd-colHead">
        <div style={{ minWidth: 0 }}>
          <b>{stage.title}</b>
          <small>{stage.hint}</small>
        </div>
        <div className="abqd-count">{deals.length}</div>
      </div>
      <div className="abqd-colBody">
        {deals.map((d) => (
          <DealCard key={d.id} deal={d} selected={d.id === selectedId} onSelect={() => onSelectDeal(d.id)} />
        ))}
      </div>
    </div>
  );
}

function HeaderDealPanel({ deal, draft, setDraft, missingForStage, onMoveStage, onSave, onClose, saving, pushToast }) {
  if (!deal || !draft) return null;

  return (
    <div className="abqd-row" style={{ marginTop: 0, gap: 10 }}>
      <span className="abqd-pill abqd-pill--wide" title="–í—ã–±—Ä–∞–Ω–Ω–∞—è —Å–¥–µ–ª–∫–∞" style={{ gap: 10 }}>
        <span style={{ fontWeight: 900 }}>{deal.company}</span>
        <span style={{ color: "var(--muted)", fontSize: 12 }}>¬∑ {deal.id}</span>
        <span style={{ color: "var(--muted)", fontSize: 12 }}>¬∑ {deal.contact}</span>
        <Button onClick={onClose} title="–ó–∞–∫—Ä—ã—Ç—å —Å–¥–µ–ª–∫—É" variant="ghost">
          ‚úï
        </Button>
      </span>

      <span className="abqd-pill abqd-pill--wide" title="–°—Ç–∞—Ç—É—Å">
        <span style={{ fontWeight: 900 }}>{stageTitleByKey[draft.stage] || draft.stage}</span>
        <select
          className="abqd-select"
          value={draft.stage}
          onChange={(e) => setDraft((p) => ({ ...p, stage: e.target.value }))}
        >
          {demoStages.map((s) => (
            <option key={s.key} value={s.key}>
              {s.title}
            </option>
          ))}
        </select>
        <Button
          variant="solid"
          onClick={() => {
            if (missingForStage.length) {
              pushToast(
                "warn",
                "–ù—É–∂–Ω—ã –ø–æ–ª—è",
                `–î–ª—è —ç—Ç–∞–ø–∞ ¬´${stageTitleByKey[draft.stage]}¬ª –∑–∞–ø–æ–ª–Ω–∏—Ç–µ: ${missingForStage.join(", ")}`
              );
              return;
            }
            onMoveStage();
          }}
          title="–ü—Ä–∏–º–µ–Ω–∏—Ç—å —ç—Ç–∞–ø"
        >
          –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å
        </Button>
      </span>

      <span className="abqd-pill abqd-pill--wide" title="–ö–∞—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö" style={{ gap: 10 }}>
        <span style={{ fontWeight: 900 }}>‚≠ê</span>
        <input
          className="abqd-miniInput"
          type="number"
          min={0}
          max={100}
          value={Number(draft.score ?? 0)}
          onChange={(e) =>
            setDraft((p) => ({
              ...p,
              score: Math.max(0, Math.min(100, Number(e.target.value || 0))),
            }))
          }
          title="Score (0‚Äì100)"
        />

        <span style={{ fontWeight: 900 }}>üìå</span>
        <input
          className="abqd-miniInput abqd-miniInput--date"
          value={draft.nextTaskAt || ""}
          onChange={(e) => setDraft((p) => ({ ...p, nextTaskAt: e.target.value }))}
          placeholder="YYYY-MM-DD"
          title="Next task date (YYYY-MM-DD)"
        />

        <Button variant="solid" onClick={onSave} disabled={saving} title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è">
          {saving ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ‚Ä¶" : "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"}
        </Button>
      </span>
    </div>
  );
}

function Drawer({ deal, draft, setDraft, plan, onClose, onSavePatch, pushToast }) {
  const [saving, setSaving] = useState(false);
  const [aiBusy, setAiBusy] = useState(false);

  useEffect(() => {
    setSaving(false);
    setAiBusy(false);
  }, [deal?.id]);

  const onField = (key, value) => {
    setDraft((prev) => ({
      ...prev,
      fields: {
        ...(prev.fields || {}),
        [key]: value,
      },
    }));
  };

  const save = async () => {
    setSaving(true);
    try {
      await onSavePatch(deal.id, pickPatchFromDraft(draft));
      pushToast("ok", "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ", "–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã");
    } catch (e) {
      pushToast("bad", "–û—à–∏–±–∫–∞", e?.message || "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å");
    } finally {
      setSaving(false);
    }
  };

  const aiSuggestNext = async () => {
    setAiBusy(true);
    try {
      const prompt = `–¢—ã ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ CRM. –î–∞–π 3 –∫–æ—Ä–æ—Ç–∫–∏–µ —Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–¥–∞—á–∏ (Next Action) –¥–ª—è —Å–¥–µ–ª–∫–∏.

–î–∞–Ω–Ω—ã–µ: ${JSON.stringify(
        {
          company: draft.company,
          stage: draft.stage,
          amount: draft.amount,
          fields: draft.fields,
          tags: draft.tags,
        },
        null,
        2
      )}

–§–æ—Ä–º–∞—Ç: –±—É–ª–ª–µ—Ç—ã, –±–µ–∑ –≤–æ–¥—ã, –ø–æ –¥–µ–ª—É.`;
      const text = await callGemini(prompt, false);
      pushToast("ok", "AI –ø–æ–¥—Å–∫–∞–∑–∫–∏", text || "–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç");
    } catch (e) {
      pushToast("bad", "AI –æ—à–∏–±–∫–∞", e?.message || "");
    } finally {
      setAiBusy(false);
    }
  };

  return (
    <aside className="abqd-drawer">
      <div className="abqd-drawerHead">
        <div className="abqd-drawerTopRow">
          <div style={{ minWidth: 0 }}>
            <div className="abqd-sectionTitle">{deal.company}</div>
            <div className="abqd-sectionHint">
              {deal.id} ¬∑ {deal.contact}
            </div>
          </div>
          <Button onClick={onClose} title="–ó–∞–∫—Ä—ã—Ç—å">
            ‚úï
          </Button>
        </div>
        <div className="abqd-sectionHint" style={{ marginTop: 8 }}>
          –ü–æ–¥—Ä–æ–±–Ω—ã–µ –ø–æ–ª—è —Å–¥–µ–ª–∫–∏ (—Å—Ç–∞—Ç—É—Å/–∫–∞—á–µ—Å—Ç–≤–æ ‚Äî –≤ —à–∞–ø–∫–µ —Å–≤–µ—Ä—Ö—É).
        </div>
      </div>

      <div className="abqd-drawerBody">
        <div className="abqd-section">
          <div className="abqd-sectionTitle">–ö–æ–Ω—Ç–∞–∫—Ç—ã</div>
          <div className="abqd-fieldLabel">Email</div>
          <input
            className="abqd-smallInput"
            value={draft.email || ""}
            onChange={(e) => setDraft((p) => ({ ...p, email: e.target.value }))}
          />
          <div className="abqd-fieldLabel">–¢–µ–ª–µ—Ñ–æ–Ω</div>
          <input
            className="abqd-smallInput"
            value={draft.phone || ""}
            onChange={(e) => setDraft((p) => ({ ...p, phone: e.target.value }))}
          />
        </div>

        <div className="abqd-section">
          <div className="abqd-sectionTitle">–ü–æ–ª—è —ç—Ç–∞–ø–æ–≤</div>
          <div className="abqd-sectionHint">–ú–∏–Ω–∏–º—É–º –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ –ø–æ –≤–æ—Ä–æ–Ω–∫–µ.</div>

          <div className="abqd-fieldLabel">Budget</div>
          <input className="abqd-smallInput" value={draft.fields?.budget || ""} onChange={(e) => onField("budget", e.target.value)} />

          <div className="abqd-fieldLabel">Deadline</div>
          <input className="abqd-smallInput" value={draft.fields?.deadline || ""} onChange={(e) => onField("deadline", e.target.value)} />

          <div className="abqd-fieldLabel">Decision maker</div>
          <input
            className="abqd-smallInput"
            value={draft.fields?.decisionMaker || ""}
            onChange={(e) => onField("decisionMaker", e.target.value)}
          />

          <div className="abqd-fieldLabel">INN</div>
          <input className="abqd-smallInput" value={draft.fields?.inn || ""} onChange={(e) => onField("inn", e.target.value)} />

          <div className="abqd-fieldLabel">Legal name</div>
          <input
            className="abqd-smallInput"
            value={draft.fields?.legalName || ""}
            onChange={(e) => onField("legalName", e.target.value)}
          />

          <div className="abqd-fieldLabel">Lost reason</div>
          <input
            className="abqd-smallInput"
            value={draft.fields?.lostReason || ""}
            onChange={(e) => onField("lostReason", e.target.value)}
          />

          <div className="abqd-fieldLabel">Note</div>
          <textarea className="abqd-textarea" value={draft.fields?.note || ""} onChange={(e) => onField("note", e.target.value)} />
        </div>

        <div className="abqd-divider" />

        <div className="abqd-section">
          <div className="abqd-sectionTitle">–î–µ–π—Å—Ç–≤–∏—è</div>
          <div className="abqd-row" style={{ marginTop: 10 }}>
            <Button variant="solid" onClick={save} disabled={saving}>
              {saving ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ‚Ä¶" : "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"}
            </Button>
            <Button onClick={() => pushToast("ok", "–û—Ç–∫—Ä—ã—Ç—å –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä", "https://app.abqd.ru/constructor/")}>‚åÅ –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</Button>
            <Button
              onClick={aiSuggestNext}
              disabled={aiBusy || !isPluginUnlockedForPlan(pluginCatalog.find((p) => p.id === "ai_agent"), plan)}
            >
              {aiBusy ? "AI‚Ä¶" : "ü§ñ Next Action"}
            </Button>
          </div>
          {!apiKey && (
            <div className="abqd-sectionHint" style={{ marginTop: 10 }}>
              AI —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ –±–µ–∑ API –∫–ª—é—á–∞.
            </div>
          )}
        </div>
      </div>
    </aside>
  );
}

function Toasts({ toasts }) {
  if (!toasts.length) return null;
  return (
    <div className="abqd-toastStack">
      {toasts.map((t) => (
        <div
          key={t.id}
          className={cx(
            "abqd-toast",
            t.tone === "ok" && "abqd-toast--ok",
            t.tone === "warn" && "abqd-toast--warn",
            t.tone === "bad" && "abqd-toast--bad"
          )}
        >
          <b>{t.title}</b>
          <p>{t.text}</p>
        </div>
      ))}
    </div>
  );
}

// -------------------------
// TESTS
// -------------------------
function runUnitTests() {
  const assert = (name, cond) => {
    if (!cond) throw new Error(`Test failed: ${name}`);
  };

  assert("planTitle(pro)", planTitle("pro") === "Pro");
  assert("planTitle(unknown)", planTitle("zzz") === "Free");

  const p = pluginCatalog.find((x) => x.id === "calendar");
  assert("plugin unlocked for starter", isPluginUnlockedForPlan(p, "starter") === true);
  assert("plugin locked for free", isPluginUnlockedForPlan(p, "free") === false);

  assert("dueTone empty", dueTone("") === "none");
  assert("dueTone malformed", dueTone("2026/01/01") === "none");

  const d0 = deepCopy(demoDealsSeed[0]);
  assert("missing for qual budget+deadline", requiredMissingForStage(d0, "qual").length === 2);
  d0.fields.budget = "100";
  d0.fields.deadline = "2026-02-01";
  assert("missing for qual none", requiredMissingForStage(d0, "qual").length === 0);

  const d1 = deepCopy(demoDealsSeed[0]);
  d1.stage = "contract";
  assert("missing for contract inn+legalName", requiredMissingForStage(d1, "contract").length === 2);

  const search = createSearchString(d0);
  assert("search includes company", search.includes("sova"));
  assert("search includes id", search.includes("d-1001"));

  const money = formatMoney(1000, "RUB");
  assert("formatMoney returns string", typeof money === "string" && money.length > 0);

  const d2 = deepCopy(demoDealsSeed[0]);
  d2.fields.budget = "   ";
  assert("gates trim whitespace", requiredMissingForStage(d2, "qual").includes("budget") === true);

  const patch = pickPatchFromDraft(deepCopy(demoDealsSeed[0]));
  assert("pickPatchFromDraft contains fields", typeof patch.fields === "object");
}

// -------------------------
// APP
// -------------------------
export default function App() {
  // ‚úÖ FIX: theme declared here BEFORE using it
  const [theme, setTheme] = useStoredTheme();

  const { toasts, push } = useToasts();

  const [plan, setPlan] = useState("pro");
  const [role, setRole] = useState("hunter");
  const [query, setQuery] = useState("");
  const [savingHeader, setSavingHeader] = useState(false);

  const [activePluginIds, setActivePluginIds] = useState(["constructor"]);

  const [deals, setDeals] = useState(() => demoDealsSeed.map((d) => ({ ...d })));
  const [selectedId, setSelectedId] = useState(() => demoDealsSeed[0]?.id || "");

  const selectedDeal = useMemo(() => deals.find((d) => d.id === selectedId) || null, [deals, selectedId]);

  // –æ–¥–∏–Ω draft, –∫–æ—Ç–æ—Ä—ã–π —à–∞—Ä–∏—Ç—Å—è –º–µ–∂–¥—É Header –∏ Drawer
  const [draft, setDraft] = useState(() => (selectedDeal ? deepCopy(selectedDeal) : null));

  useEffect(() => {
    if (selectedDeal) setDraft(deepCopy(selectedDeal));
    else setDraft(null);
  }, [selectedDeal?.id]);

  useEffect(() => {
    try {
      runUnitTests();
      // eslint-disable-next-line no-console
      console.info("ABQD CRM tests: OK");
    } catch (e) {
      // eslint-disable-next-line no-console
      console.error(e);
      push("bad", "Tests failed", e?.message || "");
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  const filteredDeals = useMemo(() => {
    const q = query.trim().toLowerCase();
    return deals.filter((d) => {
      if (activePluginIds.length) {
        const has = (d.plugins || []).some((pid) => activePluginIds.includes(pid));
        if (!has) return false;
      }

      if (role === "farmer" && d.stage === "inbox") return false;

      if (!q) return true;
      return createSearchString(d).includes(q);
    });
  }, [deals, query, activePluginIds, role]);

  const dealsByStage = useMemo(() => {
    const map = Object.fromEntries(demoStages.map((s) => [s.key, []]));
    filteredDeals.forEach((d) => {
      (map[d.stage] ||= []).push(d);
    });
    return map;
  }, [filteredDeals]);

  const missingForSelectedStage = useMemo(() => {
    if (!draft) return [];
    return requiredMissingForStage(draft, draft.stage);
  }, [draft]);

  const toggleTheme = () => setTheme(theme === "dark" ? "light" : "dark");

  const togglePlugin = (pluginId) => {
    setActivePluginIds((prev) => {
      if (prev.includes(pluginId)) return prev.filter((x) => x !== pluginId);
      return [...prev, pluginId];
    });
  };

  const savePatch = async (dealId, patch) => {
    await mockApi.saveDealPatch(dealId, patch);
    setDeals((prev) =>
      prev.map((d) => {
        if (d.id !== dealId) return d;
        const fields = patch.fields ? { ...(d.fields || {}), ...(patch.fields || {}) } : d.fields;
        return { ...d, ...patch, fields };
      })
    );
  };

  const moveStage = async (dealId, toStageKey, patchFromDraft) => {
    const base = deals.find((x) => x.id === dealId);
    if (!base) return;

    const merged = patchFromDraft
      ? {
          ...base,
          ...patchFromDraft,
          fields: { ...(base.fields || {}), ...(patchFromDraft.fields || {}) },
        }
      : base;

    const missing = requiredMissingForStage(merged, toStageKey);
    const res = await mockApi.moveStage(dealId, toStageKey, missing);
    if (!res.ok && res.code === "GATES") {
      push("warn", "–ù—É–∂–Ω—ã –ø–æ–ª—è", `–î–ª—è —ç—Ç–∞–ø–∞ ¬´${stageTitleByKey[toStageKey]}¬ª –∑–∞–ø–æ–ª–Ω–∏—Ç–µ: ${res.missing.join(", ")}`);
      return;
    }

    setDeals((prev) =>
      prev.map((d) => {
        if (d.id !== dealId) return d;
        const fields = patchFromDraft?.fields ? { ...(d.fields || {}), ...(patchFromDraft.fields || {}) } : d.fields;
        return { ...d, ...(patchFromDraft || {}), fields, stage: toStageKey };
      })
    );

    push("ok", "–≠—Ç–∞–ø –∏–∑–º–µ–Ω—ë–Ω", `–°–¥–µ–ª–∫–∞ ${dealId} ‚Üí ${stageTitleByKey[toStageKey]}`);
  };

  const headerSave = async () => {
    if (!selectedDeal || !draft) return;
    setSavingHeader(true);
    try {
      await savePatch(selectedDeal.id, pickPatchFromDraft(draft));
      push("ok", "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ", "–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã");
    } catch (e) {
      push("bad", "–û—à–∏–±–∫–∞", e?.message || "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å");
    } finally {
      setSavingHeader(false);
    }
  };

  const headerMove = async () => {
    if (!selectedDeal || !draft) return;
    await moveStage(selectedDeal.id, draft.stage, pickPatchFromDraft(draft));
  };

  return (
    <div className="abqd-root" data-theme={theme}>
      <style>{css}</style>

      <header className="abqd-header">
        <div className="abqd-left">
          <div className="abqd-brand">
            <div className="abqd-logo" />
            <div className="abqd-title">
              <b>ABQD CRM</b>
              <span>Full-screen Kanban ¬∑ plugins ¬∑ gates</span>
            </div>
          </div>

          <HeaderDealPanel
            deal={selectedDeal}
            draft={draft}
            setDraft={setDraft}
            missingForStage={missingForSelectedStage}
            onMoveStage={headerMove}
            onSave={headerSave}
            onClose={() => setSelectedId("")}
            saving={savingHeader}
            pushToast={push}
          />
        </div>

        <div className="abqd-headerTools">
          <input className="abqd-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Å–¥–µ–ª–∫–∞–º‚Ä¶" value={query} onChange={(e) => setQuery(e.target.value)} />

          <span className="abqd-pill" title="–¢–∞—Ä–∏—Ñ (–¥–µ–º–æ)">
            <span style={{ fontWeight: 900 }}>{planTitle(plan)}</span>
            <select className="abqd-select" value={plan} onChange={(e) => setPlan(e.target.value)}>
              <option value="free">Free</option>
              <option value="starter">Start</option>
              <option value="pro">Pro</option>
              <option value="business">Business</option>
            </select>
          </span>

          <span className="abqd-pill" title="–†–æ–ª—å (–¥–µ–º–æ)">
            <span style={{ fontWeight: 900 }}>{roleDefs[role]?.icon}</span>
            <select className="abqd-select" value={role} onChange={(e) => setRole(e.target.value)}>
              <option value="hunter">Hunter</option>
              <option value="farmer">Farmer</option>
            </select>
          </span>

          <Button onClick={toggleTheme} title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É" variant="ghost">
            {theme === "dark" ? "üåô" : "‚òÄÔ∏è"}
          </Button>
        </div>
      </header>

      <div className="abqd-layout">
        <Sidebar
          plan={plan}
          role={role}
          setRole={setRole}
          plugins={pluginCatalog}
          activePluginIds={activePluginIds}
          onTogglePlugin={togglePlugin}
          pushToast={push}
        />

        <main className="abqd-main">
          <div className="abqd-board">
            {demoStages.map((s) => (
              <StageColumn
                key={s.key}
                stage={s}
                deals={dealsByStage[s.key] || []}
                selectedId={selectedId}
                onSelectDeal={(id) => setSelectedId(id)}
              />
            ))}
          </div>

          {selectedDeal && draft && (
            <Drawer
              deal={selectedDeal}
              draft={draft}
              setDraft={setDraft}
              plan={plan}
              onClose={() => setSelectedId("")}
              onSavePatch={savePatch}
              pushToast={push}
            />
          )}
        </main>
      </div>

      <Toasts toasts={toasts} />
    </div>
  );
}

  <!-- ABQD_HEADER_INCLUDE_v1 --><script src="/assets/header.js?v=1"></script>
