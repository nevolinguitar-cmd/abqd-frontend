<!doctype html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ABQD — Вход / Регистрация</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --font: "Montserrat", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --card: rgba(12,14,24,.46);
      --stroke: rgba(255,255,255,.12);
      --btn: rgba(255,255,255,.08);
      --btn2: rgba(88,136,255,.85);
      --btn2h: rgba(88,136,255,.98);
      --danger: #ff5a5f;
      --ok: #42d392;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --r: 18px;
    }

    html,body{height:100%;}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--txt);
      background:#050612;
      overflow:hidden;
    }

    .bg{
      position:fixed; inset:0;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n");
      background-size:cover;
      background-position:center;
      filter:saturate(1.05) contrast(1.05);
      transform:scale(1.02);
      z-index:0;
    }
    .bg::after{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(60% 80% at 50% 40%, rgba(84,56,255,.22), rgba(0,0,0,.72));
      backdrop-filter: blur(2px);
    }

    .stage{
      position:relative;
      z-index:2;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }

    .shell{
      width:min(620px, 100%);
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    .brand .logoText{
      font-size:44px;
      letter-spacing:-.02em;
      font-weight:500;
      opacity:.92;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .tabs{
      display:flex;
      gap:6px;
      padding:10px;
      border-bottom:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
    }
    .tab{
      flex:1;
      border:0;
      background: var(--btn);
      color: var(--txt);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:600;
    }
    .tab.active{
      background: rgba(88,136,255,.35);
      box-shadow: inset 0 0 0 1px rgba(88,136,255,.45);
    }

    .pane{display:none; padding:18px;}
    .pane.active{display:block;}

    .grid{display:grid; gap:12px;}
    .fieldWrap{display:grid; gap:6px;}
    label{font-size:12px; color:var(--muted);}
    .field{
      width:100%;
      padding:12px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.26);
      color: var(--txt);
      outline:none;
    }
    .field:focus{
      border-color: rgba(88,136,255,.55);
      box-shadow: 0 0 0 3px rgba(88,136,255,.18);
    }

    .row2{display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
    @media (max-width:520px){ .row2{grid-template-columns:1fr;} }

    .btn{
      width:100%;
      border:0;
      border-radius: 14px;
      padding:12px 14px;
      cursor:pointer;
      font-weight:700;
      color:var(--txt);
      background: var(--btn);
    }
    .btn.primary{background: var(--btn2);}
    .btn.primary:hover{background: var(--btn2h);}
    .sub{
      margin-top:10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      color:var(--muted);
      font-size:12px;
    }
    .link{
      color: rgba(172,196,255,.95);
      text-decoration:none;
      cursor:pointer;
    }
    .link:hover{ text-decoration:underline; }

    .msg{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: var(--muted);
      font-size: 12px;
      display:none;
    }
    .msg.err{border-color: rgba(255,90,95,.35); color: rgba(255,255,255,.9);}
    .msg.ok{border-color: rgba(66,211,146,.35); color: rgba(255,255,255,.9);}

    /* modal */
    .modal[hidden]{display:none;}
    .modal{
      position:fixed; inset:0;
      z-index:50;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .modal .backdrop{
      position:absolute; inset:0;
      background: rgba(0,0,0,.65);
      backdrop-filter: blur(4px);
    }
    .modal .box{
      position:relative;
      width:min(560px, 100%);
      background: rgba(14,16,26,.78);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal .head{
      padding:14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      font-weight:700;
    }
    .modal .body{padding:16px;}
    .modal .foot{
      padding:14px 16px;
      border-top: 1px solid rgba(255,255,255,.10);
      display:flex;
      gap:10px;
      justify-content:flex-end;
    }
    .xbtn{
      border:0; background:transparent; color:var(--muted);
      font-size:18px; cursor:pointer;
    }
  </style>
</head>

<body>
  <div class="bg" aria-hidden="true"></div>

  <div class="stage">
    <div class="shell">
      <div class="brand">
        <div class="logoText">abqd</div>
      </div>

      <div class="card">
        <div class="tabs">
          <button class="tab" id="tabLogin" type="button">Вход</button>
          <button class="tab" id="tabReg" type="button">Регистрация</button>
        </div>

        <!-- LOGIN -->
        <div class="pane" id="paneLogin">
          <form id="loginForm" class="grid">
            <div class="fieldWrap">
              <label for="loginEmail">Email</label>
              <input class="field" id="loginEmail" type="email" autocomplete="email" placeholder="name@domain.com" required />
            </div>
            <div class="fieldWrap">
              <label for="loginPass">Пароль</label>
              <input class="field" id="loginPass" type="password" autocomplete="current-password" placeholder="••••••••" required />
            </div>

            <button class="btn primary" type="submit">Войти</button>

            <div class="sub">
              <span></span>
              <a class="link" id="forgotLink">Забыли пароль?</a>
            </div>

            <div class="msg" id="loginMsg"></div>
          </form>
        </div>

        <!-- REGISTER (NO PHONE) -->
        <div class="pane" id="paneReg">
          <form id="regForm" class="grid">
            <div class="fieldWrap">
              <label for="regName">Имя</label>
              <input class="field" id="regName" type="text" autocomplete="name" placeholder="Александр" required />
            </div>

            <div class="fieldWrap">
              <label for="regEmail">Email</label>
              <input class="field" id="regEmail" type="email" autocomplete="email" placeholder="name@domain.com" required />
            </div>

            <div class="row2">
              <div class="fieldWrap">
                <label for="regPass">Пароль</label>
                <input class="field" id="regPass" type="password" autocomplete="new-password" placeholder="минимум 8 символов" required />
              </div>
              <div class="fieldWrap">
                <label for="regPass2">Повтор пароля</label>
                <input class="field" id="regPass2" type="password" autocomplete="new-password" placeholder="повторите пароль" required />
              </div>
            </div>

            <button class="btn primary" type="submit">Создать аккаунт</button>
            <div class="msg" id="regMsg"></div>
          </form>
        </div>

        <!-- VERIFY OTP (for login/register) -->
        <div class="pane" id="paneVerify">
          <form id="verifyForm" class="grid">
            <div class="fieldWrap">
              <label>Код из письма (6 цифр)</label>
              <input class="field" id="verifyCode" inputmode="numeric" pattern="\\d{6}" placeholder="000000" required />
            </div>
            <button class="btn primary" type="submit">Подтвердить</button>
            <div class="sub">
              <a class="link" id="backToAuth">← Назад</a>
              <span></span>
            </div>
            <div class="msg" id="verifyMsg"></div>
          </form>
        </div>

      </div>
    </div>
  </div>

  <!-- RESET MODAL -->
  <div class="modal" id="resetModal" hidden>
    <div class="backdrop" aria-hidden="true"></div>
    <div class="box" role="dialog" aria-modal="true">
      <div class="head">
        <div>Восстановление пароля</div>
        <button class="xbtn" id="resetClose" type="button">×</button>
      </div>
      <div class="body">
        <div class="grid" id="resetStep1">
          <div class="fieldWrap">
            <label for="resetEmail">Email</label>
            <input class="field" id="resetEmail" type="email" autocomplete="email" placeholder="name@domain.com" />
          </div>
          <button class="btn primary" id="resetSend" type="button">Отправить код</button>
          <div class="msg" id="resetMsg1"></div>
        </div>

        <div class="grid" id="resetStep2" style="display:none; margin-top:12px;">
          <div class="row2">
            <div class="fieldWrap">
              <label for="resetCode">Код (6 цифр)</label>
              <input class="field" id="resetCode" inputmode="numeric" pattern="\\d{6}" placeholder="000000" />
            </div>
            <div class="fieldWrap">
              <label for="resetPass">Новый пароль</label>
              <input class="field" id="resetPass" type="password" autocomplete="new-password" placeholder="минимум 8 символов" />
            </div>
          </div>
          <button class="btn primary" id="resetConfirm" type="button">Сменить пароль</button>
          <div class="msg" id="resetMsg2"></div>
        </div>
      </div>
      <div class="foot">
        <button class="btn" id="resetCancel" type="button">Закрыть</button>
      </div>
    </div>
  </div>

  <script>
    const API = {
      login: "/api/v1/auth/login",
      register: "/api/v1/auth/register",
      verify: "/api/v1/auth/verify",
      resetRequest: "/api/v1/auth/reset/request",
      resetConfirm: "/api/v1/auth/reset/confirm",
    };

    const $ = (id)=>document.getElementById(id);

    const tabLogin = $("tabLogin");
    const tabReg = $("tabReg");
    const paneLogin = $("paneLogin");
    const paneReg = $("paneReg");
    const paneVerify = $("paneVerify");

    const loginMsg = $("loginMsg");
    const regMsg = $("regMsg");
    const verifyMsg = $("verifyMsg");

    let pending = { email: "", otp_id: "" };
    let returnPane = "login";

    function showMsg(el, text, kind){
      if(!text){ el.style.display="none"; el.textContent=""; el.className="msg"; return; }
      el.style.display="block";
      el.textContent=text;
      el.className="msg " + (kind==="ok" ? "ok" : (kind==="err" ? "err" : ""));
    }

    function setPane(name){
      paneLogin.classList.toggle("active", name==="login");
      paneReg.classList.toggle("active", name==="reg");
      paneVerify.classList.toggle("active", name==="verify");

      tabLogin.classList.toggle("active", name==="login");
      tabReg.classList.toggle("active", name==="reg");
    }

    function setTabFromUrl(){
      const u = new URL(location.href);
      const t = (u.searchParams.get("tab") || "login").toLowerCase();
      setPane(t === "register" ? "reg" : "login");
    }

    tabLogin.addEventListener("click", ()=>{
      history.replaceState({}, "", "/auth/?tab=login");
      setPane("login");
    });
    tabReg.addEventListener("click", ()=>{
      history.replaceState({}, "", "/auth/?tab=register");
      setPane("reg");
    });

    async function postJSON(url, data){
      const r = await fetch(url, {
        method:"POST",
        headers:{ "content-type":"application/json" },
        body: JSON.stringify(data)
      });
      const j = await r.json().catch(()=> ({}));
      if(!r.ok){
        const d = j.detail || ("HTTP " + r.status);
        throw new Error(typeof d === "string" ? d : JSON.stringify(d));
      }
      return j;
    }

    // LOGIN -> sends OTP
    $("loginForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      showMsg(loginMsg, "", "");
      try{
        const email = $("loginEmail").value.trim().toLowerCase();
        const password = $("loginPass").value;
        const j = await postJSON(API.login, { email, password });
        pending.email = email;
        pending.otp_id = j.otp_id || j.otpId || j.id || "";
        returnPane = "login";
        setPane("verify");
        showMsg(verifyMsg, "Код отправлен на почту. Введите 6 цифр.", "ok");
      }catch(err){
        showMsg(loginMsg, err.message || "Ошибка", "err");
      }
    });

    // REGISTER -> sends OTP (verify_email)
    $("regForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      showMsg(regMsg, "", "");
      try{
        const name = $("regName").value.trim();
        const email = $("regEmail").value.trim().toLowerCase();
        const p1 = $("regPass").value;
        const p2 = $("regPass2").value;
        if(p1.length < 8) throw new Error("Пароль должен быть минимум 8 символов");
        if(p1 !== p2) throw new Error("Пароли не совпадают");

        const j = await postJSON(API.register, { name, email, password: p1 });
        pending.email = email;
        pending.otp_id = j.otp_id || j.otpId || j.id || "";
        returnPane = "reg";
        setPane("verify");
        showMsg(verifyMsg, "Код подтверждения отправлен на почту. Введите 6 цифр.", "ok");
      }catch(err){
        showMsg(regMsg, err.message || "Ошибка", "err");
      }
    });

    $("backToAuth").addEventListener("click", (e)=>{
      e.preventDefault();
      setPane(returnPane);
    });

    // VERIFY OTP -> get token
    $("verifyForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      showMsg(verifyMsg, "", "");
      try{
        const code = ($("verifyCode").value || "").trim();
        if(!/^\d{6}$/.test(code)) throw new Error("Код должен быть из 6 цифр");
        const j = await postJSON(API.verify, { email: pending.email, otp_id: pending.otp_id, code });
        const token = j.token || j.access_token || j.accessToken;
        if(token) localStorage.setItem("abqd_token", token);
        // дальше — в кабинет
        location.href = "/constructor/";
      }catch(err){
        showMsg(verifyMsg, err.message || "Ошибка", "err");
      }
    });

    // RESET MODAL (no extra blocks under link)
    const resetModal = $("resetModal");
    const resetEmail = $("resetEmail");
    const resetMsg1 = $("resetMsg1");
    const resetMsg2 = $("resetMsg2");
    const step1 = $("resetStep1");
    const step2 = $("resetStep2");

    function openReset(){
      resetEmail.value = ($("loginEmail").value || "").trim();
      showMsg(resetMsg1,"","");
      showMsg(resetMsg2,"","");
      step2.style.display="none";
      resetModal.hidden = false;
      setTimeout(()=> resetEmail.focus(), 30);
    }
    function closeReset(){
      resetModal.hidden = true;
    }

    $("forgotLink").addEventListener("click", openReset);
    $("resetClose").addEventListener("click", closeReset);
    $("resetCancel").addEventListener("click", closeReset);
    resetModal.querySelector(".backdrop").addEventListener("click", closeReset);

    $("resetSend").addEventListener("click", async ()=>{
      showMsg(resetMsg1,"","");
      try{
        const email = resetEmail.value.trim().toLowerCase();
        if(!email) throw new Error("Введите email");
        await postJSON(API.resetRequest, { email });
        step2.style.display="block";
        showMsg(resetMsg1, "Код отправлен на почту. Введите код и новый пароль.", "ok");
      }catch(err){
        showMsg(resetMsg1, err.message || "Ошибка", "err");
      }
    });

    $("resetConfirm").addEventListener("click", async ()=>{
      showMsg(resetMsg2,"","");
      try{
        const code = ($("resetCode").value || "").trim();
        const pass = $("resetPass").value || "";
        if(!/^\d{6}$/.test(code)) throw new Error("Код должен быть из 6 цифр");
        if(pass.length < 8) throw new Error("Пароль должен быть минимум 8 символов");
        await postJSON(API.resetConfirm, { token: code, password: pass });
        showMsg(resetMsg2, "Пароль обновлён. Теперь можно войти.", "ok");
        setTimeout(()=>{ closeReset(); setPane("login"); }, 700);
      }catch(err){
        showMsg(resetMsg2, err.message || "Ошибка", "err");
      }
    });

    // init
    setTabFromUrl();
    window.addEventListener("popstate", setTabFromUrl);
  </script>
</body>
</html>
