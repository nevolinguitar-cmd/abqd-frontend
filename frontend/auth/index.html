<!doctype html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ABQD — Вход / Регистрация</title>

  <!-- Montserrat (brand font) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --font: "Montserrat", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.66);
      --accent: 46,124,255;
      --panelR: 22px;
      --shadow: 0 30px 110px rgba(0,0,0,.55);

      --corridorImg: url("https://static.tildacdn.com/tild3361-3261-4562-a464-333532376265/ChatGPT_Image_21__20.png");

      --shellMax: 620px;
      --cardMax: 560px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--font);
      color: var(--txt);
      background: #07090d;
      overflow-x:hidden;
    }

    .stage{
      position: relative;
      min-height: 100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 34px 18px;
      isolation:isolate;
      overflow:hidden;
    }

    .bgImage{
      position:absolute; inset:0;
      z-index:0;
      pointer-events:none;
      background-color:#000;
      background-image:
        radial-gradient(1200px 800px at 50% 44%, rgba(255,255,255,.035), rgba(0,0,0,0) 62%),
        linear-gradient(180deg, rgba(0,0,0,.72) 0%, rgba(0,0,0,.30) 46%, rgba(0,0,0,.86) 100%),
        var(--corridorImg);
      background-repeat:no-repeat;
      background-position: 50% 50%;
      background-size: cover;
      filter: saturate(1.03) contrast(1.04) brightness(.92);
      transform: translateZ(0);
    }

    .mask{
      position:absolute; inset:0;
      z-index:1;
      pointer-events:none;
      background:
        radial-gradient(520px 520px at 88% 88%, rgba(0,0,0,.92), transparent 72%),
        radial-gradient(760px 420px at 50% 46%, rgba(0,0,0,.55), transparent 70%);
      opacity:.70;
    }

    .tint{
      position:absolute; inset:0;
      z-index:2;
      pointer-events:none;
      background:
        radial-gradient(900px 620px at 18% 12%, rgba(var(--accent), .22), transparent 55%),
        radial-gradient(900px 620px at 85% 20%, rgba(255,255,255,.08), transparent 60%),
        radial-gradient(900px 720px at 50% 92%, rgba(var(--accent), .14), transparent 66%),
        linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,0) 32%, rgba(0,0,0,.24) 100%);
    }

    .vignette{
      position:absolute; inset:0;
      z-index:3;
      pointer-events:none;
      background: radial-gradient(1300px 740px at 50% 52%, rgba(0,0,0,0) 30%, rgba(0,0,0,.62) 78%, rgba(0,0,0,.92) 100%);
      opacity:.60;
    }

    .grain{
      position:absolute; inset:0;
      z-index:4;
      pointer-events:none;
      opacity:.03;
      mix-blend-mode: overlay;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.55'/%3E%3C/svg%3E");
    }
    @media (max-width: 980px){ .grain{ display:none; } }

    .shell{
      width: min(var(--shellMax), 100%);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 12px;
      z-index:10;
    }

    .shellLogo{
      height: clamp(70px, 7.5vw, 110px);
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
      filter: drop-shadow(0 18px 70px rgba(0,0,0,.78)) drop-shadow(0 0 34px rgba(var(--accent), .12));
    }
    .shellLogo picture{ display:block; height:100%; }
    .shellLogo img{ height:100%; width:auto; max-width: min(520px, 92vw); display:block; opacity:.96; }

    .card{
      position:relative;
      width: min(var(--cardMax), 100%);
      border-radius: var(--panelR);
      padding: 26px;
      border: 1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(1200px 700px at 20% 0%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(900px 600px at 80% 30%, rgba(120,80,255,.26), transparent 58%),
        linear-gradient(180deg, rgba(255,255,255,.06) 0%, rgba(15,18,32,.62) 50%, rgba(7,9,16,.86) 100%);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }
    .card::after{
      content:"";
      position:absolute;
      inset:1px;
      border-radius: calc(var(--panelR) - 1px);
      pointer-events:none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.12), inset 0 -1px 0 rgba(0,0,0,.22);
    }

    .tabsWrap{
      position:relative;
      z-index:1;
      display:flex;
      padding: 6px;
      border-radius: 999px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.10);
    }

    .tab{
      flex:1;
      border:0;
      border-radius: 999px;
      padding: 14px 16px;
      font-family: var(--font);
      font-weight: 800;
      font-size: 18px;
      color: rgba(255,255,255,.72);
      background: transparent;
      cursor:pointer;
      transition: transform .18s ease, background .18s ease, box-shadow .18s ease, color .18s ease;
    }

    .tab.active{
      color: rgba(255,255,255,.96);
      background: linear-gradient(180deg, rgba(46,124,255,.55), rgba(46,124,255,.22));
      box-shadow: 0 16px 60px rgba(0,0,0,.35);
      border: 1px solid rgba(46,124,255,.35);
    }
    .tab:active{ transform: scale(.99); }

    .pane{ display:none; padding: 20px 6px 6px; position:relative; z-index:1; }
    .pane.active{ display:block; }

    label{ display:block; font-size: 16px; color: rgba(255,255,255,.70); margin: 14px 0 8px; }

    .field{
      width:100%;
      padding: 18px 18px;
      border-radius: 18px;
      font-family: var(--font);
      font-size: 18px;
      color: rgba(255,255,255,.92);
      outline:none;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.10), inset 0 -1px 0 rgba(0,0,0,.28), 0 18px 55px rgba(0,0,0,.18);
      transition: border-color .18s ease, box-shadow .18s ease, transform .18s ease, background .18s ease;
    }
    .field::placeholder{ color: rgba(255,255,255,.40); }
    .field:focus{
      border-color: rgba(46,124,255,.62);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.12), inset 0 -1px 0 rgba(0,0,0,.30), 0 0 0 5px rgba(46,124,255,.14), 0 22px 70px rgba(0,0,0,.26);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      transform: translateY(-1px);
    }

    .btn{
      width:100%;
      border:0;
      border-radius: 20px;
      padding: 18px 18px;
      font-family: var(--font);
      font-weight: 800;
      font-size: 18px;
      color: rgba(255,255,255,.95);
      cursor:pointer;
      background: linear-gradient(180deg, rgba(46,124,255,.60), rgba(46,124,255,.26));
      border: 1px solid rgba(46,124,255,.38);
      box-shadow: 0 18px 70px rgba(0,0,0,.32);
      transition: transform .18s ease, filter .18s ease;
      margin-top: 16px;
    }
    .btn:active{ transform: translateY(1px); }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; filter: grayscale(.2); }

    .hint{ font-size: 13px; color: rgba(255,255,255,.56); line-height: 1.45; margin-top: 8px; }

    .toast{
      display:none;
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      color: rgba(255,255,255,.86);
      font-size: 14px;
      position:relative;
      z-index:1;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .toast.show{ display:block; }
    .toast.ok{ border-color: rgba(104,245,169, .35); }
    .toast.err{ border-color: rgba(255, 86, 110, .40); }

    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
    @media (max-width: 980px){ .row{ grid-template-columns:1fr; } }

    .linkRow{ margin-top: 10px; display:flex; gap:16px; flex-wrap:wrap; }
    .link{
      border:0;
      background: transparent;
      color: rgba(255,255,255,.78);
      font-family: var(--font);
      cursor:pointer;
      padding: 0;
      font-size: 15px;
      font-weight: 800;
    }
    .link:hover{ color: rgba(255,255,255,.90); }

    /* password toggle */
    .pwWrap{ position:relative; }
    .pwWrap .field{ padding-right: 108px; }
    .pwToggle{
      position:absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      border-radius: 14px;
      padding: 10px 12px;
      border: 1px solid rgba(46,124,255,.38);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.92);
      font-family: var(--font);
      font-weight: 800;
      cursor:pointer;
    }
    .pwToggle:active{ transform: translateY(-50%) scale(.99); }

    .divider{
      height: 1px;
      background: rgba(255,255,255,.10);
      margin: 16px 0 12px;
    }

    @media (prefers-reduced-motion: reduce){
      .bgImage{ animation:none !important; }
    }
  </style>
</head>

<body>
  <div class="stage">
    <div class="bgImage" aria-hidden="true"></div>
    <div class="mask" aria-hidden="true"></div>
    <div class="tint" aria-hidden="true"></div>
    <div class="vignette" aria-hidden="true"></div>
    <div class="grain" aria-hidden="true"></div>

    <div class="shell" role="main">
      <div class="shellLogo" aria-hidden="true">
        <picture>
          <source media="(max-width: 640px)" srcset="https://static.tildacdn.com/tild6464-3131-4736-b938-656238643465/_abqd.png">
          <img src="https://static.tildacdn.com/tild3437-6438-4735-a331-343834336463/_abqd.svg" alt="abqd" />
        </picture>
      </div>

      <section class="card" aria-label="Auth">
        <div class="tabsWrap" role="tablist" aria-label="Режим">
          <button class="tab active" id="tabLogin" role="tab" aria-selected="true" aria-controls="paneLogin">Вход</button>
          <button class="tab" id="tabRegister" role="tab" aria-selected="false" aria-controls="paneRegister">Регистрация</button>
        </div>

        <div id="toast" class="toast" aria-live="polite"></div>

        <!-- LOGIN -->
        <div class="pane active" id="paneLogin" role="tabpanel" aria-labelledby="tabLogin">
          <form id="formLogin" autocomplete="on">
            <div>
              <label for="loginEmail">Email</label>
              <input class="field" id="loginEmail" type="email" required placeholder="name@example.com" />
            </div>

            <div>
              <label for="loginPass">Пароль</label>
              <div class="pwWrap">
                <input class="field" id="loginPass" type="password" placeholder="••••••••" />
                <button class="pwToggle" id="toggleLoginPass" type="button">Показать</button>
              </div>
              <div class="hint">Если у тебя вход через код 6 цифр — можешь вставить код как пароль или используй блок «Вход по коду» ниже.</div>
            </div>

            <button class="btn" id="btnLogin" type="submit">Войти</button>

            <div class="linkRow">
              <button class="link" type="button" id="btnShowReset">Забыли пароль?</button>
              <button class="link" type="button" id="btnShowOtp">Вход по коду</button>
            </div>

            <!-- RESET -->
            <div id="resetBox" style="display:none; margin-top:10px;">
              <label for="resetEmail">Email для восстановления</label>
              <input class="field" id="resetEmail" type="email" placeholder="name@example.com" />
              <button class="btn" id="btnReset" type="button" style="margin-top:10px;">Отправить</button>
              <div class="hint">Если функция отключена на сервере — покажем ошибку.</div>
            </div>

            <!-- OTP -->
            <div id="otpBox" style="display:none; margin-top:14px;">
              <div class="divider"></div>
              <div class="hint" style="margin-top:0;">Получи код на почту, затем введи 6 цифр и войди.</div>

              <button class="btn" id="btnOtpRequest" type="button" style="margin-top:12px;">Получить код на почту</button>

              <label for="otpCode">Код (6 цифр)</label>
              <input class="field" id="otpCode" inputmode="numeric" autocomplete="one-time-code" placeholder="6 цифр" maxlength="6" />

              <button class="btn" id="btnOtpLogin" type="button" style="margin-top:12px;">Войти по коду</button>

              <div class="hint">Если сервер работает по схеме <b>login → otp_id → verify → token</b> — мы это обработаем автоматически.</div>
            </div>
          </form>
        </div>

        <!-- REGISTER -->
        <div class="pane" id="paneRegister" role="tabpanel" aria-labelledby="tabRegister">
          <form id="formRegister" autocomplete="on">
            <div class="row">
              <div>
                <label for="regName">Имя</label>
                <input class="field" id="regName" type="text" required placeholder="Александр" />
              </div>
              <div>
                <label for="regPhone">Телефон</label>
                <input class="field" id="regPhone" type="tel" inputmode="tel" placeholder="+7 999 000-12-34" />
                <div class="hint">Можно оставить пустым.</div>
              </div>
            </div>

            <div>
              <label for="regEmail">Email</label>
              <input class="field" id="regEmail" type="email" required placeholder="name@example.com" />
            </div>

            <div class="row">
              <div>
                <label for="regPass">Пароль</label>
                <div class="pwWrap">
                  <input class="field" id="regPass" type="password" required placeholder="Минимум 8 символов" />
                  <button class="pwToggle" id="toggleRegPass" type="button">Показать</button>
                </div>
              </div>
              <div>
                <label for="regPass2">Повтори пароль</label>
                <div class="pwWrap">
                  <input class="field" id="regPass2" type="password" required placeholder="Повтори" />
                  <button class="pwToggle" id="toggleRegPass2" type="button">Показать</button>
                </div>
              </div>
            </div>

            <button class="btn" id="btnRegister" type="submit">Создать аккаунт</button>

            <div id="verifyBox" style="display:none; margin-top:14px;">
              <div class="divider"></div>
              <label for="regCode">Код из письма</label>
              <input class="field" id="regCode" inputmode="numeric" autocomplete="one-time-code" placeholder="6 цифр" maxlength="6" />
              <button class="btn" id="btnVerify" type="button" style="margin-top:10px;">Подтвердить</button>
              <div class="hint">Если код не пришёл — отправь ещё раз.</div>
              <div class="linkRow" style="margin-top:8px;">
                <button class="link" type="button" id="btnResend">Отправить код ещё раз</button>
              </div>
            </div>

            <div class="hint" style="margin-top:10px;">Нажимая «Создать аккаунт», вы соглашаетесь на обработку данных.</div>
          </form>
        </div>
      </section>
    </div>
  </div>

<script>
(() => {
  // === CONFIG ===
  const API = "https://api.abqd.ru";
  const TOKEN_KEY = "abqd_token";

  // === helpers ===
  const $ = (id) => document.getElementById(id);
  const toast = $("toast");

  function showToast(type, msg){
    toast.className = "toast show " + (type === "ok" ? "ok" : "err");
    toast.textContent = String(msg ?? "");
  }
  function clearToast(){
    toast.className = "toast";
    toast.textContent = "";
  }
  function setBusy(btn, busy){
    if (!btn) return;
    btn.disabled = !!busy;
    btn.dataset._txt = btn.dataset._txt || btn.textContent;
    btn.textContent = busy ? "Подожди…" : btn.dataset._txt;
  }

  function safeNextUrl(){
    const u = new URL(location.href);
    let next =
      u.searchParams.get("next") ||
      u.searchParams.get("return_to") ||
      u.searchParams.get("redirect") ||
      sessionStorage.getItem("abqd_return_to") ||
      "";

    if (!next) {
      try {
        const ref = document.referrer ? new URL(document.referrer) : null;
        if (ref && ref.origin === location.origin) {
          // если пришли с тарифов/конструктора — вернём туда
          if (ref.pathname.startsWith("/tariffs")) next = ref.pathname + ref.search;
          if (ref.pathname.startsWith("/constructor")) next = ref.pathname + ref.search;
        }
      } catch(_) {}
    }

    if (!next) next = "/tariffs/";
    // разрешаем только относительные пути на этом же домене
    try {
      if (next.startsWith("http")) {
        const n = new URL(next);
        if (n.origin === location.origin) next = n.pathname + n.search;
        else next = "/tariffs/";
      }
      if (!next.startsWith("/")) next = "/tariffs/";
    } catch(_) {
      next = "/tariffs/";
    }

    sessionStorage.setItem("abqd_return_to", next);
    return next;
  }

  function extractToken(obj){
    // возвращаем строку токена, если нашли
    const seen = new Set();
    const walk = (x) => {
      if (!x) return null;
      if (typeof x === "string") {
        if (x.length >= 20) return x;
        return null;
      }
      if (typeof x !== "object") return null;
      if (seen.has(x)) return null;
      seen.add(x);

      // популярные ключи
      const keys = ["access_token","token","jwt","bearer","id_token"];
      for (const k of keys){
        if (typeof x[k] === "string" && x[k].length >= 20) return x[k];
        if (x[k] && typeof x[k] === "object") {
          const inner = walk(x[k]);
          if (inner) return inner;
        }
      }
      // рекурсивно по всем полям
      for (const k of Object.keys(x)){
        const inner = walk(x[k]);
        if (inner) return inner;
      }
      return null;
    };
    return walk(obj);
  }

  async function apiPost(path, body, token){
    const res = await fetch(API + path, {
      method: "POST",
      headers: {
        "content-type": "application/json",
        ...(token ? { "Authorization": "Bearer " + token } : {})
      },
      body: JSON.stringify(body ?? {})
    });

    const text = await res.text();
    let json = null;
    try { json = text ? JSON.parse(text) : null; } catch(_) {}
    return { res, text, json };
  }

  function saveToken(tok){
    localStorage.setItem(TOKEN_KEY, tok);
  }

  function redirectAfterAuth(){
    const next = safeNextUrl();
    location.href = next;
  }

  // === UI: tabs ===
  const tabLogin = $("tabLogin");
  const tabRegister = $("tabRegister");
  const paneLogin = $("paneLogin");
  const paneRegister = $("paneRegister");

  function setTab(which){
    clearToast();
    const isLogin = which === "login";
    tabLogin.classList.toggle("active", isLogin);
    tabRegister.classList.toggle("active", !isLogin);
    tabLogin.setAttribute("aria-selected", String(isLogin));
    tabRegister.setAttribute("aria-selected", String(!isLogin));
    paneLogin.classList.toggle("active", isLogin);
    paneRegister.classList.toggle("active", !isLogin);
  }

  tabLogin.addEventListener("click", () => setTab("login"));
  tabRegister.addEventListener("click", () => setTab("register"));

  // === UI: show/hide password ===
  function bindToggle(btnId, inputId){
    const btn = $(btnId);
    const inp = $(inputId);
    if (!btn || !inp) return;
    btn.addEventListener("click", () => {
      const isPwd = inp.type === "password";
      inp.type = isPwd ? "text" : "password";
      btn.textContent = isPwd ? "Скрыть" : "Показать";
      inp.focus();
    });
  }
  bindToggle("toggleLoginPass", "loginPass");
  bindToggle("toggleRegPass", "regPass");
  bindToggle("toggleRegPass2", "regPass2");

  // === blocks ===
  const resetBox = $("resetBox");
  const otpBox = $("otpBox");
  $("btnShowReset").addEventListener("click", () => {
    resetBox.style.display = resetBox.style.display === "none" ? "block" : "none";
  });
  $("btnShowOtp").addEventListener("click", () => {
    otpBox.style.display = otpBox.style.display === "none" ? "block" : "none";
  });

  // === Auth logic ===
  // если уже есть токен — сразу выходим туда, куда надо
  const existing = localStorage.getItem(TOKEN_KEY);
  if (existing && existing.length >= 20) {
    // не делаем авто-редирект без next? но безопасно
    // чтобы не мешать тестам — только если явно есть next/return_to
    const u = new URL(location.href);
    if (u.searchParams.get("next") || u.searchParams.get("return_to") || u.searchParams.get("redirect")) {
      redirectAfterAuth();
    }
  }

  // --- LOGIN (password OR otp init) ---
  const formLogin = $("formLogin");
  const btnLogin = $("btnLogin");

  async function handleLogin(email, password){
    clearToast();
    setBusy(btnLogin, true);

    try{
      // 1) обычный логин
      const r = await apiPost("/api/v1/auth/login", { email, password }, null);

      if (!r.res.ok){
        const detail = r.json?.detail || r.text || ("HTTP " + r.res.status);
        showToast("err", "Ошибка входа (" + r.res.status + "):\n" + detail);
        return;
      }

      // token сразу?
      const tok = extractToken(r.json);
      if (tok){
        saveToken(tok);
        showToast("ok", "Готово. Входим…");
        redirectAfterAuth();
        return;
      }

      // OTP-ветка: ok:true,next:"verify",otp_id:"..."
      if (r.json?.next === "verify" && r.json?.otp_id){
        sessionStorage.setItem("abqd_otp_id", r.json.otp_id);
        otpBox.style.display = "block";
        showToast("ok", "Код отправлен на почту. Введи 6 цифр и нажми «Войти по коду».");
        return;
      }

      showToast("err",
        "Логин выполнен, но token не пришёл.\n" +
        "Ожидаю token/access_token либо next=verify+otp_id.\n\nОтвет:\n" +
        (r.text || JSON.stringify(r.json))
      );

    } finally {
      setBusy(btnLogin, false);
    }
  }

  formLogin.addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = $("loginEmail").value.trim();
    const pass  = $("loginPass").value.trim();
    if (!email) return showToast("err","Введи email.");
    // пароль может быть пустым, если человек хочет OTP — тогда логин тоже может выдать otp_id
    await handleLogin(email, pass || "");
  });

  // --- RESET ---
  const btnReset = $("btnReset");
  btnReset.addEventListener("click", async () => {
    clearToast();
    const email = ($("resetEmail").value || $("loginEmail").value || "").trim();
    if (!email) return showToast("err","Введи email для восстановления.");
    setBusy(btnReset, true);
    try{
      const r = await apiPost("/api/v1/auth/reset/request", { email }, null);
      if (!r.res.ok){
        showToast("err", "Reset ("+r.res.status+"):\n" + (r.json?.detail || r.text));
        return;
      }
      showToast("ok", "Если email существует — письмо отправлено.");
    } finally {
      setBusy(btnReset, false);
    }
  });

  // --- OTP REQUEST ---
  const btnOtpRequest = $("btnOtpRequest");
  btnOtpRequest.addEventListener("click", async () => {
    clearToast();
    const email = $("loginEmail").value.trim();
    if (!email) return showToast("err","Сначала введи email.");
    setBusy(btnOtpRequest, true);

    try{
      // чаще всего сервер шлёт OTP при login(email) без password
      let r = await apiPost("/api/v1/auth/login", { email }, null);

      // fallback: некоторые реализации требуют password:""
      if (!r.res.ok) {
        r = await apiPost("/api/v1/auth/login", { email, password: "" }, null);
      }

      if (!r.res.ok){
        showToast("err", "Не удалось отправить код ("+r.res.status+"):\n" + (r.json?.detail || r.text));
        return;
      }

      const tok = extractToken(r.json);
      if (tok){
        saveToken(tok);
        showToast("ok","Готово. Входим…");
        redirectAfterAuth();
        return;
      }

      if (r.json?.next === "verify" && r.json?.otp_id){
        sessionStorage.setItem("abqd_otp_id", r.json.otp_id);
        showToast("ok","Код отправлен. Введи 6 цифр и нажми «Войти по коду».");
        return;
      }

      showToast("err",
        "Код запросили, но ответ неожиданный.\n\nОтвет:\n" + (r.text || JSON.stringify(r.json))
      );
    } finally {
      setBusy(btnOtpRequest, false);
    }
  });

  // --- OTP VERIFY / LOGIN WITH CODE ---
  const btnOtpLogin = $("btnOtpLogin");
  btnOtpLogin.addEventListener("click", async () => {
    clearToast();
    const email = $("loginEmail").value.trim();
    const code = $("otpCode").value.trim();
    const otpId = sessionStorage.getItem("abqd_otp_id") || "";

    if (!email) return showToast("err","Введи email.");
    if (!/^\d{6}$/.test(code)) return showToast("err","Код должен быть 6 цифр.");

    setBusy(btnOtpLogin, true);
    try{
      // 1) основной путь: /auth/verify
      let r = null;

      // пробуем разные поля, чтобы не зависеть от точного названия на сервере
      const verifyBodies = [
        { otp_id: otpId, code },
        { otp_id: otpId, otp_code: code },
        { otp_id: otpId, password: code },
        { email, code },
        { email, otp: code },
      ];

      for (const body of verifyBodies){
        if (!body.otp_id && (body.otp_id !== 0) && (body.otp_id !== "") && ("otp_id" in body)) continue;
        r = await apiPost("/api/v1/auth/verify", body, null);
        if (r.res.status === 404 || r.res.status === 405) break; // verify нет — уйдём в fallback
        if (r.res.ok) break; // есть шанс, что ok и токен внутри
      }

      if (r && r.res && r.res.ok){
        const tok = extractToken(r.json);
        if (tok){
          saveToken(tok);
          showToast("ok","Готово. Входим…");
          redirectAfterAuth();
          return;
        }
        // бывает: verify вернул ok, но без токена (плохо, но покажем)
        showToast("err",
          "Verify прошёл, но token не пришёл.\n\nОтвет:\n" + (r.text || JSON.stringify(r.json))
        );
        return;
      }

      // 2) fallback: сервер принимает код как password в /auth/login
      const r2 = await apiPost("/api/v1/auth/login", { email, password: code }, null);
      if (!r2.res.ok){
        showToast("err", "Не удалось войти по коду ("+r2.res.status+"):\n" + (r2.json?.detail || r2.text));
        return;
      }
      const tok2 = extractToken(r2.json);
      if (tok2){
        saveToken(tok2);
        showToast("ok","Готово. Входим…");
        redirectAfterAuth();
        return;
      }

      if (r2.json?.next === "verify" && r2.json?.otp_id){
        sessionStorage.setItem("abqd_otp_id", r2.json.otp_id);
        showToast("ok","Код обновлён. Проверь почту и введи новый код.");
        return;
      }

      showToast("err","Ожидаю token после входа по коду.\n\nОтвет:\n" + (r2.text || JSON.stringify(r2.json)));

    } finally {
      setBusy(btnOtpLogin, false);
    }
  });

  // --- REGISTER ---
  const formRegister = $("formRegister");
  const btnRegister = $("btnRegister");
  const verifyBox = $("verifyBox");
  const btnVerify = $("btnVerify");
  const btnResend = $("btnResend");

  formRegister.addEventListener("submit", async (e) => {
    e.preventDefault();
    clearToast();

    const name = $("regName").value.trim();
    const phone = $("regPhone").value.trim();
    const email = $("regEmail").value.trim();
    const pass = $("regPass").value;
    const pass2 = $("regPass2").value;

    if (!name) return showToast("err","Введи имя.");
    if (!email) return showToast("err","Введи email.");
    if (pass.length < 8) return showToast("err","Пароль минимум 8 символов.");
    if (pass !== pass2) return showToast("err","Пароли не совпадают.");

    setBusy(btnRegister, true);
    try{
      const payload = { name, email, password: pass };
      if (phone) payload.phone = phone;

      const r = await apiPost("/api/v1/auth/register", payload, null);
      if (!r.res.ok){
        showToast("err", "Регистрация ("+r.res.status+"):\n" + (r.json?.detail || r.text));
        return;
      }

      const tok = extractToken(r.json);
      if (tok){
        saveToken(tok);
        showToast("ok","Аккаунт создан. Входим…");
        redirectAfterAuth();
        return;
      }

      if (r.json?.next === "verify" && r.json?.otp_id){
        sessionStorage.setItem("abqd_reg_otp_id", r.json.otp_id);
        verifyBox.style.display = "block";
        showToast("ok","Код отправлен на почту. Введи 6 цифр и нажми «Подтвердить».");
        return;
      }

      // если сервер не отдаёт otp_id — всё равно покажем verify блок (попросим код)
      verifyBox.style.display = "block";
      showToast("ok","Аккаунт создан. Если нужно подтверждение — введи код из письма.");
    } finally {
      setBusy(btnRegister, false);
    }
  });

  btnVerify.addEventListener("click", async () => {
    clearToast();
    const email = $("regEmail").value.trim();
    const code = $("regCode").value.trim();
    const otpId = sessionStorage.getItem("abqd_reg_otp_id") || "";

    if (!/^\d{6}$/.test(code)) return showToast("err","Код должен быть 6 цифр.");

    setBusy(btnVerify, true);
    try{
      const bodies = [
        { otp_id: otpId, code },
        { otp_id: otpId, otp_code: code },
        { email, code },
        { email, otp: code },
      ];

      let last = null;
      for (const b of bodies){
        if ("otp_id" in b && !b.otp_id) continue;
        const r = await apiPost("/api/v1/auth/verify", b, null);
        last = r;
        if (r.res.status === 404 || r.res.status === 405) break;
        if (r.res.ok) {
          const tok = extractToken(r.json);
          if (tok){
            saveToken(tok);
            showToast("ok","Подтверждено. Входим…");
            redirectAfterAuth();
            return;
          }
        }
      }

      showToast("err", "Не удалось подтвердить.\n" + (last?.json?.detail || last?.text || "Unknown error"));

    } finally {
      setBusy(btnVerify, false);
    }
  });

  btnResend.addEventListener("click", async () => {
    clearToast();
    // самый безопасный ресенд — через OTP login по email (аккаунт уже есть)
    setTab("login");
    otpBox.style.display = "block";
    $("loginEmail").value = $("regEmail").value.trim();
    showToast("ok", "Перешёл во «Вход по коду». Нажми «Получить код на почту».");
  });

})();
</script>
</body>
</html>
