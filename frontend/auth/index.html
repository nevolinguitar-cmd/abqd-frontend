<!doctype html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ABQD ‚Äî –í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</title>

  <!-- Montserrat (brand font) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --font: "Montserrat", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.66);
      --accent: 46,124,255;
      --panelR: 22px;
      --shadow: 0 30px 110px rgba(0,0,0,.55);

      --corridorImg: url("https://static.tildacdn.com/tild3361-3261-4562-a464-333532376265/ChatGPT_Image_21__20.png");

      --shellMax: 620px;
      --cardMax: 560px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--font);
      color: var(--txt);
      background: #07090d;
      overflow-x:hidden;
    }

    .stage{
      position: relative;
      min-height: 100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 34px 18px;
      isolation:isolate;
      overflow:hidden;
    }

    .bgImage{
      position:absolute; inset:0;
      z-index:0;
      pointer-events:none;
      background-color:#000;
      background-image:
        radial-gradient(1200px 800px at 50% 44%, rgba(255,255,255,.035), rgba(0,0,0,0) 62%),
        linear-gradient(180deg, rgba(0,0,0,.72) 0%, rgba(0,0,0,.30) 46%, rgba(0,0,0,.86) 100%),
        var(--corridorImg);
      background-repeat:no-repeat;
      background-position: 50% 50%;
      background-size: cover;
      filter: saturate(1.03) contrast(1.04) brightness(.92);
      transform: translateZ(0);
    }

    .mask{
      position:absolute; inset:0;
      z-index:1;
      pointer-events:none;
      background:
        radial-gradient(520px 520px at 88% 88%, rgba(0,0,0,.92), transparent 72%),
        radial-gradient(760px 420px at 50% 46%, rgba(0,0,0,.55), transparent 70%);
      opacity:.70;
    }

    .tint{
      position:absolute; inset:0;
      z-index:2;
      pointer-events:none;
      background:
        radial-gradient(900px 620px at 18% 12%, rgba(var(--accent), .22), transparent 55%),
        radial-gradient(900px 620px at 85% 20%, rgba(255,255,255,.08), transparent 60%),
        radial-gradient(900px 720px at 50% 92%, rgba(var(--accent), .14), transparent 66%),
        linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,0) 32%, rgba(0,0,0,.24) 100%);
    }

    .vignette{
      position:absolute; inset:0;
      z-index:3;
      pointer-events:none;
      background: radial-gradient(1300px 740px at 50% 52%, rgba(0,0,0,0) 30%, rgba(0,0,0,.62) 78%, rgba(0,0,0,.92) 100%);
      opacity:.60;
    }

    .grain{
      position:absolute; inset:0;
      z-index:4;
      pointer-events:none;
      opacity:.03;
      mix-blend-mode: overlay;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.55'/%3E%3C/svg%3E");
    }
    @media (max-width: 980px){ .grain{ display:none; } }

    .shell{
      width: min(var(--shellMax), 100%);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 12px;
      z-index:10;
    }

    .shellLogo{
      height: clamp(70px, 7.5vw, 110px);
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
      filter: drop-shadow(0 18px 70px rgba(0,0,0,.78)) drop-shadow(0 0 34px rgba(var(--accent), .12));
    }

    .shellLogo picture{ display:block; height:100%; }
    .shellLogo img{ height:100%; width:auto; max-width: min(520px, 92vw); display:block; opacity:.96; }

    .card{
      position:relative;
      width: min(var(--cardMax), 100%);
      border-radius: var(--panelR);
      padding: 26px;
      border: 1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(1200px 700px at 20% 0%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(900px 600px at 80% 30%, rgba(120,80,255,.26), transparent 58%),
        linear-gradient(180deg, rgba(255,255,255,.06) 0%, rgba(15,18,32,.62) 50%, rgba(7,9,16,.86) 100%);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }
    .card::after{
      content:"";
      position:absolute;
      inset:1px;
      border-radius: calc(var(--panelR) - 1px);
      pointer-events:none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.12), inset 0 -1px 0 rgba(0,0,0,.22);
    }

    .tabsWrap{
      position:relative;
      z-index:1;
      display:flex;
      padding: 6px;
      border-radius: 999px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.10);
    }

    .tab{
      flex:1;
      border:0;
      border-radius: 999px;
      padding: 14px 16px;
      font-family: var(--font);
      font-weight: 800;
      font-size: 18px;
      color: rgba(255,255,255,.72);
      background: transparent;
      cursor:pointer;
      transition: transform .18s ease, background .18s ease, box-shadow .18s ease, color .18s ease;
    }

    .tab.active{
      color: rgba(255,255,255,.96);
      background: linear-gradient(180deg, rgba(46,124,255,.55), rgba(46,124,255,.22));
      box-shadow: 0 16px 60px rgba(0,0,0,.35);
      border: 1px solid rgba(46,124,255,.35);
    }
    .tab:active{ transform: scale(.99); }

    .pane{ display:none; padding: 20px 6px 6px; position:relative; z-index:1; }
    .pane.active{ display:block; }

    label{ display:block; font-size: 16px; color: rgba(255,255,255,.70); margin: 14px 0 8px; }

    .field{
      width:100%;
      padding: 18px 18px;
      border-radius: 18px;
      font-family: var(--font);
      font-size: 18px;
      color: rgba(255,255,255,.92);
      outline:none;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.10), inset 0 -1px 0 rgba(0,0,0,.28), 0 18px 55px rgba(0,0,0,.18);
      transition: border-color .18s ease, box-shadow .18s ease, transform .18s ease, background .18s ease;
    }
    .field::placeholder{ color: rgba(255,255,255,.40); }
    .field:focus{
      border-color: rgba(46,124,255,.62);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.12), inset 0 -1px 0 rgba(0,0,0,.30), 0 0 0 5px rgba(46,124,255,.14), 0 22px 70px rgba(0,0,0,.26);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      transform: translateY(-1px);
    }

    .btn{
      width:100%;
      border:0;
      border-radius: 20px;
      padding: 18px 18px;
      font-family: var(--font);
      font-weight: 800;
      font-size: 18px;
      color: rgba(255,255,255,.95);
      cursor:pointer;
      background: linear-gradient(180deg, rgba(46,124,255,.60), rgba(46,124,255,.26));
      border: 1px solid rgba(46,124,255,.38);
      box-shadow: 0 18px 70px rgba(0,0,0,.32);
      transition: transform .18s ease;
      margin-top: 16px;
    }
    .btn:active{ transform: translateY(1px); }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; }

    .hint{ font-size: 13px; color: rgba(255,255,255,.56); line-height: 1.45; margin-top: 8px; }

    .toast{
      display:none;
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      color: rgba(255,255,255,.86);
      font-size: 14px;
      position:relative;
      z-index:1;
    }
    .toast.show{ display:block; }
    .toast.ok{ border-color: rgba(104,245,169, .35); }
    .toast.err{ border-color: rgba(255, 86, 110, .40); }

    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
    @media (max-width: 980px){ .row{ grid-template-columns:1fr; } }

    .linkRow{ margin-top: 10px; }
    .link{
      border:0;
      background: transparent;
      color: rgba(255,255,255,.78);
      font-family: var(--font);
      cursor:pointer;
      padding: 0;
      font-size: 15px;
      font-weight: 800;
    }
    .link:hover{ color: rgba(255,255,255,.90); }

    /* show/hide (eye) */
    .abqdWrap{ position:relative; }
    .abqdWrap .field{ padding-right:56px; }
    .abqdEye{
      position:absolute; right:12px; top:50%;
      transform:translateY(-50%);
      width:36px; height:36px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.20);
      color:rgba(255,255,255,.88);
      cursor:pointer;
    }
    .abqdEye:active{ transform:translateY(-50%) scale(.99); }

    @media (prefers-reduced-motion: reduce){
      .bgImage{ animation:none !important; }
    }
  </style>
</head>

<body>
  <div class="stage">
    <div class="bgImage" aria-hidden="true"></div>
    <div class="mask" aria-hidden="true"></div>
    <div class="tint" aria-hidden="true"></div>
    <div class="vignette" aria-hidden="true"></div>
    <div class="grain" aria-hidden="true"></div>

    <div class="shell" role="main">
      <div class="shellLogo" aria-hidden="true">
        <picture>
          <source media="(max-width: 640px)" srcset="https://static.tildacdn.com/tild6464-3131-4736-b938-656238643465/_abqd.png">
          <img src="https://static.tildacdn.com/tild3437-6438-4735-a331-343834336463/_abqd.svg" alt="abqd" />
        </picture>
      </div>

      <section class="card" aria-label="Auth">
        <div class="tabsWrap" role="tablist" aria-label="–†–µ–∂–∏–º">
          <button class="tab active" id="tabLogin" role="tab" aria-selected="true" aria-controls="paneLogin">–í—Ö–æ–¥</button>
          <button class="tab" id="tabRegister" role="tab" aria-selected="false" aria-controls="paneRegister">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>

        <div id="toast" class="toast" aria-live="polite"></div>

        <!-- LOGIN -->
        <div class="pane active" id="paneLogin" role="tabpanel" aria-labelledby="tabLogin">
          <form id="formLogin" autocomplete="on">
            <div>
              <label for="loginEmail">Email</label>
              <input class="field" id="loginEmail" type="email" required placeholder="name@example.com" />
            </div>

            <div>
              <label for="loginPass">–ü–∞—Ä–æ–ª—å</label>
              <!-- –ø–∞—Ä–æ–ª—å –ù–ï required, —á—Ç–æ–±—ã –≤—Ö–æ–¥ –ø–æ –∫–æ–¥—É –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞–ª -->
              <input class="field" id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            </div>

            <button class="btn" id="btnLogin" type="submit">–í–æ–π—Ç–∏</button>

            <div class="linkRow" style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;">
              <button class="link" type="button" id="btnLoginByCode">–í–æ–π—Ç–∏ –ø–æ –∫–æ–¥—É</button>
              <button class="link" type="button" id="btnShowReset">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</button>
            </div>

            <!-- OTP Login box -->
            <div id="loginCodeBox" style="display:none; margin-top:14px;">
              <label for="loginCode">–ö–æ–¥ –∏–∑ –ø–∏—Å—å–º–∞</label>
              <input class="field" id="loginCode" type="password" inputmode="numeric" autocomplete="one-time-code"
                     placeholder="6 —Ü–∏—Ñ—Ä" maxlength="6" />

              <button class="btn" id="btnSendLoginCode" type="button" style="margin-top:10px;">
                –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥
              </button>

              <button class="btn" id="btnVerifyLoginCode" type="button" style="margin-top:10px;">
                –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
              </button>

              <div class="linkRow" style="margin-top:8px; display:flex; gap:14px; flex-wrap:wrap;">
                <button class="link" type="button" id="btnResendLoginCode">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –µ—â—ë —Ä–∞–∑</button>
                <button class="link" type="button" id="btnBackToPass">–ù–∞–∑–∞–¥ –∫ –ø–∞—Ä–æ–ª—é</button>
              </div>

              <div class="hint">–ö–æ–¥ –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–∞ email. –í–≤–µ–¥–∏—Ç–µ 6 —Ü–∏—Ñ—Ä –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤—Ö–æ–¥.</div>
            </div>

            <!-- RESET box -->
            <div id="resetBox" style="display:none; margin-top:10px;">
              <label for="resetEmail">Email –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è</label>
              <input class="field" id="resetEmail" type="email" placeholder="name@example.com" />
              <button class="btn" id="btnReset" type="button" style="margin-top:10px;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
              <div class="hint">–ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ ‚Äî –ø–æ–∫–∞–∂–µ–º –æ—à–∏–±–∫—É (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ).</div>
            </div>
          </form>
        </div>

        <!-- REGISTER -->
        <div class="pane" id="paneRegister" role="tabpanel" aria-labelledby="tabRegister">
          <form id="formRegister" autocomplete="on">
            <div class="row">
              <div>
                <label for="regName">–ò–º—è</label>
                <input class="field" id="regName" type="text" required placeholder="–ê–ª–µ–∫—Å–∞–Ω–¥—Ä" />
              </div>
              <div>
                <label for="regPhone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                <input class="field" id="regPhone" type="tel" inputmode="tel" placeholder="+7 999 000-12-34" />
                <div class="hint">–ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.</div>
              </div>
            </div>

            <div>
              <label for="regEmail">Email</label>
              <input class="field" id="regEmail" type="email" required placeholder="name@example.com" />
            </div>

            <div class="row">
              <div>
                <label for="regPass">–ü–∞—Ä–æ–ª—å</label>
                <input class="field" id="regPass" type="password" required placeholder="–ú–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤" />
              </div>
              <div>
                <label for="regPass2">–ü–æ–≤—Ç–æ—Ä–∏ –ø–∞—Ä–æ–ª—å</label>
                <input class="field" id="regPass2" type="password" required placeholder="–ü–æ–≤—Ç–æ—Ä–∏" />
              </div>
            </div>

            <button class="btn" id="btnRegister" type="submit">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>

            <!-- Verify block (–ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ register) -->
            <div id="verifyBox" style="display:none; margin-top:14px;">
              <label for="regCode">–ö–æ–¥ –∏–∑ –ø–∏—Å—å–º–∞</label>
              <input class="field" id="regCode" type="password" inputmode="numeric" autocomplete="one-time-code"
                     placeholder="6 —Ü–∏—Ñ—Ä" maxlength="6" />
              <button class="btn" id="btnVerify" type="button" style="margin-top:10px;">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
              <div class="hint">–ö–æ–¥ –Ω—É–∂–µ–Ω –æ–¥–∏–Ω —Ä–∞–∑ ‚Äî –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–∫–∫–∞—É–Ω—Ç–∞.</div>
              <div class="linkRow" style="margin-top:8px;">
                <button class="link" type="button" id="btnResend">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –µ—â—ë —Ä–∞–∑</button>
              </div>
            </div>

            <div class="hint" style="margin-top:10px;">–ù–∞–∂–∏–º–∞—è ¬´–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç¬ª, –≤—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö.</div>
          </form>
        </div>
      </section>
    </div>
  </div>

  <script>
    (() => {
      const $ = (id) => document.getElementById(id);

      // ====== –ù–ê–°–¢–†–û–ô–ö–ò ======
      // –ï—Å–ª–∏ —É —Ç–µ–±—è API –≤—Å–µ–≥–¥–∞ –Ω–∞ api.abqd.ru ‚Äî –æ—Å—Ç–∞–≤—å —Ç–∞–∫.
      // –ï—Å–ª–∏ –∫–æ–≥–¥–∞-—Ç–æ –±—É–¥–µ—à—å –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ /api ‚Äî –ø–æ–º–µ–Ω—è–µ—à—å –∑–¥–µ—Å—å –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ.
      const API_BASE = "https://api.abqd.ru";

      const ENDPOINTS = {
        login: "/api/v1/auth/login",             // POST {email, password?} –∏–ª–∏ {email} —á—Ç–æ–±—ã –≤—ã—Å–ª–∞—Ç—å –∫–æ–¥
        verify: "/api/v1/auth/verify",           // POST {email, code} -> token
        register: "/api/v1/auth/register",       // POST {name,email,phone?,password}
        resetRequest: "/api/v1/auth/reset/request"
      };

      const TOKEN_KEY = "abqd_token";
      const REDIRECT_DEFAULT = "/constructor/";

      // ====== UI ======
      const toast = $("toast");

      function showToast(msg, type="ok"){
        if(!toast) return;
        toast.className = "toast show " + (type === "err" ? "err" : "ok");
        toast.textContent = msg;
      }
      function clearToast(){
        if(!toast) return;
        toast.className = "toast";
        toast.textContent = "";
      }

      function redirectAfterLogin(){
        const u = new URL(location.href);
        const next = u.searchParams.get("next") || REDIRECT_DEFAULT;
        location.href = next;
      }

      function normalizeToken(resp){
        return (resp && (resp.token || resp.access_token || resp.jwt || (resp.data && resp.data.token))) || "";
      }

      function sanitizeCode(v){
        return (v || "").replace(/\D/g, "").slice(0, 6);
      }

      async function post(path, body){
        const r = await fetch(API_BASE + path, {
          method: "POST",
          headers: { "content-type":"application/json" },
          body: JSON.stringify(body || {})
        });
        const text = await r.text();
        let json = null;
        try { json = text ? JSON.parse(text) : null; } catch(e){}
        if(!r.ok){
          const msg = (json && (json.detail || json.message)) || text || ("HTTP " + r.status);
          throw new Error(msg);
        }
        return json || {};
      }

      // ====== TABS ======
      const tabLogin = $("tabLogin");
      const tabRegister = $("tabRegister");
      const paneLogin = $("paneLogin");
      const paneRegister = $("paneRegister");

      function setTab(which){
        clearToast();
        const isLogin = which === "login";
        tabLogin.classList.toggle("active", isLogin);
        tabRegister.classList.toggle("active", !isLogin);
        tabLogin.setAttribute("aria-selected", isLogin ? "true" : "false");
        tabRegister.setAttribute("aria-selected", !isLogin ? "true" : "false");
        paneLogin.classList.toggle("active", isLogin);
        paneRegister.classList.toggle("active", !isLogin);
      }

      tabLogin.addEventListener("click", () => setTab("login"));
      tabRegister.addEventListener("click", () => setTab("register"));

      // ====== EYE BUTTONS (show/hide) ======
      function wrapWithEye(inputId){
        const inp = $(inputId);
        if(!inp) return;
        if(inp.closest(".abqdWrap")) return;

        const wrap = document.createElement("div");
        wrap.className = "abqdWrap";
        inp.parentNode.insertBefore(wrap, inp);
        wrap.appendChild(inp);

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "abqdEye";
        btn.textContent = "üëÅ";
        btn.addEventListener("click", () => {
          inp.type = (inp.type === "password") ? "text" : "password";
        });
        wrap.appendChild(btn);
      }

      wrapWithEye("loginPass");
      wrapWithEye("loginCode");
      wrapWithEye("regPass");
      wrapWithEye("regPass2");
      wrapWithEye("regCode");

      // ====== LOGIN (password) ======
      const formLogin = $("formLogin");
      const loginEmail = $("loginEmail");
      const loginPass  = $("loginPass");
      const btnLogin   = $("btnLogin");

      const loginCodeBox = $("loginCodeBox");
      const loginCode    = $("loginCode");
      const btnLoginByCode = $("btnLoginByCode");
      const btnSendLoginCode = $("btnSendLoginCode");
      const btnVerifyLoginCode = $("btnVerifyLoginCode");
      const btnResendLoginCode = $("btnResendLoginCode");
      const btnBackToPass = $("btnBackToPass");

      function showLoginCodeBox(show){
        loginCodeBox.style.display = show ? "block" : "none";
      }

      btnLoginByCode.addEventListener("click", () => {
        clearToast();
        showLoginCodeBox(true);
        loginPass.value = ""; // —á—Ç–æ–±—ã –Ω–µ –ø—É—Ç–∞–ª–æ
        setTimeout(() => loginCode.focus(), 50);
      });

      btnBackToPass.addEventListener("click", () => {
        clearToast();
        showLoginCodeBox(false);
        setTimeout(() => loginPass.focus(), 50);
      });

      loginCode.addEventListener("input", () => {
        loginCode.value = sanitizeCode(loginCode.value);
      });

      async function requestLoginCode(){
        clearToast();
        const email = (loginEmail.value || "").trim().toLowerCase();
        if(!email) return showToast("–°–Ω–∞—á–∞–ª–∞ —É–∫–∞–∂–∏ email.", "err");

        btnSendLoginCode.disabled = true;
        try{
          const resp = await post(ENDPOINTS.login, { email });
          const token = normalizeToken(resp);
          if(token){
            localStorage.setItem(TOKEN_KEY, token);
            showToast("–ì–æ—Ç–æ–≤–æ. –í—Ö–æ–¥–∏–º‚Ä¶", "ok");
            return redirectAfterLogin();
          }
          showToast("–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ email. –í–≤–µ–¥–∏ 6 —Ü–∏—Ñ—Ä –∏ –Ω–∞–∂–º–∏ ¬´–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å¬ª.", "ok");
          showLoginCodeBox(true);
          setTimeout(() => loginCode.focus(), 50);
        }catch(err){
          showToast(err.message || "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥.", "err");
        }finally{
          btnSendLoginCode.disabled = false;
        }
      }

      async function verifyLoginCode(){
        clearToast();
        const email = (loginEmail.value || "").trim().toLowerCase();
        const code  = sanitizeCode(loginCode.value || "");
        if(!email) return showToast("–£–∫–∞–∂–∏ email.", "err");
        if(code.length !== 6) return showToast("–í–≤–µ–¥–∏ 6 —Ü–∏—Ñ—Ä –∫–æ–¥–∞.", "err");

        btnVerifyLoginCode.disabled = true;
        try{
          const resp = await post(ENDPOINTS.verify, { email, code });
          const token = normalizeToken(resp);
          if(!token) return showToast("–°–µ—Ä–≤–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª token –ø–æ—Å–ª–µ verify.", "err");
          localStorage.setItem(TOKEN_KEY, token);
          showToast("–ì–æ—Ç–æ–≤–æ. –í—Ö–æ–¥–∏–º‚Ä¶", "ok");
          redirectAfterLogin();
        }catch(err){
          showToast(err.message || "–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –∏–ª–∏ –æ—à–∏–±–∫–∞.", "err");
        }finally{
          btnVerifyLoginCode.disabled = false;
        }
      }

      btnSendLoginCode.addEventListener("click", requestLoginCode);
      btnResendLoginCode.addEventListener("click", requestLoginCode);
      btnVerifyLoginCode.addEventListener("click", verifyLoginCode);

      // submit login:
      // - –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç –±–ª–æ–∫ –∫–æ–¥–∞ –∏ –≤–≤–µ–¥–µ–Ω–æ 6 —Ü–∏—Ñ—Ä ‚Äî –¥–µ–ª–∞–µ–º verify
      // - –∏–Ω–∞—á–µ –µ—Å–ª–∏ –≤–≤–µ–¥—ë–Ω –ø–∞—Ä–æ–ª—å ‚Äî –æ–±—ã—á–Ω—ã–π login
      formLogin.addEventListener("submit", async (e) => {
        e.preventDefault();
        clearToast();

        const email = (loginEmail.value || "").trim().toLowerCase();
        const pass  = (loginPass.value || "").trim();
        const code  = sanitizeCode(loginCode.value || "");

        if(!email) return showToast("–£–∫–∞–∂–∏ email.", "err");

        if(loginCodeBox.style.display === "block" && code.length === 6){
          return verifyLoginCode();
        }

        if(!pass) return showToast("–í–≤–µ–¥–∏ –ø–∞—Ä–æ–ª—å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π ¬´–í–æ–π—Ç–∏ –ø–æ –∫–æ–¥—É¬ª.", "err");

        btnLogin.disabled = true;
        try{
          const resp = await post(ENDPOINTS.login, { email, password: pass });
          const token = normalizeToken(resp);
          if(!token) return showToast("–°–µ—Ä–≤–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª token.", "err");
          localStorage.setItem(TOKEN_KEY, token);
          showToast("–ì–æ—Ç–æ–≤–æ. –í—Ö–æ–¥–∏–º‚Ä¶", "ok");
          redirectAfterLogin();
        }catch(err){
          showToast(err.message || "–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞.", "err");
        }finally{
          btnLogin.disabled = false;
        }
      });

      // ====== RESET ======
      const btnShowReset = $("btnShowReset");
      const resetBox = $("resetBox");
      const resetEmail = $("resetEmail");
      const btnReset = $("btnReset");

      btnShowReset.addEventListener("click", () => {
        clearToast();
        resetBox.style.display = (resetBox.style.display === "none" || !resetBox.style.display) ? "block" : "none";
        if(loginEmail.value && !resetEmail.value) resetEmail.value = loginEmail.value;
      });

      btnReset.addEventListener("click", async () => {
        clearToast();
        const email = (resetEmail.value || loginEmail.value || "").trim().toLowerCase();
        if(!email) return showToast("–£–∫–∞–∂–∏ email –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.", "err");

        btnReset.disabled = true;
        try{
          await post(ENDPOINTS.resetRequest, { email });
          showToast("–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å –ø–æ—á—Ç—É.", "ok");
        }catch(err){
          showToast(err.message || "–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.", "err");
        }finally{
          btnReset.disabled = false;
        }
      });

      // ====== REGISTER + VERIFY ======
      const formRegister = $("formRegister");
      const regName = $("regName");
      const regPhone = $("regPhone");
      const regEmail = $("regEmail");
      const regPass = $("regPass");
      const regPass2 = $("regPass2");
      const btnRegister = $("btnRegister");

      const verifyBox = $("verifyBox");
      const regCode = $("regCode");
      const btnVerify = $("btnVerify");
      const btnResend = $("btnResend");

      regCode.addEventListener("input", () => {
        regCode.value = sanitizeCode(regCode.value);
      });

      formRegister.addEventListener("submit", async (e) => {
        e.preventDefault();
        clearToast();

        const name = (regName.value || "").trim();
        const phone = (regPhone.value || "").trim();
        const email = (regEmail.value || "").trim().toLowerCase();
        const p1 = (regPass.value || "").trim();
        const p2 = (regPass2.value || "").trim();

        if(!name) return showToast("–£–∫–∞–∂–∏ –∏–º—è.", "err");
        if(!email) return showToast("–£–∫–∞–∂–∏ email.", "err");
        if(p1.length < 8) return showToast("–ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤.", "err");
        if(p1 !== p2) return showToast("–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç.", "err");

        btnRegister.disabled = true;
        try{
          await post(ENDPOINTS.register, { name, phone: phone || null, email, password: p1 });
          showToast("–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω. –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ email ‚Äî –≤–≤–µ–¥–∏ 6 —Ü–∏—Ñ—Ä –Ω–∏–∂–µ.", "ok");
          verifyBox.style.display = "block";
          setTimeout(() => regCode.focus(), 50);
        }catch(err){
          showToast(err.message || "–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.", "err");
        }finally{
          btnRegister.disabled = false;
        }
      });

      btnVerify.addEventListener("click", async () => {
        clearToast();
        const email = (regEmail.value || "").trim().toLowerCase();
        const code  = sanitizeCode(regCode.value || "");
        if(!email) return showToast("–£–∫–∞–∂–∏ email.", "err");
        if(code.length !== 6) return showToast("–í–≤–µ–¥–∏ 6 —Ü–∏—Ñ—Ä –∫–æ–¥–∞.", "err");

        btnVerify.disabled = true;
        try{
          const resp = await post(ENDPOINTS.verify, { email, code });
          const token = normalizeToken(resp);

          if(token){
            localStorage.setItem(TOKEN_KEY, token);
            showToast("Email –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω. –í—Ö–æ–¥–∏–º‚Ä¶", "ok");
            redirectAfterLogin();
          }else{
            // –µ—Å–ª–∏ verify –Ω–µ –æ—Ç–¥–∞—ë—Ç token (–Ω–∞ –≤—Å—è–∫–∏–π)
            showToast("Email –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω. –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ ¬´–í—Ö–æ–¥¬ª.", "ok");
            setTab("login");
            loginEmail.value = email;
            showLoginCodeBox(true);
          }
        }catch(err){
          showToast(err.message || "–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.", "err");
        }finally{
          btnVerify.disabled = false;
        }
      });

      // resend –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: –∏—Å–ø–æ–ª—å–∑—É–µ–º login {email} –∫–∞–∫ ‚Äú–≤—ã—Å–ª–∞—Ç—å –∫–æ–¥ –µ—â—ë —Ä–∞–∑‚Äù
      btnResend.addEventListener("click", async () => {
        clearToast();
        const email = (regEmail.value || "").trim().toLowerCase();
        if(!email) return showToast("–£–∫–∞–∂–∏ email.", "err");

        btnResend.disabled = true;
        try{
          await post(ENDPOINTS.login, { email });
          showToast("–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–≤—Ç–æ—Ä–Ω–æ.", "ok");
          setTimeout(() => regCode.focus(), 50);
        }catch(err){
          showToast(err.message || "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥.", "err");
        }finally{
          btnResend.disabled = false;
        }
      });

    })();
  </script>
</body>
</html>
