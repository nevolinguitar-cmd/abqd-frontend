<!doctype html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ABQD — Вход / Регистрация</title>

  <!-- Montserrat (brand font) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --font: "Montserrat", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.66);
      --accent: 46,124,255;
      --panelR: 22px;
      --shadow: 0 30px 110px rgba(0,0,0,.55);

      /* ✅ ВАЖНО: «рука» и большие буквы — это ЧАСТЬ фоновой картинки.
         Чтобы получить вид как на 2‑м скрине — поставь чистую картинку коридора БЕЗ руки/букв.
         Самый правильный путь: положить файл на сервер и указать относительный путь ниже. */
      --corridorImg: url("https://static.tildacdn.com/tild3361-3261-4562-a464-333532376265/ChatGPT_Image_21__20.png");

      /* ABQD logo */
      --logoSvgUrl: "https://static.tildacdn.com/tild3437-6438-4735-a331-343834336463/_abqd.svg";

      /* размер карточки как на «правильном» варианте */
      --shellMax: 620px;
      --cardMax: 560px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--font);
      color: var(--txt);
      background: #07090d;
      overflow-x:hidden;
    }

    /* ====== BACKDROP ====== */
    .stage{
      position: relative;
      min-height: 100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 34px 18px;
      isolation:isolate;
      overflow:hidden;
    }

    .bgImage{
      position:absolute; inset:0;
      z-index:0;
      pointer-events:none;
      background-color:#000;
      background-image:
        radial-gradient(1200px 800px at 50% 44%, rgba(255,255,255,.035), rgba(0,0,0,0) 62%),
        linear-gradient(180deg, rgba(0,0,0,.72) 0%, rgba(0,0,0,.30) 46%, rgba(0,0,0,.86) 100%),
        var(--corridorImg);
      background-repeat:no-repeat;
      background-position: 50% 50%;
      background-size: cover;
      filter: saturate(1.03) contrast(1.04) brightness(.92);
      transform: translateZ(0);
    }

    /* МАСКА — временный костыль, если пока нет «чистой» картинки.
       Затем можно удалить целиком. */
    .mask{
      position:absolute; inset:0;
      z-index:1;
      pointer-events:none;
      background:
        radial-gradient(520px 520px at 88% 88%, rgba(0,0,0,.92), transparent 72%),
        radial-gradient(760px 420px at 50% 46%, rgba(0,0,0,.55), transparent 70%);
      opacity:.70;
    }

    .tint{
      position:absolute; inset:0;
      z-index:2;
      pointer-events:none;
      background:
        radial-gradient(900px 620px at 18% 12%, rgba(var(--accent), .22), transparent 55%),
        radial-gradient(900px 620px at 85% 20%, rgba(255,255,255,.08), transparent 60%),
        radial-gradient(900px 720px at 50% 92%, rgba(var(--accent), .14), transparent 66%),
        linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,0) 32%, rgba(0,0,0,.24) 100%);
    }

    .vignette{
      position:absolute; inset:0;
      z-index:3;
      pointer-events:none;
      background: radial-gradient(1300px 740px at 50% 52%, rgba(0,0,0,0) 30%, rgba(0,0,0,.62) 78%, rgba(0,0,0,.92) 100%);
      opacity:.60;
    }

    .grain{
      position:absolute; inset:0;
      z-index:4;
      pointer-events:none;
      opacity:.03;
      mix-blend-mode: overlay;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.55'/%3E%3C/svg%3E");
    }

    @media (max-width: 980px){ .grain{ display:none; } }

    /* ====== LAYOUT ====== */
    .shell{
      width: min(var(--shellMax), 100%);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 12px;
      z-index:10;
    }

    .shellLogo{
      height: clamp(70px, 7.5vw, 110px);
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
      filter: drop-shadow(0 18px 70px rgba(0,0,0,.78)) drop-shadow(0 0 34px rgba(var(--accent), .12));
    }
    .shellLogo img{ height:100%; width:auto; max-width: min(520px, 92vw); display:block; opacity:.96; }

    /* ====== CARD ====== */
    .card{
      position:relative;
      width: min(var(--cardMax), 100%);
      border-radius: var(--panelR);
      padding: 26px;
      border: 1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(1200px 700px at 20% 0%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(900px 600px at 80% 30%, rgba(120,80,255,.26), transparent 58%),
        linear-gradient(180deg, rgba(255,255,255,.06) 0%, rgba(15,18,32,.62) 50%, rgba(7,9,16,.86) 100%);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }
    .card::after{
      content:"";
      position:absolute;
      inset:1px;
      border-radius: calc(var(--panelR) - 1px);
      pointer-events:none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.12), inset 0 -1px 0 rgba(0,0,0,.22);
    }

    .tabsWrap{
      position:relative;
      z-index:1;
      display:flex;
      padding: 6px;
      border-radius: 999px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.10);
    }

    .tab{
      flex:1;
      border:0;
      border-radius: 999px;
      padding: 14px 16px;
      font-family: var(--font);
      font-weight: 800;
      font-size: 18px;
      color: rgba(255,255,255,.72);
      background: transparent;
      cursor:pointer;
      transition: transform .18s ease, background .18s ease, box-shadow .18s ease, color .18s ease;
    }

    .tab.active{
      color: rgba(255,255,255,.96);
      background: linear-gradient(180deg, rgba(46,124,255,.55), rgba(46,124,255,.22));
      box-shadow: 0 16px 60px rgba(0,0,0,.35);
      border: 1px solid rgba(46,124,255,.35);
    }
    .tab:active{ transform: scale(.99); }

    .pane{ display:none; padding: 20px 6px 6px; position:relative; z-index:1; }
    .pane.active{ display:block; }

    label{ display:block; font-size: 16px; color: rgba(255,255,255,.70); margin: 14px 0 8px; }

    .field{
      width:100%;
      padding: 18px 18px;
      border-radius: 18px;
      font-family: var(--font);
      font-size: 18px;
      color: rgba(255,255,255,.92);
      outline:none;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.10), inset 0 -1px 0 rgba(0,0,0,.28), 0 18px 55px rgba(0,0,0,.18);
      transition: border-color .18s ease, box-shadow .18s ease, transform .18s ease, background .18s ease;
    }
    .field::placeholder{ color: rgba(255,255,255,.40); }
    .field:focus{
      border-color: rgba(46,124,255,.62);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.12), inset 0 -1px 0 rgba(0,0,0,.30), 0 0 0 5px rgba(46,124,255,.14), 0 22px 70px rgba(0,0,0,.26);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      transform: translateY(-1px);
    }

    .btn{
      width:100%;
      border:0;
      border-radius: 20px;
      padding: 18px 18px;
      font-family: var(--font);
      font-weight: 800;
      font-size: 18px;
      color: rgba(255,255,255,.95);
      cursor:pointer;
      background: linear-gradient(180deg, rgba(46,124,255,.60), rgba(46,124,255,.26));
      border: 1px solid rgba(46,124,255,.38);
      box-shadow: 0 18px 70px rgba(0,0,0,.32);
      transition: transform .18s ease;
      margin-top: 16px;
    }
    .btn:active{ transform: translateY(1px); }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; }

    .divider{
      position: relative;
      margin: 16px 0 10px;
      text-align:center;
      color: rgba(255,255,255,.52);
      font-weight: 800;
      letter-spacing: -0.01em;
      font-size: 14px;
    }
    .divider::before,
    .divider::after{
      content:"";
      position:absolute;
      top:50%;
      width:42%;
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.14), transparent);
      transform: translateY(-50%);
    }
    .divider::before{ left:0; }
    .divider::after{ right:0; }

    .socialRow{ display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 10px; }
    @media (max-width: 980px){ .socialRow{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }

    .socialBtn{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      width:100%;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      box-shadow: inset 0 1px 0 rgba(255,255,255,.10), inset 0 -1px 0 rgba(0,0,0,.26), 0 18px 55px rgba(0,0,0,.16);
      color: rgba(255,255,255,.90);
      font-family: var(--font);
      font-weight: 800;
      font-size: 15px;
      cursor:pointer;
      user-select:none;
      transition: transform .18s ease, border-color .18s ease, box-shadow .18s ease;
    }
    .socialBtn:active{ transform: translateY(1px); }
    .socialBtn:hover{ border-color: rgba(46,124,255,.45); box-shadow: 0 0 0 4px rgba(46,124,255,.10), 0 18px 55px rgba(0,0,0,.16); }

    .socialIco{ width: 20px; height: 20px; flex: 0 0 20px; display:block; opacity:.92; filter: drop-shadow(0 8px 22px rgba(0,0,0,.35)); }

    .hint{ font-size: 13px; color: rgba(255,255,255,.56); line-height: 1.45; margin-top: 8px; }

    .toast{
      display:none;
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      color: rgba(255,255,255,.86);
      font-size: 14px;
      position:relative;
      z-index:1;
    }
    .toast.show{ display:block; }
    .toast.ok{ border-color: rgba(104,245,169, .35); }
    .toast.err{ border-color: rgba(255, 86, 110, .40); }

    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
    @media (max-width: 980px){ .row{ grid-template-columns:1fr; } }

    .linkRow{ margin-top: 10px; }
    .link{
      border:0;
      background: transparent;
      color: rgba(255,255,255,.78);
      font-family: var(--font);
      cursor:pointer;
      padding: 0;
      font-size: 15px;
      font-weight: 800;
    }
    .link:hover{ color: rgba(255,255,255,.90); }

    @media (prefers-reduced-motion: reduce){
      .bgImage{ animation:none !important; }
    }
  </style>
</head>
<body>
  <div class="stage">
    <div class="bgImage" aria-hidden="true"></div>
    <div class="mask" aria-hidden="true"></div>
    <div class="tint" aria-hidden="true"></div>
    <div class="vignette" aria-hidden="true"></div>
    <div class="grain" aria-hidden="true"></div>

    <div class="shell" role="main">
      <div class="shellLogo" aria-hidden="true">
        <img src="https://static.tildacdn.com/tild3437-6438-4735-a331-343834336463/_abqd.svg" alt="abqd" />
      </div>

      <section class="card" aria-label="Auth">
        <div class="tabsWrap" role="tablist" aria-label="Режим">
          <button class="tab active" id="tabLogin" role="tab" aria-selected="true" aria-controls="paneLogin">Вход</button>
          <button class="tab" id="tabRegister" role="tab" aria-selected="false" aria-controls="paneRegister">Регистрация</button>
        </div>

        <div id="toast" class="toast" aria-live="polite"></div>

        <div class="pane active" id="paneLogin" role="tabpanel" aria-labelledby="tabLogin">
          <form id="formLogin" autocomplete="on">
            <div>
              <label for="loginEmail">Email</label>
              <input class="field" id="loginEmail" type="email" required placeholder="name@example.com" />
            </div>
            <div>
              <label for="loginPass">Пароль</label>
              <input class="field" id="loginPass" type="password" required placeholder="••••••••" />
            </div>
            <button class="btn" id="btnLogin" type="submit">Войти</button>

            <div class="divider">или</div>

            <div class="social" aria-label="Вход через соцсети">
              <div class="socialRow">
                <button class="socialBtn" type="button" data-oauth="google" aria-label="Войти через Google">
                  <svg class="socialIco" viewBox="0 0 48 48" aria-hidden="true"><path fill="#FFC107" d="M43.6 20.5H42V20H24v8h11.3C33.7 32.7 29.3 36 24 36c-6.6 0-12-5.4-12-12s5.4-12 12-12c3 0 5.7 1.1 7.8 2.9l5.7-5.7C34.6 6 29.5 4 24 4 12.9 4 4 12.9 4 24s8.9 20 20 20c10.5 0 19-8.5 19-19 0-1.3-.1-2.6-.4-3.5z"/><path fill="#FF3D00" d="M6.3 14.7l6.6 4.8C14.7 15.1 19 12 24 12c3 0 5.7 1.1 7.8 2.9l5.7-5.7C34.6 6 29.5 4 24 4 16.3 4 9.6 8.3 6.3 14.7z"/><path fill="#4CAF50" d="M24 44c5.3 0 10.2-2 13.9-5.2l-6.4-5.2C29.4 35.2 26.8 36 24 36c-5.3 0-9.8-3.4-11.4-8.1l-6.7 5.2C9.1 39.6 16 44 24 44z"/><path fill="#1976D2" d="M43.6 20.5H42V20H24v8h11.3c-1.3 3.5-4.6 6-8.8 6-5.3 0-9.8-3.4-11.4-8.1l-6.7 5.2C9.1 39.6 16 44 24 44c10.5 0 19-8.5 19-19 0-1.3-.1-2.6-.4-3.5z"/></svg>
                  Google
                </button>

                <button class="socialBtn" type="button" data-oauth="apple" aria-label="Войти через Apple">
                  <svg class="socialIco" viewBox="0 0 1792 1792" aria-hidden="true"><circle cx="896" cy="896" r="896" fill="#0f1116"/><path fill="#ffffff" d="M1585 1215q-39 125-123 250-129 196-257 196-49 0-140-32-86-32-151-32-61 0-142 33-81 34-132 34-152 0-301-259-147-261-147-503 0-228 113-374 113-144 284-144 72 0 177 30 104 30 138 30 45 0 143-34 102-34 173-34 119 0 213 65 52 36 104 100-79 67-114 118-65 94-65 207 0 124 69 223t158 126zm-376-1173q0 61-29 136-30 75-93 138-54 54-108 72-37 11-104 17 3-149 78-257 74-107 250-148 1 3 2.5 11t2.5 11q0 4 .5 10t.5 10z"/></svg>
                  Apple
                </button>

                <button class="socialBtn" type="button" data-oauth="vk" aria-label="Войти через VK">
                  <svg class="socialIco" viewBox="0 0 24 24" aria-hidden="true"><rect x="0" y="0" width="24" height="24" rx="6" fill="#0077FF"/><path fill="#fff" d="M3.2 7.5c.1 5.3 2.8 9 7.2 9h.4v-3c1.7.2 3 1.4 3.5 3h2.4c-.6-2.3-2-3.6-3-4.1 1-.6 2.3-2.1 2.7-4.9h-2.2c-.5 2-1.8 3.7-3.4 3.9V7.5H9.7v6.8C8 13.9 6.7 12.1 6.6 7.5H3.2z"/></svg>
                  VK
                </button>

                <button class="socialBtn" type="button" data-oauth="telegram" aria-label="Войти через Telegram">
                  <svg class="socialIco" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="12" fill="#2AABEE"/><path fill="#ffffff" d="M17.86 7.2 6.98 11.4c-.74.29-.73 1.36.02 1.62l2.78.92 1.05 3.37c.18.59.93.72 1.3.23l1.52-2.01 2.92 2.16c.52.39 1.27.11 1.39-.55l1.93-9.12c.15-.72-.56-1.27-1.11-1.06zM9.92 13.48l6.34-4.03c.19-.12.39.14.23.29l-5.18 4.76-.19 2.58-1.06-3.6c-.08-.28.01-.59.24-.78z"/></svg>
                  Telegram
                </button>

                <button class="socialBtn" type="button" data-oauth="yandex" aria-label="Войти через Яндекс">
                  <svg class="socialIco" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="12" fill="#ffffff"/><text x="12" y="12" text-anchor="middle" dominant-baseline="middle" font-family="Montserrat, Arial, sans-serif" font-weight="800" font-size="14" fill="#FC3F1D">Я</text></svg>
                  Яндекс
                </button>

                <button class="socialBtn" type="button" data-oauth="ok" aria-label="Войти через OK">
                  <svg class="socialIco" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="12" fill="#EE8208"/><path fill="#fff" d="M12 2a5 5 0 1 0 0 10 5 5 0 0 0 0-10zm0 2.4a2.6 2.6 0 1 1 0 5.2 2.6 2.6 0 0 1 0-5.2zM7.2 13.2a1.2 1.2 0 0 0-.7 2.2c1.6 1 3.2 1.6 4.8 1.8l-2.2 2.3a1.2 1.2 0 1 0 1.7 1.7L12 20l1.2 1.2a1.2 1.2 0 1 0 1.7-1.7l-2.2-2.3c1.6-.2 3.2-.8 4.8-1.8a1.2 1.2 0 1 0-1.3-2c-1.6 1-3 1.4-4.2 1.4s-2.6-.4-4.2-1.4a1.2 1.2 0 0 0-.6-.2z"/></svg>
                  OK
                </button>
              </div>
            </div>

            <div class="linkRow">
              <button class="link" type="button" id="btnShowReset">Забыли пароль?</button>
            </div>

            <div id="resetBox" style="display:none; margin-top:10px;">
              <label for="resetEmail">Email для восстановления</label>
              <input class="field" id="resetEmail" type="email" placeholder="name@example.com" />
              <button class="btn" id="btnReset" type="button" style="margin-top:10px;">Отправить</button>
              <div class="hint">Письмо придёт на указанный email.</div>
            </div>
          </form>
        </div>

        <div class="pane" id="paneRegister" role="tabpanel" aria-labelledby="tabRegister">
          <form id="formRegister" autocomplete="on">
            <div class="divider">быстро</div>
            <div class="row">
              <div>
                <label for="regName">Имя</label>
                <input class="field" id="regName" type="text" required placeholder="Александр" />
              </div>
              <div>
                <label for="regPhone">Телефон</label>
                <input class="field" id="regPhone" type="tel" inputmode="tel" required placeholder="+7 999 000-12-34" />
                <div class="hint">В международном формате: +7… / +385…</div>
              </div>
            </div>

            <div>
              <label for="regEmail">Email</label>
              <input class="field" id="regEmail" type="email" required placeholder="name@example.com" />
            </div>

            <div class="row">
              <div>
                <label for="regPass">Пароль</label>
                <input class="field" id="regPass" type="password" required placeholder="Минимум 8 символов" />
              </div>
              <div>
                <label for="regPass2">Повтори пароль</label>
                <input class="field" id="regPass2" type="password" required placeholder="Повтори" />
              </div>
            </div>

            <button class="btn" id="btnRegister" type="submit">Создать аккаунт</button>
            <div class="hint" style="margin-top:10px;">Нажимая «Создать аккаунт», вы подтверждаете согласие на обработку данных.</div>
          </form>
        </div>

      </section>
    </div>
  </div>

  <script>
    // === DEPLOY CONFIG (Yandex Cloud VM) ===
    const BACKEND_ORIGIN = window.location.origin;

    const API = {
      login: BACKEND_ORIGIN + "/api/v1/auth/login",
      register: BACKEND_ORIGIN + "/api/v1/auth/register",
      resetRequest: BACKEND_ORIGIN + "/api/v1/auth/reset/request"
    };

    const AFTER_LOGIN = BACKEND_ORIGIN + "/constructor/";

    // OAuth start endpoints (server must implement these маршруты)
    const OAUTH_START = BACKEND_ORIGIN + "/api/v1/auth/oauth";

    function navigateTo(url){
      try{
        if(window.top && window.top !== window.self) window.top.location.href = url;
        else window.location.href = url;
      }catch(_e){
        window.location.href = url;
      }
    }

    function oauthStartUrl(provider){
      return OAUTH_START + "/" + encodeURIComponent(provider) + "/start?return=" + encodeURIComponent(AFTER_LOGIN);
    }

    (function takeTokenFromUrl(){
      try{
        var u = new URL(window.location.href);
        var t = u.searchParams.get("access_token") || u.searchParams.get("token") || "";
        if(t){
          localStorage.setItem("abqd_token", t);
          u.searchParams.delete("access_token");
          u.searchParams.delete("token");
          window.history.replaceState({}, "", u.toString());
          setTimeout(function(){ navigateTo(AFTER_LOGIN); }, 150);
        }
      }catch(_e){}
    })();

    (function bindOAuthButtons(){
      var btns = document.querySelectorAll('[data-oauth]');
      for(var i=0;i<btns.length;i++){
        (function(btn){
          btn.addEventListener('click', function(){
            clearToast();
            var p = btn.getAttribute('data-oauth') || '';
            if(!p) return;
            window.location.href = oauthStartUrl(p);
          });
        })(btns[i]);
      }
    })();

    const toast = document.getElementById("toast");

    function safeMsg(x){
      if(x == null) return "";
      if(typeof x === "string") return x;
      if(typeof x === "number" || typeof x === "boolean") return String(x);
      try{ return JSON.stringify(x); }catch(_e){ return String(x); }
    }

    function showToast(msg, kind){
      toast.className = "toast show " + (kind === "ok" ? "ok" : kind === "err" ? "err" : "");
      toast.textContent = safeMsg(msg) || "Ошибка";
    }
    function clearToast(){ toast.className = "toast"; toast.textContent = ""; }

    async function postJSON(url, data){
      const r = await fetch(url, {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(data)
      });
      const text = await r.text();
      let json = null;
      try{ json = text ? JSON.parse(text) : null; } catch(_e){ json = null; }
      if(!r.ok){
        let detail = "HTTP " + r.status;
        if(json && (json.detail != null)) detail = json.detail;
        else if(json && (json.error != null)) detail = json.error;
        else if(text) detail = text;
        throw new Error(safeMsg(detail));
      }
      return json;
    }

    function setBusy(btn, busy){
      if(!btn) return;
      btn.disabled = !!busy;
      btn.dataset._t = btn.dataset._t || btn.textContent;
      btn.textContent = busy ? "Подожди…" : btn.dataset._t;
    }

    const tabLogin = document.getElementById("tabLogin");
    const tabRegister = document.getElementById("tabRegister");
    const paneLogin = document.getElementById("paneLogin");
    const paneRegister = document.getElementById("paneRegister");

    function readInitialTab(){
      try{
        var u = new URL(window.location.href);
        var q = (u.searchParams.get("tab") || u.searchParams.get("mode") || "").toLowerCase();
        var h = (u.hash || "").replace("#", "").toLowerCase();
        var v = q || h;
        if(v === "register" || v === "signup" || v === "reg") return "register";
        return "login";
      }catch(_e){
        var hh = (window.location.hash || "").replace("#", "").toLowerCase();
        if(hh === "register" || hh === "signup" || hh === "reg") return "register";
        return "login";
      }
    }

    function syncTabToUrl(which){
      try{
        var u2 = new URL(window.location.href);
        u2.searchParams.set("tab", (which === "register") ? "register" : "login");
        u2.hash = "";
        window.history.replaceState({}, "", u2.toString());
      }catch(_e){}
    }

    function setTab(which, fromUrl){
      clearToast();
      var isLogin = (which !== "register");
      tabLogin.classList.toggle("active", isLogin);
      tabRegister.classList.toggle("active", !isLogin);
      tabLogin.setAttribute("aria-selected", String(isLogin));
      tabRegister.setAttribute("aria-selected", String(!isLogin));
      paneLogin.classList.toggle("active", isLogin);
      paneRegister.classList.toggle("active", !isLogin);
      if(!fromUrl) syncTabToUrl(isLogin ? "login" : "register");
    }

    tabLogin.addEventListener("click", ()=>setTab("login"));
    tabRegister.addEventListener("click", ()=>setTab("register"));

    setTab(readInitialTab(), true);
    window.addEventListener("popstate", ()=>setTab(readInitialTab(), true));

    const formLogin = document.getElementById("formLogin");
    const btnLogin = document.getElementById("btnLogin");

    formLogin.addEventListener("submit", async (ev)=>{
      ev.preventDefault();
      clearToast();
      const email = (document.getElementById("loginEmail").value || "").trim();
      const password = document.getElementById("loginPass").value || "";
      if(!email || !password){ showToast("Заполни email и пароль.", "err"); return; }

      setBusy(btnLogin, true);
      try{
        const res = await postJSON(API.login, { email, password });
        const token = res && (res.access_token || res.token);
        if(token) localStorage.setItem("abqd_token", token);
        showToast("Вход выполнен. Перенаправляю…", "ok");
        setTimeout(()=>{ navigateTo(AFTER_LOGIN); }, 450);
      }catch(e){
        showToast(e && e.message ? e.message : e, "err");
      }finally{
        setBusy(btnLogin, false);
      }
    });

    const btnShowReset = document.getElementById("btnShowReset");
    const resetBox = document.getElementById("resetBox");
    const btnReset = document.getElementById("btnReset");

    btnShowReset.addEventListener("click", ()=>{
      clearToast();
      resetBox.style.display = (resetBox.style.display === "none" || !resetBox.style.display) ? "block" : "none";
    });

    btnReset.addEventListener("click", async ()=>{
      clearToast();
      const email1 = (document.getElementById("resetEmail").value || "").trim();
      const email2 = (document.getElementById("loginEmail").value || "").trim();
      const email = email1 || email2;
      if(!email){ showToast("Укажи email для восстановления.", "err"); return; }
      setBusy(btnReset, true);
      try{
        await postJSON(API.resetRequest, { email: email });
        showToast("Отправили письмо. Проверь входящие/спам.", "ok");
      }catch(e){
        showToast(e && e.message ? e.message : e, "err");
      }finally{
        setBusy(btnReset, false);
      }
    });

    const formRegister = document.getElementById("formRegister");
    const btnRegister = document.getElementById("btnRegister");

    function normalizePhone(p){
      p = String(p||"").trim();
      var out = "";
      for(var i=0;i<p.length;i++){
        var ch = p.charAt(i);
        if(ch === " " || ch === "(" || ch === ")" || ch === "-") continue;
        out += ch;
      }
      return out;
    }

    formRegister.addEventListener("submit", async (ev)=>{
      ev.preventDefault();
      clearToast();

      const name = (document.getElementById("regName").value || "").trim();
      const email = (document.getElementById("regEmail").value || "").trim();
      const phone = normalizePhone(document.getElementById("regPhone").value || "");
      const password = document.getElementById("regPass").value || "";
      const password2 = document.getElementById("regPass2").value || "";

      if(!name || !email || !phone || !password){ showToast("Имя, телефон, email и пароль обязательны.", "err"); return; }
      if(password.length < 8){ showToast("Пароль слишком короткий (минимум 8).", "err"); return; }
      if(password !== password2){ showToast("Пароли не совпадают.", "err"); return; }

      setBusy(btnRegister, true);
      try{
        await postJSON(API.register, { name: name, email: email, phone: phone, password: password });
        const res = await postJSON(API.login, { email: email, password: password });
        const token = res && (res.access_token || res.token);
        if(token) localStorage.setItem("abqd_token", token);

        showToast("Аккаунт создан. Перенаправляю…", "ok");
        setTimeout(()=>{ navigateTo(AFTER_LOGIN); }, 450);
      }catch(e){
        showToast(e && e.message ? e.message : e, "err");
      }finally{
        setBusy(btnRegister, false);
      }
    });
  </script>
</body>
</html>
