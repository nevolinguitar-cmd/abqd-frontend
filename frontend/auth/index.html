<script>
(() => {
  const API_ORIGIN = "https://api.abqd.ru";
  const API_BASE = API_ORIGIN + "/api/v1";
  const LS_TOKEN_KEY = "abqd_token";

  const $ = (id) => document.getElementById(id);

  function showToast(msg, kind="err"){
    const el = $("toast");
    el.className = "toast show " + (kind === "ok" ? "ok" : "err");
    el.textContent = msg;
  }
  function hideToast(){
    const el = $("toast");
    el.className = "toast";
    el.textContent = "";
  }
  function setBusy(btn, busy, textBusy="Подождите…"){
    if(!btn) return;
    if(!btn.dataset.txt) btn.dataset.txt = btn.textContent;
    btn.disabled = !!busy;
    btn.textContent = busy ? textBusy : btn.dataset.txt;
  }
  function safeStr(v){
    if(v === null || v === undefined) return "";
    if(typeof v === "string") return v;
    try { return JSON.stringify(v); } catch { return String(v); }
  }

  async function fetchJson(path, { method="GET", body=null, headers={} } = {}){
    const url = path.startsWith("http") ? path : (API_BASE + path);
    const h = Object.assign({}, headers);
    if(body !== null) h["content-type"] = "application/json";

    const res = await fetch(url, {
      method,
      headers: h,
      body: body !== null ? JSON.stringify(body) : undefined,
      credentials: "omit",
    });

    const text = await res.text();
    let json = null;
    try { json = text ? JSON.parse(text) : null; } catch {}
    const hdrs = {};
    try { for (const [k,v] of res.headers.entries()) hdrs[k.toLowerCase()] = v; } catch {}

    return { ok: res.ok, status: res.status, json, text, headers: hdrs, url };
  }

  function pickError(r){
    const j = r && r.json;
    if(j && typeof j === "object"){
      return j.detail || j.message || safeStr(j);
    }
    return (r && r.text) ? r.text : ("HTTP " + (r ? r.status : "ERR"));
  }

  function extractTokenFromJson(obj){
    if(!obj || typeof obj !== "object") return "";
    const candidates = [
      obj.token,
      obj.access_token,
      obj.accessToken,
      obj.jwt,
      obj?.data?.token,
      obj?.data?.access_token,
      obj?.result?.token,
    ];
    for(const t of candidates){
      if(typeof t === "string" && t.trim().length >= 12) return t.trim();
    }
    // рекурсивный поиск ключей token/jwt
    const seen = new Set();
    const stack = [obj];
    while(stack.length){
      const cur = stack.pop();
      if(!cur || typeof cur !== "object" || seen.has(cur)) continue;
      seen.add(cur);
      for(const [k,v] of Object.entries(cur)){
        if(typeof v === "string" && /token|jwt/i.test(k) && v.trim().length >= 12){
          return v.trim();
        }
        if(v && typeof v === "object") stack.push(v);
      }
    }
    return "";
  }

  function extractToken(r){
    const t1 = extractTokenFromJson(r && r.json);
    if(t1) return t1;
    const h = (r && r.headers) || {};
    const auth = h["authorization"] || h["x-abqd-token"] || h["x-token"];
    if(typeof auth === "string" && auth.length >= 12){
      return auth.replace(/^Bearer\s+/i, "").trim();
    }
    return "";
  }

  function openCodeBox(){
    const box = $("codeBox");
    if(box) box.style.display = "block";
  }

  async function apiLogin(email, password){
    const r = await fetchJson("/auth/login", { method:"POST", body:{ email, password } });
    if(!r.ok) throw new Error(pickError(r));

    const token = extractToken(r);
    if(token){
      localStorage.setItem(LS_TOKEN_KEY, token);
      return { stage:"ok", token };
    }

    // ВАЖНО: если сервер 2-шаговый — 200 без token часто значит "код отправлен"
    return {
      stage: "code_sent",
      token: "",
      raw: (r.text || "").slice(0, 300)
    };
  }

  async function apiMe(token){
    const r = await fetchJson("/auth/me", { method:"GET", headers:{ "Authorization":"Bearer " + token } });
    if(r.ok && r.json) return r.json;
    return null;
  }

  function redirectAfterLogin(me){
    const params = new URLSearchParams(location.search);
    const next = params.get("next");
    if(next){ location.href = next; return; }
    if(me && (me.role === "ceo" || me.role === "admin")){ location.href = "/dashboard/"; return; }
    location.href = "/constructor/";
  }

  // ✅ Запрос кода: пробуем несколько реальных вариантов, пока один не сработает.
  async function apiRequestCode(email){
    const tries = [
      { path:"/auth/verify", body:{ email } },
      { path:"/auth/verify", body:{ login: email } },
      { path:"/auth/verify", body:{ username: email } },

      // иногда код шлётся через login при пустом password
      { path:"/auth/login", body:{ email, password:"" } },
      { path:"/auth/login", body:{ email } },

      // крайний вариант (если у вас код реализован как reset)
      { path:"/auth/reset/request", body:{ email } },
    ];

    const errors = [];
    for(const t of tries){
      const r = await fetchJson(t.path, { method:"POST", body:t.body });
      if(r.ok){
        return { used: t.path, response: r.json || r.text };
      }
      errors.push(`${t.path} HTTP ${r.status}: ${pickError(r)}`);
    }
    throw new Error("Не получилось запросить код.\n" + errors.join("\n"));
  }

  async function apiLoginByCode(email, code){
    // 1) код как password
    let r = await fetchJson("/auth/login", { method:"POST", body:{ email, password: code } });
    if(r.ok){
      const token = extractToken(r);
      if(token){
        localStorage.setItem(LS_TOKEN_KEY, token);
        return token;
      }
      throw new Error("Login OK, но token не пришёл. Ответ: " + ((r.text||"").slice(0,300) || "(пусто)"));
    }

    // 2) verify {email, code} (если у вас так устроено)
    r = await fetchJson("/auth/verify", { method:"POST", body:{ email, code } });
    if(!r.ok) throw new Error(pickError(r));
    const token = extractToken(r);
    if(!token) throw new Error("Verify OK, но token не пришёл. Ответ: " + ((r.text||"").slice(0,300) || "(пусто)"));
    localStorage.setItem(LS_TOKEN_KEY, token);
    return token;
  }

  // ===== UI =====
  function activateTab(which){
    hideToast();
    const isLogin = which === "login";
    $("tabLogin").classList.toggle("active", isLogin);
    $("tabRegister").classList.toggle("active", !isLogin);
    $("paneLogin").classList.toggle("active", isLogin);
    $("paneRegister").classList.toggle("active", !isLogin);
  }

  $("tabLogin").addEventListener("click", () => activateTab("login"));
  $("tabRegister").addEventListener("click", () => activateTab("register"));

  document.addEventListener("click", (e) => {
    const btn = e.target.closest("[data-toggle]");
    if(!btn) return;
    const sel = btn.getAttribute("data-toggle");
    const inp = document.querySelector(sel);
    if(!inp) return;
    const isPwd = inp.type === "password";
    inp.type = isPwd ? "text" : "password";
    btn.textContent = isPwd ? "Скрыть" : "Показать";
  });

  $("btnShowReset").addEventListener("click", () => {
    hideToast();
    const box = $("resetBox");
    box.style.display = box.style.display === "none" ? "block" : "none";
  });

  $("btnShowCode").addEventListener("click", () => {
    hideToast();
    const box = $("codeBox");
    box.style.display = box.style.display === "none" ? "block" : "none";
  });

  // ===== LOGIN submit =====
  $("formLogin").addEventListener("submit", async (e) => {
    e.preventDefault();
    hideToast();

    const email = $("loginEmail").value.trim();
    const pass = $("loginPass").value;

    if(!email){
      showToast("Заполни email.", "err");
      return;
    }
    if(!pass){
      showToast("Введи пароль или используй “Вход по коду”.", "err");
      return;
    }

    const btn = $("btnLogin");
    try{
      setBusy(btn, true);

      const res = await apiLogin(email, pass);

      if(res.stage === "ok"){
        const me = await apiMe(res.token);
        showToast("Вход выполнен.", "ok");
        redirectAfterLogin(me);
        return;
      }

      // ✅ 2-шаговый сценарий: token нет — считаем что код отправили
      openCodeBox();
      showToast(
        "Код отправлен на почту (если письмо не пришло — проверь спам).\n" +
        "Если письма нет — значит сервер не отправил. Тогда смотри логи SMTP.\n" +
        (res.raw ? ("Ответ сервера: " + res.raw) : ""),
        "ok"
      );
      $("loginCode").focus();

    }catch(err){
      showToast(String(err && err.message ? err.message : err), "err");
    }finally{
      setBusy(btn, false);
    }
  });

  // ===== CODE request =====
  $("btnCodeRequest").addEventListener("click", async () => {
    hideToast();
    const email = $("loginEmail").value.trim();
    if(!email){
      showToast("Сначала введи email (вверху).", "err");
      return;
    }

    const btn = $("btnCodeRequest");
    try{
      setBusy(btn, true);
      const out = await apiRequestCode(email);
      openCodeBox();
      showToast("Запрос кода выполнен через " + out.used + ". Проверь почту/спам.", "ok");
      $("loginCode").focus();
    }catch(err){
      showToast(String(err && err.message ? err.message : err), "err");
    }finally{
      setBusy(btn, false);
    }
  });

  // ===== CODE login =====
  $("btnCodeLogin").addEventListener("click", async () => {
    hideToast();
    const email = $("loginEmail").value.trim();
    const code = ($("loginCode").value || "").trim();

    if(!email){ showToast("Введи email (вверху).", "err"); return; }
    if(!/^\d{6}$/.test(code)){ showToast("Код должен быть 6 цифр.", "err"); return; }

    const btn = $("btnCodeLogin");
    try{
      setBusy(btn, true);
      const token = await apiLoginByCode(email, code);
      const me = await apiMe(token);
      showToast("Вход по коду выполнен.", "ok");
      redirectAfterLogin(me);
    }catch(err){
      showToast(String(err && err.message ? err.message : err), "err");
    }finally{
      setBusy(btn, false);
    }
  });

  // ===== RESET =====
  $("btnReset").addEventListener("click", async () => {
    hideToast();
    const email = ($("resetEmail").value || $("loginEmail").value || "").trim();
    if(!email){ showToast("Введи email для восстановления.", "err"); return; }

    const btn = $("btnReset");
    try{
      setBusy(btn, true);
      const r = await fetchJson("/auth/reset/request", { method:"POST", body:{ email } });
      if(!r.ok) throw new Error(pickError(r));
      showToast("Если email существует — письмо отправлено.", "ok");
    }catch(err){
      showToast(String(err && err.message ? err.message : err), "err");
    }finally{
      setBusy(btn, false);
    }
  });

  // мелочь: автоподстановка email
  $("loginEmail").addEventListener("input", () => {
    if($("resetEmail").value.trim() === "") $("resetEmail").value = $("loginEmail").value.trim();
  });

})();
</script>
