<!doctype html>
<html lang="ru" data-theme="soft">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ABQD • Профиль</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --font: 'Montserrat', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      --r1:16px;
      --r2:22px;

      --bg:#0b0c10;
      --panel:#0f1117;
      --panel2:#11131b;
      --text:#eef1f6;
      --muted:rgba(238,241,246,.66);
      --line:rgba(255,255,255,.13);
      --shadow:0 18px 60px rgba(0,0,0,.30);

      --primary1:#ff4d9d;
      --primary2:#6d5cff;

      --gridBg: rgba(255,255,255,.03);
      --ok:#39d98a;
    }

    html[data-theme="soft"]{
      --bg:#f4f6fb;
      --panel:rgba(255,255,255,.62);
      --panel2:rgba(255,255,255,.78);
      --text:#10131a;
      --muted:rgba(16,19,26,.56);
      --line:rgba(16,19,26,.14);
      --shadow:0 18px 60px rgba(18,24,40,.12);

      --primary1:#2563eb;
      --primary2:#7c3aed;

      --gridBg: rgba(255,255,255,.42);
      --ok:#39d98a;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      font-size:15.5px;
      line-height:1.62;
      background:
        radial-gradient(1100px 700px at 15% 10%, rgba(109,92,255,.16), transparent 55%),
        radial-gradient(1100px 700px at 85% 15%, rgba(255,77,157,.14), transparent 55%),
        var(--bg);
    }
    body::before{
      content:"";
      position:fixed;inset:0;pointer-events:none;z-index:0;
      opacity:.055;mix-blend-mode:overlay;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.55'/%3E%3C/svg%3E");
      transform:translateZ(0)
    }

    .wrap{position:relative;z-index:1;max-width:980px;margin:0 auto;padding:18px 14px 44px;}
    @media (max-width:560px){ .wrap{padding-top:18px} }

    .card{
      position:relative;
      border:1px solid var(--line);
      background:
        radial-gradient(120% 140% at 10% 0%, rgba(255,255,255,.10), transparent 55%),
        linear-gradient(180deg,var(--panel),rgba(255,255,255,.04));
      border-radius:var(--r2);
      box-shadow:var(--shadow);
      backdrop-filter:blur(12px);
      overflow:hidden
    }
    .card::before{
      content:"";position:absolute;inset:0;border-radius:inherit;pointer-events:none;
      background:linear-gradient(135deg, rgba(255,255,255,.22), transparent 42%, rgba(255,255,255,.10));
      opacity:.18;mix-blend-mode:overlay
    }
    html[data-theme="soft"] .card::before{opacity:.10;mix-blend-mode:normal}

    .cardHd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px
    }
    .cardHd b{font-size:12px;letter-spacing:.16em;text-transform:uppercase;color:var(--muted)}
    .mini{font-size:12px;color:var(--muted);font-weight:800}

    .hero{padding:16px}

    .banner{
      position:relative;height:220px;border-radius:var(--r2);overflow:hidden;
      border:1px solid var(--line);background:rgba(0,0,0,.10);z-index:1
    }
    .bannerPlh{
      position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      font-weight:800;letter-spacing:.12em;text-transform:uppercase;font-size:12px;
      color:var(--muted);background:linear-gradient(180deg, rgba(255,255,255,.06), transparent);
      pointer-events:none
    }
    html[data-theme="soft"] .bannerPlh{background:linear-gradient(180deg, rgba(255,255,255,.30), transparent)}
    .banner img{width:100%;height:100%;object-fit:cover;display:block}

    .bannerLogo{
      position:absolute;right:12px;top:12px;width:56px;height:56px;border-radius:16px;
      border:1px solid var(--line);background:rgba(0,0,0,.18);backdrop-filter:blur(10px);
      display:flex;align-items:center;justify-content:center;overflow:hidden;text-decoration:none;
      box-shadow:0 10px 30px rgba(0,0,0,.18)
    }
    html[data-theme="soft"] .bannerLogo{background:rgba(255,255,255,.55)}
    .bannerLogo img{width:100%;height:100%;object-fit:cover;display:block}

    .heroHead{
      margin-top:-54px;
      display:flex;align-items:flex-end;justify-content:space-between;gap:12px;flex-wrap:wrap;
      padding:0 10px;position:relative;z-index:3
    }
    .left{display:flex;align-items:flex-end;gap:12px}
    .avatar{
      width:106px;height:106px;border-radius:999px;border:4px solid rgba(255,255,255,.9);
      overflow:hidden;background:rgba(0,0,0,.18);
      box-shadow:0 18px 60px rgba(0,0,0,.20);
      flex:0 0 auto;display:flex;align-items:center;justify-content:center;
      position:relative;z-index:4
    }
    .avatar img{width:100%;height:100%;object-fit:cover;display:block}
    .avatar .fallback{font-weight:800;font-size:38px;opacity:.92}

    .nm{margin:0;font-size:28px;letter-spacing:-.02em;line-height:1.08;font-weight:800}
    .rl{margin:6px 0 0;color:var(--muted);letter-spacing:.14em;text-transform:uppercase;font-size:12px;font-weight:800}

    .about{padding:10px 10px 14px}
    .h2{margin:10px 0 10px;letter-spacing:.16em;text-transform:uppercase;font-size:12px;color:var(--muted);font-weight:800}
    .aboutText{margin:0;line-height:1.72;font-size:14.5px;white-space:pre-wrap;color:rgba(238,241,246,.78)}
    html[data-theme="soft"] .aboutText{color:rgba(16,19,26,.72)}

    .cta{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .cta a{
      border:1px solid var(--line);border-radius:999px;padding:11px 14px;font-weight:800;font-size:13px;text-decoration:none;
      color:#fff;background:rgba(0,0,0,.22);
      position:relative;overflow:hidden;isolation:isolate;transform:translateZ(0);
      transition:transform .14s ease, filter .14s ease
    }
    .cta a:active{transform:translateY(1px)}
    .cta a.primary{border:0 !important;background:transparent !important;color:#fff !important;border-radius:999px;overflow:hidden;position:relative;isolation:isolate;transform:translateZ(0);box-shadow:0 10px 26px rgba(0,0,0,.14)}
    .cta a.primary::before{content:"";position:absolute;inset:-1px;background:linear-gradient(90deg,var(--primary1),var(--primary2));border-radius:inherit;z-index:-1;transform:translateZ(0)}
    html[data-theme="soft"] .cta a.primary{color:var(--text) !important;text-shadow:none;border:1px solid rgba(16,19,26,.16) !important;box-shadow:0 16px 36px rgba(18,24,40,.14),0 1px 0 rgba(255,255,255,.70) inset,0 -1px 0 rgba(0,0,0,.06) inset}
    html[data-theme="soft"] .cta a.primary::before{background:linear-gradient(180deg, rgba(226,229,235,.98) 0%, rgba(196,203,214,.96) 48%, rgba(168,177,191,.95) 100%)}

    .section{padding:16px}
    .secTitle{margin:0 0 12px;font-size:12px;letter-spacing:.18em;text-transform:uppercase;color:var(--muted);font-weight:800}
    .hide{display:none!important}

    .chipsRow{display:flex;flex-wrap:wrap;gap:10px}
    .chipA{
      display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:999px;border:1px solid var(--line);
      background:rgba(0,0,0,.05);text-decoration:none;color:var(--muted)!important;font-weight:800;font-size:12px;
      transition:transform .14s ease, filter .14s ease
    }
    html[data-theme="soft"] .chipA{background:rgba(255,255,255,.45)}
    .chipA:hover{color:var(--text)!important}
    .chipA:active{transform:translateY(1px)}
    .chipI{opacity:.9;color:var(--muted)}

    .list{display:flex;flex-direction:column;gap:10px}
    .item{border:1px solid var(--line);background:rgba(0,0,0,.05);border-radius:var(--r1);padding:12px;display:flex;gap:12px;align-items:flex-start;overflow:hidden}
    html[data-theme="soft"] .item{background:rgba(255,255,255,.45)}
    .check{
      width:28px;height:28px;border-radius:999px;border:1px solid var(--line);
      background:rgba(0,0,0,.08);color:var(--ok);
      display:flex;align-items:center;justify-content:center;font-weight:900;font-size:14px;line-height:1;flex:0 0 auto
    }
    .itT{margin:0;font-weight:800;font-size:14px}
    .itD{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.55;white-space:pre-wrap}

    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media (max-width:900px){.grid3{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:560px){.grid3{grid-template-columns:1fr}}
    .work{border:1px solid var(--line);border-radius:var(--r1);overflow:hidden;background:rgba(0,0,0,.05);cursor:pointer;transition:.18s ease;min-height:220px;display:flex;flex-direction:column}
    html[data-theme="soft"] .work{background:rgba(255,255,255,.45)}
    .work:hover{transform:translateY(-2px)}
    .workImg{height:160px;background:rgba(0,0,0,.12)}
    .workImg img{width:100%;height:100%;object-fit:cover;display:block}
    .workBody{padding:12px}
    .workT{margin:0;font-weight:800;font-size:14px;line-height:1.2;white-space:pre-wrap;word-break:break-word}
    .workM{margin:7px 0 0;color:var(--muted);font-size:13px;line-height:1.5;white-space:pre-wrap}

    .footer{padding:14px 16px 18px;text-align:center;color:var(--muted);font-size:12px;font-weight:800;letter-spacing:.04em}

    .err{padding:18px}
    .err h1{margin:0 0 8px;font-size:20px}
    .err p{margin:0;color:var(--muted);font-weight:700}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="card">
      <div class="cardHd">
        <b>Профиль</b>
        <span class="mini" id="miniRight">app.abqd.ru/u/…</span>
      </div>

      <div class="hero">
        <div class="banner" id="bannerBox">
          <div class="bannerPlh" id="bannerPlh">Баннер</div>
        </div>

        <div class="heroHead">
          <div class="left">
            <div class="avatar" id="avatarBox"><span class="fallback">A</span></div>
            <div>
              <h2 class="nm" id="nameEl">Загрузка…</h2>
              <div class="rl" id="roleEl"></div>
            </div>
          </div>
        </div>

        <div class="about">
          <div class="h2">Обо мне</div>
          <p class="aboutText" id="aboutEl"></p>
          <div class="cta" id="ctaRow"></div>
        </div>
      </div>

      <div class="section" id="contactsSection" style="padding:0 10px 16px">
        <div class="secTitle" id="contactsTitleEl">Контакты</div>
        <div class="chipsRow" id="contactsPreview"></div>
      </div>

      <div class="section" id="pointsSection">
        <div class="secTitle" id="pointsTitleEl">Ссылки</div>
        <div class="list" id="pointsPreview"></div>
      </div>

      <div class="section" id="gallerySection">
        <div class="secTitle" id="galleryTitleEl">Работы</div>
        <div class="grid3" id="galleryPreview"></div>
      </div>

      <div class="footer" id="profileFooter"></div>
    </div>
  </div>

<script>
(function(){
  function $(id){ return document.getElementById(id); }
  function clean(s){ return String(s == null ? '' : s).replace(/^\s+|\s+$/g,''); }
  function normUrl(u){
    u = clean(u); if (!u) return '';
    var low = u.toLowerCase();
    if (low.indexOf('http://')===0 || low.indexOf('https://')===0) return u;
    if (low.indexOf('mailto:')===0 || low.indexOf('tel:')===0 || low.indexOf('tg://')===0) return u;
    return 'https://' + u;
  }
  function contactUrl(u){
    u = clean(u); if (!u) return '';
    var low = u.toLowerCase();
    if (low.indexOf('http://')===0 || low.indexOf('https://')===0 || low.indexOf('mailto:')===0 || low.indexOf('tel:')===0 || low.indexOf('tg://')===0) return u;
    if (u.indexOf('@') !== -1 && u.indexOf(' ') === -1) return 'mailto:' + u;
    if (/^[0-9\s()\-\.+]+$/.test(u)) {
      var digits = u.replace(/[\s\-().]/g, '');
      if (digits.length >= 6) return 'tel:' + digits;
    }
    return 'https://' + u;
  }
  function phoneToTel(s){
    s = clean(s); if (!s) return '';
    var out = '';
    for (var i=0;i<s.length;i++){
      var ch = s.charAt(i);
      if (ch>='0' && ch<='9') out += ch;
      else if (ch==='+' && out.length===0) out += ch;
    }
    var digits = (out.charAt(0)==='+') ? out.slice(1) : out;
    if (digits.length < 6) return '';
    return 'tel:' + out;
  }
  function pick(obj, keys){
    for (var i=0;i<keys.length;i++){
      var k = keys[i];
      if (obj && obj[k] != null && String(obj[k]).length) return obj[k];
    }
    return '';
  }
  function parseSlug(){
    // ожидаем /u/<slug> или /u/<slug>/
    var p = location.pathname || '';
    p = p.replace(/\/+$/,''); // trim trailing /
    var m = p.match(/^\/u\/([^\/]+)$/);
    return m ? m[1] : '';
  }

  function setTheme(t){
    t = clean(t);
    if (t !== 'dark' && t !== 'soft') t = 'soft';
    document.documentElement.setAttribute('data-theme', t);
  }

  function render(profile, slug){
    var theme = pick(profile, ['theme','ui_theme']) || 'soft';
    setTheme(theme);

    var fullName = pick(profile, ['fullName','full_name','name','title']) || slug;
    var role = pick(profile, ['role','position']) || '';

    var about = pick(profile, ['about','bio','description']) || '';
    var phone = pick(profile, ['phone','phone_number']) || '';
    var callStyle = pick(profile, ['callStyle','call_style']) || 'ghost';

    var avatar = pick(profile, ['avatarUrl','avatar_url','avatarDataUrl','avatar_data_url','avatar']) || '';
    var banner = pick(profile, ['bannerUrl','banner_url','bannerDataUrl','banner_data_url','banner']) || '';
    var logo = pick(profile, ['logoUrl','logo_url','logoDataUrl','logo_data_url','logo']) || '';
    var logoLink = pick(profile, ['logoLink','logo_link']) || '';

    $('miniRight').textContent = 'app.abqd.ru/u/' + slug;
    document.title = fullName + ' • ABQD';

    $('nameEl').textContent = fullName;
    $('roleEl').textContent = role;

    $('aboutEl').textContent = about;

    // banner
    var bannerBox = $('bannerBox');
    var bannerPlh = $('bannerPlh');
    bannerBox.innerHTML = '';
    if (bannerPlh) bannerBox.appendChild(bannerPlh);

    if (banner) {
      if (bannerPlh) bannerPlh.style.display = 'none';
      var imgB = document.createElement('img');
      imgB.src = banner; imgB.alt = 'banner';
      bannerBox.insertBefore(imgB, bannerBox.firstChild);

      if (logo) {
        var a = document.createElement('a');
        a.className = 'bannerLogo';
        var lnk = normUrl(logoLink);
        a.href = lnk || '#';
        a.target = '_blank';
        a.rel = 'noopener';
        if (!lnk) a.style.pointerEvents = 'none';
        var li = document.createElement('img');
        li.src = logo; li.alt = 'logo';
        a.appendChild(li);
        bannerBox.appendChild(a);
      }
    } else {
      if (bannerPlh) bannerPlh.style.display = 'flex';
    }

    // avatar
    var av = $('avatarBox');
    av.innerHTML = '';
    if (avatar) {
      var imgA = document.createElement('img');
      imgA.src = avatar; imgA.alt = 'avatar';
      av.appendChild(imgA);
    } else {
      var letter = (fullName || 'A').slice(0,1).toUpperCase();
      var sp = document.createElement('span');
      sp.className = 'fallback';
      sp.textContent = letter;
      av.appendChild(sp);
    }

    // CTA
    var cta = $('ctaRow');
    cta.innerHTML = '';
    if (phone) {
      var tel = phoneToTel(phone);
      var callBtn = document.createElement('a');
      callBtn.textContent = 'Позвонить';
      callBtn.className = (callStyle === 'primary') ? 'primary' : '';
      callBtn.href = tel || '#';
      callBtn.target = '_self';
      callBtn.rel = 'nofollow';
      if (!tel) { callBtn.style.opacity='.55'; callBtn.style.pointerEvents='none'; }
      cta.appendChild(callBtn);
    }

    var buttons = profile.buttons || profile.cta || [];
    if (!buttons || !buttons.length) buttons = [];
    var maxButtons = phone ? 5 : 6;
    for (var i=0;i<buttons.length && i<maxButtons;i++){
      var b = buttons[i] || {};
      var label = clean(b.label || b.title);
      var url = clean(b.url || b.href);
      if (!label) continue;
      var a2 = document.createElement('a');
      a2.textContent = label;
      a2.className = ((b.style || b.variant) === 'primary') ? 'primary' : '';
      a2.href = normUrl(url) || '#';
      a2.target = '_blank';
      a2.rel = 'noopener';
      if (!url) a2.style.opacity = '.55';
      cta.appendChild(a2);
    }

    // contacts
    var chips = profile.chips || profile.contacts || [];
    var contactsPreview = $('contactsPreview');
    contactsPreview.innerHTML = '';
    var hasContacts = false;
    for (var ci=0; ci<chips.length && ci<20; ci++){
      var c = chips[ci] || {};
      var lbl = clean(c.label || c.title);
      var raw = clean(c.url || c.value || c.href);
      var icon = clean(c.icon || '');
      if (!lbl && !raw) continue;
      hasContacts = true;

      var a3 = document.createElement('a');
      a3.className = 'chipA';

      if (icon){
        var ic = document.createElement('span');
        ic.className = 'chipI';
        ic.textContent = icon;
        a3.appendChild(ic);
      }

      var tx = document.createElement('span');
      tx.textContent = lbl || raw;
      a3.appendChild(tx);

      var href = contactUrl(raw);
      a3.href = href || '#';
      a3.target = '_blank';
      a3.rel = 'noopener';
      if (!href){ a3.style.opacity='.55'; a3.style.pointerEvents='none'; }

      contactsPreview.appendChild(a3);
    }
    $('contactsSection').classList.toggle('hide', !hasContacts);

    // points
    $('pointsTitleEl').textContent = pick(profile, ['pointsTitle','points_title']) || 'Ссылки';
    var pts = profile.points || profile.links || [];
    var pl = $('pointsPreview');
    pl.innerHTML = '';
    for (var pi=0; pi<pts.length && pi<12; pi++){
      var p = pts[pi] || {};
      var title = clean(p.title || p.label);
      if (!title) continue;

      var el = document.createElement('div');
      el.className = 'item';

      var chk = document.createElement('div');
      chk.className = 'check';
      chk.textContent = '✓';

      var box = document.createElement('div');
      box.style.minWidth = '0';

      var t2 = document.createElement('p');
      t2.className = 'itT';
      t2.textContent = title;
      box.appendChild(t2);

      var text = clean(p.text || p.description);
      if (text){
        var d = document.createElement('div');
        d.className = 'itD';
        d.textContent = text;
        box.appendChild(d);
      }

      var url2 = clean(p.url || p.href);
      if (url2){
        var link2 = document.createElement('a');
        link2.style.display = 'inline-block';
        link2.style.marginTop = '8px';
        link2.style.fontWeight = '800';
        link2.style.fontSize = '12px';
        link2.style.color = 'inherit';
        link2.href = normUrl(url2);
        link2.target = '_blank';
        link2.rel = 'noopener';
        link2.textContent = 'Открыть ссылку';
        box.appendChild(link2);
      }

      el.appendChild(chk);
      el.appendChild(box);
      pl.appendChild(el);
    }
    $('pointsSection').classList.toggle('hide', !pts || !pts.length);

    // gallery
    $('galleryTitleEl').textContent = pick(profile, ['galleryTitle','gallery_title']) || 'Работы';
    var gal = profile.gallery || profile.works || [];
    var gg = $('galleryPreview');
    gg.innerHTML = '';
    for (var gi=0; gi<gal.length && gi<12; gi++){
      (function(g){
        g = g || {};
        var card = document.createElement('div');
        card.className = 'work';

        var imgWrap = document.createElement('div');
        imgWrap.className = 'workImg';

        var imgUrl = clean(g.img || g.image || g.img_url || g.image_url);
        if (imgUrl){
          var im = document.createElement('img');
          im.src = imgUrl; im.alt = '';
          imgWrap.appendChild(im);
        }

        var body = document.createElement('div');
        body.className = 'workBody';

        var title = document.createElement('p');
        title.className = 'workT';
        title.textContent = clean(g.title || g.name) || 'Работа';
        body.appendChild(title);

        var desc = clean(g.text || g.description);
        if (desc){
          var d = document.createElement('div');
          d.className = 'workM';
          d.textContent = desc;
          body.appendChild(d);
        }

        card.appendChild(imgWrap);
        card.appendChild(body);

        var url = clean(g.url || g.href);
        if (url){
          card.addEventListener('click', function(){
            window.open(normUrl(url), '_blank', 'noopener');
          });
        }

        gg.appendChild(card);
      })(gal[gi]);
    }
    $('gallerySection').classList.toggle('hide', !gal || !gal.length);

    var year = new Date().getFullYear();
    $('profileFooter').textContent = '© ' + year + ' ' + fullName;
  }

  function renderError(slug, msg){
    var card = $('card');
    card.innerHTML = '<div class="err"><h1>Профиль не найден</h1><p>' +
      (msg ? msg : ('Проверь адрес: /u/' + slug)) +
      '</p></div>';
  }

  var slug = parseSlug();
  if (!slug){
    renderError('…', 'Неверный адрес. Ожидается /u/<slug>.');
    return;
  }

  // важный момент: frontend ходит на app.abqd.ru/api/v1/..., nginx проксирует на api.abqd.ru
  fetch('/api/v1/profile/' + encodeURIComponent(slug), { method:'GET' })
    .then(function(r){
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.json();
    })
    .then(function(data){
      // если API оборачивает ответ, вытаскиваем
      var profile = data && (data.profile || data.data || data) || {};
      render(profile, slug);
    })
    .catch(function(e){
      renderError(slug, 'Не удалось загрузить профиль. ' + (e && e.message ? e.message : ''));
    });
})();
</script>
</body>
</html>
