<!doctype html>
<html lang="ru" data-theme="soft">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ABQD • Профиль</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --font:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      --r1:16px; --r2:22px;
      --bg:#0b0c10; --panel:#0f1117; --panel2:#11131b;
      --text:#eef1f6; --muted:rgba(238,241,246,.66); --line:rgba(255,255,255,.13);
      --shadow:0 18px 60px rgba(0,0,0,.30);
      --primary1:#ff4d9d; --primary2:#6d5cff;
      --gridBg: rgba(255,255,255,.03);
      --ok:#39d98a;
    }
    html[data-theme="soft"]{
      --bg:#f4f6fb; --panel:rgba(255,255,255,.62); --panel2:rgba(255,255,255,.78);
      --text:#10131a; --muted:rgba(16,19,26,.56); --line:rgba(16,19,26,.14);
      --shadow:0 18px 60px rgba(18,24,40,.12);
      --primary1:#2563eb; --primary2:#7c3aed;
      --gridBg: rgba(255,255,255,.42);
      --ok:#39d98a;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:var(--font);color:var(--text);font-size:15.5px;line-height:1.62;
      background:
        radial-gradient(1100px 700px at 15% 10%, rgba(109,92,255,.16), transparent 55%),
        radial-gradient(1100px 700px at 85% 15%, rgba(255,77,157,.14), transparent 55%),
        var(--bg);
    }
    .wrap{max-width:980px;margin:0 auto;padding:18px 14px 44px;}
    .card{position:relative;border:1px solid var(--line);
      background:
        radial-gradient(120% 140% at 10% 0%, rgba(255,255,255,.10), transparent 55%),
        linear-gradient(180deg,var(--panel),rgba(255,255,255,.04));
      border-radius:var(--r2); box-shadow:var(--shadow);
      backdrop-filter:blur(12px); overflow:hidden;
    }
    .cardHd{padding:14px 14px 10px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between}
    .cardHd b{font-size:12px;letter-spacing:.16em;text-transform:uppercase;color:var(--muted)}
    .hero{padding:16px}
    .banner{position:relative;height:220px;border-radius:var(--r2);overflow:hidden;border:1px solid var(--line);background:rgba(0,0,0,.10);z-index:1}
    .bannerPlh{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      font-weight:800;letter-spacing:.12em;text-transform:uppercase;font-size:12px;color:var(--muted);
      background:linear-gradient(180deg, rgba(255,255,255,.06), transparent);pointer-events:none}
    html[data-theme="soft"] .bannerPlh{background:linear-gradient(180deg, rgba(255,255,255,.30), transparent)}
    .banner img{width:100%;height:100%;object-fit:cover;display:block}
    .bannerLogo{position:absolute;right:12px;top:12px;width:56px;height:56px;border-radius:16px;
      border:1px solid var(--line);background:rgba(0,0,0,.18);backdrop-filter:blur(10px);
      display:flex;align-items:center;justify-content:center;overflow:hidden;text-decoration:none;
      box-shadow:0 10px 30px rgba(0,0,0,.18)}
    html[data-theme="soft"] .bannerLogo{background:rgba(255,255,255,.55)}
    .bannerLogo img{width:100%;height:100%;object-fit:cover;display:block}
    .heroHead{margin-top:-54px;display:flex;align-items:flex-end;justify-content:space-between;gap:12px;flex-wrap:wrap;padding:0 10px;position:relative;z-index:3}
    .left{display:flex;align-items:flex-end;gap:12px}
    .avatar{width:106px;height:106px;border-radius:999px;border:4px solid rgba(255,255,255,.9);overflow:hidden;background:rgba(0,0,0,.18);
      box-shadow:0 18px 60px rgba(0,0,0,.20);flex:0 0 auto;display:flex;align-items:center;justify-content:center}
    .avatar img{width:100%;height:100%;object-fit:cover;display:block}
    .avatar .fallback{font-weight:800;font-size:38px;opacity:.92}
    .nm{margin:0;font-size:28px;letter-spacing:-.02em;line-height:1.08;font-weight:800}
    .rl{margin:6px 0 0;color:var(--muted);letter-spacing:.14em;text-transform:uppercase;font-size:12px;font-weight:800}
    .about{padding:10px 10px 14px}
    .h2{margin:10px 0 10px;letter-spacing:.16em;text-transform:uppercase;font-size:12px;color:var(--muted);font-weight:800}
    .aboutText{margin:0;line-height:1.72;font-size:14.5px;white-space:pre-wrap;color:rgba(238,241,246,.78)}
    html[data-theme="soft"] .aboutText{color:rgba(16,19,26,.72)}
    .cta{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .cta a{border:1px solid var(--line);border-radius:999px;padding:11px 14px;font-weight:800;font-size:13px;text-decoration:none;
      color:#fff;background:rgba(0,0,0,.22);position:relative;overflow:hidden;isolation:isolate}
    .cta a.primary{border:0!important;background:transparent!important;color:#fff!important;box-shadow:0 10px 26px rgba(0,0,0,.14)}
    .cta a.primary::before{content:"";position:absolute;inset:-1px;background:linear-gradient(90deg,var(--primary1),var(--primary2));border-radius:inherit;z-index:-1}
    html[data-theme="soft"] .cta a.primary{color:var(--text)!important;border:1px solid rgba(16,19,26,.16)!important;box-shadow:0 16px 36px rgba(18,24,40,.14),0 1px 0 rgba(255,255,255,.70) inset,0 -1px 0 rgba(0,0,0,.06) inset}
    html[data-theme="soft"] .cta a.primary::before{background:linear-gradient(180deg, rgba(226,229,235,.98) 0%, rgba(196,203,214,.96) 48%, rgba(168,177,191,.95) 100%)}
    .section{padding:16px}
    .secTitle{margin:0 0 12px;font-size:12px;letter-spacing:.18em;text-transform:uppercase;color:var(--muted);font-weight:800}
    .chipsRow{display:flex;flex-wrap:wrap;gap:10px}
    .chipA{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:999px;border:1px solid var(--line);
      background:rgba(0,0,0,.05);text-decoration:none;color:var(--muted)!important;font-weight:800;font-size:12px}
    html[data-theme="soft"] .chipA{background:rgba(255,255,255,.45)}
    .chipA:hover{color:var(--text)!important}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{border:1px solid var(--line);background:rgba(0,0,0,.05);border-radius:var(--r1);padding:12px;display:flex;gap:12px;align-items:flex-start}
    html[data-theme="soft"] .item{background:rgba(255,255,255,.45)}
    .check{width:28px;height:28px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.08);color:var(--ok);
      display:flex;align-items:center;justify-content:center;font-weight:900}
    .itT{margin:0;font-weight:800;font-size:14px}
    .itD{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.55;white-space:pre-wrap}
    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media (max-width:900px){.grid3{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:560px){.grid3{grid-template-columns:1fr}}
    .work{border:1px solid var(--line);border-radius:var(--r1);overflow:hidden;background:rgba(0,0,0,.05);cursor:pointer;min-height:220px;display:flex;flex-direction:column}
    html[data-theme="soft"] .work{background:rgba(255,255,255,.45)}
    .workImg{height:160px;background:rgba(0,0,0,.12)}
    .workImg img{width:100%;height:100%;object-fit:cover;display:block}
    .workBody{padding:12px}
    .workT{margin:0;font-weight:800;font-size:14px;line-height:1.2;white-space:pre-wrap;word-break:break-word}
    .workM{margin:7px 0 0;color:var(--muted);font-size:13px;line-height:1.5;white-space:pre-wrap}
    .hide{display:none!important}
    .err{padding:22px;text-align:center;color:var(--muted);font-weight:800}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="card">
      <div class="cardHd"><b>Профиль</b><span style="color:var(--muted);font-weight:800" id="slugBadge"></span></div>

      <div class="hero">
        <div class="banner" id="bannerBox">
          <div class="bannerPlh" id="bannerPlh">Баннер</div>
        </div>

        <div class="heroHead">
          <div class="left">
            <div class="avatar" id="avatarBox"><span class="fallback">A</span></div>
            <div>
              <h2 class="nm" id="nameEl"></h2>
              <div class="rl" id="roleEl"></div>
            </div>
          </div>
        </div>

        <div class="about">
          <div class="h2">Обо мне</div>
          <p class="aboutText" id="aboutEl"></p>
          <div class="cta" id="ctaRow"></div>
        </div>
      </div>

      <div class="section" id="contactsSection" style="padding:0 10px 16px">
        <div class="secTitle">Контакты</div>
        <div class="chipsRow" id="contactsPreview"></div>
      </div>

      <div class="section" id="pointsSection">
        <div class="secTitle" id="pointsTitleEl">Ссылки</div>
        <div class="list" id="pointsPreview"></div>
      </div>

      <div class="section" id="gallerySection">
        <div class="secTitle" id="galleryTitleEl">Работы</div>
        <div class="grid3" id="galleryPreview"></div>
      </div>

      <div class="err hide" id="errBox"></div>
    </div>
  </div>

<script>
(function(){
  function $(id){ return document.getElementById(id); }
  function clean(s){ return String(s==null?'':s).replace(/^\s+|\s+$/g,''); }
  function normUrl(u){
    u = clean(u); if(!u) return '';
    var low = u.toLowerCase();
    if (low.indexOf('http://')===0 || low.indexOf('https://')===0) return u;
    if (low.indexOf('mailto:')===0 || low.indexOf('tel:')===0 || low.indexOf('tg://')===0) return u;
    return 'https://' + u;
  }
  function phoneToTel(s){
    s = clean(s); if(!s) return '';
    var out=''; for(var i=0;i<s.length;i++){
      var ch=s.charAt(i);
      if(ch>='0'&&ch<='9') out+=ch;
      else if(ch==='+' && out.length===0) out+=ch;
    }
    var digits=(out.charAt(0)==='+')?out.slice(1):out;
    if(digits.length<6) return '';
    return 'tel:' + out;
  }

  // slug из /u/<slug>
  var parts = location.pathname.split('/').filter(Boolean); // ["u","alex"]
  var slug = (parts.length>=2 && parts[0]==='u') ? parts[1] : '';
  $('slugBadge').textContent = slug ? ('/u/' + slug) : '';

  if(!slug){
    $('errBox').classList.remove('hide');
    $('errBox').textContent = 'Нет slug в адресе.';
    return;
  }

  // грузим профиль (app проксирует /api/* на api.abqd.ru)
  fetch('/api/v1/profile/' + encodeURIComponent(slug), { cache:'no-store' })
    .then(function(r){
      if(!r.ok) throw new Error('HTTP ' + r.status);
      return r.json();
    })
    .then(function(p){
      // ожидаем, что p ~ state конструктора
      var theme = (p.theme === 'dark' || p.theme === 'soft') ? p.theme : 'soft';
      document.documentElement.setAttribute('data-theme', theme);

      $('nameEl').textContent = p.fullName || '';
      $('roleEl').textContent = p.role || '';
      $('aboutEl').textContent = p.about || '';

      // banner + logo
      var banner = $('bannerBox');
      var plh = $('bannerPlh');
      banner.innerHTML = '';
      banner.appendChild(plh);

      if (p.bannerDataUrl) {
        plh.style.display = 'none';
        var imgB = document.createElement('img');
        imgB.src = p.bannerDataUrl;
        banner.insertBefore(imgB, banner.firstChild);

        if (p.logoDataUrl) {
          var a = document.createElement('a');
          a.className = 'bannerLogo';
          a.href = p.logoLink ? normUrl(p.logoLink) : '#';
          a.target = '_blank';
          a.rel = 'noopener';
          if(!p.logoLink) a.style.pointerEvents='none';
          var li = document.createElement('img');
          li.src = p.logoDataUrl;
          a.appendChild(li);
          banner.appendChild(a);
        }
      } else {
        plh.style.display = 'flex';
      }

      // avatar
      var av = $('avatarBox');
      av.innerHTML = '';
      if (p.avatarDataUrl) {
        var imgA = document.createElement('img');
        imgA.src = p.avatarDataUrl;
        av.appendChild(imgA);
      } else {
        var letter = (p.fullName || 'A').slice(0,1).toUpperCase();
        var span = document.createElement('span');
        span.className='fallback';
        span.textContent = letter;
        av.appendChild(span);
      }

      // CTA: телефон + кнопки
      var cta = $('ctaRow');
      cta.innerHTML = '';

      if (p.phone) {
        var tel = phoneToTel(p.phone);
        var callBtn = document.createElement('a');
        callBtn.textContent = 'Позвонить';
        callBtn.className = (p.callStyle === 'primary') ? 'primary' : '';
        callBtn.href = tel || '#';
        callBtn.target = '_self';
        callBtn.rel = 'nofollow';
        if(!tel){ callBtn.style.opacity='.55'; callBtn.style.pointerEvents='none'; }
        cta.appendChild(callBtn);
      }

      var btns = p.buttons || [];
      for (var i=0; i<btns.length && i<6; i++){
        var b = btns[i]; if(!b || !b.label) continue;
        var a2 = document.createElement('a');
        a2.textContent = b.label;
        a2.className = (b.style === 'primary') ? 'primary' : '';
        a2.href = normUrl(b.url) || '#';
        a2.target = '_blank';
        a2.rel = 'noopener';
        if(!b.url){ a2.style.opacity='.55'; a2.style.pointerEvents='none'; }
        cta.appendChild(a2);
      }

      // contacts
      var contacts = $('contactsPreview');
      contacts.innerHTML = '';
      var chips = p.chips || [];
      for (var c=0; c<chips.length && c<20; c++){
        var cc = chips[c] || {};
        if(!cc.label && !cc.url) continue;
        var a3 = document.createElement('a');
        a3.className='chipA';
        a3.textContent = cc.label || cc.url;
        a3.href = cc.url ? normUrl(cc.url) : '#';
        a3.target = '_blank'; a3.rel='noopener';
        if(!cc.url){ a3.style.opacity='.55'; a3.style.pointerEvents='none'; }
        contacts.appendChild(a3);
      }
      $('contactsSection').classList.toggle('hide', contacts.children.length === 0);

      // points
      $('pointsTitleEl').textContent = p.pointsTitle || 'Ссылки';
      var list = $('pointsPreview');
      list.innerHTML = '';
      var pts = p.points || [];
      for (var k=0; k<pts.length && k<12; k++){
        var pp = pts[k]; if(!pp || !pp.title) continue;
        var it = document.createElement('div'); it.className='item';
        var chk = document.createElement('div'); chk.className='check'; chk.textContent='✓';
        var box = document.createElement('div'); box.style.minWidth='0';
        var t = document.createElement('p'); t.className='itT'; t.textContent = pp.title;
        box.appendChild(t);
        if(pp.text){ var d=document.createElement('div'); d.className='itD'; d.textContent=pp.text; box.appendChild(d); }
        if(pp.url){ var l=document.createElement('a'); l.href=normUrl(pp.url); l.target='_blank'; l.rel='noopener'; l.style.color='var(--muted)'; l.style.fontWeight='800'; l.textContent='Открыть ссылку'; box.appendChild(l); }
        it.appendChild(chk); it.appendChild(box);
        list.appendChild(it);
      }
      $('pointsSection').classList.toggle('hide', list.children.length === 0);

      // gallery
      $('galleryTitleEl').textContent = p.galleryTitle || 'Работы';
      var gg = $('galleryPreview');
      gg.innerHTML = '';
      var gal = p.gallery || [];
      for (var g=0; g<gal.length && g<12; g++){
        (function(x){
          var card = document.createElement('div'); card.className='work';
          var imgW = document.createElement('div'); imgW.className='workImg';
          if(x.img){
            var im = document.createElement('img'); im.src=x.img; imgW.appendChild(im);
          }
          var body = document.createElement('div'); body.className='workBody';
          var tt = document.createElement('p'); tt.className='workT'; tt.textContent = x.title || '';
          body.appendChild(tt);
          if(x.text){ var mm=document.createElement('div'); mm.className='workM'; mm.textContent=x.text; body.appendChild(mm); }
          card.appendChild(imgW); card.appendChild(body);
          if(x.url){ card.addEventListener('click', function(){ window.open(normUrl(x.url), '_blank', 'noopener'); }); }
          gg.appendChild(card);
        })(gal[g] || {});
      }
      $('gallerySection').classList.toggle('hide', gg.children.length === 0);
    })
    .catch(function(err){
      $('errBox').classList.remove('hide');
      $('errBox').textContent = 'Профиль не найден или ошибка загрузки. (' + String(err.message || err) + ')';
    });
})();
</script>
</body>
</html>
