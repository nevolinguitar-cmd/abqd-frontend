<!doctype html>
<!--
  ABQD • Конструктор профиля (NFC) — NFC 1.1 (самодостаточный файл)
  v1.2 • 2026-01-05

  Цели:
  - Единый стиль “матовое стекло” + Montserrat
  - Локальный автосейв в localStorage (ключ: abqd_constructor_demo_v2)
  - Live Preview в /u/<slug>?preview=1 через postMessage
  - Публикация в API (PUT /api/v1/profile/<slug>) в формате:
      { title, description, state }
  - Если нет токена (localStorage abqd_token) — сохраняем локально, не публикуем

  ВАЖНО:
  - Убедись, что /u/<slug>?preview=1 принимает сообщения типа {type:'abqd_profile_state', state: <object>}
    (твоя /u Mirror Page это уже умеет)
-->
<html lang="ru" data-theme="soft">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
  <title>ABQD — Конструктор</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --font:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      --r1:14px; --r2:20px; --r3:26px;

      /* DARK */
      --bg:#0b0c10;
      --panel:#0f1117;
      --panel2:#11131b;
      --text:#eef1f6;
      --muted:rgba(238,241,246,.66);
      --line:rgba(255,255,255,.13);
      --shadow:0 18px 60px rgba(0,0,0,.30);

      --accent:#ff4d9d;
      --accent2:#6d5cff;
      --primary1:#ff4d9d;
      --primary2:#6d5cff;

      --ok:#39d98a;
      --warn:#f6c445;
      --bad:#ff4d4d;
    }

    html[data-theme="soft"]{
      --bg:#f4f6fb;
      --panel:rgba(255,255,255,.62);
      --panel2:rgba(255,255,255,.78);
      --text:#10131a;
      --muted:rgba(16,19,26,.56);
      --line:rgba(16,19,26,.14);
      --shadow:0 18px 60px rgba(18,24,40,.12);

      --accent:#2563eb;
      --accent2:#7c3aed;
      --primary1:#2563eb;
      --primary2:#7c3aed;

      --ok:#1bbf63;
      --warn:#b7791f;
      --bad:#c53030;
    }

    *{box-sizing:border-box}
    body{margin:0;font-family:var(--font);color:var(--text);font-size:14.5px;line-height:1.55;
      background:
        radial-gradient(1100px 700px at 15% 10%, rgba(109,92,255,.16), transparent 55%),
        radial-gradient(1100px 700px at 85% 15%, rgba(255,77,157,.14), transparent 55%),
        var(--bg);
    }

    body::before{content:"";position:fixed;inset:0;pointer-events:none;z-index:0;
      opacity:.055;mix-blend-mode:overlay;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.55'/%3E%3C/svg%3E");
      transform:translateZ(0)}

    a{color:inherit}
    .app{position:relative;z-index:1;min-height:100vh;display:flex;flex-direction:column}

    /* Topbar */
    .topbar{position:sticky;top:0;z-index:50;border-bottom:1px solid var(--line);
      background:linear-gradient(180deg,var(--panel2),rgba(255,255,255,.02));
      backdrop-filter:blur(14px);
    }
    .topbarIn{max-width:1400px;margin:0 auto;padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:12px}

    .brand{display:flex;align-items:center;gap:10px;min-width:260px}
    .badge{width:34px;height:34px;border-radius:12px;border:1px solid var(--line);
      background:radial-gradient(120% 140% at 10% 0%, rgba(255,255,255,.12), transparent 55%),
                 linear-gradient(180deg,var(--panel),rgba(255,255,255,.04));
      box-shadow:var(--shadow);
      display:grid;place-items:center;font-weight:900;letter-spacing:.02em}
    .brandTxt{display:flex;flex-direction:column;gap:2px}
    .brandTxt b{font-size:13px;letter-spacing:.12em;text-transform:uppercase}
    .brandTxt span{font-size:12px;color:var(--muted);font-weight:700;letter-spacing:.02em}

    .actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .status{font-size:12px;color:var(--muted);font-weight:800;letter-spacing:.02em;white-space:nowrap}
    .statusDot{display:inline-block;width:8px;height:8px;border-radius:99px;background:var(--muted);margin-right:8px;vertical-align:middle}
    .status.ok .statusDot{background:var(--ok)}
    .status.saving .statusDot{background:var(--warn)}
    .status.bad .statusDot{background:var(--bad)}

    .btn{border:1px solid var(--line);border-radius:999px;padding:10px 13px;font-weight:900;font-size:12px;
      background:rgba(0,0,0,.18);color:var(--text);cursor:pointer;user-select:none;letter-spacing:.10em;text-transform:uppercase;
      transition:transform .12s ease, filter .12s ease, opacity .12s ease;display:inline-flex;align-items:center;gap:8px}
    html[data-theme="soft"] .btn{background:rgba(255,255,255,.40)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{border:0;background:transparent;position:relative;isolation:isolate;color:#fff}
    .btn.primary::before{content:"";position:absolute;inset:-1px;border-radius:999px;z-index:-1;
      background:linear-gradient(90deg,var(--primary1),var(--primary2))}
    html[data-theme="soft"] .btn.primary{color:var(--text)}
    html[data-theme="soft"] .btn.primary::before{background:linear-gradient(180deg, rgba(226,229,235,.98) 0%, rgba(196,203,214,.96) 48%, rgba(168,177,191,.95) 100%)}

    /* Layout */
    .main{max-width:1400px;margin:0 auto;width:100%;padding:14px 14px 22px;display:grid;grid-template-columns: 430px 1fr;gap:12px;align-items:start}
    @media (max-width: 1020px){
      .main{grid-template-columns:1fr;}
      .previewWrap{min-height:60vh}
    }

    .panel{border:1px solid var(--line);
      background:radial-gradient(120% 140% at 10% 0%, rgba(255,255,255,.10), transparent 55%),
                 linear-gradient(180deg,var(--panel),rgba(255,255,255,.04));
      border-radius:var(--r3);
      box-shadow:var(--shadow);
      backdrop-filter:blur(12px);
      overflow:hidden;
    }

    .editor{position:sticky;top:66px;max-height:calc(100vh - 90px);overflow:auto}
    @media (max-width:1020px){.editor{position:relative;top:auto;max-height:none}}

    .editorHead{padding:14px 14px 12px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{border:1px solid var(--line);border-radius:999px;padding:8px 10px;font-weight:900;font-size:11px;letter-spacing:.10em;text-transform:uppercase;
      background:rgba(0,0,0,.12);color:var(--muted);cursor:pointer;user-select:none}
    html[data-theme="soft"] .tab{background:rgba(255,255,255,.40)}
    .tab.active{color:var(--text);filter:saturate(1.1)}

    .miniRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .mini{font-size:12px;color:var(--muted);font-weight:900;letter-spacing:.08em;text-transform:uppercase}

    .editorBody{padding:14px}
    .section{display:none}
    .section.active{display:block}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:1020px){.grid2{grid-template-columns:1fr}}

    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    .label{font-size:12px;color:var(--muted);font-weight:900;letter-spacing:.10em;text-transform:uppercase}
    .input,.textarea,.select{border:1px solid var(--line);border-radius:14px;padding:11px 12px;font:inherit;color:var(--text);
      background:rgba(0,0,0,.10);outline:none}
    html[data-theme="soft"] .input, html[data-theme="soft"] .textarea, html[data-theme="soft"] .select{background:rgba(255,255,255,.45)}
    .textarea{min-height:92px;resize:vertical}

    .hint{font-size:12px;color:var(--muted);font-weight:700}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    .list{display:flex;flex-direction:column;gap:10px;margin-top:6px}
    .item{border:1px solid var(--line);border-radius:18px;padding:10px;background:rgba(0,0,0,.06)}
    html[data-theme="soft"] .item{background:rgba(255,255,255,.45)}
    .itemTop{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
    .itemTitle{font-weight:900;letter-spacing:.06em;text-transform:uppercase;font-size:11px;color:var(--muted)}
    .iconBtn{border:1px solid var(--line);border-radius:999px;padding:8px 10px;font-weight:900;font-size:11px;
      background:rgba(0,0,0,.10);color:var(--muted);cursor:pointer;user-select:none}
    html[data-theme="soft"] .iconBtn{background:rgba(255,255,255,.45)}
    .iconBtn.danger{color:var(--bad)}

    /* Preview */
    .previewWrap{padding:0;display:flex;flex-direction:column}
    .previewHead{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .previewHead b{font-size:12px;letter-spacing:.12em;text-transform:uppercase}
    .pill{border:1px solid var(--line);border-radius:999px;padding:7px 10px;font-weight:900;font-size:11px;color:var(--muted);
      background:rgba(0,0,0,.08)}
    html[data-theme="soft"] .pill{background:rgba(255,255,255,.45)}

    .iframe{width:100%;border:0;flex:1;min-height:740px;background:transparent}
    @media (max-width:1020px){.iframe{min-height:520px}}

    /* Toast */
    .toast{position:fixed;left:14px;bottom:14px;z-index:80;max-width:min(520px, calc(100vw - 28px));
      border:1px solid var(--line);border-radius:18px;padding:12px 12px;
      background:radial-gradient(120% 140% at 10% 0%, rgba(255,255,255,.10), transparent 55%),
                 linear-gradient(180deg,var(--panel),rgba(255,255,255,.04));
      box-shadow:var(--shadow);backdrop-filter:blur(12px);
      display:none}
    .toast.show{display:block;animation:pop .14s ease}
    @keyframes pop{from{transform:translateY(8px);opacity:0}to{transform:translateY(0);opacity:1}}
    .toast b{display:block;font-size:12px;letter-spacing:.12em;text-transform:uppercase;margin-bottom:4px}
    .toast p{margin:0;color:var(--muted);font-weight:700;font-size:13px;white-space:pre-wrap}
  </style>
</head>

<body>
  <div class="app">

    <header class="topbar">
      <div class="topbarIn">
        <div class="brand">
          <div class="badge">A</div>
          <div class="brandTxt">
            <b>ABQD • Конструктор</b>
            <span id="subLine">NFC 1.1 • /u live preview</span>
          </div>
        </div>

        <div class="actions">
          <div id="saveStatus" class="status ok"><span class="statusDot"></span><span id="saveStatusText">Готово</span></div>
          <button class="btn" id="themeBtn" type="button">Тема</button>
          <button class="btn" id="previewBtn" type="button">Preview</button>
          <button class="btn" id="profileLink" type="button">Профиль</button>
          <button class="btn primary" id="save" type="button">Сохранить</button>
        </div>
      </div>
    </header>

    <main class="main">
      <!-- EDITOR -->
      <section class="panel editor" aria-label="Редактор">
        <div class="editorHead">
          <div class="tabs" id="tabs">
            <div class="tab active" data-tab="profile">Профиль</div>
            <div class="tab" data-tab="buttons">Кнопки</div>
            <div class="tab" data-tab="contacts">Контакты</div>
            <div class="tab" data-tab="points">Пункты</div>
            <div class="tab" data-tab="gallery">Галерея</div>
          </div>
          <div class="miniRow">
            <span class="mini">Slug:</span>
            <span class="pill" id="slugPill">—</span>
          </div>
        </div>

        <div class="editorBody">

          <!-- PROFILE -->
          <div class="section active" id="sec-profile">
            <div class="grid2">
              <div class="field">
                <div class="label">Slug (адрес)</div>
                <input class="input" id="slug" placeholder="например: ivanov" />
                <div class="hint">URL будет: /u/&lt;slug&gt;</div>
              </div>

              <div class="field">
                <div class="label">Тема</div>
                <select class="select" id="theme">
                  <option value="soft">soft</option>
                  <option value="dark">dark</option>
                </select>
                <div class="hint">Тема влияет на /u витрину</div>
              </div>

              <div class="field">
                <div class="label">Имя</div>
                <input class="input" id="fullName" placeholder="Имя Фамилия" />
              </div>

              <div class="field">
                <div class="label">Роль (подзаголовок)</div>
                <input class="input" id="role" placeholder="Дизайнер интерьеров" />
              </div>

              <div class="field">
                <div class="label">Телефон</div>
                <input class="input" id="phone" placeholder="+7 999 000-00-00" />
              </div>

              <div class="field">
                <div class="label">Стиль кнопки «Позвонить»</div>
                <select class="select" id="callStyle">
                  <option value="primary">primary</option>
                  <option value="ghost">ghost</option>
                </select>
              </div>
            </div>

            <div class="field">
              <div class="label">О себе</div>
              <textarea class="textarea" id="about" placeholder="Коротко: чем полезны, чем занимаетесь, где работаете..."></textarea>
            </div>

            <div class="grid2">
              <div class="field">
                <div class="label">Avatar (URL или data:...)</div>
                <input class="input" id="avatarDataUrl" placeholder="https://..." />
                <div class="hint">Лучше URL (S3), base64 может не пройти публикацию</div>
              </div>
              <div class="field">
                <div class="label">Banner (URL или data:...)</div>
                <input class="input" id="bannerDataUrl" placeholder="https://..." />
              </div>
              <div class="field">
                <div class="label">Logo (URL или data:...)</div>
                <input class="input" id="logoDataUrl" placeholder="https://..." />
              </div>
              <div class="field">
                <div class="label">Logo link</div>
                <input class="input" id="logoLink" placeholder="https://abqd.ru" />
              </div>
            </div>
          </div>

          <!-- BUTTONS -->
          <div class="section" id="sec-buttons">
            <div class="row" style="justify-content:space-between;margin-bottom:10px">
              <div class="hint">CTA-кнопки под «Обо мне». Первые 5–6 показываются.</div>
              <button class="iconBtn" id="addBtn" type="button">+ Добавить</button>
            </div>
            <div class="list" id="buttonsList"></div>
          </div>

          <!-- CONTACTS -->
          <div class="section" id="sec-contacts">
            <div class="row" style="justify-content:space-between;margin-bottom:10px">
              <div class="hint">Чипсы-контакты (тел/почта/ссылка/мессенджер)</div>
              <button class="iconBtn" id="addChip" type="button">+ Добавить</button>
            </div>
            <div class="list" id="chipsList"></div>
          </div>

          <!-- POINTS -->
          <div class="section" id="sec-points">
            <div class="field">
              <div class="label">Заголовок секции</div>
              <input class="input" id="pointsTitle" placeholder="Ссылки" />
            </div>
            <div class="row" style="justify-content:space-between;margin-bottom:10px">
              <div class="hint">Список пунктов/ссылок (до 12)</div>
              <button class="iconBtn" id="addPoint" type="button">+ Добавить</button>
            </div>
            <div class="list" id="pointsList"></div>
          </div>

          <!-- GALLERY -->
          <div class="section" id="sec-gallery">
            <div class="field">
              <div class="label">Заголовок секции</div>
              <input class="input" id="galleryTitle" placeholder="Работы" />
            </div>
            <div class="row" style="justify-content:space-between;margin-bottom:10px">
              <div class="hint">Карточки работ (до 12)</div>
              <button class="iconBtn" id="addWork" type="button">+ Добавить</button>
            </div>
            <div class="list" id="galleryList"></div>
          </div>

        </div>
      </section>

      <!-- PREVIEW -->
      <section class="panel previewWrap" aria-label="Превью">
        <div class="previewHead">
          <b>Preview (/u)</b>
          <span class="pill" id="previewUrlPill">—</span>
        </div>
        <iframe id="previewFrame" class="iframe" title="Preview"></iframe>
      </section>
    </main>

    <div class="toast" id="toast">
      <b id="toastT">Сообщение</b>
      <p id="toastD">…</p>
    </div>

  </div>

<script>
(function(){
  // =========================
  // CONFIG
  // =========================
  var LS_KEY = 'abqd_constructor_demo_v2';
  var TOKEN_KEY = 'abqd_token';
  var SAVE_DEBOUNCE_MS = 900;
  var PREVIEW_DEBOUNCE_MS = 180;

  // =========================
  // HELPERS
  // =========================
  function $(id){ return document.getElementById(id); }
  function clean(s){ return String(s == null ? '' : s).replace(/^\s+|\s+$/g,''); }

  function normalizeSlug(s){
    s = clean(s).toLowerCase();
    s = s.replace(/^\/+|\/+$/g,'');
    s = s.replace(/\s+/g,'-');
    s = s.replace(/[^a-z0-9\-_]/g,'');
    // не даём пустой/один дефис
    s = s.replace(/\-+/g,'-').replace(/^\-+|\-+$/g,'');
    return s;
  }

  function clone(obj){ return JSON.parse(JSON.stringify(obj || {})); }

  function getToken(){
    try{ return localStorage.getItem(TOKEN_KEY) || ''; }
    catch(_e){ return ''; }
  }

  function toast(title, desc){
    var box = $('toast');
    $('toastT').textContent = title || 'Готово';
    $('toastD').textContent = desc || '';
    box.classList.add('show');
    window.clearTimeout(toast._t);
    toast._t = window.setTimeout(function(){ box.classList.remove('show'); }, 3800);
  }

  function setSaveStatus(mode, text){
    var el = $('saveStatus');
    el.classList.remove('ok','saving','bad');
    el.classList.add(mode || 'ok');
    $('saveStatusText').textContent = text || 'Готово';
  }

  function blurActionButtons(){
    var ids = ['save','previewBtn','profileLink','themeBtn'];
    for (var i=0;i<ids.length;i++){
      var b = $(ids[i]);
      if (b) b.blur();
    }
  }

  function hardStop(e){
    if(!e) return;
    try{ e.preventDefault(); }catch(_e){}
    try{ e.stopImmediatePropagation(); }catch(_e2){}
    try{ e.stopPropagation(); }catch(_e3){}
  }

  // =========================
  // STATE (old schema: directly used by /u renderer)
  // =========================
  var state = {
    slug: '',
    theme: 'soft',

    fullName: '',
    role: '',
    about: '',

    phone: '',
    callStyle: 'primary',

    avatarDataUrl: '',
    bannerDataUrl: '',
    logoDataUrl: '',
    logoLink: 'https://abqd.ru',

    buttons: [
      { label:'Написать', url:'https://t.me/', style:'primary' },
      { label:'Сайт', url:'https://', style:'ghost' }
    ],

    chips: [
      { label:'Telegram', url:'https://t.me/', icon:'✈️' }
    ],

    pointsTitle: 'Ссылки',
    points: [
      { title:'Портфолио', text:'', url:'https://'}
    ],

    galleryTitle: 'Работы',
    gallery: [
      { title:'Проект 1', text:'Описание', img:'', url:'' }
    ]
  };

  // =========================
  // LOAD/SAVE LOCAL
  // =========================
  function loadLocal(){
    try{
      var raw = localStorage.getItem(LS_KEY);
      if(!raw) return;
      var data = JSON.parse(raw);
      if(!data || typeof data !== 'object') return;
      // мягкое слияние
      state = Object.assign(clone(state), data);
      state.slug = normalizeSlug(state.slug || '');
      if (state.theme !== 'dark' && state.theme !== 'soft') state.theme = 'soft';
    }catch(_e){}
  }

  function persistNow(){
    try{
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }catch(_e){}
  }

  var saveTimer = null;
  function scheduleLocalSave(){
    setSaveStatus('saving','Сохраняю…');
    window.clearTimeout(saveTimer);
    saveTimer = window.setTimeout(function(){
      persistNow();
      setSaveStatus('ok','Сохранено');
    }, SAVE_DEBOUNCE_MS);
  }

  // =========================
  // PREVIEW (iframe + postMessage)
  // =========================
  var previewTimer = null;
  var previewReady = false;

  function previewUrl(){
    var s = normalizeSlug(state.slug || '');
    if(!s) return '';
    return '/u/' + s + '?preview=1';
  }

  function setPreviewFrameUrl(force){
    var url = previewUrl();
    $('previewUrlPill').textContent = url || '—';
    $('slugPill').textContent = normalizeSlug(state.slug || '') || '—';

    if(!url){
      $('previewFrame').src = 'about:blank';
      previewReady = false;
      return;
    }

    if(force || $('previewFrame').getAttribute('data-src') !== url){
      $('previewFrame').setAttribute('data-src', url);
      $('previewFrame').src = url;
      previewReady = false;
    }
  }

  function postPreview(){
    var fr = $('previewFrame');
    if(!fr || !fr.contentWindow) return;
    // отправляем даже без ready, но с дебаунсом
    try{
      fr.contentWindow.postMessage({ type:'abqd_profile_state', state: clone(state) }, '*');
    }catch(_e){}
  }

  function schedulePreviewSend(){
    window.clearTimeout(previewTimer);
    previewTimer = window.setTimeout(function(){
      postPreview();
    }, PREVIEW_DEBOUNCE_MS);
  }

  window.addEventListener('message', function(e){
    var d = e && e.data ? e.data : null;
    if(!d) return;
    if(d.type === 'abqd_u_ready'){
      previewReady = true;
      postPreview();
    }
  });

  // =========================
  // RENDER EDITOR
  // =========================
  function bindInput(id, key){
    var el = $(id);
    if(!el) return;
    el.value = (state[key] == null) ? '' : String(state[key]);
    el.addEventListener('input', function(){
      state[key] = el.value;
      if(key === 'slug'){
        state.slug = normalizeSlug(state.slug);
        el.value = state.slug;
        setPreviewFrameUrl(false);
      }
      if(key === 'theme'){
        if (state.theme !== 'dark' && state.theme !== 'soft') state.theme = 'soft';
        document.documentElement.setAttribute('data-theme', state.theme);
      }
      scheduleLocalSave();
      schedulePreviewSend();
    });
  }

  function renderButtons(){
    var box = $('buttonsList');
    box.innerHTML = '';
    var arr = Array.isArray(state.buttons) ? state.buttons : (state.buttons = []);

    for(var i=0;i<arr.length;i++){
      (function(idx){
        var b = arr[idx] || (arr[idx] = {label:'',url:'',style:'ghost'});

        var item = document.createElement('div');
        item.className = 'item';

        var top = document.createElement('div');
        top.className = 'itemTop';

        var t = document.createElement('div');
        t.className = 'itemTitle';
        t.textContent = 'Кнопка #' + (idx+1);

        var del = document.createElement('button');
        del.type = 'button';
        del.className = 'iconBtn danger';
        del.textContent = 'Удалить';
        del.addEventListener('click', function(){
          arr.splice(idx,1);
          scheduleLocalSave();
          renderButtons();
          schedulePreviewSend();
        });

        top.appendChild(t);
        top.appendChild(del);
        item.appendChild(top);

        var f1 = document.createElement('div');
        f1.className = 'field';
        f1.innerHTML = '<div class="label">Текст</div>';
        var in1 = document.createElement('input');
        in1.className = 'input';
        in1.value = b.label || '';
        in1.placeholder = 'Написать';
        in1.addEventListener('input', function(){
          b.label = in1.value;
          scheduleLocalSave();
          schedulePreviewSend();
        });
        f1.appendChild(in1);

        var f2 = document.createElement('div');
        f2.className = 'field';
        f2.innerHTML = '<div class="label">Ссылка</div>';
        var in2 = document.createElement('input');
        in2.className = 'input';
        in2.value = b.url || '';
        in2.placeholder = 'https://...';
        in2.addEventListener('input', function(){
          b.url = in2.value;
          scheduleLocalSave();
          schedulePreviewSend();
        });
        f2.appendChild(in2);

        var f3 = document.createElement('div');
        f3.className = 'field';
        f3.innerHTML = '<div class="label">Стиль</div>';
        var sel = document.createElement('select');
        sel.className = 'select';
        sel.innerHTML = '<option value="primary">primary</option><option value="ghost">ghost</option>';
        sel.value = (b.style === 'primary') ? 'primary' : 'ghost';
        sel.addEventListener('change', function(){
          b.style = sel.value;
          scheduleLocalSave();
          schedulePreviewSend();
        });
        f3.appendChild(sel);

        item.appendChild(f1);
        item.appendChild(f2);
        item.appendChild(f3);

        box.appendChild(item);
      })(i);
    }
  }

  function renderChips(){
    var box = $('chipsList');
    box.innerHTML = '';
    var arr = Array.isArray(state.chips) ? state.chips : (state.chips = []);

    for(var i=0;i<arr.length;i++){
      (function(idx){
        var c = arr[idx] || (arr[idx] = {label:'',url:'',icon:''});

        var item = document.createElement('div');
        item.className = 'item';

        var top = document.createElement('div');
        top.className = 'itemTop';

        var t = document.createElement('div');
        t.className = 'itemTitle';
        t.textContent = 'Контакт #' + (idx+1);

        var del = document.createElement('button');
        del.type = 'button';
        del.className = 'iconBtn danger';
        del.textContent = 'Удалить';
        del.addEventListener('click', function(){
          arr.splice(idx,1);
          scheduleLocalSave();
          renderChips();
          schedulePreviewSend();
        });

        top.appendChild(t);
        top.appendChild(del);
        item.appendChild(top);

        var f1 = document.createElement('div');
        f1.className = 'field';
        f1.innerHTML = '<div class="label">Иконка (эмодзи)</div>';
        var inI = document.createElement('input');
        inI.className = 'input';
        inI.value = c.icon || '';
        inI.placeholder = '✈️';
        inI.addEventListener('input', function(){
          c.icon = inI.value;
          scheduleLocalSave();
          schedulePreviewSend();
        });
        f1.appendChild(inI);

        var f2 = document.createElement('div');
        f2.className = 'field';
        f2.innerHTML = '<div class="label">Подпись</div>';
        var in1 = document.createElement('input');
        in1.className = 'input';
        in1.value = c.label || '';
        in1.placeholder = 'Telegram';
        in1.addEventListener('input', function(){
          c.label = in1.value;
          scheduleLocalSave();
          schedulePreviewSend();
        });
        f2.appendChild(in1);

        var f3 = document.createElement('div');
        f3.className = 'field';
        f3.innerHTML = '<div class="label">Значение/ссылка</div>';
        var in2 = document.createElement('input');
        in2.className = 'input';
        in2.value = c.url || '';
        in2.placeholder = 'https://t.me/... или mail@example.com или +7999...';
        in2.addEventListener('input', function(){
          c.url = in2.value;
          scheduleLocalSave();
          schedulePreviewSend();
        });
        f3.appendChild(in2);

        item.appendChild(f1);
        item.appendChild(f2);
        item.appendChild(f3);
        box.appendChild(item);
      })(i);
    }
  }

  function renderPoints(){
    var box = $('pointsList');
    box.innerHTML = '';
    var arr = Array.isArray(state.points) ? state.points : (state.points = []);

    for(var i=0;i<arr.length;i++){
      (function(idx){
        var p = arr[idx] || (arr[idx] = {title:'',text:'',url:''});

        var item = document.createElement('div');
        item.className = 'item';

        var top = document.createElement('div');
        top.className = 'itemTop';

        var t = document.createElement('div');
        t.className = 'itemTitle';
        t.textContent = 'Пункт #' + (idx+1);

        var del = document.createElement('button');
        del.type = 'button';
        del.className = 'iconBtn danger';
        del.textContent = 'Удалить';
        del.addEventListener('click', function(){
          arr.splice(idx,1);
          scheduleLocalSave();
          renderPoints();
          schedulePreviewSend();
        });

        top.appendChild(t);
        top.appendChild(del);
        item.appendChild(top);

        var f1 = document.createElement('div');
        f1.className = 'field';
        f1.innerHTML = '<div class="label">Заголовок</div>';
        var in1 = document.createElement('input');
        in1.className = 'input';
        in1.value = p.title || '';
        in1.placeholder = 'Портфолио';
        in1.addEventListener('input', function(){
          p.title = in1.value;
          scheduleLocalSave();
          schedulePreviewSend();
        });
        f1.appendChild(in1);

        var f2 = document.createElement('div');
        f2.className = 'field';
        f2.innerHTML = '<div class="label">Текст</div>';
        var ta = document.createElement('textarea');
        ta.className = 'textarea';
        ta.style.minHeight = '70px';
        ta.value = p.text || '';
        ta.placeholder = 'Короткое описание';
        ta.addEventListener('input', function(){
          p.text = ta.value;
          scheduleLocalSave();
          schedulePreviewSend();
        });
        f2.appendChild(ta);

        var f3 = document.createElement('div');
        f3.className = 'field';
        f3.innerHTML = '<div class="label">Ссылка (опционально)</div>';
        var in2 = document.createElement('input');
        in2.className = 'input';
        in2.value = p.url || '';
        in2.placeholder = 'https://...';
        in2.addEventListener('input', function(){
          p.url = in2.value;
          scheduleLocalSave();
          schedulePreviewSend();
        });
        f3.appendChild(in2);

        item.appendChild(f1);
        item.appendChild(f2);
        item.appendChild(f3);
        box.appendChild(item);
      })(i);
    }
  }

  function renderGallery(){
    var box = $('galleryList');
    box.innerHTML = '';
    var arr = Array.isArray(state.gallery) ? state.gallery : (state.gallery = []);

    for(var i=0;i<arr.length;i++){
      (function(idx){
        var g = arr[idx] || (arr[idx] = {title:'',text:'',img:'',url:''});

        var item = document.createElement('div');
        item.className = 'item';

        var top = document.createElement('div');
        top.className = 'itemTop';

        var t = document.createElement('div');
        t.className = 'itemTitle';
        t.textContent = 'Работа #' + (idx+1);

        var del = document.createElement('button');
        del.type = 'button';
        del.className = 'iconBtn danger';
        del.textContent = 'Удалить';
        del.addEventListener('click', function(){
          arr.splice(idx,1);
          scheduleLocalSave();
          renderGallery();
          schedulePreviewSend();
        });

        top.appendChild(t);
        top.appendChild(del);
        item.appendChild(top);

        var f1 = document.createElement('div');
        f1.className = 'field';
        f1.innerHTML = '<div class="label">Название</div>';
        var in1 = document.createElement('input');
        in1.className = 'input';
        in1.value = g.title || '';
        in1.placeholder = 'Проект кухни';
        in1.addEventListener('input', function(){
          g.title = in1.value;
          scheduleLocalSave();
          schedulePreviewSend();
        });
        f1.appendChild(in1);

        var f2 = document.createElement('div');
        f2.className = 'field';
        f2.innerHTML = '<div class="label">Описание</div>';
        var ta = document.createElement('textarea');
        ta.className = 'textarea';
        ta.style.minHeight = '70px';
        ta.value = g.text || '';
        ta.placeholder = 'Что сделано, метраж, город...';
        ta.addEventListener('input', function(){
          g.text = ta.value;
          scheduleLocalSave();
          schedulePreviewSend();
        });
        f2.appendChild(ta);

        var f3 = document.createElement('div');
        f3.className = 'field';
        f3.innerHTML = '<div class="label">Картинка (URL)</div>';
        var in2 = document.createElement('input');
        in2.className = 'input';
        in2.value = g.img || '';
        in2.placeholder = 'https://...';
        in2.addEventListener('input', function(){
          g.img = in2.value;
          scheduleLocalSave();
          schedulePreviewSend();
        });
        f3.appendChild(in2);

        var f4 = document.createElement('div');
        f4.className = 'field';
        f4.innerHTML = '<div class="label">Ссылка (опционально)</div>';
        var in3 = document.createElement('input');
        in3.className = 'input';
        in3.value = g.url || '';
        in3.placeholder = 'https://...';
        in3.addEventListener('input', function(){
          g.url = in3.value;
          scheduleLocalSave();
          schedulePreviewSend();
        });
        f4.appendChild(in3);

        item.appendChild(f1);
        item.appendChild(f2);
        item.appendChild(f3);
        item.appendChild(f4);
        box.appendChild(item);
      })(i);
    }
  }

  function renderAll(){
    // inputs
    bindInput('slug','slug');
    bindInput('theme','theme');
    bindInput('fullName','fullName');
    bindInput('role','role');
    bindInput('phone','phone');
    bindInput('callStyle','callStyle');
    bindInput('about','about');
    bindInput('avatarDataUrl','avatarDataUrl');
    bindInput('bannerDataUrl','bannerDataUrl');
    bindInput('logoDataUrl','logoDataUrl');
    bindInput('logoLink','logoLink');

    bindInput('pointsTitle','pointsTitle');
    bindInput('galleryTitle','galleryTitle');

    renderButtons();
    renderChips();
    renderPoints();
    renderGallery();

    document.documentElement.setAttribute('data-theme', state.theme || 'soft');
    setPreviewFrameUrl(true);
    schedulePreviewSend();
  }

  // =========================
  // TABS
  // =========================
  function setTab(name){
    var tabs = $('tabs').querySelectorAll('.tab');
    for (var i=0;i<tabs.length;i++){
      var t = tabs[i];
      t.classList.toggle('active', t.getAttribute('data-tab') === name);
    }
    var ids = ['profile','buttons','contacts','points','gallery'];
    for (var j=0;j<ids.length;j++){
      var id = ids[j];
      $('sec-' + id).classList.toggle('active', id === name);
    }
  }

  // =========================
  // PUBLISH (API)
  // =========================
  function stripHeavyMedia(st){
    var changed = false;
    function dropIfDataUrl(key){
      if (st[key] && String(st[key]).indexOf('data:') === 0){
        st[key] = '';
        changed = true;
      }
    }
    dropIfDataUrl('avatarDataUrl');
    dropIfDataUrl('bannerDataUrl');
    dropIfDataUrl('logoDataUrl');

    if (st.gallery && st.gallery.length){
      for (var i=0;i<st.gallery.length;i++){
        var g = st.gallery[i];
        if (g && g.img && String(g.img).indexOf('data:') === 0){
          g.img = '';
          changed = true;
        }
      }
    }
    return changed;
  }

  function buildUpsertBody(slug, st){
    var title = clean(st.fullName) || null;
    var description = clean(st.about) || null;
    return { title: title, description: description, state: st };
  }

  function publishProfileToApi(){
    if(!window.fetch){
      toast('Ошибка','fetch не поддерживается');
      return Promise.reject(new Error('fetch-not-supported'));
    }

    var slug = normalizeSlug(state.slug || '');
    if(!slug){
      toast('Нет slug','Сначала задай адрес');
      return Promise.reject(new Error('no-slug'));
    }

    var token = getToken();
    if(!token){
      toast('Сохранено локально','Для публикации нужен вход (/auth)');
      return Promise.reject(new Error('no-token'));
    }

    var st = clone(state);
    st.slug = slug;

    var upsert = buildUpsertBody(slug, st);
    var body = '';
    try{ body = JSON.stringify(upsert); }catch(_e){ body = ''; }

    if(body && body.length > 900000){
      var changed = stripHeavyMedia(st);
      if(changed){
        toast('Картинки тяжёлые','Убрал base64 у медиа (лучше ссылки из хранилища)');
      }
      upsert = buildUpsertBody(slug, st);
      body = JSON.stringify(upsert);
      if(body.length > 900000){
        toast('Слишком большой профиль','Уменьши галерею/изображения');
        return Promise.reject(new Error('payload-too-large'));
      }
    }

    return fetch('/api/v1/profile/' + encodeURIComponent(slug), {
      method:'PUT',
      headers:{
        'content-type':'application/json',
        'Authorization':'Bearer ' + token
      },
      body: body
    }).then(function(res){
      if(res.status === 200 || res.status === 201){
        return res.json().catch(function(){ return {}; });
      }
      return res.text().then(function(t){
        var msg = t;
        try{ msg = (JSON.parse(t) || {}).detail || t; }catch(_e){}
        throw new Error('HTTP ' + res.status + ': ' + msg);
      });
    });
  }

  function apiGetProfile(slug){
    return fetch('/api/v1/profile/' + encodeURIComponent(slug), { method:'GET', cache:'no-store' });
  }

  // =========================
  // ACTIONS
  // =========================
  function doSaveAndPublish(){
    blurActionButtons();
    // 1) стопим автосейв и фиксируем локально
    window.clearTimeout(saveTimer);
    persistNow();

    var token = getToken();
    if(!token){
      setSaveStatus('ok','Сохранено локально');
      toast('Сохранено','Чтобы опубликовать — войди на /auth');
      return;
    }

    setSaveStatus('saving','Публикация…');
    publishProfileToApi().then(function(){
      setSaveStatus('ok','Опубликовано');
      var s = normalizeSlug(state.slug || '');
      toast('Опубликовано','Профиль: /u/' + s);
    }).catch(function(err){
      setSaveStatus('ok','Сохранено локально');
      toast('Сохранено локально', err && err.message ? err.message : 'Не удалось опубликовать');
    });
  }

  function doOpenProfile(){
    blurActionButtons();
    var s = normalizeSlug(state.slug || '');
    if(!s){ toast('Нет slug','Сначала задай адрес'); return; }

    apiGetProfile(s).then(function(r){
      if(r.status === 200){
        window.open('/u/' + s, '_blank', 'noopener');
        toast('Открываю профиль','/u/' + s);
        return;
      }

      var token = getToken();
      if(!token){
        toast('Профиль не опубликован','Нажми «Сохранить» (нужен вход /auth)');
        return;
      }

      setSaveStatus('saving','Публикация…');
      publishProfileToApi().then(function(){
        setSaveStatus('ok','Опубликовано');
        window.open('/u/' + s, '_blank', 'noopener');
        toast('Открываю профиль','/u/' + s);
      }).catch(function(err){
        setSaveStatus('ok','Сохранено локально');
        toast('Не получилось', err && err.message ? err.message : 'Нажми «Сохранить»');
      });
    }).catch(function(){
      toast('Ошибка сети','Не удалось проверить профиль');
    });
  }

  function doPreviewReload(){
    blurActionButtons();
    setPreviewFrameUrl(true);
    toast('Preview','Перезагрузил витрину /u');
  }

  function toggleThemeQuick(){
    blurActionButtons();
    state.theme = (state.theme === 'dark') ? 'soft' : 'dark';
    $('theme').value = state.theme;
    document.documentElement.setAttribute('data-theme', state.theme);
    scheduleLocalSave();
    schedulePreviewSend();
    toast('Тема', 'Сейчас: ' + state.theme);
  }

  // =========================
  // INIT
  // =========================
  function init(){
    // tabs
    $('tabs').addEventListener('click', function(e){
      var t = e.target && e.target.closest ? e.target.closest('.tab') : null;
      if(!t) return;
      setTab(t.getAttribute('data-tab'));
    });

    // add buttons
    $('addBtn').addEventListener('click', function(){
      state.buttons = Array.isArray(state.buttons) ? state.buttons : [];
      state.buttons.push({label:'Новая кнопка', url:'', style:'ghost'});
      scheduleLocalSave();
      renderButtons();
      schedulePreviewSend();
    });

    $('addChip').addEventListener('click', function(){
      state.chips = Array.isArray(state.chips) ? state.chips : [];
      state.chips.push({label:'Контакт', url:'', icon:''});
      scheduleLocalSave();
      renderChips();
      schedulePreviewSend();
    });

    $('addPoint').addEventListener('click', function(){
      state.points = Array.isArray(state.points) ? state.points : [];
      state.points.push({title:'Пункт', text:'', url:''});
      scheduleLocalSave();
      renderPoints();
      schedulePreviewSend();
    });

    $('addWork').addEventListener('click', function(){
      state.gallery = Array.isArray(state.gallery) ? state.gallery : [];
      state.gallery.push({title:'Работа', text:'', img:'', url:''});
      scheduleLocalSave();
      renderGallery();
      schedulePreviewSend();
    });

    // actions
    $('save').addEventListener('click', function(e){ hardStop(e); doSaveAndPublish(); }, true);
    $('profileLink').addEventListener('click', function(e){ hardStop(e); doOpenProfile(); }, true);
    $('previewBtn').addEventListener('click', function(e){ hardStop(e); doPreviewReload(); }, true);
    $('themeBtn').addEventListener('click', function(e){ hardStop(e); toggleThemeQuick(); }, true);

    // initial preview refresh when iframe loads
    $('previewFrame').addEventListener('load', function(){
      // иногда /u не присылает ready (кэш/браузер), поэтому пушим сами
      postPreview();
    });

    // load state
    loadLocal();
    // ensure theme
    if (state.theme !== 'dark' && state.theme !== 'soft') state.theme = 'soft';
    document.documentElement.setAttribute('data-theme', state.theme);

    renderAll();
    setSaveStatus('ok','Готово');

    // если slug есть — сразу откроем preview url
    setPreviewFrameUrl(true);
  }

  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();

})();
</script>
  <!--
  ABQD • Constructor → /u Publish Bridge (drop‑in) • v1.2 • 2026‑01‑05

  ВСТАВЬ ЭТОТ БЛОК целиком в constructor/index.html ПЕРЕД закрывающим </body>
  (после всех твоих скриптов).

  Цель:
  - «Сохранить» = локально сохранить (как раньше) + (если есть токен) опубликовать в API
  - «Ссылка на профиль» = открыть /u/<slug> (если не опубликовано — сначала publish при наличии токена)
  - «Предпросмотр» = открыть /u/<slug>/?preview=1 и передать state через postMessage + продублировать в localStorage

  Важно:
  - Ошибка NO_TOKEN означает: в localStorage нет 'abqd_token'.
    Это нормально, если пользователь ещё не вошёл через /auth/.
  - Этот бридж НЕ падает с ошибкой, а показывает подсказку и даёт Preview.

  Для идеального зеркала нужно, чтобы /u/index.html умела:
  - GET /api/v1/profile/<slug> (боевой режим)
  - и/или принимать postMessage {type:'abqd_profile_state', state}
  - и/или читать localStorage 'abqd_preview_state_v1'
-->

<script>
(function(){
  'use strict';

  var STORAGE_KEY = 'abqd_constructor_demo_v2';
  var TOKEN_KEY   = 'abqd_token';
  var PREVIEW_KEY = 'abqd_preview_state_v1';

  function clean(s){ return String(s == null ? '' : s).replace(/^\s+|\s+$/g,''); }

  function safeJsonParse(s){
    try{ return JSON.parse(s); }catch(_e){ return null; }
  }

  function normalizeSlug(s){
    s = clean(s).toLowerCase();
    if (!s) return '';
    s = s.replace(/\s+/g,'-');
    // разрешаем a-z 0-9 - _
    s = s.replace(/[^a-z0-9\-_]/g,'');
    s = s.replace(/-+/g,'-');
    s = s.replace(/^[-_]+|[-_]+$/g,'');
    return s.slice(0, 64);
  }

  function getState(){
    // 1) если ты когда-нибудь захочешь — можешь назначить window.abqdState
    if (window.abqdState && typeof window.abqdState === 'object') return window.abqdState;

    // 2) читаем localStorage как в демо
    var raw = null;
    try{ raw = localStorage.getItem(STORAGE_KEY); }catch(_e){ raw = null; }
    if (!raw) return null;
    return safeJsonParse(raw);
  }

  function getToken(){
    try{ return clean(localStorage.getItem(TOKEN_KEY)); }catch(_e){ return ''; }
  }

  function findSlugInput(){
    var el = document.querySelector('[data-abqd="slug"]');
    if (el) return el;

    el = document.getElementById('slug') || document.getElementById('slugInput');
    if (el) return el;

    el = document.querySelector('input[name="slug"], input[name="profile_slug"], input[name="page_slug"]');
    if (el) return el;

    // эвристика
    var inputs = document.querySelectorAll('input[type="text"], input:not([type])');
    for (var i=0;i<inputs.length;i++){
      var p = (inputs[i].getAttribute('placeholder') || '').toLowerCase();
      var a = (inputs[i].getAttribute('aria-label') || '').toLowerCase();
      if (p.indexOf('slug') !== -1 || a.indexOf('slug') !== -1) return inputs[i];
    }
    return null;
  }

  function getSlug(){
    var st = getState() || {};
    var s = '';

    // разные схемы state
    if (typeof st.slug === 'string') s = st.slug;
    if (!s && st.profile && typeof st.profile.slug === 'string') s = st.profile.slug;

    // fallback: input
    if (!s){
      var inp = findSlugInput();
      if (inp) s = inp.value;
    }

    s = normalizeSlug(s);
    if (!s) return '';
    return s;
  }

  function toast(msg, isErr){
    var id = 'abqdToast';
    var el = document.getElementById(id);
    if (!el){
      el = document.createElement('div');
      el.id = id;
      el.style.cssText = [
        'position:fixed','right:14px','bottom:14px','z-index:99999',
        'max-width:420px','padding:10px 12px','border-radius:14px',
        'background:rgba(15,17,23,.92)','color:#fff',
        'border:1px solid rgba(255,255,255,.16)',
        'box-shadow:0 18px 60px rgba(0,0,0,.35)',
        'font:800 13px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial',
        'backdrop-filter: blur(10px)','white-space:pre-wrap'
      ].join(';');
      document.body.appendChild(el);
    }
    el.style.borderColor = isErr ? 'rgba(255,80,80,.45)' : 'rgba(255,255,255,.16)';
    el.textContent = msg;

    clearTimeout(el._t);
    el._t = setTimeout(function(){
      try{ el.remove(); }catch(_e){ el.style.display = 'none'; }
    }, isErr ? 7000 : 3400);
  }

  function savePreviewState(slug, st){
    try{
      localStorage.setItem(PREVIEW_KEY, JSON.stringify({
        slug: slug,
        ts: Date.now(),
        state: st
      }));
    }catch(_e){}
  }

  function apiFetch(method, url, bodyObj){
    var token = getToken();
    if (!token) return Promise.resolve({ __no_token: true });

    return fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: bodyObj ? JSON.stringify(bodyObj) : undefined
    }).then(function(r){
      return r.text().then(function(t){
        var j = null;
        try{ j = t ? JSON.parse(t) : null; }catch(_e){ j = null; }
        if (!r.ok){
          var msg = (j && (j.detail || j.message)) ? (j.detail || j.message) : (t || ('HTTP ' + r.status));
          throw new Error(msg);
        }
        return j || {};
      });
    });
  }

  function publishNow(opts){
    opts = opts || {};

    var slug = getSlug();
    if (!slug){
      toast('Slug не найден. Заполни поле SLUG.', true);
      return Promise.resolve({ ok:false, reason:'NO_SLUG' });
    }

    var st = getState();
    if (!st){
      toast('State не найден (localStorage ' + STORAGE_KEY + '). Открой/измени конструктор и нажми «Сохранить».', true);
      return Promise.resolve({ ok:false, reason:'NO_STATE' });
    }

    // всегда сохраняем preview state — полезно даже без токена
    savePreviewState(slug, st);

    var token = getToken();
    if (!token){
      if (!opts.silentNoToken){
        toast('Нет токена (abqd_token). Войди через /auth/ чтобы профиль стал публичным.\nPreview можно смотреть без токена.', true);
      }
      return Promise.resolve({ ok:false, reason:'NO_TOKEN' });
    }

    // лёгкая нормализация theme (не ломаем твой state)
    var theme = (st.theme === 'dark' || st.theme === 'soft') ? st.theme : 'soft';

    toast('Публикую профиль: ' + slug + ' …');
    return apiFetch('PUT', '/api/v1/profile/' + encodeURIComponent(slug), {
      slug: slug,
      theme: theme,
      state: st
    }).then(function(res){
      if (res && res.__no_token){
        // теоретически сюда не попадём, но пусть будет безопасно
        toast('Нет токена. Войди через /auth/.', true);
        return { ok:false, reason:'NO_TOKEN' };
      }
      toast('Опубликовано ✓  (' + slug + ')');
      return { ok:true, slug: slug };
    }).catch(function(e){
      toast('Ошибка публикации: ' + (e && e.message ? e.message : e), true);
      return { ok:false, reason:'PUBLISH_ERROR', error: String(e && e.message ? e.message : e) };
    });
  }

  function openPublic(){
    var slug = getSlug();
    if (!slug){ toast('Slug не найден.', true); return; }

    // если есть токен — пытаемся догнать публикацию перед открытием
    publishNow({ silentNoToken:true }).then(function(r){
      // если нет токена — всё равно можно открыть страницу, но она будет показывать либо preview, либо пусто
      window.open('/u/' + encodeURIComponent(slug) + '/', '_blank');
      if (r && r.ok){
        toast('Открываю публичный профиль: /u/' + slug);
      } else if (r && r.reason === 'NO_TOKEN'){
        toast('Открываю /u/' + slug + ' (без токена — только preview/локальные данные).', true);
      }
    });
  }

  function openPreview(){
    var slug = getSlug();
    if (!slug){ toast('Slug не найден.', true); return; }

    var st = getState();
    if (!st){ toast('State не найден.', true); return; }

    savePreviewState(slug, st);

    var w = window.open('/u/' + encodeURIComponent(slug) + '/?preview=1', '_blank');
    if (!w){ toast('Браузер заблокировал новое окно.', true); return; }

    // несколько попыток отправить state (на случай, если вкладка ещё грузится)
    var tries = 0;
    var timer = setInterval(function(){
      tries++;
      try{
        w.postMessage({ type:'abqd_profile_state', slug: slug, state: st }, window.location.origin);
      }catch(_e){}
      if (tries >= 20) clearInterval(timer);
    }, 200);

    toast('Preview открыт. Отправляю state…');
  }

  function hardStop(e){
    if (!e) return;
    try{ e.preventDefault(); }catch(_e){}
    try{ e.stopImmediatePropagation(); }catch(_e2){}
    try{ e.stopPropagation(); }catch(_e3){}
  }

  function bindById(){
    // В твоём конструкторе есть id: save, preview, profileLink
    var saveBtn = document.getElementById('save');
    var prevBtn = document.getElementById('preview');
    var linkBtn = document.getElementById('profileLink');

    // «Сохранить» — не ломаем твою логику: сначала даём твоим обработчикам сохранить state,
    // потом публикуем.
    if (saveBtn){
      saveBtn.addEventListener('click', function(){
        setTimeout(function(){ publishNow(); }, 160);
      }, false);
    }

    if (prevBtn){
      // preview уже может иметь свою модалку — НЕ перехватываем полностью.
      // Добавляем доп. поведение: открыть /u preview в новой вкладке.
      prevBtn.addEventListener('click', function(){
        setTimeout(function(){ openPreview(); }, 40);
      }, false);
    }

    if (linkBtn){
      // тут перехватываем, потому что «ссылка на профиль» должна вести на /u
      linkBtn.addEventListener('click', function(e){
        hardStop(e);
        openPublic();
      }, true);
    }

    return !!(saveBtn || prevBtn || linkBtn);
  }

  function bindByText(){
    // fallback если ids поменяются
    function hookText(text, fn, capture){
      var want = clean(text).toLowerCase();
      var nodes = document.querySelectorAll('button, a');
      for (var i=0;i<nodes.length;i++){
        var n = nodes[i];
        var t = clean(n.textContent).toLowerCase();
        if (t === want){
          n.addEventListener('click', function(e){
            if (capture) hardStop(e);
            fn();
          }, !!capture);
          return true;
        }
      }
      return false;
    }

    var a = hookText('Ссылка на профиль', openPublic, true);
    var b = hookText('Предпросмотр', openPreview, false);

    // на «Сохранить» — publish после сохранения
    var c = hookText('Сохранить', function(){ setTimeout(function(){ publishNow(); }, 160); }, false);

    return (a || b || c);
  }

  function addMiniPanel(){
    var id = 'abqdBridgePanel';
    if (document.getElementById(id)) return;

    var box = document.createElement('div');
    box.id = id;
    box.style.cssText = [
      'position:fixed','left:14px','bottom:14px','z-index:99998',
      'display:flex','gap:8px','flex-wrap:wrap',
      'padding:10px','border-radius:16px',
      'background:rgba(255,255,255,.10)','border:1px solid rgba(255,255,255,.18)',
      'backdrop-filter: blur(10px)','box-shadow:0 18px 60px rgba(0,0,0,.25)'
    ].join(';');

    function mk(label, onClick){
      var b = document.createElement('button');
      b.type = 'button';
      b.textContent = label;
      b.style.cssText = [
        'cursor:pointer','border-radius:999px','padding:10px 12px',
        'border:1px solid rgba(255,255,255,.22)','background:rgba(15,17,23,.75)',
        'color:#fff','font:900 12px/1 system-ui,-apple-system,Segoe UI,Roboto,Arial'
      ].join(';');
      b.addEventListener('click', function(e){ hardStop(e); onClick(); });
      return b;
    }

    box.appendChild(mk('PUBLISH', function(){ publishNow(); }));
    box.appendChild(mk('PUBLIC', function(){ openPublic(); }));
    box.appendChild(mk('PREVIEW', function(){ openPreview(); }));

    document.body.appendChild(box);
  }

  function runSelfTests(){
    try{
      console.assert(normalizeSlug('Ivan Ivanov') === 'ivan-ivanov', 'test normalizeSlug spaces');
      console.assert(normalizeSlug('---A__B---') === 'a__b', 'test normalizeSlug trims');
      console.assert(normalizeSlug('тест') === '', 'test normalizeSlug non-latin');
      // getToken может быть пустой — это НЕ ошибка
      console.assert(typeof getToken() === 'string', 'test getToken type');
    }catch(_e){}
  }

  function boot(){
    var ok = bindById();
    if (!ok) ok = bindByText();
    if (!ok){
      addMiniPanel();
      toast('Не нашёл кнопки (id/save/preview/profileLink). Добавил мини‑панель снизу слева.');
    }
    runSelfTests();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', boot);
  } else {
    boot();
  }
})();
</script>
</body>
</html>
