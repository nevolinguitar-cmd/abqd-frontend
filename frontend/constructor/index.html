<!doctype html>
<!--
  ABQD • Конструктор NFC 1.1 (фиксированная версия-эталон для отката)
  Дата фиксации: 2025-12-28
  Unified constructor/index.html (без дублей publish) • 2026-01-05
-->
<html lang="ru" data-theme="soft">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Конструктор профиля</title>

  <!-- Montserrat (UI font) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --font: 'Montserrat', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      --r1:16px;
      --r2:22px;

      /* DARK (Тёмная) */
      --bg:#0b0c10;
      --panel:#0f1117;
      --panel2:#11131b;
      --text:#eef1f6;
      --muted:rgba(238,241,246,.66);
      --line:rgba(255,255,255,.13);
      --shadow:0 18px 60px rgba(0,0,0,.30);

      --accent:#ff4d9d;
      --accent2:#6d5cff;
      --primary1:#ff4d9d;
      --primary2:#6d5cff;

      --gridBg: rgba(255,255,255,.03);

      /* OK / checkmark — зелёный */
      --ok:#39d98a;
      --ok2:#1bbf63;
    }

    html[data-theme="soft"]{
      /* WHITE (Белая) — айфон-стекло */
      --bg:#f4f6fb;
      --panel:rgba(255,255,255,.62);
      --panel2:rgba(255,255,255,.78);
      --text:#10131a;
      --muted:rgba(16,19,26,.56);
      --line:rgba(16,19,26,.14);
      --shadow:0 18px 60px rgba(18,24,40,.12);

      --accent:#2563eb;
      --accent2:#7c3aed;

      --primary1:#2563eb;
      --primary2:#7c3aed;

      --gridBg: rgba(255,255,255,.42);

      --ok:#39d98a;
      --ok2:#1bbf63;
    }

    *{box-sizing:border-box}
    body{margin:0;font-family:var(--font);color:var(--text);font-size:15.5px;line-height:1.62;
      background:
        radial-gradient(1100px 700px at 15% 10%, rgba(109,92,255,.16), transparent 55%),
        radial-gradient(1100px 700px at 85% 15%, rgba(255,77,157,.14), transparent 55%),
        var(--bg);
    }

    /* лёгкая «плёнка/зерно» */
    body::before{content:"";position:fixed;inset:0;pointer-events:none;z-index:0;
      opacity:.055;mix-blend-mode:overlay;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.55'/%3E%3C/svg%3E");
      transform:translateZ(0)}

    .wrap{position:relative;z-index:1}
    .wrap{max-width:1320px;margin:0 auto;padding:18px 14px 44px;}

    .top{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;margin:6px 0 14px;}
    h1{margin:0;font-size:38px;letter-spacing:-.045em;line-height:1.04;font-weight:800}

    .seg{display:inline-flex;border:1px solid var(--line);background:rgba(0,0,0,.08);border-radius:999px;overflow:hidden;backdrop-filter:blur(10px)}
    html[data-theme="soft"] .seg{background:rgba(255,255,255,.35)}
    .seg button{border:0;background:transparent;cursor:pointer;padding:9px 12px;font-size:12px;color:var(--muted);font-weight:800}
    .seg button.active{color:var(--text);background:linear-gradient(90deg,rgba(255,255,255,.16),rgba(255,255,255,.06))}

    /* ===== кнопки (пилюли) ===== */
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{
      position:relative;
      border:1px solid var(--line);
      background:rgba(0,0,0,.08);
      color:var(--text);
      border-radius:999px;
      padding:11px 14px;
      font-weight:800;
      font-size:13px;
      cursor:pointer;
      overflow:hidden;
      isolation:isolate;
      transform:translateZ(0);
      transition:transform .14s ease, filter .14s ease, background .14s ease;
    }
    html[data-theme="soft"] .btn{background:rgba(255,255,255,.45)}
    .btn:active{transform:translateY(1px)}
    .btn.outline{background:transparent}

    /* Активное состояние только для нижних action-кнопок */
    .btn.active{
      border-color:rgba(255,77,157,.55);
      box-shadow:0 0 0 2px rgba(255,77,157,.18) inset;
    }
    html[data-theme="soft"] .btn.active{
      border-color:rgba(37,99,235,.40);
      box-shadow:0 0 0 2px rgba(37,99,235,.12) inset;
    }

    /* ===== slug footer (как на скрине) ===== */
    .slugFooter{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-top:12px}
    .slugActionsLeft{display:flex;gap:10px;flex-wrap:wrap}
    .slugAction{letter-spacing:.12em;text-transform:uppercase;font-size:11.5px;padding:10px 14px}
    .slugTipInline{margin-top:8px;font-size:12.5px;line-height:1.4;color:var(--muted);font-weight:800;max-width:560px;text-align:left}

    .grid{
      display:grid;
      grid-template-columns:1.25fr .75fr;
      gap:12px;
      align-items:start;
      padding:10px;
      border-radius:var(--r2);
      background:var(--gridBg);
      border:1px solid rgba(255,255,255,.10);
    }
    html[data-theme="soft"] .grid{border-color:rgba(0,0,0,.10)}

    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    @media (max-width: 560px){
      .wrap{padding-top:86px}
      h1{font-size:28px}
      .top{margin:0 0 12px}
      .grid{padding:8px}
    }

    .card{position:relative;border:1px solid var(--line);
      background:
        radial-gradient(120% 140% at 10% 0%, rgba(255,255,255,.10), transparent 55%),
        linear-gradient(180deg,var(--panel),rgba(255,255,255,.04));
      border-radius:var(--r2);
      box-shadow:var(--shadow);
      backdrop-filter:blur(12px);
      overflow:hidden}
    .card::before{content:"";position:absolute;inset:0;border-radius:inherit;pointer-events:none;
      background:linear-gradient(135deg, rgba(255,255,255,.22), transparent 42%, rgba(255,255,255,.10));
      opacity:.18;mix-blend-mode:overlay}
    html[data-theme="soft"] .card::before{opacity:.10;mix-blend-mode:normal}

    .cardHd{padding:14px 14px 10px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .cardHd b{font-size:12px;letter-spacing:.16em;text-transform:uppercase;color:var(--muted)}

    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{border:1px solid var(--line);background:rgba(0,0,0,.08);color:var(--text);border-radius:999px;padding:8px 10px;font-weight:800;font-size:12px;cursor:pointer}
    html[data-theme="soft"] .tab{background:rgba(255,255,255,.45)}
    .tab.active{border-color:rgba(255,77,157,.55);box-shadow:0 0 0 2px rgba(255,77,157,.18) inset}
    html[data-theme="soft"] .tab.active{border-color:rgba(37,99,235,.40);box-shadow:0 0 0 2px rgba(37,99,235,.12) inset}

    .pad{padding:14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 560px){.row{grid-template-columns:1fr}}

    label{display:block;margin:0 0 6px;font-size:10.5px;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);font-weight:700}
    .help{margin:6px 0 0;color:var(--muted);font-size:13.5px;line-height:1.55;font-weight:600}
    .mini{font-size:12px;color:var(--muted);font-weight:800}

    /* ===== Save state ===== */
    .saveStatus{display:flex;align-items:center;gap:8px;margin-top:10px}
    .saveDot{width:8px;height:8px;border-radius:999px;background:var(--muted);opacity:.55;flex:0 0 auto}
    .saveStatus .saveTxt{font-size:12px;color:var(--muted);font-weight:800;letter-spacing:.02em}
    .saveStatus[data-state="dirty"] .saveDot{background:rgba(255,77,157,.85);opacity:.95}
    html[data-theme="soft"] .saveStatus[data-state="dirty"] .saveDot{background:rgba(37,99,235,.80)}
    .saveStatus[data-state="saving"] .saveDot{background:rgba(109,92,255,.85);opacity:.95;animation:savePulse 1.1s ease-in-out infinite}
    html[data-theme="soft"] .saveStatus[data-state="saving"] .saveDot{background:rgba(124,58,237,.78)}
    .saveStatus[data-state="saved"] .saveDot{background:var(--muted);opacity:.5}
    @keyframes savePulse{0%,100%{transform:scale(1)}50%{transform:scale(1.55)}}

    input, textarea, select{width:100%;border-radius:14px;padding:11px 12px;border:1px solid var(--line);
      background:rgba(0,0,0,.16);color:var(--text);outline:none;font-size:14px;
      transition:border-color .14s ease, box-shadow .14s ease, transform .14s ease
    }
    html[data-theme="soft"] input, html[data-theme="soft"] textarea, html[data-theme="soft"] select{
      background:rgba(255,255,255,.82);
      color:var(--text);
      border-color:rgba(0,0,0,.12);
    }

    textarea{min-height:112px;resize:vertical}
    input.mutedDefault, textarea.mutedDefault{color:var(--muted)}

    input:focus, textarea:focus, select:focus{
      border-color:rgba(255,77,157,.45);
      box-shadow:0 0 0 4px rgba(255,77,157,.12);
      transform:translateY(-1px)
    }
    html[data-theme="soft"] input:focus, html[data-theme="soft"] textarea:focus, html[data-theme="soft"] select:focus{
      border-color:rgba(37,99,235,.38);
      box-shadow:0 0 0 4px rgba(37,99,235,.10);
    }

    input::placeholder, textarea::placeholder{color:rgba(255,255,255,.45)}
    html[data-theme="soft"] input::placeholder, html[data-theme="soft"] textarea::placeholder{color:rgba(16,19,26,.38)}

    /* Подвал под карточками «Работы» */
    .galleryFoot{margin-top:14px;padding-top:12px;border-top:1px solid rgba(255,255,255,.10);display:flex;justify-content:center;text-align:center;color:var(--muted);font-size:12.5px;font-weight:800;letter-spacing:.01em}
    html[data-theme="soft"] .galleryFoot{border-top:1px solid rgba(0,0,0,.10)}
    input[type="file"]{color:var(--muted);padding:10px 12px;}

    input[type="file"]::file-selector-button,
    input[type="file"]::-webkit-file-upload-button{
      border:1px solid var(--line);
      border-radius:12px;
      padding:8px 12px;
      margin-right:10px;
      font-family:var(--font);
      font-weight:800;
      font-size:12.5px;
      letter-spacing:.02em;
      cursor:pointer;
      transition:transform .14s ease, filter .14s ease, background .14s ease, border-color .14s ease;
      color:var(--text);
      background:linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
      box-shadow:
        0 10px 22px rgba(0,0,0,.22),
        0 1px 0 rgba(255,255,255,.08) inset;
    }
    input[type="file"]::file-selector-button:hover,
    input[type="file"]::-webkit-file-upload-button:hover{filter:brightness(1.05)}
    input[type="file"]::file-selector-button:active,
    input[type="file"]::-webkit-file-upload-button:active{transform:translateY(1px)}

    html[data-theme="soft"] input[type="file"]::file-selector-button,
    html[data-theme="soft"] input[type="file"]::-webkit-file-upload-button{
      color:rgba(16,19,26,.88);
      border-color:rgba(16,19,26,.14);
      background:linear-gradient(180deg,
        rgba(228,232,239,.98) 0%,
        rgba(206,213,224,.97) 55%,
        rgba(186,195,210,.96) 100%);
      box-shadow:
        0 12px 24px rgba(18,24,40,.10),
        0 1px 0 rgba(255,255,255,.78) inset,
        0 -1px 0 rgba(0,0,0,.06) inset;
    }

    .btn:focus-visible, .tab:focus-visible, .x:focus-visible, .chipA:focus-visible, .cta a:focus-visible{
      outline:none;
      box-shadow:0 0 0 4px rgba(255,77,157,.16)
    }
    html[data-theme="soft"] .btn:focus-visible,
    html[data-theme="soft"] .tab:focus-visible,
    html[data-theme="soft"] .x:focus-visible,
    html[data-theme="soft"] .chipA:focus-visible,
    html[data-theme="soft"] .cta a:focus-visible{box-shadow:0 0 0 4px rgba(37,99,235,.12)}

    /* ===== Увеличенный «Редактор» ===== */
    <iframe
  id="abqdUMirror"
  src="/u/preview?preview=1"
  style="width:100%; height: calc(100vh - 24px); border:0; border-radius:18px; overflow:hidden;"
  loading="lazy"
  referrerpolicy="no-referrer"
></iframe>

    .editorCard{align-self:start}
    @media (min-width: 981px){
      .editorCard{position:sticky;top:14px;max-height:calc(100vh - 28px);overflow:hidden;}
      .editorCard .cardHd{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,var(--panel2),var(--panel));backdrop-filter:blur(14px)}
      .editorCard .pad{max-height:calc(100vh - 128px);overflow:auto}
      .editorCard .pad::-webkit-scrollbar{width:10px}
      .editorCard .pad::-webkit-scrollbar-thumb{background:rgba(255,255,255,.14);border-radius:999px;border:2px solid transparent;background-clip:content-box}
      html[data-theme="soft"] .editorCard .pad::-webkit-scrollbar-thumb{background:rgba(0,0,0,.16);background-clip:content-box}
      .editorCard .pad::-webkit-scrollbar-track{background:transparent}
    }

    /* Контакты (чипы) */
    .chipsRow{display:flex;flex-wrap:wrap;gap:10px}
    .chipA{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:999px;border:1px solid var(--line);
      background:rgba(0,0,0,.05);text-decoration:none;color:var(--muted)!important;font-weight:800;font-size:12px;
      position:relative;overflow:hidden;isolation:isolate;transform:translateZ(0);
      transition:transform .14s ease, filter .14s ease
    }
    html[data-theme="soft"] .chipA{background:rgba(255,255,255,.45)}
    .chipA:visited{color:var(--muted)!important}
    .chipA:hover{color:var(--text)!important}
    .chipA:active{transform:translateY(1px)}
    .chipI{opacity:.9;color:var(--muted)}

    /* Preview */
    .hero{padding:16px}

    .banner{position:relative;height:220px;border-radius:var(--r2);overflow:hidden;border:1px solid var(--line);background:rgba(0,0,0,.10);z-index:1}
    .bannerPlh{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      font-weight:800;letter-spacing:.12em;text-transform:uppercase;font-size:12px;
      color:var(--muted);background:linear-gradient(180deg, rgba(255,255,255,.06), transparent);
      pointer-events:none}
    html[data-theme="soft"] .bannerPlh{background:linear-gradient(180deg, rgba(255,255,255,.30), transparent)}
    .banner img{width:100%;height:100%;object-fit:cover;display:block}

    .bannerLogo{position:absolute;right:12px;top:12px;width:56px;height:56px;border-radius:16px;
      border:1px solid var(--line);background:rgba(0,0,0,.18);backdrop-filter:blur(10px);
      display:flex;align-items:center;justify-content:center;overflow:hidden;text-decoration:none;
      box-shadow:0 10px 30px rgba(0,0,0,.18)}
    html[data-theme="soft"] .bannerLogo{background:rgba(255,255,255,.55)}
    .bannerLogo img{width:100%;height:100%;object-fit:cover;display:block}

    .heroHead{margin-top:-54px;display:flex;align-items:flex-end;justify-content:space-between;gap:12px;flex-wrap:wrap;padding:0 10px;position:relative;z-index:3}

    .left{display:flex;align-items:flex-end;gap:12px}
    .avatar{width:106px;height:106px;border-radius:999px;border:4px solid rgba(255,255,255,.9);overflow:hidden;background:rgba(0,0,0,.18);
      box-shadow:0 18px 60px rgba(0,0,0,.20);flex:0 0 auto;display:flex;align-items:center;justify-content:center;
      position:relative;z-index:4}
    .avatar img{width:100%;height:100%;object-fit:cover;display:block}
    .avatar .fallback{font-weight:800;font-size:38px;opacity:.92}

    .nm{margin:0;font-size:28px;letter-spacing:-.02em;line-height:1.08;font-weight:800}
    .nm.ph{color:var(--muted);font-weight:800;text-decoration:underline;text-decoration-style:dotted;
      text-underline-offset:7px;text-decoration-thickness:2px}
    .rl{margin:6px 0 0;color:var(--muted);letter-spacing:.14em;text-transform:uppercase;font-size:12px;font-weight:800}
    .rl.ph{opacity:.95;text-decoration:underline;text-decoration-style:dotted;text-underline-offset:7px;text-decoration-thickness:2px}

    .about{padding:10px 10px 14px}
    .h2{margin:10px 0 10px;letter-spacing:.16em;text-transform:uppercase;font-size:12px;color:var(--muted);font-weight:800}
    .aboutText{margin:0;line-height:1.72;font-size:14.5px;white-space:pre-wrap;color:rgba(238,241,246,.78)}
    html[data-theme="soft"] .aboutText{color:rgba(16,19,26,.72)}

    .cta{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .cta a{border:1px solid var(--line);border-radius:999px;padding:11px 14px;font-weight:800;font-size:13px;text-decoration:none;
      color:#fff;
      background:rgba(0,0,0,.22);
      position:relative;overflow:hidden;isolation:isolate;transform:translateZ(0);
      transition:transform .14s ease, filter .14s ease
    }
    .cta a:active{transform:translateY(1px)}

    .cta a.primary{border:0 !important;background:transparent !important;color:#fff !important;border-radius:999px;overflow:hidden;position:relative;isolation:isolate;transform:translateZ(0);box-shadow:0 10px 26px rgba(0,0,0,.14)}
    .cta a.primary::before{content:"";position:absolute;inset:-1px;background:linear-gradient(90deg,var(--primary1),var(--primary2));border-radius:inherit;z-index:-1;transform:translateZ(0)}

    html[data-theme="soft"] .cta a.primary{color:var(--text) !important;text-shadow:none;border:1px solid rgba(16,19,26,.16) !important;box-shadow:0 16px 36px rgba(18,24,40,.14),0 1px 0 rgba(255,255,255,.70) inset,0 -1px 0 rgba(0,0,0,.06) inset;letter-spacing:.01em}
    html[data-theme="soft"] .cta a.primary::before{background:linear-gradient(180deg, rgba(226,229,235,.98) 0%, rgba(196,203,214,.96) 48%, rgba(168,177,191,.95) 100%)}

    .section{padding:16px}
    .secTitle{margin:0 0 12px;font-size:12px;letter-spacing:.18em;text-transform:uppercase;color:var(--muted);font-weight:800;position:relative}

    .list{display:flex;flex-direction:column;gap:10px}
    .item{border:1px solid var(--line);background:rgba(0,0,0,.05);border-radius:var(--r1);padding:12px;display:flex;gap:12px;align-items:flex-start;position:relative;overflow:hidden}
    html[data-theme="soft"] .item{background:rgba(255,255,255,.45)}

    .check{
      width:28px;height:28px;border-radius:999px;border:1px solid var(--line);
      background:rgba(0,0,0,.08);color:var(--ok);
      display:flex;align-items:center;justify-content:center;
      font-weight:900;font-size:14px;line-height:1;flex:0 0 auto;
      box-shadow:0 10px 26px rgba(0,0,0,.16),0 0 0 1px rgba(255,255,255,.06) inset;
    }
    html[data-theme="soft"] .check{background:rgba(255,255,255,.45);box-shadow:0 10px 26px rgba(18,24,40,.10),0 0 0 1px rgba(0,0,0,.06) inset;}

    .itT{margin:0;font-weight:800;font-size:14px}
    .itD{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.55;white-space:pre-wrap}

    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media (max-width: 900px){.grid3{grid-template-columns:repeat(2,1fr)}}
    @media (max-width: 560px){.grid3{grid-template-columns:1fr}}

    .work{border:1px solid var(--line);border-radius:var(--r1);overflow:hidden;background:rgba(0,0,0,.05);cursor:pointer;transition:.18s ease;min-height:220px;display:flex;flex-direction:column}
    html[data-theme="soft"] .work{background:rgba(255,255,255,.45)}
    .work:hover{transform:translateY(-2px)}
    .workImg{height:160px;background:rgba(0,0,0,.12)}
    .workImg img{width:100%;height:100%;object-fit:cover;display:block}
    .workBody{padding:12px}
    .workT{margin:0;font-weight:800;font-size:14px;line-height:1.2;white-space:pre-wrap;word-break:break-word}
    .workM{margin:7px 0 0;color:var(--muted);font-size:13px;line-height:1.5;white-space:pre-wrap}

    .hide{display:none!important}

    /* destructive buttons */
    .btn.danger{border-color: var(--line); color: var(--text); background: transparent;}
    .btn.danger:hover{border-color: rgba(255,77,157,.55); color: rgba(255,77,157,.55);}
    html[data-theme="soft"] .btn.danger:hover{border-color: rgba(37,99,235,.42); color: rgba(37,99,235,.58);}

    /* Modal preview */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}
    .modal.show{display:flex}
    .modalBackdrop{position:absolute;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(16px)}
    .modalPanel{position:relative;width:min(780px, 96vw);max-height:92vh;overflow:auto;
      transform:translateY(18px);opacity:0;
      transition:transform .28s cubic-bezier(.2,.8,.2,1), opacity .22s ease;
      will-change:transform,opacity}
    .modal.show .modalPanel{transform:translateY(0);opacity:1}
    .modalTop{position:sticky;top:0;z-index:2;display:flex;justify-content:flex-end;gap:10px;padding:10px;background:linear-gradient(180deg, rgba(0,0,0,.22), transparent)}
    html[data-theme="soft"] .modalTop{background:linear-gradient(180deg, rgba(255,255,255,.50), transparent)}
    .x{width:42px;height:42px;border-radius:14px;border:1px solid var(--line);background:rgba(0,0,0,.18);
      color:var(--text);cursor:pointer;font-weight:800}
    html[data-theme="soft"] .x{background:rgba(255,255,255,.55)}

    body.modalOpen{overflow:hidden;padding-right:var(--sbw,0px)}

    /* toast */
    .toastWrap{position:fixed;right:14px;bottom:14px;z-index:99999;display:flex;flex-direction:column;gap:10px;pointer-events:none}
    .toast{pointer-events:none;max-width:min(420px, 92vw);
      border:1px solid var(--line);
      background:linear-gradient(180deg, var(--panel2), var(--panel));
      color:var(--text);
      border-radius:18px;
      padding:12px 14px;
      box-shadow:0 18px 60px rgba(0,0,0,.22);
      backdrop-filter:blur(14px);
      transform:translateY(10px);
      opacity:0;
      transition:transform .24s cubic-bezier(.2,.8,.2,1), opacity .18s ease;
      font-weight:800
    }
    .toast.show{transform:translateY(0);opacity:1}
    .toast small{display:block;margin-top:3px;color:var(--muted);font-weight:700}
  </style>
</head>

<body>
  <div class="wrap" id="appWrap">
    <div class="top">
      <div>
        <h1>Конструктор профиля</h1>
        <p class="help" style="margin:22px 0 0;max-width:860px;font-weight:800">Заполни данные → получи ссылку на свою визитку → и интерфейс твоего профиля у тебя в руках.</p>
      </div>
      <div class="seg" id="themeSeg">
        <button type="button" data-theme="dark">Тёмная</button>
        <button type="button" data-theme="soft">Белая</button>
      </div>
    </div>

    <div class="grid">
      <!-- EDITOR -->
      <div class="card editorCard">
        <div class="cardHd">
          <b>Редактор</b>
          <div class="tabs" id="tabs">
            <button class="tab active" data-tab="profile" type="button">Профиль</button>
            <button class="tab" data-tab="buttons" type="button">Кнопки</button>
            <button class="tab" data-tab="links" type="button">Контакты</button>
            <button class="tab" data-tab="points" type="button">Ссылки</button>
            <button class="tab" data-tab="gallery" type="button">Фото</button>
          </div>
        </div>

        <!-- TAB: profile -->
        <div class="pad" id="tab-profile">
          <div class="row">
            <div>
              <label>Имя Фамилия *</label>
              <input id="fullName" placeholder="Иванов Иван Иванович" />
            </div>
            <div>
              <label>Должность</label>
              <input id="role" placeholder="АРХИТЕКТОР &amp; ДИЗАЙНЕР" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Аватар (800×800)</label>
              <input id="avatarFile" type="file" accept="image/*" />
              <input id="avatarUrl" placeholder="Ссылка на фото (опционально)" style="margin-top:8px" />
            </div>
            <div>
              <label>Баннер (1600×800)</label>
              <input id="bannerFile" type="file" accept="image/*" />
              <input id="bannerUrl" placeholder="Ссылка на баннер (опционально)" style="margin-top:8px" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Логотип (500×500 PNG)</label>
              <input id="logoFile" type="file" accept="image/*" />
              <input id="logoUrl" placeholder="Ссылка на логотип (опционально)" style="margin-top:8px" />
            </div>
            <div>
              <label>Ссылка логотипа</label>
              <input id="logoLink" placeholder="https://abqd.ru" />
            </div>
          </div>

          <div style="margin-top:10px">
            <label>Обо мне (до 500 символов)</label>
            <textarea id="about" maxlength="500"></textarea>
            <div class="mini"><span id="aboutCount">0</span>/500</div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Адрес страницы (slug)</label>
              <input id="slug" placeholder="ivan-ivanov" />
              <div class="help">Публично будет: <b><span id="slugPublicUrl">app.abqd.ru/u/slug</span></b></div>
              <div class="slugTipInline">Совет: короткий slug выигрывает в будущем — меньше ошибок, лучше шаринг.</div>
            </div>
            <div></div>
          </div>

          <div class="slugFooter">
            <div class="slugActionsLeft">
              <button class="btn outline slugAction" id="save" type="button">Сохранить</button>
              <button class="btn outline slugAction" id="preview" type="button">Предпросмотр</button>
              <button class="btn outline slugAction" id="profileLink" type="button">Ссылка на профиль</button>
            </div>
            <button class="btn outline slugAction" id="reset" type="button">Сбросить</button>
          </div>

          <div class="saveStatus" id="saveStatus" data-state="saved" aria-live="polite">
            <span class="saveDot" aria-hidden="true"></span>
            <span class="saveTxt" id="saveStatusText">Сохранено</span>
          </div>
        </div>

        <!-- TAB: buttons -->
        <div class="pad hide" id="tab-buttons">
          <div class="help" style="margin:0 0 10px;font-weight:800">Кнопки под описанием (CTA). До 6 (если указан телефон — до 5, т.к. добавится «Позвонить»).</div>
          <div style="margin:0 0 12px">
            <label>Телефон для кнопки «Позвонить»</label>
            <input id="phone" placeholder="+7 999 000-00-00" />
            <div class="help" style="margin:6px 0 0">Если заполнено — в профиле появится кнопка «Позвонить». Очистишь — кнопка исчезнет.</div>

            <div style="margin-top:10px">
              <label>Стиль кнопки «Позвонить»</label>
              <select id="callStyle">
                <option value="ghost">Обычная</option>
                <option value="primary">Акцент</option>
              </select>
              <div class="help" style="margin:6px 0 0">Работает только если телефон заполнен.</div>
            </div>
          </div>
          <div id="buttonsList"></div>
          <div class="btnRow">
            <button class="btn" id="addButton" type="button">＋ Добавить кнопку</button>
          </div>
        </div>

        <!-- TAB: points -->
        <div class="pad hide" id="tab-points">
          <div class="row">
            <div>
              <label>Заголовок блока</label>
              <input id="pointsTitle" placeholder="Ссылки" />
            </div>
            <div class="help" style="align-self:end">Пункты с возможностью ссылки. Максимум 12.</div>
          </div>
          <div style="margin-top:10px" id="pointsList"></div>
          <div class="btnRow">
            <button class="btn" id="addPoint" type="button">＋ Добавить пункт</button>
          </div>
        </div>

        <!-- TAB: gallery -->
        <div class="pad hide" id="tab-gallery">
          <div class="row">
            <div>
              <label>Заголовок блока</label>
              <input id="galleryTitle" placeholder="Работы" />
            </div>
            <div class="help" style="align-self:end">До 12 карточек. У каждой: фото + подпись + ссылка.</div>
          </div>
          <div style="margin-top:10px" id="galleryList"></div>
          <div class="btnRow">
            <button class="btn" id="addGallery" type="button">＋ Добавить работу</button>
          </div>
        </div>

        <!-- TAB: links -->
        <div class="pad hide" id="tab-links">
          <div class="help" style="margin:0 0 10px;font-weight:800">Контакты (редактор). До 20. По умолчанию без смайликов — только текст.</div>
          <div id="chipsList"></div>
          <div class="btnRow">
            <button class="btn" id="addChip" type="button">＋ Добавить контакт</button>
          </div>
        </div>
      </div>

      <!-- PREVIEW -->
      <div id="previewMount">
        <div class="card" id="previewCard">
          <div class="cardHd">
            <b>Профиль</b>
            <span class="mini"></span>
          </div>

          <div class="hero">
            <div class="banner" id="bannerBox">
              <div class="bannerPlh" id="bannerPlh">Баннер (1600×800)</div>
            </div>

            <div class="heroHead">
              <div class="left">
                <div class="avatar" id="avatarBox"><span class="fallback">A</span></div>
                <div>
                  <h2 class="nm" id="nameEl"></h2>
                  <div class="rl" id="roleEl"></div>
                </div>
              </div>
            </div>

            <div class="about">
              <div class="h2">Обо мне</div>
              <p class="aboutText" id="aboutEl"></p>
              <div class="cta" id="ctaRow"></div>
            </div>
          </div>

          <div class="section" id="contactsSection" style="padding:0 10px 16px">
            <div class="secTitle" id="contactsTitleEl">Контакты</div>
            <div class="chipsRow" id="contactsPreview"></div>
          </div>

          <div class="section" id="pointsSection">
            <div class="secTitle" id="pointsTitleEl">Ссылки</div>
            <div class="list" id="pointsPreview"></div>
          </div>

          <div class="section" id="gallerySection">
            <div class="secTitle" id="galleryTitleEl">Работы</div>
            <div class="grid3" id="galleryPreview"></div>
            <div class="galleryFoot"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- TOASTS -->
  <div class="toastWrap" id="toastWrap" aria-live="polite" aria-atomic="true"></div>

  <!-- MODAL -->
  <div class="modal" id="modal">
    <div class="modalBackdrop" id="modalBackdrop"></div>
    <div class="modalPanel" id="modalPanel">
      <div class="modalTop">
        <button class="x" id="modalClose" type="button">✕</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <script>
  (function(){
    // ES5-совместимая версия

    var KEY = 'abqd_constructor_demo_v2';
    var BUILD = 'Конструктор NFC 1.1';
    try { window.__ABQD_CONSTRUCTOR_BUILD = BUILD; } catch(e) {}
    function $(id){ return document.getElementById(id); }

    function clone(obj){
      try { return JSON.parse(JSON.stringify(obj)); }
      catch(e){ return {}; }
    }

    var defaultState = {
      slug: 'ivan-ivanov',
      theme: 'soft',
      fullName: 'Иванов Иван Иванович',
      role: 'АРХИТЕКТОР & ДИЗАЙНЕР',
      about: 'Профессиональный архитектор с опытом разработки жилых и коммерческих проектов. Специализируюсь на создании функциональных и эстетичных пространств, где каждый элемент работает в гармонии.',
      avatarDataUrl: '',
      bannerDataUrl: '',
      logoDataUrl: '',
      logoLink: 'https://abqd.ru',
      phone: '',
      callStyle: 'ghost',
      buttons: [
        { label: 'Написать', url: 'https://t.me/', style: 'primary' }
      ],
      pointsTitle: 'Ссылки',
      points: [
        { title: 'Архитектурное проектирование', text: '', url: '' },
        { title: 'Дизайн интерьера', text: '', url: '' },
        { title: '3D визуализация проектов', text: '', url: '' },
        { title: 'Консультации и аудит', text: '', url: '' }
      ],
      galleryTitle: 'Работы',
      gallery: [
        { title: 'Проект 1', text: 'Короткое описание', img: '', url: '' },
        { title: 'Проект 2', text: 'Короткое описание', img: '', url: '' },
        { title: 'Проект 3', text: 'Короткое описание', img: '', url: '' }
      ],
      chips: [
        { label: 'Telegram', url: 'https://t.me/', icon: '' },
        { label: 'WhatsApp', url: 'https://wa.me/', icon: '' },
        { label: 'Сайт', url: 'https://', icon: '' }
      ]
    };

    function escapeHtml(s){
      s = String(s == null ? '' : s);
      return s
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/\"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function clean(s){ return String(s == null ? '' : s).replace(/^\s+|\s+$/g,''); }

    function normUrl(u){
      u = clean(u);
      if (!u) return '';
      var low = u.toLowerCase();
      if (low.indexOf('http://') === 0 || low.indexOf('https://') === 0) return u;
      if (low.indexOf('mailto:') === 0 || low.indexOf('tel:') === 0 || low.indexOf('tg://') === 0) return u;
      return 'https://' + u;
    }
    function openPublicProfile(slug){
      slug = (slug || '').trim();
      if(!slug) return alert('Укажи slug');
      window.open(`/u/${encodeURIComponent(slug)}/?fresh=1`, '_blank');
  }

    function contactUrl(u){
      u = clean(u);
      if (!u) return '';
      var low = u.toLowerCase();
      if (low.indexOf('http://') === 0 || low.indexOf('https://') === 0 || low.indexOf('mailto:') === 0 || low.indexOf('tel:') === 0 || low.indexOf('tg://') === 0) return u;
      if (u.indexOf('@') !== -1 && u.indexOf(' ') === -1) return 'mailto:' + u;

      var s = u;
      if (s && (s[0] === '+' || (s[0] >= '0' && s[0] <= '9')) && s.length >= 6) {
        if (/^[0-9\s()\-\.+]+$/.test(s)) {
          var digits = s.replace(/[\s\-().]/g, '');
          return 'tel:' + digits;
        }
      }

      return 'https://' + u;
    }

    function phoneToTel(s){
      s = clean(s);
      if (!s) return '';

      var out = '';
      for (var i = 0; i < s.length; i++) {
        var ch = s.charAt(i);
        if (ch >= '0' && ch <= '9') out += ch;
        else if (ch === '+' && out.length === 0) out += ch;
      }

      var digits = (out.charAt(0) === '+') ? out.slice(1) : out;
      if (digits.length < 6) return '';

      return 'tel:' + out;
    }

    function wrapFixedChars(text, n){
      text = String(text == null ? '' : text);
      n = (typeof n === 'number' && n > 0) ? n : 17;
      if (!text) return text;

      var lines = text.split(/\r?\n/);
      var out = [];
      for (var li = 0; li < lines.length; li++) {
        var line = lines[li];
        if (line.length <= n) { out.push(line); continue; }
        for (var i = 0; i < line.length; i += n) out.push(line.slice(i, i + n));
      }
      return out.join('\n');
    }

    function normalizeSlug(s){
      s = clean(s).toLowerCase();
      if (!s) return '';

      var allowed = 'abcdefghijklmnopqrstuvwxyz0123456789-_.';
      var out = '';
      var prevDash = false;

      for (var i = 0; i < s.length; i++) {
        var ch = s.charAt(i);
        if (ch === ' ') {
          if (!prevDash) { out += '-'; prevDash = true; }
          continue;
        }
        if (allowed.indexOf(ch) !== -1) {
          out += ch;
          prevDash = (ch === '-');
        } else {
          if (!prevDash) { out += '-'; prevDash = true; }
        }
      }

      while (out.indexOf('--') !== -1) out = out.replace(/--/g, '-');
      while (out.charAt(0) === '-' || out.charAt(0) === '.') out = out.slice(1);
      while (out.charAt(out.length - 1) === '-' || out.charAt(out.length - 1) === '.') out = out.slice(0, -1);

      return out;
    }

    function load(){
      var st = clone(defaultState);
      try {
        var raw = localStorage.getItem(KEY);
        if (!raw) return st;
        var parsed = JSON.parse(raw);
        for (var k in parsed) if (Object.prototype.hasOwnProperty.call(parsed, k)) st[k] = parsed[k];
        return st;
      } catch(e) {
        return st;
      }
    }

    var state = load();

    if (state.theme !== 'dark' && state.theme !== 'soft') state.theme = 'soft';
    if (state.callStyle !== 'primary' && state.callStyle !== 'ghost') state.callStyle = 'ghost';

    // Миграции
    if (state.buttons && state.buttons.length) {
      var bb = [];
      for (var bi = 0; bi < state.buttons.length; bi++) {
        var b = state.buttons[bi];
        var lbl = clean(b && b.label).toLowerCase();
        if (lbl === 'портфолио') continue;
        bb.push(b);
      }
      state.buttons = bb;
    }

    if (state.chips && state.chips.length) {
      for (var li = 0; li < state.chips.length; li++) {
        var c = state.chips[li] || {};
        var l = clean(c.label).toLowerCase();
        if (l === 'linkedin' || l === 'linked in' || l === 'линкедин' || l === 'линкед ин') {
          c.label = 'MAX';
          state.chips[li] = c;
        }
      }
    }

    // ===== Autosave =====
    var dirty = false;
    var saveTimer = null;
    var AUTOSAVE_MS = 900;

    function setSaveStatus(mode, note){
      var box = $('saveStatus');
      var tx = $('saveStatusText');
      if (!box || !tx) return;
      box.setAttribute('data-state', mode);
      if (mode === 'dirty') tx.textContent = note || 'Есть изменения (автосохранение…)';
      else if (mode === 'saving') tx.textContent = note || 'Автосохранение…';
      else tx.textContent = note || 'Сохранено';
    }

    function persistNow(){
      try { localStorage.setItem(KEY, JSON.stringify(state)); } catch(e) {}
      dirty = false;
      setSaveStatus('saved');
    }

    function persist(){
      dirty = true;
      setSaveStatus('dirty');
      if (saveTimer) window.clearTimeout(saveTimer);
      saveTimer = window.setTimeout(function(){
        setSaveStatus('saving');
        window.setTimeout(function(){ persistNow(); }, 80);
      }, AUTOSAVE_MS);
    }

    window.addEventListener('beforeunload', function(){
      if (dirty) persistNow();
    });

    function toast(title, subtitle){
      subtitle = subtitle || '';
      var wrap = $('toastWrap');
      if (!wrap) return;
      var t = document.createElement('div');
      t.className = 'toast';
      t.innerHTML = '<div>' + escapeHtml(title) + '</div>' + (subtitle ? '<small>' + escapeHtml(subtitle) + '</small>' : '');
      wrap.appendChild(t);
      t.getBoundingClientRect();
      t.classList.add('show');
      window.setTimeout(function(){
        t.classList.remove('show');
        window.setTimeout(function(){ if (t && t.parentNode) t.parentNode.removeChild(t); }, 260);
      }, 1600);
    }

    function safeOn(id, evt, handler){
      var el = $(id);
      if (!el) return;
      el.addEventListener(evt, handler);
    }

    function setTheme(t){
      state.theme = t;
      document.documentElement.setAttribute('data-theme', t);
      var seg = $('themeSeg');
      if (seg) {
        var btns = seg.querySelectorAll('button');
        for (var i = 0; i < btns.length; i++) {
          var b = btns[i];
          b.classList.toggle('active', b.getAttribute('data-theme') === t);
        }
      }
    }

    function fetchBlob(url){
      if (window.fetch) {
        return window.fetch(url, { mode: 'cors' }).then(function(res){ return res.blob(); });
      }
      return new Promise(function(resolve, reject){
        var xhr = new XMLHttpRequest();
        xhr.open('GET', url, true);
        xhr.responseType = 'blob';
        xhr.onload = function(){ resolve(xhr.response); };
        xhr.onerror = function(){ reject(new Error('XHR error')); };
        xhr.send();
      });
    }

    function fileToCoverDataUrl(file, w, h, quality){
      quality = (typeof quality === 'number') ? quality : 0.86;
      return new Promise(function(resolve, reject){
        var blobUrl = URL.createObjectURL(file);
        var img = new Image();
        img.onload = function(){
          try {
            var c = document.createElement('canvas');
            c.width = w; c.height = h;
            var ctx = c.getContext('2d');

            var scale = Math.max(w / img.width, h / img.height);
            var sw = w / scale;
            var sh = h / scale;
            var sx = (img.width - sw) / 2;
            var sy = (img.height - sh) / 2;
            ctx.drawImage(img, sx, sy, sw, sh, 0, 0, w, h);

            var out = c.toDataURL('image/jpeg', quality);
            resolve(out);
          } catch(e) {
            reject(e);
          } finally {
            URL.revokeObjectURL(blobUrl);
          }
        };
        img.onerror = function(){
          URL.revokeObjectURL(blobUrl);
          reject(new Error('Не удалось прочитать изображение'));
        };
        img.src = blobUrl;
      });
    }

    function urlToDataUrl(url, w, h, quality){
      quality = (typeof quality === 'number') ? quality : 0.86;
      url = normUrl(url);
      if (!url) return Promise.resolve('');
      return fetchBlob(url).then(function(blob){
        var file = new File([blob], 'img', { type: blob.type || 'image/jpeg' });
        return fileToCoverDataUrl(file, w, h, quality);
      });
    }

    <script>
(function(){
  var LS_KEY = "abqd_constructor_demo_v2";
  var frame = document.getElementById("abqdUMirror");
  if (!frame) return;

  // ВАЖНО: если /u на другом домене, укажи полный URL
  // var U_BASE = "https://app.abqd.ru";
  var U_BASE = ""; // same-origin
  var lastRaw = "";

  function safeJsonParse(s){
    try { return s ? JSON.parse(s) : null; } catch(e){ return null; }
  }

  function normalizeSlug(s){
    s = String(s || "").trim().toLowerCase().replace(/\/+$/,'');
    return s;
  }

  function pickSlug(state){
    // подстраховка: ищем slug в нескольких местах
    return normalizeSlug(
      (state && state.slug) ||
      (state && state.profile && state.profile.slug) ||
      (state && state.profileSlug) ||
      ""
    );
  }

  function buildPayload(state){
    // Можно отправлять “как есть” (старый schema) — /u уже поддерживает.
    // Но лучше завернуть в новый schema (стабильнее на будущее):
    return {
      schema: "abqd_profile_v1",
      theme: state && state.theme ? state.theme : "soft",
      profile: {
        name: (state && (state.fullName || (state.profile && state.profile.name))) || "",
        role: (state && (state.role || (state.profile && state.profile.role))) || "",
        about: (state && (state.about || (state.profile && state.profile.about))) || "",
        phone: (state && (state.phone || (state.profile && state.profile.phone))) || "",
        avatar_url: (state && (state.avatarDataUrl || (state.profile && state.profile.avatarUrl))) || "",
        banner_url: (state && (state.bannerDataUrl || (state.profile && state.profile.bannerUrl))) || "",
        logo_url: (state && (state.logoDataUrl || (state.profile && state.profile.logoUrl))) || "",
        logo_link: (state && (state.logoLink || (state.profile && state.profile.logoLink))) || ""
      },
      ui: {
        callStyle: (state && state.callStyle) || "primary",
        pointsTitle: (state && state.pointsTitle) || "Ссылки",
        galleryTitle: (state && state.galleryTitle) || "Работы"
      },
      buttons: (state && state.buttons) || [],
      contacts: (state && (state.chips || state.contacts)) || [],
      points: (state && state.points) || [],
      gallery: (state && state.gallery) || []
    };
  }

  function postToUMirror(state){
    if (!frame || !frame.contentWindow) return;
    var payload = buildPayload(state);
    frame.contentWindow.postMessage({ type: "abqd_profile_state", state: payload }, "*");
  }

  function sync(){
    var raw = localStorage.getItem(LS_KEY) || "";
    if (!raw || raw === lastRaw) return;
    lastRaw = raw;

    var st = safeJsonParse(raw);
    if (!st) return;

    // если есть slug — подставляем его в src (чтобы /u/<slug> тоже было корректно)
    var slug = pickSlug(st) || "preview";
    var wantSrc = U_BASE + "/u/" + encodeURIComponent(slug) + "?preview=1";
    if (frame.getAttribute("src") !== wantSrc) frame.setAttribute("src", wantSrc);

    postToUMirror(st);
  }

  // /u в preview-mode присылает "готов" — тогда пуляем сразу актуальный state
  window.addEventListener("message", function(e){
    var d = e && e.data;
    if (d && d.type === "abqd_u_ready") sync();
  });

  // триггеры
  window.addEventListener("storage", function(e){
    if (e && e.key === LS_KEY) sync();
  });

  // на случай когда конструктор сам пишет в localStorage в этой же вкладке
  setInterval(sync, 600);

  // первый старт
  sync();
})();
</script>


    // ===== MODAL =====
    var previewHomeParent = null;
    var previewHomeNext = null;

    function openModal(){
      var modal = $('modal');
      var panelBody = $('modalBody');
      var card = $('previewCard');
      if (!modal || !panelBody || !card) return;
      if (modal.classList.contains('show')) return;

      var sbw = window.innerWidth - document.documentElement.clientWidth;
      document.body.style.setProperty('--sbw', sbw + 'px');

      previewHomeParent = card.parentNode;
      previewHomeNext = card.nextSibling;
      panelBody.appendChild(card);

      modal.classList.add('show');
      document.body.classList.add('modalOpen');
    }

    function closeModal(){
      var modal = $('modal');
      var card = $('previewCard');
      if (!modal || !card) return;
      if (!modal.classList.contains('show')) return;

      if (previewHomeParent) previewHomeParent.insertBefore(card, previewHomeNext);

      modal.classList.remove('show');
      document.body.classList.remove('modalOpen');
      document.body.style.removeProperty('--sbw');
    }

    // ===== RENDER PREVIEW =====
    function renderPreview(){
      var nameRaw = clean(state.fullName);
      var nameEmpty = !nameRaw;
      var showName = nameEmpty ? 'Иванов Иван Иванович' : nameRaw;

      var nameEl = $('nameEl');
      if (nameEl) {
        nameEl.textContent = showName;
        nameEl.classList.toggle('ph', nameEmpty);
      }

      var roleRaw = clean(state.role);
      var roleEmpty = !roleRaw;
      var showRole = roleEmpty ? 'АРХИТЕКТОР & ДИЗАЙНЕР' : roleRaw;

      var roleEl = $('roleEl');
      if (roleEl) {
        roleEl.textContent = showRole;
        roleEl.classList.toggle('ph', roleEmpty);
      }

      var aboutEl = $('aboutEl');
      if (aboutEl) aboutEl.textContent = state.about || '';

      // slug
      state.slug = normalizeSlug(state.slug || '');
      var slugInput = $('slug');
      if (slugInput) slugInput.value = state.slug;
      var slugFullEl = $("slugPublicUrl");
      if (slugFullEl) slugFullEl.textContent = 'app.abqd.ru/u/' + (state.slug || '...');

      // banner + logo
      var banner = $('bannerBox');
      var plh = $('bannerPlh');
      var hasBanner = !!state.bannerDataUrl;
      if (plh) plh.style.display = hasBanner ? 'none' : 'flex';

      if (banner) {
        banner.innerHTML = '';
        if (plh) banner.appendChild(plh);

        if (hasBanner) {
          var imgB = document.createElement('img');
          imgB.src = state.bannerDataUrl;
          imgB.alt = 'banner';
          banner.insertBefore(imgB, banner.firstChild);

          if (state.logoDataUrl) {
            var link = state.logoLink ? normUrl(state.logoLink) : '';
            var a = document.createElement('a');
            a.className = 'bannerLogo';
            a.href = link || '#';
            a.target = '_blank';
            a.rel = 'noopener';
            if (!link) a.style.pointerEvents = 'none';

            var li2 = document.createElement('img');
            li2.src = state.logoDataUrl;
            li2.alt = 'logo';
            a.appendChild(li2);
            banner.appendChild(a);
          }
        }
      }

      // avatar
      var av = $('avatarBox');
      if (av) {
        av.innerHTML = '';
        if (state.avatarDataUrl) {
          var imgA = document.createElement('img');
          imgA.src = state.avatarDataUrl;
          imgA.alt = 'avatar';
          av.appendChild(imgA);
        } else {
          var letter = (nameRaw || 'A').slice(0, 1).toUpperCase();
          var span = document.createElement('span');
          span.className = 'fallback';
          span.textContent = letter;
          av.appendChild(span);
        }
      }

      // CTA (включая кнопку «Позвонить» при наличии телефона)
      var cta = $('ctaRow');
      if (cta) {
        cta.innerHTML = '';

        var phoneRaw = clean(state.phone);
        var hasPhone = !!phoneRaw;

        if (hasPhone) {
          var tel = phoneToTel(phoneRaw);
          var callBtn = document.createElement('a');
          callBtn.textContent = 'Позвонить';
          callBtn.className = (state.callStyle === 'primary') ? 'primary' : '';
          callBtn.href = tel || '#';
          callBtn.target = '_self';
          callBtn.rel = 'nofollow';
          if (!tel) {
            callBtn.style.opacity = '.55';
            callBtn.style.pointerEvents = 'none';
          }
          cta.appendChild(callBtn);
        }

        var maxButtons = hasPhone ? 5 : 6;
        var btns = state.buttons || [];
        for (var bi = 0; bi < btns.length && bi < maxButtons; bi++) {
          var btn = btns[bi];
          if (!btn || !btn.label) continue;
          var a2 = document.createElement('a');
          a2.textContent = btn.label;
          a2.className = (btn.style === 'primary') ? 'primary' : '';
          a2.href = normUrl(btn.url) || '#';
          a2.target = '_blank';
          a2.rel = 'noopener';
          if (!btn.url) a2.style.opacity = '.55';
          cta.appendChild(a2);
        }
      }

      // Контакты
      var contactsSection = $('contactsSection');
      var contactsPreview = $('contactsPreview');
      if (contactsPreview) {
        contactsPreview.innerHTML = '';
        var chips = state.chips || [];
        for (var ci = 0; ci < chips.length && ci < 20; ci++) {
          var c = chips[ci];
          var label = clean(c && c.label);
          var rawUrl = clean(c && c.url);
          var iconValue = clean(c && c.icon);
          if (!label && !rawUrl) continue;

          var a3 = document.createElement('a');
          a3.className = 'chipA';

          if (iconValue) {
            var icon = document.createElement('span');
            icon.className = 'chipI';
            icon.textContent = iconValue;
            a3.appendChild(icon);
          }

          var text = document.createElement('span');
          text.textContent = label || rawUrl;
          a3.appendChild(text);

          var href = contactUrl(rawUrl);
          a3.href = href || '#';
          a3.target = '_blank';
          a3.rel = 'noopener';
          if (!href) {
            a3.style.opacity = '.55';
            a3.style.pointerEvents = 'none';
          }

          contactsPreview.appendChild(a3);
        }
      }

      var hasContacts = false;
      var chips2 = state.chips || [];
      for (var ci2 = 0; ci2 < chips2.length; ci2++) {
        if (clean(chips2[ci2] && chips2[ci2].label) || clean(chips2[ci2] && chips2[ci2].url)) { hasContacts = true; break; }
      }
      if (contactsSection) contactsSection.classList.toggle('hide', !hasContacts);

      // Ссылки (points)
      var pointsTitleEl = $('pointsTitleEl');
      if (pointsTitleEl) pointsTitleEl.textContent = state.pointsTitle || 'Ссылки';

      var pl2 = $('pointsPreview');
      if (pl2) {
        pl2.innerHTML = '';
        var pts = state.points || [];
        for (var pi = 0; pi < pts.length && pi < 12; pi++) {
          var p = pts[pi];
          if (!p || !p.title) continue;

          var el = document.createElement('div');
          el.className = 'item';

          var chk = document.createElement('div');
          chk.className = 'check';
          chk.textContent = '✓';

          var box = document.createElement('div');
          box.style.minWidth = '0';

          var t2 = document.createElement('p');
          t2.className = 'itT';
          t2.textContent = p.title;
          box.appendChild(t2);

          if (p.text) {
            var d = document.createElement('div');
            d.className = 'itD';
            d.textContent = p.text;
            box.appendChild(d);
          }

          if (p.url) {
            var link2 = document.createElement('a');
            link2.className = 'mini';
            link2.href = normUrl(p.url);
            link2.target = '_blank';
            link2.rel = 'noopener';
            link2.textContent = 'Открыть ссылку';
            box.appendChild(link2);
          }

          el.appendChild(chk);
          el.appendChild(box);
          pl2.appendChild(el);
        }
      }

      var pointsSection = $('pointsSection');
      var hasPoints = (state.points && state.points.length);
      if (pointsSection) pointsSection.classList.toggle('hide', !hasPoints);

      // Галерея
      var galleryTitleEl = $('galleryTitleEl');
      if (galleryTitleEl) galleryTitleEl.textContent = state.galleryTitle || 'Работы';

      var gg = $('galleryPreview');
      if (gg) {
        gg.innerHTML = '';
        var gal = state.gallery || [];
        for (var gi = 0; gi < gal.length && gi < 12; gi++) {
          (function(g){
            var card = document.createElement('div');
            card.className = 'work';

            var imgWrap = document.createElement('div');
            imgWrap.className = 'workImg';
            if (g && g.img) {
              var img = document.createElement('img');
              img.src = g.img;
              img.alt = '';
              imgWrap.appendChild(img);
            }

            var body = document.createElement('div');
            body.className = 'workBody';

            var title = document.createElement('p');
            title.className = 'workT';
            title.textContent = wrapFixedChars((g && g.title) || '', 17);
            body.appendChild(title);

            if (g && g.text) {
              var desc = document.createElement('div');
              desc.className = 'workM';
              desc.textContent = g.text;
              body.appendChild(desc);
            }

            card.appendChild(imgWrap);
            card.appendChild(body);

            card.addEventListener('click', function(){
              if (g && g.url) window.open(normUrl(g.url), '_blank', 'noopener');
            });

            gg.appendChild(card);
          })(gal[gi]);
        }
      }

      var gallerySection = $('gallerySection');
      var hasGallery = (state.gallery && state.gallery.length);
      if (gallerySection) gallerySection.classList.toggle('hide', !hasGallery);
    }

    // ===== RENDER EDITOR LISTS =====
    function renderLists(){
      // Buttons
      var bl = $('buttonsList');
      if (bl) {
        bl.innerHTML = '';
        var btns = state.buttons || [];
        for (var i = 0; i < btns.length; i++) {
          var b = btns[i] || {};
          var wrap = document.createElement('div');
          wrap.className = 'card';
          wrap.style.marginBottom = '10px';
          wrap.innerHTML =
            '<div class="pad">' +
            '  <div class="row">' +
            '    <div><label>Текст</label><input data-b="label" data-i="' + i + '" value="' + escapeHtml(b.label || '') + '" /></div>' +
            '    <div><label>URL</label><input data-b="url" data-i="' + i + '" value="' + escapeHtml(b.url || '') + '" placeholder="https://..." /></div>' +
            '  </div>' +
            '  <div class="row" style="margin-top:10px">' +
            '    <div><label>Стиль</label>' +
            '      <select data-b="style" data-i="' + i + '">' +
            '        <option value="ghost" ' + (((b.style || 'ghost') === 'ghost') ? 'selected' : '') + '>Обычная</option>' +
            '        <option value="primary" ' + (((b.style || 'ghost') === 'primary') ? 'selected' : '') + '>Акцент</option>' +
            '      </select>' +
            '    </div>' +
            '    <div></div>' +
            '  </div>' +
            '  <div class="btnRow">' +
            '    <button class="btn danger" type="button" data-act="delBtn" data-i="' + i + '">Удалить</button>' +
            '    <button class="btn" type="button" data-act="upBtn" data-i="' + i + '">↑</button>' +
            '    <button class="btn" type="button" data-act="downBtn" data-i="' + i + '">↓</button>' +
            '  </div>' +
            '</div>';
          bl.appendChild(wrap);
        }
      }

      // Points
      var pl = $('pointsList');
      if (pl) {
        pl.innerHTML = '';
        var pts = state.points || [];
        for (var j = 0; j < pts.length; j++) {
          var p = pts[j] || {};
          var wrap2 = document.createElement('div');
          wrap2.className = 'card';
          wrap2.style.marginBottom = '10px';
          wrap2.innerHTML =
            '<div class="pad">' +
            '  <div class="row">' +
            '    <div><label>Заголовок</label><input data-p="title" data-i="' + j + '" value="' + escapeHtml(p.title || '') + '" /></div>' +
            '    <div><label>URL (опц.)</label><input data-p="url" data-i="' + j + '" value="' + escapeHtml(p.url || '') + '" placeholder="https://..." /></div>' +
            '  </div>' +
            '  <div style="margin-top:10px"><label>Описание (опц.)</label><textarea data-p="text" data-i="' + j + '">' + escapeHtml(p.text || '') + '</textarea></div>' +
            '  <div class="btnRow">' +
            '    <button class="btn danger" type="button" data-act="delPoint" data-i="' + j + '">Удалить</button>' +
            '    <button class="btn" type="button" data-act="upPoint" data-i="' + j + '">↑</button>' +
            '    <button class="btn" type="button" data-act="downPoint" data-i="' + j + '">↓</button>' +
            '  </div>' +
            '</div>';
          pl.appendChild(wrap2);
        }
      }

      // Gallery
      var gl = $('galleryList');
      if (gl) {
        gl.innerHTML = '';
        var gal = state.gallery || [];
        for (var k = 0; k < gal.length; k++) {
          var g = gal[k] || {};
          var wrap3 = document.createElement('div');
          wrap3.className = 'card';
          wrap3.style.marginBottom = '10px';
          wrap3.innerHTML =
            '<div class="pad">' +
            '  <div class="row">' +
            '    <div><label>Подпись (17 символов в строке)</label><input data-g="title" data-i="' + k + '" value="' + escapeHtml(g.title || '') + '" placeholder="Проект" /></div>' +
            '    <div><label>Ссылка (опц.)</label><input data-g="url" data-i="' + k + '" value="' + escapeHtml(g.url || '') + '" placeholder="https://..." /></div>' +
            '  </div>' +
            '  <div style="margin-top:10px"><label>Описание (опц.)</label><textarea data-g="text" data-i="' + k + '">' + escapeHtml(g.text || '') + '</textarea></div>' +
            '  <div class="row" style="margin-top:10px">' +
            '    <div><label>Фото (файл)</label><input type="file" accept="image/*" data-g="imgfile" data-i="' + k + '" /></div>' +
            '    <div><label>Фото (ссылка)</label><input data-g="imgurl" data-i="' + k + '" value="" placeholder="https://..." /></div>' +
            '  </div>' +
            '  <div class="btnRow">' +
            '    <button class="btn danger" type="button" data-act="delGallery" data-i="' + k + '">Удалить</button>' +
            '    <button class="btn" type="button" data-act="upGallery" data-i="' + k + '">↑</button>' +
            '    <button class="btn" type="button" data-act="downGallery" data-i="' + k + '">↓</button>' +
            '  </div>' +
            '</div>';
          gl.appendChild(wrap3);
        }
      }

      // Contacts
      var cl = $('chipsList');
      if (cl) {
        cl.innerHTML = '';
        var chips = state.chips || [];
        for (var m = 0; m < chips.length; m++) {
          var c = chips[m] || {};
          var wrap4 = document.createElement('div');
          wrap4.className = 'card';
          wrap4.style.marginBottom = '10px';
          wrap4.innerHTML =
            '<div class="pad">' +
            '  <div class="row">' +
            '    <div><label>Текст</label><input data-c="label" data-i="' + m + '" value="' + escapeHtml(c.label || '') + '" placeholder="Напр. Телефон" /></div>' +
            '    <div><label>URL / Email / Телефон</label><input data-c="url" data-i="' + m + '" value="' + escapeHtml(c.url || '') + '" placeholder="+7..., name@mail.com, https://..." /></div>' +
            '  </div>' +
            '  <div style="margin-top:10px"><label>Иконка (опционально)</label><input data-c="icon" data-i="' + m + '" value="' + escapeHtml(c.icon || '') + '" placeholder="Если нужно: ☎️ ✉️ 📍" /></div>' +
            '  <div class="btnRow">' +
            '    <button class="btn danger" type="button" data-act="delChip" data-i="' + m + '">Удалить</button>' +
            '    <button class="btn" type="button" data-act="upChip" data-i="' + m + '">↑</button>' +
            '    <button class="btn" type="button" data-act="downChip" data-i="' + m + '">↓</button>' +
            '  </div>' +
            '</div>';
          cl.appendChild(wrap4);
        }
      }
    }

    function syncFieldsFromState(){
      var fullName = $('fullName'); if (fullName) fullName.value = state.fullName || '';
      var role = $('role'); if (role) role.value = state.role || '';
      var logoLink = $('logoLink'); if (logoLink) logoLink.value = state.logoLink || '';

      var phone = $('phone'); if (phone) phone.value = state.phone || '';
      var callStyle = $('callStyle'); if (callStyle) callStyle.value = state.callStyle || 'ghost';

      var about = $('about');
      if (about) {
        about.value = state.about || '';
        var cnt = $('aboutCount');
        if (cnt) cnt.textContent = String((state.about || '').length);
      }

      var pointsTitle = $('pointsTitle'); if (pointsTitle) pointsTitle.value = state.pointsTitle || 'Ссылки';
      var galleryTitle = $('galleryTitle'); if (galleryTitle) galleryTitle.value = state.galleryTitle || 'Работы';
      var slug = $('slug'); if (slug) slug.value = state.slug || '';
    }

    function swap(arr, i, j){ var t = arr[i]; arr[i] = arr[j]; arr[j] = t; }

    // ===== EVENTS =====
    safeOn('themeSeg', 'click', function(e){
      var b = e.target.closest('button[data-theme]');
      if (!b) return;
      setTheme(b.getAttribute('data-theme'));
      persistNow();
      renderPreview();
    });

    safeOn('tabs', 'click', function(e){
      var t = e.target.closest('.tab');
      if (!t) return;
      var all = document.querySelectorAll('.tab');
      for (var i = 0; i < all.length; i++) all[i].classList.remove('active');
      t.classList.add('active');

      var name = t.getAttribute('data-tab');
      var tabs = ['profile', 'buttons', 'points', 'gallery', 'links'];
      for (var j = 0; j < tabs.length; j++) {
        var n = tabs[j];
        var el = $('tab-' + n);
        if (el) el.classList.toggle('hide', n !== name);
      }
    });

    safeOn('fullName', 'input', function(){ state.fullName = $('fullName').value; persist(); renderPreview(); });
    safeOn('role', 'input', function(){ state.role = $('role').value; persist(); renderPreview(); });
    safeOn('logoLink', 'input', function(){ state.logoLink = $('logoLink').value; persist(); renderPreview(); });

    safeOn('phone', 'input', function(){
      var val = $('phone').value;
      state.phone = val;

      if (clean(val) && state.callStyle !== 'primary') {
        state.callStyle = 'primary';
        var cs = $('callStyle');
        if (cs) cs.value = 'primary';
      }

      persist();
      renderPreview();
    });
    safeOn('callStyle', 'change', function(){ state.callStyle = $('callStyle').value; persist(); renderPreview(); });

    safeOn('about', 'input', function(){
      state.about = $('about').value;
      var cnt = $('aboutCount');
      if (cnt) cnt.textContent = String(state.about.length);
      persist();
      renderPreview();
    });

    safeOn('pointsTitle', 'input', function(){ state.pointsTitle = $('pointsTitle').value; persist(); renderPreview(); });
    safeOn('galleryTitle', 'input', function(){ state.galleryTitle = $('galleryTitle').value; persist(); renderPreview(); });
    safeOn('slug', 'input', function(){ state.slug = $('slug').value; persist(); renderPreview(); });

    safeOn('avatarFile', 'change', function(e){
      var f = e.target.files && e.target.files[0]; if (!f) return;
      fileToCoverDataUrl(f, 800, 800, 0.86)
        .then(function(u){ state.avatarDataUrl = u; persist(); renderPreview(); })
        .catch(function(){ alert('Не удалось загрузить аватар. Попробуй ссылку или другой файл.'); });
    });

    safeOn('bannerFile', 'change', function(e){
      var f = e.target.files && e.target.files[0]; if (!f) return;
      fileToCoverDataUrl(f, 1600, 800, 0.86)
        .then(function(u){ state.bannerDataUrl = u; persist(); renderPreview(); })
        .catch(function(){ alert('Не удалось загрузить баннер. Попробуй ссылку или другой файл.'); });
    });

    safeOn('logoFile', 'change', function(e){
      var f = e.target.files && e.target.files[0]; if (!f) return;
      fileToCoverDataUrl(f, 500, 500, 0.90)
        .then(function(u){ state.logoDataUrl = u; persist(); renderPreview(); })
        .catch(function(){ alert('Не удалось загрузить логотип. Попробуй ссылку или другой файл.'); });
    });

    safeOn('avatarUrl', 'change', function(){
      var el = $('avatarUrl');
      if (!el || !el.value) return;
      urlToDataUrl(el.value, 800, 800, 0.86)
        .then(function(u){ state.avatarDataUrl = u; persist(); renderPreview(); })
        .catch(function(){ alert('Ссылка не загрузилась (часто из-за CORS). В проде решается прокси/хранилищем.'); });
    });

    safeOn('bannerUrl', 'change', function(){
      var el = $('bannerUrl');
      if (!el || !el.value) return;
      urlToDataUrl(el.value, 1600, 800, 0.86)
        .then(function(u){ state.bannerDataUrl = u; persist(); renderPreview(); })
        .catch(function(){ alert('Ссылка не загрузилась (часто из-за CORS). В проде решается прокси/хранилищем.'); });
    });

    safeOn('logoUrl', 'change', function(){
      var el = $('logoUrl');
      if (!el || !el.value) return;
      urlToDataUrl(el.value, 500, 500, 0.90)
        .then(function(u){ state.logoDataUrl = u; persist(); renderPreview(); })
        .catch(function(){ alert('Ссылка не загрузилась (часто из-за CORS). В проде решается прокси/хранилищем.'); });
    });

    document.body.addEventListener('input', function(e){
      var t = e.target;
      if (!t || !t.dataset) return;

      var i = Number(t.dataset.i);
      if (!isFinite(i)) return;

      if (t.dataset.b) { state.buttons[i][t.dataset.b] = t.value; persist(); renderPreview(); }
      if (t.dataset.p) { state.points[i][t.dataset.p] = t.value; persist(); renderPreview(); }
      if (t.dataset.g && t.dataset.g !== 'imgfile' && t.dataset.g !== 'imgurl') { state.gallery[i][t.dataset.g] = t.value; persist(); renderPreview(); }
      if (t.dataset.c) { state.chips[i][t.dataset.c] = t.value; persist(); renderPreview(); }
    });

    document.body.addEventListener('change', function(e){
      var t = e.target;
      if (!t || !t.dataset) return;

      if (t.dataset.g === 'imgfile') {
        var i = Number(t.dataset.i);
        var f = t.files && t.files[0]; if (!f) return;
        fileToCoverDataUrl(f, 1600, 1000, 0.86)
          .then(function(u){ state.gallery[i].img = u; persist(); renderLists(); renderPreview(); })
          .catch(function(){ alert('Не удалось загрузить фото.'); });
      }

      if (t.dataset.g === 'imgurl') {
        var j = Number(t.dataset.i);
        var url = t.value; if (!url) return;
        urlToDataUrl(url, 1600, 1000, 0.86)
          .then(function(u){ state.gallery[j].img = u; persist(); renderLists(); renderPreview(); })
          .catch(function(){ alert('Ссылка не загрузилась (часто из-за CORS).'); });
      }
    });

    document.body.addEventListener('click', function(e){
      var act = e.target && e.target.dataset ? e.target.dataset.act : '';
      var i = Number(e.target && e.target.dataset ? e.target.dataset.i : NaN);
      if (!act || !isFinite(i)) return;

      if (act === 'delBtn') { state.buttons.splice(i, 1); }
      if (act === 'upBtn' && i > 0) { swap(state.buttons, i, i - 1); }
      if (act === 'downBtn' && i < state.buttons.length - 1) { swap(state.buttons, i, i + 1); }

      if (act === 'delPoint') { state.points.splice(i, 1); }
      if (act === 'upPoint' && i > 0) { swap(state.points, i, i - 1); }
      if (act === 'downPoint' && i < state.points.length - 1) { swap(state.points, i, i + 1); }

      if (act === 'delGallery') { state.gallery.splice(i, 1); }
      if (act === 'upGallery' && i > 0) { swap(state.gallery, i, i - 1); }
      if (act === 'downGallery' && i < state.gallery.length - 1) { swap(state.gallery, i, i + 1); }

      if (act === 'delChip') { state.chips.splice(i, 1); }
      if (act === 'upChip' && i > 0) { swap(state.chips, i, i - 1); }
      if (act === 'downChip' && i < state.chips.length - 1) { swap(state.chips, i, i + 1); }

      persist();
      renderLists();
      renderPreview();
    });

    safeOn('addButton', 'click', function(){
      var phoneRaw = clean(state.phone);
      var max = phoneRaw ? 5 : 6;
      if ((state.buttons || []).length >= max) return alert('Максимум ' + max + ' кнопок' + (phoneRaw ? ' (т.к. добавится «Позвонить»)' : ''));
      state.buttons.push({ label: 'Новая кнопка', url: '', style: 'ghost' });
      persist(); renderLists(); renderPreview();
    });

    safeOn('addPoint', 'click', function(){
      if ((state.points || []).length >= 12) return alert('Максимум 12 пунктов');
      state.points.push({ title: 'Новый пункт', text: '', url: '' });
      persist(); renderLists(); renderPreview();
    });

    safeOn('addGallery', 'click', function(){
      if ((state.gallery || []).length >= 12) return alert('Максимум 12 фото');
      state.gallery.push({ title: 'Новая работа', text: '', img: '', url: '' });
      persist(); renderLists(); renderPreview();
    });

    safeOn('addChip', 'click', function(){
      if ((state.chips || []).length >= 20) return alert('Максимум 20 контактов');
      state.chips.push({ label: 'Новый контакт', url: '', icon: '' });
      persist(); renderLists(); renderPreview();
    });

    // action buttons: active только у одной
    var actionBtnIds = ['save','preview','profileLink'];
    function setActiveActionButton(id){
      for (var i = 0; i < actionBtnIds.length; i++) {
        var x = actionBtnIds[i];
        var el = $(x);
        if (el) el.classList.toggle('active', x === id);
      }
    }
    function blurActionButtons(){
      for (var i = 0; i < actionBtnIds.length; i++) {
        var el = $(actionBtnIds[i]);
        if (el) el.blur();
      }
    }

    // Базовые обработчики (preview/reset) — остаются
    safeOn('preview', 'click', function(){
      setActiveActionButton('preview');
      blurActionButtons();
      openModal();
    });

    safeOn('reset', 'click', function(){
      if (!confirm('Сбросить все данные?')) return;
      blurActionButtons();

      state = clone(defaultState);
      setTheme(state.theme);

      if (saveTimer) window.clearTimeout(saveTimer);
      persistNow();

      syncFieldsFromState();
      renderLists();
      renderPreview();

      setSaveStatus('saved', 'Сброшено');
      toast('Сброшено', 'Вернули настройки по умолчанию');
    });

    safeOn('modalClose', 'click', closeModal);
    safeOn('modalBackdrop', 'click', closeModal);
    window.addEventListener('keydown', function(e){ if (e.key === 'Escape') closeModal(); });

    /* =========================================================
       ABQD • PUBLISH OVERRIDE (Save + ProfileLink) • v1.2 • 2026-01-05
       ========================================================= */
    (function(){
      function getToken(){
        try { return localStorage.getItem('abqd_token') || ''; }
        catch(e){ return ''; }
      }

      function apiGetProfile(slug){
        if (!window.fetch) return Promise.reject(new Error('fetch-not-supported'));
        return fetch('/api/v1/profile/' + encodeURIComponent(slug), { cache: 'no-store' });
      }

      function stripHeavyMedia(payload){
        var changed = false;

        function dropIfDataUrl(key){
          if (payload[key] && String(payload[key]).indexOf('data:') === 0){
            payload[key] = '';
            changed = true;
          }
        }

        dropIfDataUrl('avatarDataUrl');
        dropIfDataUrl('bannerDataUrl');
        dropIfDataUrl('logoDataUrl');

        if (payload.gallery && payload.gallery.length){
          for (var i = 0; i < payload.gallery.length; i++){
            var g = payload.gallery[i];
            if (g && g.img && String(g.img).indexOf('data:') === 0){
              g.img = '';
              changed = true;
            }
          }
        }

        return changed;
      }

      function publishProfileToApi(){
        if (!window.fetch) {
          toast('Ошибка', 'Браузер не поддерживает публикацию (нет fetch)');
          return Promise.reject(new Error('fetch-not-supported'));
        }

        var token = getToken();
        var slug = normalizeSlug(state.slug || '');

        if (!slug){
          toast('Нет slug', 'Сначала задай адрес страницы');
          return Promise.reject(new Error('no-slug'));
        }
        if (!token){
          toast('Нужен вход', 'Открой /auth и войди, чтобы опубликовать');
          return Promise.reject(new Error('no-token'));
        }

        state.slug = slug;

        // API ждёт: {title, description, state}
        var upsert = {
          title: state.fullName || null,
          description: state.about || null,
          state: clone(state)
        };

        var body = '';
        try { body = JSON.stringify(upsert); } catch(e){ body = ''; }

        if (body && body.length > 900000){
          var changed = stripHeavyMedia(upsert.state);
          if (changed){
            toast('Картинки тяжёлые', 'Для публикации временно убрал base64, текст/кнопки останутся');
          }
          body = JSON.stringify(upsert);

          if (body.length > 900000){
            toast('Слишком большой профиль', 'Уменьши изображения или переведи их на ссылки/хранилище');
            return Promise.reject(new Error('payload-too-large'));
          }
        }

        return fetch('/api/v1/profile/' + encodeURIComponent(slug), {
          method: 'PUT',
          headers: {
            'content-type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: body
        }).then(function(res){
          if (res.status === 200 || res.status === 201){
            return res.json().catch(function(){ return {}; });
          }
          return res.text().then(function(t){
            var msg = t;
            try { msg = (JSON.parse(t) || {}).detail || t; } catch(e) {}
            throw new Error('HTTP ' + res.status + ': ' + msg);
          });
        });
      }

      function hardStop(e){
        if (!e) return;
        try { e.preventDefault(); } catch(_e){}
        try { e.stopImmediatePropagation(); } catch(_e2){}
        try { e.stopPropagation(); } catch(_e3){}
      }

      function bind(){
        var saveBtn = $('save');
        var linkBtn = $('profileLink');
        if (!saveBtn || !linkBtn) return;

        // Сохранить = локально + publish
        saveBtn.addEventListener('click', function(e){
          hardStop(e);
          setActiveActionButton('save');
          try { blurActionButtons(); } catch(_e){}

          try { if (saveTimer) window.clearTimeout(saveTimer); } catch(_e2){}
          try { persistNow(); } catch(_e3){}
          try { setSaveStatus('saving', 'Публикация…'); } catch(_e4){}

          publishProfileToApi().then(function(){
            try { setSaveStatus('saved', 'Опубликовано'); } catch(_e5){}
            var s = normalizeSlug(state.slug || '');
            toast('Опубликовано', 'Профиль: /u/' + s);
          }).catch(function(err){
            try { setSaveStatus('saved', 'Сохранено локально'); } catch(_e6){}
            toast('Сохранено локально', (err && err.message) ? err.message : 'Не удалось опубликовать');
          });
        }, true);

        // Ссылка на профиль = открыть, а если нет — опубликовать и открыть
        linkBtn.addEventListener('click', function(e){
          hardStop(e);
          setActiveActionButton('profileLink');
          try { blurActionButtons(); } catch(_e){}

          var s = normalizeSlug(state.slug || '');
          if (!s){
            toast('Нет slug', 'Сначала задай адрес страницы');
            return;
          }

          apiGetProfile(s).then(function(r){
            if (r.status === 200){
              window.open('/u/' + s, '_blank', 'noopener');
              toast('Открываю профиль', '/u/' + s);
              return;
            }

            publishProfileToApi().then(function(){
              window.open('/u/' + s, '_blank', 'noopener');
              toast('Открываю профиль', '/u/' + s);
            }).catch(function(err){
              toast('Профиль не опубликован', (err && err.message) ? err.message : 'Нажми «Сохранить» (нужен вход)');
            });
          }).catch(function(){
            toast('Ошибка сети', 'Не удалось проверить профиль');
          });
        }, true);
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', bind, { once:true });
      } else {
        bind();
      }
    })();
    /* ===================== end ABQD PUBLISH OVERRIDE ===================== */

    // ===== init =====
    function init(){
      setTheme(state.theme || 'soft');
      state.slug = normalizeSlug(state.slug);

      syncFieldsFromState();
      renderLists();
      renderPreview();

      setSaveStatus('saved');
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init, { once: true });
    } else {
      init();
    }
  })();
  </script>
            <!--
  ABQD • Constructor → /u Publish Bridge (drop‑in) • v1.2 • 2026‑01‑05

  ВСТАВЬ ЭТОТ БЛОК целиком в constructor/index.html ПЕРЕД закрывающим </body>
  (после всех твоих скриптов).

  Цель:
  - «Сохранить» = локально сохранить (как раньше) + (если есть токен) опубликовать в API
  - «Ссылка на профиль» = открыть /u/<slug> (если не опубликовано — сначала publish при наличии токена)
  - «Предпросмотр» = открыть /u/<slug>/?preview=1 и передать state через postMessage + продублировать в localStorage

  Важно:
  - Ошибка NO_TOKEN означает: в localStorage нет 'abqd_token'.
    Это нормально, если пользователь ещё не вошёл через /auth/.
  - Этот бридж НЕ падает с ошибкой, а показывает подсказку и даёт Preview.

  Для идеального зеркала нужно, чтобы /u/index.html умела:
  - GET /api/v1/profile/<slug> (боевой режим)
  - и/или принимать postMessage {type:'abqd_profile_state', state}
  - и/или читать localStorage 'abqd_preview_state_v1'
-->

<script>
(function(){
  'use strict';

  var STORAGE_KEY = 'abqd_constructor_demo_v2';
  var TOKEN_KEY   = 'abqd_token';
  var PREVIEW_KEY = 'abqd_preview_state_v1';

  function clean(s){ return String(s == null ? '' : s).replace(/^\s+|\s+$/g,''); }

  function safeJsonParse(s){
    try{ return JSON.parse(s); }catch(_e){ return null; }
  }

  function normalizeSlug(s){
    s = clean(s).toLowerCase();
    if (!s) return '';
    s = s.replace(/\s+/g,'-');
    // разрешаем a-z 0-9 - _
    s = s.replace(/[^a-z0-9\-_]/g,'');
    s = s.replace(/-+/g,'-');
    s = s.replace(/^[-_]+|[-_]+$/g,'');
    return s.slice(0, 64);
  }

  function getState(){
    // 1) если ты когда-нибудь захочешь — можешь назначить window.abqdState
    if (window.abqdState && typeof window.abqdState === 'object') return window.abqdState;

    // 2) читаем localStorage как в демо
    var raw = null;
    try{ raw = localStorage.getItem(STORAGE_KEY); }catch(_e){ raw = null; }
    if (!raw) return null;
    return safeJsonParse(raw);
  }

  function getToken(){
    try{ return clean(localStorage.getItem(TOKEN_KEY)); }catch(_e){ return ''; }
  }

  function findSlugInput(){
    var el = document.querySelector('[data-abqd="slug"]');
    if (el) return el;

    el = document.getElementById('slug') || document.getElementById('slugInput');
    if (el) return el;

    el = document.querySelector('input[name="slug"], input[name="profile_slug"], input[name="page_slug"]');
    if (el) return el;

    // эвристика
    var inputs = document.querySelectorAll('input[type="text"], input:not([type])');
    for (var i=0;i<inputs.length;i++){
      var p = (inputs[i].getAttribute('placeholder') || '').toLowerCase();
      var a = (inputs[i].getAttribute('aria-label') || '').toLowerCase();
      if (p.indexOf('slug') !== -1 || a.indexOf('slug') !== -1) return inputs[i];
    }
    return null;
  }

  function getSlug(){
    var st = getState() || {};
    var s = '';

    // разные схемы state
    if (typeof st.slug === 'string') s = st.slug;
    if (!s && st.profile && typeof st.profile.slug === 'string') s = st.profile.slug;

    // fallback: input
    if (!s){
      var inp = findSlugInput();
      if (inp) s = inp.value;
    }

    s = normalizeSlug(s);
    if (!s) return '';
    return s;
  }

  function toast(msg, isErr){
    var id = 'abqdToast';
    var el = document.getElementById(id);
    if (!el){
      el = document.createElement('div');
      el.id = id;
      el.style.cssText = [
        'position:fixed','right:14px','bottom:14px','z-index:99999',
        'max-width:420px','padding:10px 12px','border-radius:14px',
        'background:rgba(15,17,23,.92)','color:#fff',
        'border:1px solid rgba(255,255,255,.16)',
        'box-shadow:0 18px 60px rgba(0,0,0,.35)',
        'font:800 13px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial',
        'backdrop-filter: blur(10px)','white-space:pre-wrap'
      ].join(';');
      document.body.appendChild(el);
    }
    el.style.borderColor = isErr ? 'rgba(255,80,80,.45)' : 'rgba(255,255,255,.16)';
    el.textContent = msg;

    clearTimeout(el._t);
    el._t = setTimeout(function(){
      try{ el.remove(); }catch(_e){ el.style.display = 'none'; }
    }, isErr ? 7000 : 3400);
  }

  function savePreviewState(slug, st){
    try{
      localStorage.setItem(PREVIEW_KEY, JSON.stringify({
        slug: slug,
        ts: Date.now(),
        state: st
      }));
    }catch(_e){}
  }

  function apiFetch(method, url, bodyObj){
    var token = getToken();
    if (!token) return Promise.resolve({ __no_token: true });

    return fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: bodyObj ? JSON.stringify(bodyObj) : undefined
    }).then(function(r){
      return r.text().then(function(t){
        var j = null;
        try{ j = t ? JSON.parse(t) : null; }catch(_e){ j = null; }
        if (!r.ok){
          var msg = (j && (j.detail || j.message)) ? (j.detail || j.message) : (t || ('HTTP ' + r.status));
          throw new Error(msg);
        }
        return j || {};
      });
    });
  }

  function publishNow(opts){
    opts = opts || {};

    var slug = getSlug();
    if (!slug){
      toast('Slug не найден. Заполни поле SLUG.', true);
      return Promise.resolve({ ok:false, reason:'NO_SLUG' });
    }

    var st = getState();
    if (!st){
      toast('State не найден (localStorage ' + STORAGE_KEY + '). Открой/измени конструктор и нажми «Сохранить».', true);
      return Promise.resolve({ ok:false, reason:'NO_STATE' });
    }

    // всегда сохраняем preview state — полезно даже без токена
    savePreviewState(slug, st);

    var token = getToken();
    if (!token){
      if (!opts.silentNoToken){
        toast('Нет токена (abqd_token). Войди через /auth/ чтобы профиль стал публичным.\nPreview можно смотреть без токена.', true);
      }
      return Promise.resolve({ ok:false, reason:'NO_TOKEN' });
    }

    // лёгкая нормализация theme (не ломаем твой state)
    var theme = (st.theme === 'dark' || st.theme === 'soft') ? st.theme : 'soft';

    toast('Публикую профиль: ' + slug + ' …');
    return apiFetch('PUT', '/api/v1/profile/' + encodeURIComponent(slug), {
      slug: slug,
      theme: theme,
      state: st
    }).then(function(res){
      if (res && res.__no_token){
        // теоретически сюда не попадём, но пусть будет безопасно
        toast('Нет токена. Войди через /auth/.', true);
        return { ok:false, reason:'NO_TOKEN' };
      }
      toast('Опубликовано ✓  (' + slug + ')');
      return { ok:true, slug: slug };
    }).catch(function(e){
      toast('Ошибка публикации: ' + (e && e.message ? e.message : e), true);
      return { ok:false, reason:'PUBLISH_ERROR', error: String(e && e.message ? e.message : e) };
    });
  }

  function openPublic(){
    var slug = getSlug();
    if (!slug){ toast('Slug не найден.', true); return; }

    // если есть токен — пытаемся догнать публикацию перед открытием
    publishNow({ silentNoToken:true }).then(function(r){
      // если нет токена — всё равно можно открыть страницу, но она будет показывать либо preview, либо пусто
      window.open('/u/' + encodeURIComponent(slug) + '/', '_blank');
      if (r && r.ok){
        toast('Открываю публичный профиль: /u/' + slug);
      } else if (r && r.reason === 'NO_TOKEN'){
        toast('Открываю /u/' + slug + ' (без токена — только preview/локальные данные).', true);
      }
    });
  }

  function openPreview(){
    var slug = getSlug();
    if (!slug){ toast('Slug не найден.', true); return; }

    var st = getState();
    if (!st){ toast('State не найден.', true); return; }

    savePreviewState(slug, st);

    var w = window.open('/u/' + encodeURIComponent(slug) + '/?preview=1', '_blank');
    if (!w){ toast('Браузер заблокировал новое окно.', true); return; }

    // несколько попыток отправить state (на случай, если вкладка ещё грузится)
    var tries = 0;
    var timer = setInterval(function(){
      tries++;
      try{
        w.postMessage({ type:'abqd_profile_state', slug: slug, state: st }, window.location.origin);
      }catch(_e){}
      if (tries >= 20) clearInterval(timer);
    }, 200);

    toast('Preview открыт. Отправляю state…');
  }

  function hardStop(e){
    if (!e) return;
    try{ e.preventDefault(); }catch(_e){}
    try{ e.stopImmediatePropagation(); }catch(_e2){}
    try{ e.stopPropagation(); }catch(_e3){}
  }

  function bindById(){
    // В твоём конструкторе есть id: save, preview, profileLink
    var saveBtn = document.getElementById('save');
    var prevBtn = document.getElementById('preview');
    var linkBtn = document.getElementById('profileLink');

    // «Сохранить» — не ломаем твою логику: сначала даём твоим обработчикам сохранить state,
    // потом публикуем.
    if (saveBtn){
      saveBtn.addEventListener('click', function(){
        setTimeout(function(){ publishNow(); }, 160);
      }, false);
    }

    if (prevBtn){
      // preview уже может иметь свою модалку — НЕ перехватываем полностью.
      // Добавляем доп. поведение: открыть /u preview в новой вкладке.
      prevBtn.addEventListener('click', function(){
        setTimeout(function(){ openPreview(); }, 40);
      }, false);
    }

    if (linkBtn){
      // тут перехватываем, потому что «ссылка на профиль» должна вести на /u
      linkBtn.addEventListener('click', function(e){
        hardStop(e);
        openPublic();
      }, true);
    }

    return !!(saveBtn || prevBtn || linkBtn);
  }

  function bindByText(){
    // fallback если ids поменяются
    function hookText(text, fn, capture){
      var want = clean(text).toLowerCase();
      var nodes = document.querySelectorAll('button, a');
      for (var i=0;i<nodes.length;i++){
        var n = nodes[i];
        var t = clean(n.textContent).toLowerCase();
        if (t === want){
          n.addEventListener('click', function(e){
            if (capture) hardStop(e);
            fn();
          }, !!capture);
          return true;
        }
      }
      return false;
    }

    var a = hookText('Ссылка на профиль', openPublic, true);
    var b = hookText('Предпросмотр', openPreview, false);

    // на «Сохранить» — publish после сохранения
    var c = hookText('Сохранить', function(){ setTimeout(function(){ publishNow(); }, 160); }, false);

    return (a || b || c);
  }

  function addMiniPanel(){
    var id = 'abqdBridgePanel';
    if (document.getElementById(id)) return;

    var box = document.createElement('div');
    box.id = id;
    box.style.cssText = [
      'position:fixed','left:14px','bottom:14px','z-index:99998',
      'display:flex','gap:8px','flex-wrap:wrap',
      'padding:10px','border-radius:16px',
      'background:rgba(255,255,255,.10)','border:1px solid rgba(255,255,255,.18)',
      'backdrop-filter: blur(10px)','box-shadow:0 18px 60px rgba(0,0,0,.25)'
    ].join(';');

    function mk(label, onClick){
      var b = document.createElement('button');
      b.type = 'button';
      b.textContent = label;
      b.style.cssText = [
        'cursor:pointer','border-radius:999px','padding:10px 12px',
        'border:1px solid rgba(255,255,255,.22)','background:rgba(15,17,23,.75)',
        'color:#fff','font:900 12px/1 system-ui,-apple-system,Segoe UI,Roboto,Arial'
      ].join(';');
      b.addEventListener('click', function(e){ hardStop(e); onClick(); });
      return b;
    }

    box.appendChild(mk('PUBLISH', function(){ publishNow(); }));
    box.appendChild(mk('PUBLIC', function(){ openPublic(); }));
    box.appendChild(mk('PREVIEW', function(){ openPreview(); }));

    document.body.appendChild(box);
  }

  function runSelfTests(){
    try{
      console.assert(normalizeSlug('Ivan Ivanov') === 'ivan-ivanov', 'test normalizeSlug spaces');
      console.assert(normalizeSlug('---A__B---') === 'a__b', 'test normalizeSlug trims');
      console.assert(normalizeSlug('тест') === '', 'test normalizeSlug non-latin');
      // getToken может быть пустой — это НЕ ошибка
      console.assert(typeof getToken() === 'string', 'test getToken type');
    }catch(_e){}
  }

  function boot(){
    var ok = bindById();
    if (!ok) ok = bindByText();
    if (!ok){
      addMiniPanel();
      toast('Не нашёл кнопки (id/save/preview/profileLink). Добавил мини‑панель снизу слева.');
    }
    runSelfTests();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', boot);
  } else {
    boot();
  }
})();
</script>
</body>
</html>
