<!doctype html>
<html lang="ru" data-theme="soft">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ABQD — Конструктор профиля</title>

  <!-- Montserrat -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --font:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      --r1:16px; --r2:22px;

      /* dark default */
      --bg:#0b0c10;
      --panel:#0f1117;
      --panel2:#11131b;
      --text:#eef1f6;
      --muted:rgba(238,241,246,.66);
      --line:rgba(255,255,255,.13);
      --shadow:0 18px 60px rgba(0,0,0,.30);

      --a1:#ff4d9d;
      --a2:#6d5cff;

      --gridBg: rgba(255,255,255,.03);
      --ok:#39d98a;
      --warn:#ffd166;
      --bad:#ff5a7a;
    }

    html[data-theme="soft"]{
      --bg:#f4f6fb;
      --panel:rgba(255,255,255,.62);
      --panel2:rgba(255,255,255,.78);
      --text:#10131a;
      --muted:rgba(16,19,26,.56);
      --line:rgba(16,19,26,.14);
      --shadow:0 18px 60px rgba(18,24,40,.12);

      --a1:#2563eb;
      --a2:#7c3aed;

      --gridBg: rgba(255,255,255,.42);
      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      font-size:15.5px;
      line-height:1.62;
      background:
        radial-gradient(1100px 700px at 15% 10%, rgba(109,92,255,.16), transparent 55%),
        radial-gradient(1100px 700px at 85% 15%, rgba(255,77,157,.14), transparent 55%),
        var(--bg);
    }
    body::before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none; z-index:0;
      opacity:.055; mix-blend-mode:overlay;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.55'/%3E%3C/svg%3E");
      transform:translateZ(0);
    }

    .wrap{position:relative;z-index:1;max-width:1320px;margin:0 auto;padding:18px 14px 44px}
    .top{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;margin:6px 0 14px}
    h1{margin:0;font-size:38px;letter-spacing:-.045em;line-height:1.04;font-weight:800}
    .help{margin:12px 0 0;color:var(--muted);font-weight:800;max-width:860px}

    .seg{
      display:inline-flex;
      border:1px solid var(--line);
      background:rgba(0,0,0,.08);
      border-radius:999px;
      overflow:hidden;
      backdrop-filter:blur(10px);
    }
    html[data-theme="soft"] .seg{background:rgba(255,255,255,.35)}
    .seg button{
      border:0;background:transparent;cursor:pointer;
      padding:9px 12px;font-size:12px;color:var(--muted);font-weight:800
    }
    .seg button.active{
      color:var(--text);
      background:linear-gradient(90deg,rgba(255,255,255,.16),rgba(255,255,255,.06));
    }

    .grid{
      display:grid;
      grid-template-columns:1.25fr .75fr;
      gap:12px;
      align-items:start;
      padding:10px;
      border-radius:var(--r2);
      background:var(--gridBg);
      border:1px solid rgba(255,255,255,.10);
    }
    html[data-theme="soft"] .grid{border-color:rgba(0,0,0,.10)}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    @media (max-width:560px){
      .wrap{padding-top:86px}
      h1{font-size:28px}
      .grid{padding:8px}
    }

    .card{
      position:relative;
      border:1px solid var(--line);
      background:
        radial-gradient(120% 140% at 10% 0%, rgba(255,255,255,.10), transparent 55%),
        linear-gradient(180deg,var(--panel),rgba(255,255,255,.04));
      border-radius:var(--r2);
      box-shadow:var(--shadow);
      backdrop-filter:blur(12px);
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute;inset:0;
      border-radius:inherit;
      pointer-events:none;
      background:linear-gradient(135deg, rgba(255,255,255,.22), transparent 42%, rgba(255,255,255,.10));
      opacity:.18;
      mix-blend-mode:overlay;
    }
    html[data-theme="soft"] .card::before{opacity:.10;mix-blend-mode:normal}

    .cardHd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .cardHd b{
      font-size:12px;
      letter-spacing:.16em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .pad{padding:14px}

    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{
      border:1px solid var(--line);
      background:rgba(0,0,0,.08);
      color:var(--text);
      border-radius:999px;
      padding:8px 10px;
      font-weight:800;
      font-size:12px;
      cursor:pointer;
    }
    html[data-theme="soft"] .tab{background:rgba(255,255,255,.45)}
    .tab.active{border-color:rgba(255,77,157,.55);box-shadow:0 0 0 2px rgba(255,77,157,.18) inset}
    html[data-theme="soft"] .tab.active{border-color:rgba(37,99,235,.40);box-shadow:0 0 0 2px rgba(37,99,235,.12) inset}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:560px){.row{grid-template-columns:1fr}}

    label{
      display:block;margin:0 0 6px;
      font-size:10.5px;letter-spacing:.12em;
      text-transform:uppercase;color:var(--muted);font-weight:700
    }
    .mini{font-size:12px;color:var(--muted);font-weight:800}

    input, textarea, select{
      width:100%;
      border-radius:14px;
      padding:11px 12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.16);
      color:var(--text);
      outline:none;
      font-size:14px;
      transition:border-color .14s ease, box-shadow .14s ease, transform .14s ease;
    }
    html[data-theme="soft"] input,
    html[data-theme="soft"] textarea,
    html[data-theme="soft"] select{
      background:rgba(255,255,255,.82);
      color:var(--text);
      border-color:rgba(0,0,0,.12);
    }
    textarea{min-height:112px;resize:vertical}
    input:focus, textarea:focus, select:focus{
      border-color:rgba(255,77,157,.45);
      box-shadow:0 0 0 4px rgba(255,77,157,.12);
      transform:translateY(-1px);
    }
    html[data-theme="soft"] input:focus,
    html[data-theme="soft"] textarea:focus,
    html[data-theme="soft"] select:focus{
      border-color:rgba(37,99,235,.38);
      box-shadow:0 0 0 4px rgba(37,99,235,.10);
    }

    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{
      border:1px solid var(--line);
      background:rgba(0,0,0,.08);
      color:var(--text);
      border-radius:999px;
      padding:11px 14px;
      font-weight:800;
      font-size:13px;
      cursor:pointer;
      transition:transform .14s ease, filter .14s ease;
    }
    html[data-theme="soft"] .btn{background:rgba(255,255,255,.45)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      border:0 !important;
      background:transparent !important;
      color:#fff !important;
      position:relative;
      overflow:hidden;
      box-shadow:0 10px 26px rgba(0,0,0,.14);
    }
    .btn.primary::before{
      content:"";
      position:absolute;inset:-1px;
      background:linear-gradient(90deg,var(--a1),var(--a2));
      border-radius:inherit;
      z-index:-1;
    }
    html[data-theme="soft"] .btn.primary{
      color:var(--text) !important;
      border:1px solid rgba(16,19,26,.16) !important;
      text-shadow:none;
    }
    html[data-theme="soft"] .btn.primary::before{
      background:linear-gradient(180deg, rgba(226,229,235,.98) 0%, rgba(196,203,214,.96) 48%, rgba(168,177,191,.95) 100%);
    }
    .btn.danger{background:transparent}
    .btn.danger:hover{border-color:rgba(255,77,157,.55);color:rgba(255,77,157,.85)}
    html[data-theme="soft"] .btn.danger:hover{border-color:rgba(37,99,235,.42);color:rgba(37,99,235,.85)}

    .hide{display:none !important}

    /* ===== Preview ===== */
    .hero{padding:16px}
    .banner{
      position:relative;height:220px;border-radius:var(--r2);
      overflow:hidden;border:1px solid var(--line);
      background:rgba(0,0,0,.10);
    }
    .banner img{width:100%;height:100%;object-fit:cover;display:block}
    .bannerPlh{
      position:absolute;inset:0;
      display:flex;align-items:center;justify-content:center;
      font-weight:800;letter-spacing:.12em;text-transform:uppercase;font-size:12px;
      color:var(--muted);
      background:linear-gradient(180deg, rgba(255,255,255,.06), transparent);
      pointer-events:none;
    }
    html[data-theme="soft"] .bannerPlh{background:linear-gradient(180deg, rgba(255,255,255,.30), transparent)}
    .bannerLogo{
      position:absolute;right:12px;top:12px;width:56px;height:56px;border-radius:16px;
      border:1px solid var(--line);background:rgba(0,0,0,.18);backdrop-filter:blur(10px);
      display:flex;align-items:center;justify-content:center;overflow:hidden;text-decoration:none;
      box-shadow:0 10px 30px rgba(0,0,0,.18)
    }
    html[data-theme="soft"] .bannerLogo{background:rgba(255,255,255,.55)}
    .bannerLogo img{width:100%;height:100%;object-fit:cover;display:block}

    .heroHead{margin-top:-54px;display:flex;align-items:flex-end;justify-content:space-between;gap:12px;flex-wrap:wrap;padding:0 10px;position:relative;z-index:3}
    .left{display:flex;align-items:flex-end;gap:12px}
    .avatar{
      width:106px;height:106px;border-radius:999px;
      border:4px solid rgba(255,255,255,.9);
      overflow:hidden;background:rgba(0,0,0,.18);
      box-shadow:0 18px 60px rgba(0,0,0,.20);
      flex:0 0 auto;display:flex;align-items:center;justify-content:center;
    }
    .avatar img{width:100%;height:100%;object-fit:cover;display:block}
    .avatar .fallback{font-weight:800;font-size:38px;opacity:.92}

    .nm{margin:0;font-size:28px;letter-spacing:-.02em;line-height:1.08;font-weight:800}
    .rl{margin:6px 0 0;color:var(--muted);letter-spacing:.14em;text-transform:uppercase;font-size:12px;font-weight:800}

    .about{padding:10px 10px 14px}
    .h2{margin:10px 0 10px;letter-spacing:.16em;text-transform:uppercase;font-size:12px;color:var(--muted);font-weight:800}
    .aboutText{margin:0;line-height:1.72;font-size:14.5px;white-space:pre-wrap;color:rgba(238,241,246,.78)}
    html[data-theme="soft"] .aboutText{color:rgba(16,19,26,.72)}

    .cta{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .cta a{
      border:1px solid var(--line);
      border-radius:999px;
      padding:11px 14px;
      font-weight:800;
      font-size:13px;
      text-decoration:none;
      color:#fff;
      background:rgba(0,0,0,.22);
      transition:transform .14s ease, filter .14s ease;
      position:relative;
      overflow:hidden;
      transform:translateZ(0);
    }
    .cta a:active{transform:translateY(1px)}
    .cta a.primary{
      border:0 !important;
      background:transparent !important;
      color:#fff !important;
      box-shadow:0 10px 26px rgba(0,0,0,.14);
    }
    .cta a.primary::before{
      content:"";
      position:absolute;inset:-1px;
      background:linear-gradient(90deg,var(--a1),var(--a2));
      border-radius:inherit;
      z-index:-1;
    }
    html[data-theme="soft"] .cta a.primary{
      color:var(--text) !important;
      border:1px solid rgba(16,19,26,.16) !important;
      text-shadow:none;
    }
    html[data-theme="soft"] .cta a.primary::before{
      background:linear-gradient(180deg, rgba(226,229,235,.98) 0%, rgba(196,203,214,.96) 48%, rgba(168,177,191,.95) 100%);
    }

    .section{padding:16px}
    .secTitle{margin:0 0 12px;font-size:12px;letter-spacing:.18em;text-transform:uppercase;color:var(--muted);font-weight:800}

    .chipsRow{display:flex;flex-wrap:wrap;gap:10px}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;border:1px solid var(--line);
      background:rgba(0,0,0,.05);text-decoration:none;color:var(--muted);font-weight:800;font-size:12px;
      transition:transform .14s ease, filter .14s ease;
    }
    html[data-theme="soft"] .chip{background:rgba(255,255,255,.45)}
    .chip:hover{color:var(--text)}
    .chip:active{transform:translateY(1px)}

    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      border:1px solid var(--line);
      background:rgba(0,0,0,.05);
      border-radius:var(--r1);
      padding:12px;
      display:flex;gap:12px;align-items:flex-start;
    }
    html[data-theme="soft"] .item{background:rgba(255,255,255,.45)}
    .check{
      width:28px;height:28px;border-radius:999px;border:1px solid var(--line);
      background:rgba(0,0,0,.08);color:var(--ok);
      display:flex;align-items:center;justify-content:center;
      font-weight:900;font-size:14px;line-height:1;
      flex:0 0 auto;
    }
    html[data-theme="soft"] .check{background:rgba(255,255,255,.45)}
    .itT{margin:0;font-weight:800;font-size:14px}
    .itD{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.55;white-space:pre-wrap}

    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media (max-width:900px){.grid3{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:560px){.grid3{grid-template-columns:1fr}}

    .work{
      border:1px solid var(--line);
      border-radius:var(--r1);
      overflow:hidden;background:rgba(0,0,0,.05);
      min-height:220px;display:flex;flex-direction:column;
    }
    html[data-theme="soft"] .work{background:rgba(255,255,255,.45)}
    .workImg{height:160px;background:rgba(0,0,0,.12)}
    .workImg img{width:100%;height:100%;object-fit:cover;display:block}
    .workBody{padding:12px}
    .workT{margin:0;font-weight:800;font-size:14px;line-height:1.2;white-space:pre-wrap;word-break:break-word}
    .workM{margin:7px 0 0;color:var(--muted);font-size:13px;line-height:1.5;white-space:pre-wrap}

    /* save status + toast */
    .saveStatus{display:flex;align-items:center;gap:8px;margin-top:10px}
    .saveDot{width:8px;height:8px;border-radius:999px;background:var(--muted);opacity:.55;flex:0 0 auto}
    .saveTxt{font-size:12px;color:var(--muted);font-weight:800;letter-spacing:.02em}
    .saveStatus[data-state="dirty"] .saveDot{background:var(--warn);opacity:.95}
    .saveStatus[data-state="saving"] .saveDot{background:rgba(109,92,255,.85);opacity:.95;animation:pulse 1.1s ease-in-out infinite}
    html[data-theme="soft"] .saveStatus[data-state="saving"] .saveDot{background:rgba(124,58,237,.78)}
    .saveStatus[data-state="saved"] .saveDot{background:var(--ok);opacity:.9}
    .saveStatus[data-state="error"] .saveDot{background:var(--bad);opacity:.95}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.55)}}

    .toastWrap{position:fixed;right:14px;bottom:14px;z-index:99999;display:flex;flex-direction:column;gap:10px;pointer-events:none}
    .toast{
      pointer-events:none;
      max-width:min(420px, 92vw);
      border:1px solid var(--line);
      background:linear-gradient(180deg, var(--panel2), var(--panel));
      color:var(--text);
      border-radius:18px;
      padding:12px 14px;
      box-shadow:0 18px 60px rgba(0,0,0,.22);
      backdrop-filter:blur(14px);
      transform:translateY(10px);
      opacity:0;
      transition:transform .24s cubic-bezier(.2,.8,.2,1), opacity .18s ease;
      font-weight:800;
    }
    .toast.show{transform:translateY(0);opacity:1}
    .toast small{display:block;margin-top:3px;color:var(--muted);font-weight:700}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Конструктор профиля</h1>
        <p class="help">Заполни данные → нажми «Сохранить» → получи ссылку на визитку.</p>
      </div>
      <div class="seg" id="themeSeg">
        <button type="button" data-theme="dark">Тёмная</button>
        <button type="button" data-theme="soft">Белая</button>
      </div>
    </div>

    <div class="grid">
      <!-- EDITOR -->
      <div class="card" id="editorCard">
        <div class="cardHd">
          <b>Редактор</b>
          <div class="tabs" id="tabs">
            <button class="tab active" type="button" data-tab="profile">Профиль</button>
            <button class="tab" type="button" data-tab="buttons">Кнопки</button>
            <button class="tab" type="button" data-tab="contacts">Контакты</button>
            <button class="tab" type="button" data-tab="links">Ссылки</button>
            <button class="tab" type="button" data-tab="gallery">Фото</button>
          </div>
        </div>

        <div class="pad" id="tab-profile">
          <div class="row">
            <div>
              <label>Имя Фамилия</label>
              <input id="fullName" placeholder="Иванов Иван Иванович" />
            </div>
            <div>
              <label>Должность</label>
              <input id="role" placeholder="АРХИТЕКТОР & ДИЗАЙНЕР" />
            </div>
          </div>

          <div style="margin-top:10px">
            <label>Обо мне (до 500)</label>
            <textarea id="about" maxlength="500"></textarea>
            <div class="mini"><span id="aboutCount">0</span>/500</div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Slug (адрес)</label>
              <input id="slug" placeholder="ivan-ivanov" />
              <div class="mini" style="margin-top:6px">Публично будет: <b><span id="slugPublicUrl">/u/...</span></b></div>
            </div>
            <div>
              <label>Телефон (для кнопки «Позвонить»)</label>
              <input id="phone" placeholder="+7 999 000-00-00" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Аватар (ссылка)</label>
              <input id="avatarUrl" placeholder="https://..." />
              <div class="mini" style="margin-top:6px">Лучше хранить в S3/облаке. Base64 в публикацию не пойдёт.</div>
            </div>
            <div>
              <label>Баннер (ссылка)</label>
              <input id="bannerUrl" placeholder="https://..." />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Логотип (ссылка)</label>
              <input id="logoUrl" placeholder="https://..." />
            </div>
            <div>
              <label>Ссылка логотипа</label>
              <input id="logoLink" placeholder="https://abqd.ru" />
            </div>
          </div>

          <div class="btnRow">
            <button class="btn primary" id="save" type="button">Сохранить</button>
            <button class="btn" id="profileLink" type="button">Ссылка на профиль</button>
            <button class="btn danger" id="reset" type="button">Сбросить</button>
          </div>

          <div class="saveStatus" id="saveStatus" data-state="saved">
            <span class="saveDot"></span>
            <span class="saveTxt" id="saveStatusText">Сохранено</span>
          </div>
        </div>

        <div class="pad hide" id="tab-buttons">
          <div class="mini">CTA-кнопки под “Обо мне”. Макс: 6 (если указан телефон — 5, потому что добавится «Позвонить»).</div>
          <div id="buttonsList" style="margin-top:10px"></div>
          <div class="btnRow">
            <button class="btn" id="addButton" type="button">＋ Добавить кнопку</button>
          </div>
        </div>

        <div class="pad hide" id="tab-contacts">
          <div class="mini">Контакты (чипы). Макс: 20. Email и телефон можно писать прямо в поле URL.</div>
          <div id="contactsList" style="margin-top:10px"></div>
          <div class="btnRow">
            <button class="btn" id="addContact" type="button">＋ Добавить контакт</button>
          </div>
        </div>

        <div class="pad hide" id="tab-links">
          <div class="row">
            <div>
              <label>Заголовок блока</label>
              <input id="linksTitle" placeholder="Ссылки" />
            </div>
            <div class="mini" style="align-self:end">Пункты: до 12</div>
          </div>
          <div id="linksList" style="margin-top:10px"></div>
          <div class="btnRow">
            <button class="btn" id="addLink" type="button">＋ Добавить пункт</button>
          </div>
        </div>

        <div class="pad hide" id="tab-gallery">
          <div class="row">
            <div>
              <label>Заголовок блока</label>
              <input id="galleryTitle" placeholder="Работы" />
            </div>
            <div class="mini" style="align-self:end">Карточки: до 12</div>
          </div>
          <div id="galleryList" style="margin-top:10px"></div>
          <div class="btnRow">
            <button class="btn" id="addGallery" type="button">＋ Добавить работу</button>
          </div>
        </div>
      </div>

      <!-- PREVIEW -->
      <div class="card" id="previewCard">
        <div class="cardHd">
          <b>Профиль</b>
          <span class="mini" id="authHint"></span>
        </div>

        <div class="hero">
          <div class="banner" id="bannerBox">
            <div class="bannerPlh" id="bannerPlh">Баннер</div>
          </div>

          <div class="heroHead">
            <div class="left">
              <div class="avatar" id="avatarBox"><span class="fallback">A</span></div>
              <div>
                <h2 class="nm" id="nameEl">—</h2>
                <div class="rl" id="roleEl"></div>
              </div>
            </div>
          </div>

          <div class="about">
            <div class="h2">Обо мне</div>
            <p class="aboutText" id="aboutEl"></p>
            <div class="cta" id="ctaRow"></div>
          </div>
        </div>

        <div class="section" id="contactsSection">
          <div class="secTitle">Контакты</div>
          <div class="chipsRow" id="contactsPreview"></div>
        </div>

        <div class="section" id="linksSection">
          <div class="secTitle" id="linksTitleEl">Ссылки</div>
          <div class="list" id="linksPreview"></div>
        </div>

        <div class="section" id="gallerySection">
          <div class="secTitle" id="galleryTitleEl">Работы</div>
          <div class="grid3" id="galleryPreview"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="toastWrap" id="toastWrap" aria-live="polite" aria-atomic="true"></div>

<script>
(function(){
  /* ==========================
     ABQD Constructor • Clean v1
     ========================== */

  var KEY = 'abqd_constructor_demo_v2';

  function $(id){ return document.getElementById(id); }
  function clean(s){ return String(s == null ? '' : s).replace(/^\s+|\s+$/g,''); }

  function clone(obj){
    try { return JSON.parse(JSON.stringify(obj)); }
    catch(e){ return {}; }
  }

  function escapeHtml(s){
    s = String(s == null ? '' : s);
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
            .replace(/\"/g,'&quot;').replace(/'/g,'&#039;');
  }

  function normUrl(u){
    u = clean(u);
    if (!u) return '';
    var low = u.toLowerCase();
    if (low.indexOf('http://') === 0 || low.indexOf('https://') === 0) return u;
    if (low.indexOf('mailto:') === 0 || low.indexOf('tel:') === 0 || low.indexOf('tg://') === 0) return u;
    return 'https://' + u;
  }

  function contactUrl(u){
    u = clean(u);
    if (!u) return '';
    var low = u.toLowerCase();
    if (low.indexOf('http://') === 0 || low.indexOf('https://') === 0 || low.indexOf('mailto:') === 0 || low.indexOf('tel:') === 0 || low.indexOf('tg://') === 0) return u;
    if (u.indexOf('@') !== -1 && u.indexOf(' ') === -1) return 'mailto:' + u;

    // phone-like
    if (/^[0-9\s()\-\.+]+$/.test(u) && u.replace(/[^0-9]/g,'').length >= 6){
      var digits = u.replace(/[\s\-().]/g,'');
      return 'tel:' + digits;
    }
    return 'https://' + u;
  }

  function phoneToTel(s){
    s = clean(s);
    if (!s) return '';
    var out = '';
    for (var i=0;i<s.length;i++){
      var ch = s.charAt(i);
      if (ch >= '0' && ch <= '9') out += ch;
      else if (ch === '+' && out.length === 0) out += ch;
    }
    var digits = (out.charAt(0) === '+') ? out.slice(1) : out;
    if (digits.length < 6) return '';
    return 'tel:' + out;
  }

  function normalizeSlug(s){
    s = clean(s).toLowerCase();
    if (!s) return '';
    var allowed = 'abcdefghijklmnopqrstuvwxyz0123456789-_.';
    var out = '';
    var prevDash = false;

    for (var i=0;i<s.length;i++){
      var ch = s.charAt(i);
      if (ch === ' '){
        if (!prevDash){ out += '-'; prevDash = true; }
        continue;
      }
      if (allowed.indexOf(ch) !== -1){
        out += ch; prevDash = (ch === '-');
      } else {
        if (!prevDash){ out += '-'; prevDash = true; }
      }
    }
    while (out.indexOf('--') !== -1) out = out.replace(/--/g,'-');
    while (out.charAt(0) === '-' || out.charAt(0) === '.') out = out.slice(1);
    while (out.charAt(out.length-1) === '-' || out.charAt(out.length-1) === '.') out = out.slice(0,-1);
    return out;
  }

  function toast(title, subtitle){
    subtitle = subtitle || '';
    var wrap = $('toastWrap');
    if (!wrap) return;
    var t = document.createElement('div');
    t.className = 'toast';
    t.innerHTML = '<div>' + escapeHtml(title) + '</div>' + (subtitle ? '<small>' + escapeHtml(subtitle) + '</small>' : '');
    wrap.appendChild(t);
    t.getBoundingClientRect();
    t.classList.add('show');
    window.setTimeout(function(){
      t.classList.remove('show');
      window.setTimeout(function(){ if (t && t.parentNode) t.parentNode.removeChild(t); }, 260);
    }, 1700);
  }

  var defaultState = {
    theme: 'soft',
    slug: 'my-profile',
    fullName: '',
    role: '',
    about: '',
    phone: '',
    avatarUrl: '',
    bannerUrl: '',
    logoUrl: '',
    logoLink: 'https://abqd.ru',
    buttons: [
      { label:'Написать', url:'https://t.me/', style:'primary' }
    ],
    contacts: [
      { label:'Telegram', url:'https://t.me/' },
      { label:'WhatsApp', url:'https://wa.me/' },
      { label:'Email', url:'name@mail.com' }
    ],
    linksTitle: 'Ссылки',
    links: [
      { title:'Мой сайт', text:'', url:'https://' }
    ],
    galleryTitle: 'Работы',
    gallery: [
      { title:'Проект 1', text:'Короткое описание', img:'', url:'' }
    ]
  };

  function load(){
    var st = clone(defaultState);
    try{
      var raw = localStorage.getItem(KEY);
      if (!raw) return st;
      var parsed = JSON.parse(raw);
      for (var k in parsed) if (Object.prototype.hasOwnProperty.call(parsed,k)) st[k] = parsed[k];
      return st;
    }catch(e){ return st; }
  }

  var state = load();
  if (state.theme !== 'dark' && state.theme !== 'soft') state.theme = 'soft';

  /* ===== Save status ===== */
  var dirty = false;
  var saveTimer = null;
  var AUTOSAVE_MS = 700;

  function setSaveStatus(mode, text){
    var box = $('saveStatus');
    var tx = $('saveStatusText');
    if (!box || !tx) return;
    box.setAttribute('data-state', mode);
    tx.textContent = text || (mode === 'dirty' ? 'Есть изменения…' : mode === 'saving' ? 'Сохранение…' : 'Сохранено');
  }

  function persistNow(){
    try { localStorage.setItem(KEY, JSON.stringify(state)); } catch(e) {}
    dirty = false;
    setSaveStatus('saved','Сохранено');
  }

  function persist(){
    dirty = true;
    setSaveStatus('dirty','Есть изменения…');
    if (saveTimer) window.clearTimeout(saveTimer);
    saveTimer = window.setTimeout(function(){
      setSaveStatus('saving','Сохранение…');
      window.setTimeout(function(){ persistNow(); }, 60);
    }, AUTOSAVE_MS);
  }

  window.addEventListener('beforeunload', function(){
    if (dirty) persistNow();
  });

  /* ===== Theme ===== */
  function setTheme(t){
    state.theme = t;
    document.documentElement.setAttribute('data-theme', t);
    var seg = $('themeSeg');
    if (seg){
      var btns = seg.getElementsByTagName('button');
      for (var i=0;i<btns.length;i++){
        var b = btns[i];
        b.className = (b.getAttribute('data-theme') === t) ? 'active' : '';
      }
    }
  }

  /* ===== Tabs ===== */
  function showTab(name){
    var names = ['profile','buttons','contacts','links','gallery'];
    for (var i=0;i<names.length;i++){
      var n = names[i];
      var el = $('tab-' + n);
      if (el) el.className = (n === name) ? 'pad' : 'pad hide';
    }
    var tabs = $('tabs');
    if (tabs){
      var btns = tabs.getElementsByTagName('button');
      for (var j=0;j<btns.length;j++){
        var bt = btns[j];
        var active = (bt.getAttribute('data-tab') === name);
        bt.className = active ? 'tab active' : 'tab';
      }
    }
  }

  /* ===== Render Preview ===== */
  function renderPreview(){
    // normalize slug
    state.slug = normalizeSlug(state.slug || '');
    var slugEl = $('slugPublicUrl');
    if (slugEl) slugEl.textContent = window.location.host + '/u/' + (state.slug || '...');

    // token hint
    var hint = $('authHint');
    if (hint){
      hint.textContent = getToken() ? 'token: есть' : 'token: нет';
    }

    var name = clean(state.fullName) || 'Имя Фамилия';
    var role = clean(state.role) || '';
    var about = state.about || '';

    var nameEl = $('nameEl'); if (nameEl) nameEl.textContent = name;
    var roleEl = $('roleEl'); if (roleEl) roleEl.textContent = role;
    var aboutEl = $('aboutEl'); if (aboutEl) aboutEl.textContent = about;

    // banner
    var banner = $('bannerBox');
    var plh = $('bannerPlh');
    if (banner){
      banner.innerHTML = '';
      if (clean(state.bannerUrl)){
        var imgB = document.createElement('img');
        imgB.src = normUrl(state.bannerUrl);
        imgB.alt = 'banner';
        banner.appendChild(imgB);
      } else if (plh){
        banner.appendChild(plh);
      }

      // logo
      if (clean(state.logoUrl)){
        var a = document.createElement('a');
        a.className = 'bannerLogo';
        a.href = clean(state.logoLink) ? normUrl(state.logoLink) : '#';
        a.target = '_blank';
        a.rel = 'noopener';
        if (!clean(state.logoLink)) a.style.pointerEvents = 'none';

        var li = document.createElement('img');
        li.src = normUrl(state.logoUrl);
        li.alt = 'logo';
        a.appendChild(li);
        banner.appendChild(a);
      }
    }

    // avatar
    var av = $('avatarBox');
    if (av){
      av.innerHTML = '';
      if (clean(state.avatarUrl)){
        var imgA = document.createElement('img');
        imgA.src = normUrl(state.avatarUrl);
        imgA.alt = 'avatar';
        av.appendChild(imgA);
      } else {
        var sp = document.createElement('span');
        sp.className = 'fallback';
        sp.textContent = (name || 'A').slice(0,1).toUpperCase();
        av.appendChild(sp);
      }
    }

    // CTA
    var cta = $('ctaRow');
    if (cta){
      cta.innerHTML = '';
      var phoneRaw = clean(state.phone);
      if (phoneRaw){
        var tel = phoneToTel(phoneRaw);
        var call = document.createElement('a');
        call.textContent = 'Позвонить';
        call.href = tel || '#';
        call.target = '_self';
        call.rel = 'nofollow';
        call.className = 'primary';
        if (!tel){ call.style.opacity = '.55'; call.style.pointerEvents = 'none'; }
        cta.appendChild(call);
      }

      var max = phoneRaw ? 5 : 6;
      var btns = state.buttons || [];
      for (var i=0;i<btns.length && i<max;i++){
        var b = btns[i];
        if (!b || !b.label) continue;
        var a2 = document.createElement('a');
        a2.textContent = b.label;
        a2.href = clean(b.url) ? normUrl(b.url) : '#';
        a2.target = '_blank';
        a2.rel = 'noopener';
        a2.className = (b.style === 'primary') ? 'primary' : '';
        if (!clean(b.url)){ a2.style.opacity='.55'; a2.style.pointerEvents='none'; }
        cta.appendChild(a2);
      }
    }

    // Contacts
    var contactsSection = $('contactsSection');
    var contactsPreview = $('contactsPreview');
    var hasContacts = false;
    if (contactsPreview){
      contactsPreview.innerHTML = '';
      var cs = state.contacts || [];
      for (var j=0;j<cs.length && j<20;j++){
        var c = cs[j] || {};
        var label = clean(c.label);
        var raw = clean(c.url);
        if (!label && !raw) continue;
        hasContacts = true;

        var chip = document.createElement('a');
        chip.className = 'chip';
        chip.textContent = label || raw;
        var href = contactUrl(raw);
        chip.href = href || '#';
        chip.target = '_blank';
        chip.rel = 'noopener';
        if (!href){ chip.style.opacity='.55'; chip.style.pointerEvents='none'; }
        contactsPreview.appendChild(chip);
      }
    }
    if (contactsSection) contactsSection.className = hasContacts ? 'section' : 'section hide';

    // Links
    var linksTitleEl = $('linksTitleEl');
    if (linksTitleEl) linksTitleEl.textContent = clean(state.linksTitle) || 'Ссылки';

    var linksSection = $('linksSection');
    var linksPreview = $('linksPreview');
    var hasLinks = false;
    if (linksPreview){
      linksPreview.innerHTML = '';
      var ls = state.links || [];
      for (var k=0;k<ls.length && k<12;k++){
        var p = ls[k] || {};
        if (!clean(p.title)) continue;
        hasLinks = true;

        var it = document.createElement('div');
        it.className = 'item';

        var chk = document.createElement('div');
        chk.className = 'check';
        chk.textContent = '✓';

        var box = document.createElement('div');
        box.style.minWidth = '0';

        var tt = document.createElement('p');
        tt.className = 'itT';
        tt.textContent = p.title;
        box.appendChild(tt);

        if (clean(p.text)){
          var dd = document.createElement('div');
          dd.className = 'itD';
          dd.textContent = p.text;
          box.appendChild(dd);
        }

        if (clean(p.url)){
          var a3 = document.createElement('a');
          a3.className = 'mini';
          a3.href = normUrl(p.url);
          a3.target = '_blank';
          a3.rel = 'noopener';
          a3.textContent = 'Открыть ссылку';
          box.appendChild(a3);
        }

        it.appendChild(chk);
        it.appendChild(box);
        linksPreview.appendChild(it);
      }
    }
    if (linksSection) linksSection.className = hasLinks ? 'section' : 'section hide';

    // Gallery
    var galleryTitleEl = $('galleryTitleEl');
    if (galleryTitleEl) galleryTitleEl.textContent = clean(state.galleryTitle) || 'Работы';

    var gallerySection = $('gallerySection');
    var galleryPreview = $('galleryPreview');
    var hasGallery = false;
    if (galleryPreview){
      galleryPreview.innerHTML = '';
      var gs = state.gallery || [];
      for (var g=0;g<gs.length && g<12;g++){
        var ww = gs[g] || {};
        if (!clean(ww.title) && !clean(ww.img) && !clean(ww.text)) continue;
        hasGallery = true;

        (function(item){
          var card = document.createElement('div');
          card.className = 'work';

          var iw = document.createElement('div');
          iw.className = 'workImg';
          if (clean(item.img)){
            var im = document.createElement('img');
            im.src = normUrl(item.img);
            im.alt = '';
            iw.appendChild(im);
          }
          var body = document.createElement('div');
          body.className = 'workBody';

          var t = document.createElement('p');
          t.className = 'workT';
          t.textContent = item.title || '';
          body.appendChild(t);

          if (clean(item.text)){
            var m = document.createElement('div');
            m.className = 'workM';
            m.textContent = item.text;
            body.appendChild(m);
          }

          card.appendChild(iw);
          card.appendChild(body);

          if (clean(item.url)){
            card.style.cursor = 'pointer';
            card.addEventListener('click', function(){
              window.open(normUrl(item.url), '_blank', 'noopener');
            });
          }

          galleryPreview.appendChild(card);
        })(ww);
      }
    }
    if (gallerySection) gallerySection.className = hasGallery ? 'section' : 'section hide';
  }

  /* ===== Render Lists (Editor) ===== */
  function renderLists(){
    // Buttons
    var bl = $('buttonsList');
    if (bl){
      bl.innerHTML = '';
      var btns = state.buttons || [];
      for (var i=0;i<btns.length;i++){
        var b = btns[i] || {};
        var block =
          '<div class="card" style="margin-bottom:10px"><div class="pad">' +
          '<div class="row">' +
            '<div><label>Текст</label><input data-kind="btn" data-i="'+i+'" data-k="label" value="'+escapeHtml(b.label||'')+'"></div>' +
            '<div><label>URL</label><input data-kind="btn" data-i="'+i+'" data-k="url" value="'+escapeHtml(b.url||'')+'" placeholder="https://..."></div>' +
          '</div>' +
          '<div class="row" style="margin-top:10px">' +
            '<div><label>Стиль</label>' +
              '<select data-kind="btn" data-i="'+i+'" data-k="style">' +
                '<option value="ghost" '+((b.style||'ghost')==='ghost'?'selected':'')+'>Обычная</option>' +
                '<option value="primary" '+((b.style||'ghost')==='primary'?'selected':'')+'>Акцент</option>' +
              '</select>' +
            '</div><div></div>' +
          '</div>' +
          '<div class="btnRow">' +
            '<button class="btn danger" type="button" data-act="btnDel" data-i="'+i+'">Удалить</button>' +
            '<button class="btn" type="button" data-act="btnUp" data-i="'+i+'">↑</button>' +
            '<button class="btn" type="button" data-act="btnDown" data-i="'+i+'">↓</button>' +
          '</div>' +
          '</div></div>';
        bl.insertAdjacentHTML('beforeend', block);
      }
    }

    // Contacts
    var cl = $('contactsList');
    if (cl){
      cl.innerHTML = '';
      var cs = state.contacts || [];
      for (var j=0;j<cs.length;j++){
        var c = cs[j] || {};
        var block2 =
          '<div class="card" style="margin-bottom:10px"><div class="pad">' +
          '<div class="row">' +
            '<div><label>Текст</label><input data-kind="ct" data-i="'+j+'" data-k="label" value="'+escapeHtml(c.label||'')+'" placeholder="Telegram"></div>' +
            '<div><label>URL / Email / Телефон</label><input data-kind="ct" data-i="'+j+'" data-k="url" value="'+escapeHtml(c.url||'')+'" placeholder="+7..., name@mail.com, https://..."></div>' +
          '</div>' +
          '<div class="btnRow">' +
            '<button class="btn danger" type="button" data-act="ctDel" data-i="'+j+'">Удалить</button>' +
            '<button class="btn" type="button" data-act="ctUp" data-i="'+j+'">↑</button>' +
            '<button class="btn" type="button" data-act="ctDown" data-i="'+j+'">↓</button>' +
          '</div>' +
          '</div></div>';
        cl.insertAdjacentHTML('beforeend', block2);
      }
    }

    // Links
    var ll = $('linksList');
    if (ll){
      ll.innerHTML = '';
      var ls = state.links || [];
      for (var k=0;k<ls.length;k++){
        var p = ls[k] || {};
        var block3 =
          '<div class="card" style="margin-bottom:10px"><div class="pad">' +
          '<div class="row">' +
            '<div><label>Заголовок</label><input data-kind="lk" data-i="'+k+'" data-k="title" value="'+escapeHtml(p.title||'')+'"></div>' +
            '<div><label>URL (опц.)</label><input data-kind="lk" data-i="'+k+'" data-k="url" value="'+escapeHtml(p.url||'')+'" placeholder="https://..."></div>' +
          '</div>' +
          '<div style="margin-top:10px"><label>Описание (опц.)</label><textarea data-kind="lk" data-i="'+k+'" data-k="text">'+escapeHtml(p.text||'')+'</textarea></div>' +
          '<div class="btnRow">' +
            '<button class="btn danger" type="button" data-act="lkDel" data-i="'+k+'">Удалить</button>' +
            '<button class="btn" type="button" data-act="lkUp" data-i="'+k+'">↑</button>' +
            '<button class="btn" type="button" data-act="lkDown" data-i="'+k+'">↓</button>' +
          '</div>' +
          '</div></div>';
        ll.insertAdjacentHTML('beforeend', block3);
      }
    }

    // Gallery
    var gl = $('galleryList');
    if (gl){
      gl.innerHTML = '';
      var gs = state.gallery || [];
      for (var g=0;g<gs.length;g++){
        var it = gs[g] || {};
        var block4 =
          '<div class="card" style="margin-bottom:10px"><div class="pad">' +
          '<div class="row">' +
            '<div><label>Заголовок</label><input data-kind="ga" data-i="'+g+'" data-k="title" value="'+escapeHtml(it.title||'')+'" placeholder="Проект"></div>' +
            '<div><label>Ссылка (опц.)</label><input data-kind="ga" data-i="'+g+'" data-k="url" value="'+escapeHtml(it.url||'')+'" placeholder="https://..."></div>' +
          '</div>' +
          '<div style="margin-top:10px"><label>Описание (опц.)</label><textarea data-kind="ga" data-i="'+g+'" data-k="text">'+escapeHtml(it.text||'')+'</textarea></div>' +
          '<div class="row" style="margin-top:10px">' +
            '<div><label>Фото (ссылка)</label><input data-kind="ga" data-i="'+g+'" data-k="img" value="'+escapeHtml(it.img||'')+'" placeholder="https://..."></div>' +
            '<div></div>' +
          '</div>' +
          '<div class="btnRow">' +
            '<button class="btn danger" type="button" data-act="gaDel" data-i="'+g+'">Удалить</button>' +
            '<button class="btn" type="button" data-act="gaUp" data-i="'+g+'">↑</button>' +
            '<button class="btn" type="button" data-act="gaDown" data-i="'+g+'">↓</button>' +
          '</div>' +
          '</div></div>';
        gl.insertAdjacentHTML('beforeend', block4);
      }
    }
  }

  function syncFields(){
    var el;
    el = $('fullName'); if (el) el.value = state.fullName || '';
    el = $('role'); if (el) el.value = state.role || '';
    el = $('about'); if (el) el.value = state.about || '';
    el = $('aboutCount'); if (el) el.textContent = String((state.about||'').length);
    el = $('slug'); if (el) el.value = state.slug || '';
    el = $('phone'); if (el) el.value = state.phone || '';
    el = $('avatarUrl'); if (el) el.value = state.avatarUrl || '';
    el = $('bannerUrl'); if (el) el.value = state.bannerUrl || '';
    el = $('logoUrl'); if (el) el.value = state.logoUrl || '';
    el = $('logoLink'); if (el) el.value = state.logoLink || '';
    el = $('linksTitle'); if (el) el.value = state.linksTitle || 'Ссылки';
    el = $('galleryTitle'); if (el) el.value = state.galleryTitle || 'Работы';
  }

  function swap(arr,i,j){ var t=arr[i]; arr[i]=arr[j]; arr[j]=t; }

  /* ===== API publish ===== */
  function getToken(){
    var t = '';
    try { t = localStorage.getItem('abqd_token') || ''; } catch(e){ t = ''; }
    t = clean(t);
    if (!t) return '';

    if (t.charAt(0) === '{'){
      try{
        var o = JSON.parse(t);
        t = (o && (o.access_token || o.token || o.jwt || o.bearer)) ? (o.access_token || o.token || o.jwt || o.bearer) : '';
      }catch(e2){}
      t = clean(t);
    }

    if (t.charAt(0) === '"'){
      try{ t = JSON.parse(t); }catch(e3){}
      t = clean(t);
    }

    if (t.toLowerCase().indexOf('bearer ') === 0) t = clean(t.slice(7));
    return t;
  }

  function stripHeavyMedia(payload){
    var changed = false;

    function dropIfDataUrl(key){
      if (payload[key] && String(payload[key]).indexOf('data:') === 0){
        payload[key] = '';
        changed = true;
      }
    }

    // на всякий случай (если кто-то потом добавит dataURL)
    dropIfDataUrl('avatarDataUrl');
    dropIfDataUrl('bannerDataUrl');
    dropIfDataUrl('logoDataUrl');

    if (payload.gallery && payload.gallery.length){
      for (var i=0;i<payload.gallery.length;i++){
        var g = payload.gallery[i];
        if (g && g.img && String(g.img).indexOf('data:') === 0){
          g.img = '';
          changed = true;
        }
      }
    }

    return changed;
  }

  function buildPayload(){
    var slug = normalizeSlug(state.slug || '');
    var payloadState = clone(state);
    payloadState.slug = slug;

    // минимально совместимый payload для твоего API
    return {
      slug: slug,
      title: clean(state.fullName) || slug,
      description: clean(state.role) || '',
      state: payloadState
    };
  }

  function fetchJson(url, opts){
    if (!window.fetch) return Promise.reject(new Error('fetch-not-supported'));
    return fetch(url, opts).then(function(res){
      return res.text().then(function(t){
        var j = null;
        try { j = t ? JSON.parse(t) : null; } catch(e) {}
        return { status: res.status, json: j, text: t };
      });
    });
  }

  function publish(){
    var slug = normalizeSlug(state.slug || '');
    if (!slug){
      toast('Нет slug','Сначала задай адрес страницы');
      setSaveStatus('error','Ошибка: slug');
      return Promise.reject(new Error('no-slug'));
    }
    state.slug = slug;

    var payload = buildPayload();

    // защита от огромных payload
    var raw = '';
    try { raw = JSON.stringify(payload); } catch(e){ raw = ''; }
    if (raw && raw.length > 900000){
      var changed = stripHeavyMedia(payload.state);
      if (changed) toast('Картинки тяжёлые','Для публикации убрал base64 (текст/кнопки останутся)');
      raw = JSON.stringify(payload);
      if (raw.length > 900000){
        toast('Слишком большой профиль','Сократи картинки/переведи на ссылки');
        setSaveStatus('error','Слишком большой payload');
        return Promise.reject(new Error('payload-too-large'));
      }
    }

    var token = getToken();

    // 1) пробуем PUT если есть токен
    if (token){
      return fetchJson('/api/v1/profile/' + encodeURIComponent(slug), {
        method:'PUT',
        headers:{
          'content-type':'application/json',
          'Authorization':'Bearer ' + token
        },
        body: JSON.stringify(payload)
      }).then(function(r){
        if (r.status === 200 || r.status === 201){
          return r;
        }
        // если 401/403/404 — fallback на POST (чтобы “не стоять”)
        return fetchJson('/api/v1/profile', {
          method:'POST',
          headers:{ 'content-type':'application/json' },
          body: JSON.stringify(payload)
        });
      });
    }

    // 2) токена нет → POST (у тебя он работает)
    return fetchJson('/api/v1/profile', {
      method:'POST',
      headers:{ 'content-type':'application/json' },
      body: JSON.stringify(payload)
    });
  }

  /* ===== Events ===== */
  $('themeSeg').addEventListener('click', function(e){
    var t = e.target;
    if (!t) return;
    var th = t.getAttribute('data-theme');
    if (!th) return;
    setTheme(th);
    persistNow();
    renderPreview();
  });

  $('tabs').addEventListener('click', function(e){
    var t = e.target;
    while (t && t !== document && !(t.className && String(t.className).indexOf('tab') !== -1)) t = t.parentNode;
    if (!t || !t.getAttribute) return;
    var tab = t.getAttribute('data-tab');
    if (!tab) return;
    showTab(tab);
  });

  function bindInput(id, fn){
    var el = $(id);
    if (!el) return;
    el.addEventListener('input', fn);
    el.addEventListener('change', fn);
  }

  bindInput('fullName', function(){ state.fullName = $('fullName').value; persist(); renderPreview(); });
  bindInput('role', function(){ state.role = $('role').value; persist(); renderPreview(); });
  bindInput('slug', function(){ state.slug = $('slug').value; persist(); renderPreview(); });
  bindInput('phone', function(){ state.phone = $('phone').value; persist(); renderPreview(); });

  bindInput('about', function(){
    state.about = $('about').value;
    $('aboutCount').textContent = String(state.about.length);
    persist(); renderPreview();
  });

  bindInput('avatarUrl', function(){ state.avatarUrl = $('avatarUrl').value; persist(); renderPreview(); });
  bindInput('bannerUrl', function(){ state.bannerUrl = $('bannerUrl').value; persist(); renderPreview(); });
  bindInput('logoUrl', function(){ state.logoUrl = $('logoUrl').value; persist(); renderPreview(); });
  bindInput('logoLink', function(){ state.logoLink = $('logoLink').value; persist(); renderPreview(); });

  bindInput('linksTitle', function(){ state.linksTitle = $('linksTitle').value; persist(); renderPreview(); });
  bindInput('galleryTitle', function(){ state.galleryTitle = $('galleryTitle').value; persist(); renderPreview(); });

  // delegated input change in lists
  document.body.addEventListener('input', function(e){
    var t = e.target;
    if (!t || !t.getAttribute) return;
    var kind = t.getAttribute('data-kind');
    var idx = Number(t.getAttribute('data-i'));
    var key = t.getAttribute('data-k');
    if (!kind || !isFinite(idx) || !key) return;

    if (kind === 'btn'){ state.buttons[idx][key] = t.value; }
    if (kind === 'ct'){ state.contacts[idx][key] = t.value; }
    if (kind === 'lk'){ state.links[idx][key] = t.value; }
    if (kind === 'ga'){ state.gallery[idx][key] = t.value; }

    persist();
    renderPreview();
  });

  document.body.addEventListener('change', function(e){
    // select style in buttons
    var t = e.target;
    if (!t || !t.getAttribute) return;
    var kind = t.getAttribute('data-kind');
    var idx = Number(t.getAttribute('data-i'));
    var key = t.getAttribute('data-k');
    if (!kind || !isFinite(idx) || !key) return;

    if (kind === 'btn' && key === 'style'){
      state.buttons[idx].style = t.value;
      persist(); renderPreview();
    }
  });

  // click actions for list controls
  document.body.addEventListener('click', function(e){
    var t = e.target;
    if (!t || !t.getAttribute) return;
    var act = t.getAttribute('data-act');
    var i = Number(t.getAttribute('data-i'));
    if (!act || !isFinite(i)) return;

    if (act === 'btnDel'){ state.buttons.splice(i,1); }
    if (act === 'btnUp' && i>0){ swap(state.buttons,i,i-1); }
    if (act === 'btnDown' && i<state.buttons.length-1){ swap(state.buttons,i,i+1); }

    if (act === 'ctDel'){ state.contacts.splice(i,1); }
    if (act === 'ctUp' && i>0){ swap(state.contacts,i,i-1); }
    if (act === 'ctDown' && i<state.contacts.length-1){ swap(state.contacts,i,i+1); }

    if (act === 'lkDel'){ state.links.splice(i,1); }
    if (act === 'lkUp' && i>0){ swap(state.links,i,i-1); }
    if (act === 'lkDown' && i<state.links.length-1){ swap(state.links,i,i+1); }

    if (act === 'gaDel'){ state.gallery.splice(i,1); }
    if (act === 'gaUp' && i>0){ swap(state.gallery,i,i-1); }
    if (act === 'gaDown' && i<state.gallery.length-1){ swap(state.gallery,i,i+1); }

    persist();
    renderLists();
    renderPreview();
  });

  $('addButton').addEventListener('click', function(){
    var max = clean(state.phone) ? 5 : 6;
    if ((state.buttons||[]).length >= max){
      toast('Лимит', 'Максимум ' + max + ' кнопок');
      return;
    }
    state.buttons.push({ label:'Новая кнопка', url:'', style:'ghost' });
    persist(); renderLists(); renderPreview();
  });

  $('addContact').addEventListener('click', function(){
    if ((state.contacts||[]).length >= 20){ toast('Лимит','Максимум 20 контактов'); return; }
    state.contacts.push({ label:'Новый контакт', url:'' });
    persist(); renderLists(); renderPreview();
  });

  $('addLink').addEventListener('click', function(){
    if ((state.links||[]).length >= 12){ toast('Лимит','Максимум 12 пунктов'); return; }
    state.links.push({ title:'Новый пункт', text:'', url:'' });
    persist(); renderLists(); renderPreview();
  });

  $('addGallery').addEventListener('click', function(){
    if ((state.gallery||[]).length >= 12){ toast('Лимит','Максимум 12 работ'); return; }
    state.gallery.push({ title:'Новая работа', text:'', img:'', url:'' });
    persist(); renderLists(); renderPreview();
  });

  $('save').addEventListener('click', function(){
    // 1) локально
    if (saveTimer) window.clearTimeout(saveTimer);
    persistNow();

    // 2) публикуем
    setSaveStatus('saving','Публикация…');
    publish().then(function(r){
      setSaveStatus('saved','Опубликовано');
      var s = normalizeSlug(state.slug||'');
      toast('Опубликовано', '/u/' + s);
    }).catch(function(err){
      setSaveStatus('error','Сохранено локально');
      toast('Сохранено локально', (err && err.message) ? err.message : 'Публикация не удалась');
    });
  });

  $('profileLink').addEventListener('click', function(){
    var s = normalizeSlug(state.slug||'');
    if (!s){ toast('Нет slug','Сначала задай адрес страницы'); return; }
    window.open('/u/' + s, '_blank', 'noopener');
  });

  $('reset').addEventListener('click', function(){
    if (!confirm('Сбросить все данные?')) return;
    state = clone(defaultState);
    setTheme(state.theme);
    persistNow();
    syncFields();
    renderLists();
    renderPreview();
    toast('Сброшено','Вернули значения по умолчанию');
  });

  function init(){
    setTheme(state.theme || 'soft');
    state.slug = normalizeSlug(state.slug || state.slug);
    syncFields();
    showTab('profile');
    renderLists();
    renderPreview();
    setSaveStatus('saved','Сохранено');
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', init, { once:true });
  } else {
    init();
  }
})();
</script>
</body>
</html>
